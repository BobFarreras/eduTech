ESTRUCTURA DEL PROJECTE (./src)

├── .env.local
├── .env.test
├── .git
│   ├── COMMITMESSAGE
│   ├── COMMIT_EDITMSG
│   ├── config
│   ├── description
│   ├── FETCH_HEAD
│   ├── fork-settings
│   ├── HEAD
│   ├── hooks
│   │   ├── applypatch-msg.sample
│   │   ├── commit-msg.sample
│   │   ├── fsmonitor-watchman.sample
│   │   ├── post-update.sample
│   │   ├── pre-applypatch.sample
│   │   ├── pre-commit.sample
│   │   ├── pre-merge-commit.sample
│   │   ├── pre-push.sample
│   │   ├── pre-rebase.sample
│   │   ├── pre-receive.sample
│   │   ├── prepare-commit-msg.sample
│   │   ├── push-to-checkout.sample
│   │   ├── sendemail-validate.sample
│   │   └── update.sample
│   ├── index
│   ├── info
│   │   └── exclude
│   ├── logs
│   │   ├── HEAD
│   │   └── refs
│   │       ├── heads
│   │       │   ├── develop
│   │       │   ├── feature
│   │       │   │   ├── crear-admin
│   │       │   │   ├── disseny
│   │       │   │   ├── guia-landing-dashbaord-temas
│   │       │   │   └── intro
│   │       │   ├── main
│   │       │   └── release
│   │       └── remotes
│   │           └── origin
│   │               ├── develop
│   │               ├── feature
│   │               │   ├── crear-admin
│   │               │   ├── disseny
│   │               │   ├── guia-landing-dashbaord-temas
│   │               │   └── intro
│   │               ├── HEAD
│   │               ├── main
│   │               └── release
│   ├── objects
│   │   ├── 00
│   │   │   ├── 38258cf4b674e4556ea03c4cef1e1f33890ba9
│   │   │   ├── 4145cddf3f9db91b57b9cb596683c8eb420862
│   │   │   └── e6024a6187395213faa22d988777aaa304a243
│   │   ├── 01
│   │   │   ├── 0eef23e3ed3e7876206ffad64bf4494c6ef227
│   │   │   ├── 32c1f401272722e4098ead147a2154e1f5f56b
│   │   │   └── 5d48bb6db79a89418e9f358fe66de69fd65d80
│   │   ├── 02
│   │   │   ├── 3de8361b9b5f63d2bb595b00e3dc4d3baf7caf
│   │   │   ├── 7b19c3168ca82e0a98846f809ef8081b8faf12
│   │   │   ├── d74d7a73523ae654ee7996075a9c19d3272621
│   │   │   └── d79e55310cd450d29bb498d87752859a8b9df0
│   │   ├── 03
│   │   │   └── b96c226afd6c1bd0ab2acb0929095b0f0811dc
│   │   ├── 04
│   │   │   ├── 0b8f194987501ed51710f784f9755cc5e7cb75
│   │   │   ├── 636a1498fd827392f5f0865a26ba2dabe92c2d
│   │   │   ├── b967fbfcdfb1eea0c0a650e157cb6a0bbf5eef
│   │   │   └── bba9ece5910fc4423e33dcc66c97304d30dfb8
│   │   ├── 05
│   │   │   ├── 6fb6fc9c03efba3460d94879c1706390cde238
│   │   │   ├── 70397c440de7a8f3235d04daff14aa20d375ef
│   │   │   ├── adaf33d6627beab311fb925cd7c5f7e1276f6e
│   │   │   └── e726d1b4201bc8c7716d2b058279676582e8c0
│   │   ├── 06
│   │   │   ├── 2aaf76c78b84836263907d92fac0fcc9294460
│   │   │   ├── de34e06752cc4541ecf84592fdb51dbe5eb2cd
│   │   │   └── eb34d506fbe34a4c62db86076ea32ae178fa83
│   │   ├── 07
│   │   │   ├── 2037d567444b127f9150d3c82bc29e8b84daff
│   │   │   ├── b44284fc13dc40728613f85e40e6e77710f094
│   │   │   ├── dd2209c026c3e4c6c3c440fc2df1b914b5c1fa
│   │   │   └── f479fe404dfe2d68e7173384701197c0b176a6
│   │   ├── 08
│   │   │   ├── 18b631e0b42052ced52fdff1485d28d61cc57c
│   │   │   ├── 4574ea613c0a038c8b873df74da6d8017f9781
│   │   │   ├── ccaed9a63a41f56e6093a60168c20d00361d5c
│   │   │   └── f86f50b63dfd3dbe7d9c6c2541c177f010ef88
│   │   ├── 09
│   │   │   └── 150fdabb49a6639275aecaaad228a91bb061c1
│   │   ├── 0a
│   │   │   ├── 36da754b352128503f2672f28286442f2291b5
│   │   │   ├── b593262f0c4e6c7413096389842c7bd5cb2ddf
│   │   │   └── bccc9ba9da2cb89682c1e9300c9784dc9c6e8c
│   │   ├── 0b
│   │   │   ├── 13009f75033f238a46de000826d890d0479b16
│   │   │   └── d69f6e23d4ad3740241f397554e8bac8744487
│   │   ├── 0c
│   │   │   ├── 1f99ab34c339c2ea2d1a435a356118b4ff274b
│   │   │   ├── b5000df94293d86505c78ff3f8360e32133d6d
│   │   │   └── fda66e6fa084a1bf9ec5cc6f8bec8305ac6a6a
│   │   ├── 0d
│   │   │   ├── 4339d45993c673a97e59cc7b562d824a20d7af
│   │   │   ├── 61fc3145757dff109ec9f6e6881e8274b6fbcd
│   │   │   ├── b39bab6cdcaac3727db5c9917123f8b34797b9
│   │   │   └── ca57ff408f6ff3f3f9dd3e8438514a1d9175ad
│   │   ├── 0e
│   │   │   ├── 26031fbc371f2f6df11baa1717e3d62ddf5890
│   │   │   ├── 4d12127f3e7b2e2d8f83ce171ab9b5a8472dc0
│   │   │   ├── 62fddec4426c423f40998e6c5ded795df01041
│   │   │   ├── 89b8e6dba0716c9e554e1850cf9b3e920524a3
│   │   │   └── 9d82be1a9774d511da749193426a5a5c982946
│   │   ├── 0f
│   │   │   ├── 8e157f397c74f0fddcdef593329fbd8495f18c
│   │   │   └── 94900c5ede38da9333b59d70605cb22ac2c56b
│   │   ├── 10
│   │   │   ├── 574cf7398601760c6979b2d86e6ab3e6bae418
│   │   │   ├── 61a3ae36856f48e9098c4043ab0525f502a3b2
│   │   │   ├── 9299c2486a080e055f57352eddca7902041411
│   │   │   ├── b25b6ae1faa4aaad56c6671d0551f27d3a95ad
│   │   │   ├── ce8354c2e9a574f67e7ced1f1236a5d83c5c00
│   │   │   └── d99cd2e5e7e3887f94c3e201eaa753e0b3e946
│   │   ├── 11
│   │   │   ├── 1a4703e992d2e086f64b5b44e7699e1a66ee37
│   │   │   └── 3ff51874a0c194cabf16238facf1606639b430
│   │   ├── 12
│   │   │   └── c5482caa8f6500ca4f22b644792b12510484f7
│   │   ├── 13
│   │   │   ├── 37c09f5b5c6afbc222872e76b15f45ce8afde4
│   │   │   └── fd6ef1df7a3a04a7b9ac2109d583a577a01c41
│   │   ├── 14
│   │   │   ├── 0433e4057d6a089b64f36e5e8ea60cbf44ee59
│   │   │   ├── 0a2428b176921e71677d0ae9fe72c2471e62f0
│   │   │   ├── 239e33c642ebae81dfead9793f6d448c4c3d53
│   │   │   ├── c761beb4e5d23d4bca8588ef9e7f62f82dda06
│   │   │   └── e6698b9cd6ef72606c4c8e46e26459b14c0c28
│   │   ├── 15
│   │   │   └── 8eedabf3ed298aa3f60d560cfee6a9f676b60c
│   │   ├── 16
│   │   │   ├── 0d71f1d1997fdcb81238ed50462a2a9585220f
│   │   │   ├── 1a5baa5cc7fa8cebd87f46159a43da7988b632
│   │   │   ├── 7bf14108f4b263747fb960dbaa74861d692d07
│   │   │   ├── c346783d7e4de061a989a4660454ec563981a8
│   │   │   ├── c8cd51d4ee5f89b5282289da25958bcd7aa87a
│   │   │   ├── fb5feeaaef791cdae952849d2745fefb17c61c
│   │   │   └── fe115375f775a90f6949733f3b23725f7b9ea3
│   │   ├── 17
│   │   │   ├── 2534024ac234a6148c27a743c13dec7391e16e
│   │   │   ├── 601a4ea100588cad36097e4b22f9eb72a7b1ea
│   │   │   ├── 70363f224814c578cd3132466ad1f2bee13113
│   │   │   ├── 975f58393f8de813a56bdd14fa617c738918b2
│   │   │   └── b05bf1e17c6d2338f255fdc91766a0d266a9d7
│   │   ├── 18
│   │   │   ├── 5963839c4e68d3272c6a99638efae21fa7c372
│   │   │   ├── e3cffc2ca721d47091f89fda5e8fa2ea54ab71
│   │   │   └── fc7ab3025e7f637264fb157593c8a6bf76544d
│   │   ├── 19
│   │   │   ├── a064bcb06e714c0b9d82e9c88af2e379ffd506
│   │   │   ├── c3c9199df07fd38b5f14bb1a613ac88710994c
│   │   │   └── f1cd7c5a82bd4185760e4cb037bf65550ef2fb
│   │   ├── 1a
│   │   │   ├── 3c93f2f4c694a3f10671740e274f56b85bd528
│   │   │   └── 978d5065e12bf5933ffeb15f9c85b7f257f646
│   │   ├── 1b
│   │   │   ├── 155791014fdca5fc6f8afb7703330f74d8d155
│   │   │   ├── 38c4140d843dd5048c7fc01778190a278d5f4f
│   │   │   └── bdefa03f86d5362e42a17484cb981f35cf9657
│   │   ├── 1c
│   │   │   ├── 702c66ddf00c0430e6e3d7c5ac42571ae4def8
│   │   │   ├── 7883def5f14fa130aec677dd18c40daedafd59
│   │   │   └── e2de9553d3e043e5f664ea0aaf3f03f28388aa
│   │   ├── 1d
│   │   │   ├── 06b087f2924c307c6bb65f7f1f50312aaacdc0
│   │   │   └── 0a646399d463b41f6fb0d7c4b61fc91a88fbb6
│   │   ├── 1e
│   │   │   ├── 698dd3a170e11dffebf546a3f3c19c332f25d0
│   │   │   └── 9299edcaaf0d95b04beba9a1fd734ad9efd61c
│   │   ├── 1f
│   │   │   ├── 1b0d2c58bca49764a3308a108951e0452c5638
│   │   │   ├── 3539f92e16c8e8cde5988867545957539361c8
│   │   │   ├── 7d4da3487c41b868ffa71a1ffbbe9c2653ea2b
│   │   │   ├── f4bcb8e9af34c70fdaedd4240946346cb9c69e
│   │   │   └── fb0ff066c4ba9e76948d7e09457097869f8a4f
│   │   ├── 20
│   │   │   └── 04c8a4c68447324ad5c34657703fce95ffd976
│   │   ├── 21
│   │   │   ├── 15cf378d7577f78415d621838b573f98aaa2e8
│   │   │   ├── 197cb054499c1ed27d30ceda94fe55c6b98bb5
│   │   │   ├── 4acebfb2e59637b8974f757bd321cb72d1e7df
│   │   │   ├── db4ac5e7d725253baf1fc15431047772c6acca
│   │   │   ├── de2a25ecb0133617c8662b35c9665af8671e59
│   │   │   └── ead2c8bae08f5d4ca086cf368710e69c45327c
│   │   ├── 22
│   │   │   ├── 001fd2cede0591c492361318dafe275fd430fa
│   │   │   ├── 0aa490adebb3a1249faa6d5b3e4b9aca32b088
│   │   │   ├── 3a5c1d5702bf142f9bb8557b4bb0c831ffca78
│   │   │   ├── 4d0bf38eca17c182142d9a2de8b87a3de1fabd
│   │   │   ├── a1b5e85f87475df58de8540389891aae8038c7
│   │   │   └── c16c118afe1205caa5fc80806e2dc3596997f1
│   │   ├── 23
│   │   │   ├── 8b9f862ef8ddc9ea23159c142cae1ca47025b1
│   │   │   ├── a4bedda672b82f07d3dfdbcf49df76c664dc1b
│   │   │   └── d1978e03013d339a619f03e4de7595bbdd4b41
│   │   ├── 24
│   │   │   ├── aff6fb486ebedb9637e2053d08186a5c9e61cc
│   │   │   ├── e2296230396a11cbfdc8c31b6ede2293ed796d
│   │   │   └── ef84f46b9096d61c8da2fa14d388eaac2c7ca7
│   │   ├── 25
│   │   │   ├── 620be82adf68408563df8406776739ece50cba
│   │   │   ├── 80ee9ab8043c8dd5d0cb4219cac35ce597663d
│   │   │   ├── 85c78eed6c3f92a45db47a2d93d26de3b103d5
│   │   │   ├── 9cb818bbe158d8652b209a09ba3793c7d85164
│   │   │   └── b9e53df0195a5795cb59c1ae9391d2ae8d8485
│   │   ├── 26
│   │   │   └── c1ad9bb3f31571028cc2e70efd84b4bc521f94
│   │   ├── 27
│   │   │   └── 8e9ffaac866706d2a03ca6b674817a80dee484
│   │   ├── 28
│   │   │   ├── 3755f6a4baa82f78345123acb23ceea1e38b8c
│   │   │   ├── 98b7992e0b78fcd885d2b9a8081e707f24b81a
│   │   │   ├── d949ca0826d217ff324d737ff58ed654d667c9
│   │   │   ├── df353e961d46630a57d7a8ea7b6a6f54f7bd88
│   │   │   └── fb7b926b6ba9ffc729d5383c38c07968428ba3
│   │   ├── 29
│   │   │   ├── 351dbb5bcf5025002486ba9bd0bca36b32cdb5
│   │   │   ├── 5f8fdf14fcfe6cccaa832133037157521b1890
│   │   │   ├── b31ab112cf6500423b77898317dd139f59d5b3
│   │   │   ├── bf102ba89b603bf873441d557f7580fbd941a6
│   │   │   └── ed011bba0f49f19aa1b2f970c6849754cf69eb
│   │   ├── 2a
│   │   │   └── 3691384e34f9b6b52e63f40fb2dfd734b2003b
│   │   ├── 2b
│   │   │   ├── 3d4876826e9c73b9c3767e716b00b48a5dcd7c
│   │   │   ├── b180444840fd8115b4d7ad05ab2d3bb3e00410
│   │   │   └── f446e5b2fedfef26c3391fad88cc6e16062ef2
│   │   ├── 2c
│   │   │   ├── 15fe3ab16719e618bc887f8dbe2bb02f1f65c0
│   │   │   ├── 33dae76f776268f9eacf7f9bed0eb7afb79897
│   │   │   ├── 3e7bc3f73e771f53544e4083feb34ef102f393
│   │   │   ├── 7c4ca2835dde6eb82a34328896ab256dbbd51a
│   │   │   ├── 83f74a34a2404b39d41483302cd218e6e2b616
│   │   │   ├── 910247388164df97fb5159a77f503799f769b8
│   │   │   ├── a3e961a71678c49e89eb2bb8e1c17c4f367b6c
│   │   │   └── d7983b1c3542b0765ea7bc182d7b1b8d1a8f37
│   │   ├── 2d
│   │   │   ├── 1340685d9462bbd1b24ea5eed6f6d3fc2b11fa
│   │   │   ├── 72dafbb02d7daf4a151c7c14ee763b190fe60e
│   │   │   ├── 900af2bf58cd2402ed8b27f16383e9dc1bf1fc
│   │   │   └── dee3360ca237036b8054556c22b6dc23deb12a
│   │   ├── 2e
│   │   │   ├── 6429aac6ef84dc65772c227d8c60696849400d
│   │   │   ├── 7b63413ccb1ebe40ea1aaa9bc1013f9b708539
│   │   │   └── 9a2823eebcd814f257cf2156fa7b014b008ae2
│   │   ├── 2f
│   │   │   ├── 3accef7bedebca448d8684798e0c1fa54d4afe
│   │   │   └── 73963b3be265fcb46de5a7017ba78fe3f692e6
│   │   ├── 30
│   │   │   ├── 39407bf4cbea7af90dd17090d7a2553bcb169e
│   │   │   ├── 51705602d93af08603a350d45fa8b694f172cc
│   │   │   ├── 64b81e80cf949ad98ace47b0bfdbe51815e34f
│   │   │   └── 70ea256faa98ed78da9a97755789e78ab3ca89
│   │   ├── 32
│   │   │   ├── 21f6486fbdce0f9df334b4ebdb1712378fdb2e
│   │   │   ├── 6843c80c537128e2219bf4d8ccb81df5300ce1
│   │   │   ├── 9a00545a8303d5d96039e297805a2076466ddf
│   │   │   ├── 9f971ad6a710ca97ae978c6d44229f97cbaa52
│   │   │   └── e55937e08a9e9c6b6668139b800cf00972598c
│   │   ├── 33
│   │   │   ├── cb6e1fa96940b324e6eb4ddd1e3038a616e175
│   │   │   └── cf8c7ee53e3886380268b04adc8d1f7bf48677
│   │   ├── 34
│   │   │   ├── 5bad2ddb9ae24d23c181e0b89ca2e3e26e481e
│   │   │   └── aaad1b55589ee16a460cf745f150e9e3c35238
│   │   ├── 35
│   │   │   ├── 00afdf9f09b933f0bc6954f576be9400fc45cb
│   │   │   ├── 2043678b242b1f0b160e7eff00e37722cd057c
│   │   │   └── 2de3757a0aed623e714d2a7ec71eb0c448611b
│   │   ├── 36
│   │   │   ├── f345740d5cfe4a662e5976e288e062251ef0cd
│   │   │   └── f825b06fb9856f2c19966c029ce49480ebfdf6
│   │   ├── 37
│   │   │   └── f4e56b9e57e3c8d0a02cc21a0576246d51cff9
│   │   ├── 38
│   │   │   ├── 0b95186261f56228d4a2ea3f5b775db056ff5a
│   │   │   ├── 2040e1a3e0bd9adfd3108923db9def4f5c4d34
│   │   │   ├── 23a190c5162de1543bc055cab8d53d1b72598c
│   │   │   ├── a2213af2cab025173a2048df9c7892620aac04
│   │   │   ├── de622fe5f0e9413ab31c470caad81e7d04d628
│   │   │   └── f9a135faebb12b32a7b9236258cd7a3d50ca9d
│   │   ├── 39
│   │   │   ├── 708f3768a2b40b86e797628b752f3542d31937
│   │   │   ├── 908150f61617ba19b1a1deaa2c977812b48698
│   │   │   ├── a1c3512eb5abd37c557977793454be2fb41c1b
│   │   │   └── e5f580699f1001b08630a482be204adbc426c2
│   │   ├── 3a
│   │   │   ├── 137d4ac55d0f3b827f901c66278d3a55c4afda
│   │   │   ├── 13f90a773b0facb675bf5b1a8239c8f33d36f5
│   │   │   ├── 306a607fae4e86dd831cb0f4f2891226de606e
│   │   │   ├── a8b92abaddabefaa8041b13bd33ae9774dd8a7
│   │   │   └── dffb2c75f2c2597bc747d64c55028929c1aec5
│   │   ├── 3b
│   │   │   ├── 2a54bea3483a5039314171732c291d5f6e7df9
│   │   │   ├── 59cd2446ee8d329670e476f9d793c84d3f1bcf
│   │   │   ├── 85c4687509187368981d3296a94e1065d6a08d
│   │   │   ├── c1f9cfb261928772ee7db9178d84fb1d6e9861
│   │   │   └── e18f9c532eaba8732ddf1f557dd1b7f0a4ed96
│   │   ├── 3c
│   │   │   ├── 1297478b736510a00a0a97ae2e68f5d9687950
│   │   │   ├── 6a2ea15effefe52b3f2828921f1f2b08d60b08
│   │   │   └── 9f5a80fbeb07ba3bb268df78f05350c9efc6eb
│   │   ├── 3d
│   │   │   ├── 2311d99afd282b80b0e7db892a6c285caddf15
│   │   │   ├── 24675af08a8d726238da3b90816994ed32f6e6
│   │   │   ├── 843507fc148d1765a398f880d0cf9cd484bf74
│   │   │   ├── a09def916a54bf29d33d9829f201e4406a2c91
│   │   │   ├── a9b0adf0c8e4db443baab46b410d177435bdf9
│   │   │   ├── c41f465bc85f597bc512a7a9728edc66ccb951
│   │   │   ├── d1ad59a921ec8ea04357ed9696926efdfae7ab
│   │   │   └── d622fd0e7db324caed1164ed126363b5c25bad
│   │   ├── 3e
│   │   │   ├── 26ba5e7354cf4ab27db256661d159480bbc8c5
│   │   │   ├── b652e6cc3294e4256523cf995dd0863bf140d4
│   │   │   └── d78237e0d567e13e959b5627ae2190febb68d1
│   │   ├── 3f
│   │   │   ├── 0abce9320b2946a2a419106589095411878c18
│   │   │   ├── 3f1d8815f85f94d581d30a5368f92610823d7f
│   │   │   └── 795c4719a381185e1d5dde19cc57446a7b92cf
│   │   ├── 40
│   │   │   └── bcab5e2d43bbc3e299efd7123ebcb0a6ec5789
│   │   ├── 42
│   │   │   ├── 2e226632f46ebf95f8156fdad2429e5c17369d
│   │   │   └── b8ab6c2952636f885e74fed80b98eb1b9b079b
│   │   ├── 43
│   │   │   ├── 15996943841cc3786a79ea7e75da20c3b4c0f5
│   │   │   ├── 27cb6e6ef668fe7e11c15b1db2dc3c7792710d
│   │   │   ├── c48d5fe5623316ab6e51a31ac44ab36cdb1452
│   │   │   └── f752b362a7171fc3082ee213b39a89a77d233e
│   │   ├── 44
│   │   │   ├── 33a9e2dcf80b5d027852fec66aedc0a4081419
│   │   │   ├── a102ae64d6ecb247fdf6cd9bbdf9f5e49c941f
│   │   │   ├── d98862904591fdee0ba3849a7e5a18b015c9de
│   │   │   └── efeedd11a6f664930c8d3ad5ec6147429b0bd0
│   │   ├── 45
│   │   │   ├── 62a4446e0cfd91a48927f5993f33e4b5a91a2a
│   │   │   ├── 8a9f9510c2ba91675cff01bbd31a2540a075d0
│   │   │   └── bdc3e92234b3bec56cdbec2c22b3c2ebc553f7
│   │   ├── 47
│   │   │   ├── 0a9f15697716a9333c28aedaa9a27cbf0dd0f9
│   │   │   └── 5efcb7080478264baf7f470f7010561cc9b82f
│   │   ├── 48
│   │   │   ├── 0d0e0e40ec8e38d39a9d884736da6d086fabbe
│   │   │   └── 51e0ce64b2e9cc2a84534b3a5769121d0d61a2
│   │   ├── 49
│   │   │   ├── 99f57fcccca993a99a91590d3e67f574958691
│   │   │   └── fe033835b7a050b0b13908617f24f3e77ac50e
│   │   ├── 4a
│   │   │   └── 82067c6393bf10773e3f2bc5c01cb1f5d172a0
│   │   ├── 4b
│   │   │   └── 40cf3b66c4cd1859a7b09996e8f553ac9081b2
│   │   ├── 4c
│   │   │   ├── 274d9941dd1aa01b02d879024f35f8432eaceb
│   │   │   ├── 59dfb5d468d4900302b3c54d77f79f49cf2ae7
│   │   │   ├── 8169b5975cf154cc5108b4bdfc7f2bb4941783
│   │   │   └── e183a8041940a2e3af71282c402ab4946057af
│   │   ├── 4d
│   │   │   ├── 3e60c0ab8df919b259e85ef5dbfeca805f5024
│   │   │   ├── 72bcc0916491a2d79d8991576ef4cd047e5256
│   │   │   ├── 7f5f66f495830e43b101040ee4119ee778b13d
│   │   │   ├── 8ac67ae9af5fac962ad54466be430d83722720
│   │   │   └── e7aea12c55874127f6554c890deb49d23eba57
│   │   ├── 4e
│   │   │   ├── 1ca65f38f890868fc09edbb416fd56691c4a98
│   │   │   ├── 22e75671a3be243b539e48efe05d0cf186207a
│   │   │   ├── 8128c13ee1f30c70773245b478c73d97068834
│   │   │   ├── d0c80be3ce06a7227dd64672065059ee82a46c
│   │   │   └── e3284ea3724837981a78a738203866aa311649
│   │   ├── 4f
│   │   │   ├── c21fa0f1c8e0ea35b63fc8de8c23400f1ecd06
│   │   │   ├── cc2c343e6e54cfd1bf378625ecc9818ef5a427
│   │   │   └── e3df39c2b9cfc5412e3f44c96fc52b3a766662
│   │   ├── 50
│   │   │   ├── 0cad0250182546a1667020b3ce3d42dea95df2
│   │   │   ├── 1681935a10848a742f4734a29e1eb54c3741e0
│   │   │   ├── cc68a673e7a9d6f75e99661c48a425468aa481
│   │   │   └── f654f106d61febdd8e3f458595c3d906ad6ee8
│   │   ├── 51
│   │   │   ├── 131b825c832aa9eab3694152db63bf82f95cf9
│   │   │   ├── 4fa32bdfba678418e8257935069d9b99176e61
│   │   │   ├── 5d99cf1ba40f8d0855877ceee116e35c54ab48
│   │   │   ├── 74b28c565c285e3e312ec5178be64fbeca8398
│   │   │   ├── a757b7e4fb4469be1e87d84c0bdc781ea840b7
│   │   │   └── b29638bc5c8ef72ad2725831d2438b9a04df19
│   │   ├── 52
│   │   │   ├── 0365b5f68380c5adc7347d9d73d97ed25bcbfb
│   │   │   ├── 69471159b90c61a4174527f9e9dd6c556fb5a3
│   │   │   └── 7b05f291fdd7cf1213ff5b485f837b62a7bed4
│   │   ├── 53
│   │   │   ├── 2065073f9007ca759467267b582cf6bf560f17
│   │   │   ├── 358a5c2b94e262aa6dc86e9fb0f72bea850184
│   │   │   ├── bb8bade75b6c3696aeb1a1d3d6062ec22a0fe8
│   │   │   └── bf4f9282cc75bfa37983f4559194ff585aac4f
│   │   ├── 54
│   │   │   ├── 1fb8ff03f7a96c8aae773953290e5cb3efb8b4
│   │   │   ├── aa0b7fd7796f2fa4ed685a86c1d2646b9874c2
│   │   │   ├── dbe203c8bcd585e344a8bc85a10cab2808d366
│   │   │   └── f703ad0731034831e268a2baf07dcb35630d6a
│   │   ├── 56
│   │   │   ├── 7f17b0d7c7fb662c16d4357dd74830caf2dccb
│   │   │   └── db8a47751ea89d8dc75735e2ae2c12926b497f
│   │   ├── 57
│   │   │   └── ad22ccf8283e658b9faca9e1120b93c8527b28
│   │   ├── 58
│   │   │   ├── 2be105877a121bb4b4fc1b4d0e4f82b07c3b6a
│   │   │   └── bd66e222ef2690c5141a8d9bb965182ffd755b
│   │   ├── 59
│   │   │   ├── 4d036ad73620d9e644264ceea3735623f3fa92
│   │   │   └── 762441534360e2f0dacbde4373688c086dcef4
│   │   ├── 5a
│   │   │   ├── 1d75d065e5e15ebb4b715d89c33745b2b4fe7b
│   │   │   ├── 305549e24e05e6bca2703d933aa581a67433c5
│   │   │   ├── 41722d9c382c91aeec8c7cfb0b38d220980feb
│   │   │   ├── ca76ef45874e010a847d03b9f53482c7d00bd1
│   │   │   └── fabbcc49de92848f355737f448a51be4b77c2c
│   │   ├── 5b
│   │   │   ├── 023437294451c67a894df4133787a3639775ba
│   │   │   ├── 28a61358205bf311f313a1bc1b943cd795bf71
│   │   │   ├── 41b477e2fee7389befd3a7ccaa065113cca188
│   │   │   └── b532756e4e8d66bcc7e3aff713e40f93643587
│   │   ├── 5c
│   │   │   ├── 10a6265a9a8ce54ce4b5fc07a091454d231c99
│   │   │   └── be8363c0fa0773c1053d24163941d972091f5e
│   │   ├── 5d
│   │   │   ├── 4bf334306b76a2d560210c0ae495be7490dcf6
│   │   │   ├── c4aec8134048a6c7cfd410bcb9d148eeca13fa
│   │   │   ├── edd03103f0b96f6fb1804b8fb6585759194c85
│   │   │   └── ee72c7a991a38e93be8f14616e15669cc7d2fb
│   │   ├── 5e
│   │   │   ├── 35d4a9e79ac001a62b1f711491185afc4c5e18
│   │   │   ├── abbda88a47bf8d638660a6c97c89791591dc35
│   │   │   ├── d2d2e5a9e6faa828d290b579a9e237366141a2
│   │   │   └── f6a520780202a1d6addd833d800ccb1ecac0bb
│   │   ├── 5f
│   │   │   ├── 9338e1e57273fcc15065c07ba742e7d85cd21a
│   │   │   └── a5dc798e665377e9ebc364b9c1255290939339
│   │   ├── 60
│   │   │   ├── 3529b3ff040734310385de5d6e10a43f7825f2
│   │   │   ├── 3d37f003bc27092c7429b57567bdbf0df40a94
│   │   │   └── 6a5586651af121c2af2f572d36436921df855e
│   │   ├── 61
│   │   │   ├── 925ebd9473a5264094d2abfdc540521a9cfdbc
│   │   │   ├── bd35d411b806c2baf9ae4bc74c9d65af087d99
│   │   │   ├── c3c08e5a28ac3b8c43b6f788b0a847a98f2f90
│   │   │   ├── e36849cf7cfa9f1f71b4a3964a4953e3e243d3
│   │   │   └── e581b98275acc8ea1eb4aed49d69f8aedca80d
│   │   ├── 62
│   │   │   ├── 3773613fec6ecc992854196197cc67b0aa0e6a
│   │   │   ├── b072941ec1d1a263e8236ece19c0449509b708
│   │   │   ├── c03e7f0e8507413c49d79bb24bf3c25aec797f
│   │   │   ├── c687561adcaf4f2f55638a5af80236bf5c70ae
│   │   │   └── fdd33153bb1bb0f61c7820738cb6fc485057c0
│   │   ├── 63
│   │   │   ├── 7468941006f41bbe515470e69b60ce2756b50c
│   │   │   └── 84949d797e98c8cd010d700ee4533a8b8de6d4
│   │   ├── 64
│   │   │   └── 6dd9c4a73fadd9e06b216d123b1576e6c9f0fb
│   │   ├── 65
│   │   │   ├── b67c55f602d788bbfdc8051307a2083f346e7b
│   │   │   ├── b8bace8f5a2fa3364240b1a24f62b8ec3d04b4
│   │   │   ├── c36f6a6cf747143e58b3846265fe885e3c4524
│   │   │   └── ce3431dee34ae0613fb9af224c1e485f06609f
│   │   ├── 67
│   │   │   ├── 45b0585781c1c56ffb45cde5a8d52b30fddb44
│   │   │   ├── 6a638283b2a9f9de87a0738ffcdc10f4ba38a1
│   │   │   ├── 7b580ec7e529bf6126a1ab076169c18f2601d5
│   │   │   ├── f2df0015a3ac5252d4b8eef4cb3eae8b2edd82
│   │   │   └── fce839120e7f87f3ae89571533e3455f8f2ef5
│   │   ├── 68
│   │   │   ├── 314a9ada144cb2905e8b7ec5dd2470caa0aa80
│   │   │   └── df8bb5f1c714daf26de755f9067500da61da5d
│   │   ├── 69
│   │   │   ├── 3d40c739d65e11ab90857b9d08c01003dab9d1
│   │   │   ├── 6c7fac44397c7e0524411e1f6e3c84ede5031c
│   │   │   ├── 8d402e602c49dedaa37ec5fff294bc00322464
│   │   │   ├── bb98fd900582a80fd8f30f4f6c768ba90b05f8
│   │   │   └── f0089abf6d24bf28b39ff390b28fe53148062c
│   │   ├── 6a
│   │   │   ├── 1f6637d1801c39ffdb284f4e4bdb0fa18a3828
│   │   │   ├── 8e3fcc90157f7f142706b765e95236a9305bcf
│   │   │   └── c5bdf674999accb0a886a0073a9e8d56c39c31
│   │   ├── 6b
│   │   │   └── b148f7ce15bba64bd95c1efe14e275448cc4b0
│   │   ├── 6c
│   │   │   ├── 1ac599d84befb016681da8aae64dc6b36cc434
│   │   │   ├── 55d4f5e4efc6f527e634c0d3d662e10751cd47
│   │   │   ├── 6a18573bce17a8c8fd81f8a261224b019e6b53
│   │   │   ├── 8a26247536aacbd255fdeef489ef96f940242a
│   │   │   ├── c650b181b8802678414eb38578a5f6fcb378c0
│   │   │   └── cdd16acbe992989fd60f86fce7572fbc2b8457
│   │   ├── 6d
│   │   │   ├── 106da23fec791e1f886644e4339fff6c14de32
│   │   │   ├── 8528a8aaa9232337743c16c47a47a14a8b90f0
│   │   │   └── ec08c3288ebb44f1c973ae8378e747bcbd831d
│   │   ├── 6e
│   │   │   ├── 4da63431f1a44845fc662abe74abc93fb31833
│   │   │   ├── 4db68bf040562147487696f7682f0fcaaf38fc
│   │   │   ├── 8b054637d6464bb59541bbfe5e96595b0ac9b0
│   │   │   └── decb1a114cf766cac1822b8908c4e3af7936fd
│   │   ├── 6f
│   │   │   ├── 00e7c197c9cccef3f77871243e772cfc178073
│   │   │   ├── 1ebe9ecf6b452ad174c34cbb99e07f910962b5
│   │   │   ├── 274496873551d9d7d94340f53858892c731f12
│   │   │   ├── 2fc59dafa59fa1ac95d15036e63068dbcf50d1
│   │   │   ├── 9460110fa10f09b7384eeed6530244494cb59b
│   │   │   ├── 99ca52b9215059590db8fbbebff02924e83857
│   │   │   └── d38a0376292147428995a2261054daf6b542c4
│   │   ├── 70
│   │   │   ├── 1f624c6222b52b2ef34a10cca7d1d768ffe69b
│   │   │   ├── 53ebdab5909131d942fe35697a7748b6d6f37a
│   │   │   ├── 6e59b6b961a3a6fc0cf8f2ea1a1de27b995c07
│   │   │   ├── 7a7186ff89a9b63bb1169326b69812aac8aaa4
│   │   │   ├── 84550fcb65e233aaa8d7f1e8079ee4d0f90899
│   │   │   ├── ad8a98545619c5c83148b3ca30ba868bf3a0e4
│   │   │   ├── e776f2ae54982fd8091152aa8d941a95cf5cec
│   │   │   └── f016b620e59adde8df270868c719a75ddac7d2
│   │   ├── 71
│   │   │   ├── 08a7455ac3521cfb2dc6f65dcf1099e219c2da
│   │   │   ├── 2b2a4562b6b5167b80edb4b122c433637b3207
│   │   │   ├── 8d6fea4835ec2d246af9800eddb7ffb276240c
│   │   │   ├── b887a4d3957ba19e64e3a904eb7de62b1379c4
│   │   │   └── dacfcb3c1f7b6e3f9a285dd40e21208577c221
│   │   ├── 72
│   │   │   └── 91eaf9c03a77276ff7c6bc0fa0fd76c41193fb
│   │   ├── 73
│   │   │   ├── 4e0177a53c62bf9dc4049b3cbe819471ac5e89
│   │   │   └── df25bfa4202bdd9e126c1125fc19e18af8e49d
│   │   ├── 74
│   │   │   ├── 23f6cc16d8edc80e7c1128a3845e2aa73afadf
│   │   │   └── f825ffc02dab1f1926bcab63c957997410f7fb
│   │   ├── 75
│   │   │   ├── 0fbf3bd2034fc0339e00137bd1aa625ecc2550
│   │   │   └── 892ba1047224d4c0804e1f642cd2f6aff2f84c
│   │   ├── 76
│   │   │   ├── 3c8d4e611bd75c2497cf00fc4c7e6501611ec5
│   │   │   ├── 5afd7191f0a5a263c1406e41fea92d89b68744
│   │   │   └── e9cf9a49313c468c7a25c39c22eb17260059ed
│   │   ├── 77
│   │   │   ├── 053960334e2e34dc584dea8019925c3b4ccca9
│   │   │   ├── 1054c7fbfbca8eb1ab50dd1d32f8f9a758b987
│   │   │   ├── 2ac07b104f8b34b3e8fe047ee3253e57cfa903
│   │   │   └── 80d651e6d409ead54d65f1c35f751edf76a155
│   │   ├── 78
│   │   │   ├── 0a4a055c11fd0d6ef77951122c7fa2d1304872
│   │   │   ├── 5f9f0d3fe77f55743d1f4af9331bed0029e0aa
│   │   │   ├── 7496041a44d7ff889edfbe212a0f8a6fdd4e5c
│   │   │   └── 899f1de8f8620147083721474ce663692aa14f
│   │   ├── 79
│   │   │   ├── 6e1b5f3d12743a8b0e89c30409f02b302121e4
│   │   │   └── b95ec71a8e1a170c43ae3eac3c573136ec945b
│   │   ├── 7a
│   │   │   └── e253db098336a83a72060b75d07c52999fa2d8
│   │   ├── 7c
│   │   │   └── 14e3c0bfe4f746e54336e64c1e0268d840c5ef
│   │   ├── 7d
│   │   │   └── 4589b5254a8236302bac4a3301c9fc668945db
│   │   ├── 7e
│   │   │   ├── 3a3344852b951510c7b37480df7a230ba7d3fc
│   │   │   ├── 4d45340d501eaaa7d4e6e12a4632ba8fe49500
│   │   │   ├── 68610739e1fcda271958847deb1450707a0abb
│   │   │   └── f4840c810291bcde69deaacae4f0f71755f91b
│   │   ├── 7f
│   │   │   ├── 98de0603b7b70a66afb32a51e75ee64fcfb6e1
│   │   │   └── a60dcec011d7fe07df55a3460f54144693c715
│   │   ├── 80
│   │   │   ├── 307e031220d9287df6c8210b145f1bc11b3c82
│   │   │   ├── 34c5e9a4ea1890291502bbdcb903cb59378ba6
│   │   │   ├── 40ce553ec6586726207984edb4685e5f099b85
│   │   │   └── d9a039a54ad64e04b96a461c973f3810c9468c
│   │   ├── 81
│   │   │   └── 44f9a4121683f779bd0f7cadbdb3b9267a83fc
│   │   ├── 82
│   │   │   ├── 0c7bfa7f19058c55dc962f54619019f6076d14
│   │   │   ├── e150d81b28a737f8f05ae89267770c60c7faaa
│   │   │   └── e8854f9f77f19caa750fb121de16f32606ece3
│   │   ├── 83
│   │   │   ├── 0208aa3b69ea36173970f13b56128a201da103
│   │   │   ├── 30a687c3dc540813b7b1e6eb7526f1db218598
│   │   │   └── bf87d9236238cd7b21be8a2241e7cd25359703
│   │   ├── 84
│   │   │   ├── 25971febcb78d372c790dd79ae92bf1dd17114
│   │   │   ├── 5efcf4ee98dc96d38d03977a36b23f9eda9ca7
│   │   │   └── da5efb62c34058c822cf55e84b2e2e37e512db
│   │   ├── 85
│   │   │   ├── 9f85ac590a98c1ca6f0141acd0d6fdcd1ce8c6
│   │   │   ├── cec038c8fbb945227c181948dcc8c407fdb437
│   │   │   └── fedc470740f8382f87b59da681789b2dcb7a9c
│   │   ├── 86
│   │   │   ├── 3494147560d5f9a8cf387f121a8063b21efe19
│   │   │   └── 95dbb4267684f6aae270277aa13f0fd520da7c
│   │   ├── 87
│   │   │   ├── 0505d2f47cd8c37bbe09d1afbc694aa62ed845
│   │   │   ├── 24663871e69a5ddb00260615e14f2c77718cc2
│   │   │   ├── 56ae3a9e606a10486409e1ba7ecfc940eed223
│   │   │   ├── 70f254e209aca2304a1e8436a2bb082ceddbec
│   │   │   ├── acc152028ea38ea04370e75e4eb9e81f9658c5
│   │   │   └── b57fa1adc8c0c32cb00fa3f558742b473a0b38
│   │   ├── 88
│   │   │   ├── 1598005177bd1618b3cbea6488a5ecfc6fb9c1
│   │   │   ├── 9f96713fc47f964a3b756114e07d25f6067865
│   │   │   ├── c5932377b6f0c7eb71579d88a4f6a086ffa0fd
│   │   │   ├── d050b1908057b53d38b42702ebc659e3d7f696
│   │   │   └── e6f312e20dd9ed233d86c73ebcd9e413b46e5c
│   │   ├── 89
│   │   │   └── 711140ffdc55edf3535e46d666652f94483b9e
│   │   ├── 8a
│   │   │   ├── 233efe36b8788b93fb30068ba821d7b25d795b
│   │   │   ├── 595ce74ddc509cf445afcfdf56a19e46b9adb8
│   │   │   └── f9b4522d82e78bf661ea7599048bc17050f91f
│   │   ├── 8b
│   │   │   ├── 691c02ecf5cff638e0586c3a8dea8d4a5e7518
│   │   │   └── fc383be5f240cac9abea0bbf38eacba5ea1ad4
│   │   ├── 8c
│   │   │   ├── 05bbda8915784920259945b07d7d9adcdd271a
│   │   │   └── 68db77089294cb4f34409f8507dd639ce8aea9
│   │   ├── 8d
│   │   │   ├── 2cb87f170efaeeb9ded51c61eb8bb358fdef56
│   │   │   ├── 4c38a2f6e3d0088ac0d2ae03c7d99561e5fc43
│   │   │   └── 5adede09c5f7b2a15a10e67a188afd31950770
│   │   ├── 8e
│   │   │   ├── 167f316e288efa8717f1a8169f2f3a2eb131a0
│   │   │   ├── 37883471f58907aa611d62688bb8f9657d7834
│   │   │   └── 76bff801bf5eb95d207cde8f7d3e1478c45577
│   │   ├── 8f
│   │   │   ├── 1525d8d8d2d073770f0c8af0445641a029dd87
│   │   │   ├── 5db4f5df8d2f78ad6ed6ee52f4631bb8d06e11
│   │   │   ├── 80aaaff97a1bfe6b4d753625085944568a1363
│   │   │   ├── 8735950a6c03bf3ecb571c49c9c4a14b400bf1
│   │   │   └── c1aa288c105c33a9e6a17f51614b2ae559d9c5
│   │   ├── 91
│   │   │   └── b46072ce462dabcaa7cc1c7b02793345470e14
│   │   ├── 92
│   │   │   ├── 0d1851956905c031a7b99124fc864a2e0f9eb9
│   │   │   ├── a0a6fabdb113183564ecaad2ffeeadc489cbef
│   │   │   ├── d6a32bc12ed111c856f56aa08f445fcb2770b2
│   │   │   └── dc0cf707480e9bf4517198db9b0cb3e8a9d2fa
│   │   ├── 93
│   │   │   ├── 36ce6ed8f805210ec0d7dccae2e4d73b007448
│   │   │   └── d570d13b062e81330577c32aab07277516f04c
│   │   ├── 94
│   │   │   └── 51a8f3e3588f383bb93711e0772a33bbfcccb0
│   │   ├── 95
│   │   │   ├── cebe3192365cf2e8e9f27a0bd19af452f16c16
│   │   │   └── fcdab10ee521da7fea7417812b63e2566635e7
│   │   ├── 96
│   │   │   └── c961613ff1605d56cea4a36cd54bfc32a22162
│   │   ├── 97
│   │   │   └── 3df98d62fa9c685a6fab5633ab794cee53ece8
│   │   ├── 98
│   │   │   ├── 2168abe9ad2366b5f220b035714b875bb52a71
│   │   │   ├── 51593791be9981766a67f6240d068263a8f908
│   │   │   ├── bde270b7c95ee0bf77872990db8d02395059ab
│   │   │   └── c059449a00ce6d249194ea47a8d36546eaa2b8
│   │   ├── 99
│   │   │   ├── 2428cd58c0cf84de0b8c8e5157c7f7f5675924
│   │   │   ├── 9fa6c15c75cfaea7c509843fc7500a4d223056
│   │   │   └── e515b28b4036300b38267649774650be6fdca1
│   │   ├── 9a
│   │   │   ├── 5c043f3fc4c089818ef4fb3406c77724a6fad2
│   │   │   └── e2ad84233ef97092ffd3fd8e0d0905fecd93b9
│   │   ├── 9b
│   │   │   ├── 26ad3414c99b7a31852a97b3026fc90cbd3379
│   │   │   ├── 317fff1b90f99f948bdeff9ac806c35b1b8957
│   │   │   └── a2233ab7331e98bf7a9c0710a5c960b7acf6a1
│   │   ├── 9c
│   │   │   ├── 76c60214d033f75d9d9460463d9ccf67acf9fd
│   │   │   └── f1a7fc2f312b8eb5a48675ad21041de50fc5e4
│   │   ├── 9d
│   │   │   ├── 1f899f634cd3ee6fff218dab5c5bf50f7d1700
│   │   │   ├── 47edac5f437e7d580119ef987ab8eee17d1092
│   │   │   └── a8a84339d1769730634f0f035c314b717ee697
│   │   ├── 9e
│   │   │   ├── 26dfeeb6e641a33dae4961196235bdb965b21b
│   │   │   └── 91b6a697269bae99bec2bcdd93b4b625a64564
│   │   ├── 9f
│   │   │   ├── 654ccf8d7b5b47bea4dab691093ace0ac2b097
│   │   │   └── ff0be18a7cc4adbec703370de0699e0e2b8035
│   │   ├── a0
│   │   │   ├── 22f5afabf0a1817b50cb3bdf214b2ec24450c6
│   │   │   ├── 59e66c323f9a0602ea58c2213e0e5c887c2d03
│   │   │   ├── 9d3b59dbe32496100032ce76793ee7604f9eca
│   │   │   └── a2d622b94c09d9fdb24ee3c4a543568b4516d8
│   │   ├── a1
│   │   │   ├── c0e3130d78cf6f7bdaa00b9773b757032268cd
│   │   │   ├── c396e34b680e432d7ac46a5ca396626f597132
│   │   │   ├── c9b38cd3933c6f42e652b63149a5e71d17caa1
│   │   │   └── f1371cbd80f4b87c71a4c5a8d1ca3098d11369
│   │   ├── a2
│   │   │   ├── 2322b0be7d5d9faa76b9f3ba7fb23f1148c7bd
│   │   │   ├── 6a0f6774d196847097b42a7b1fb209198b5311
│   │   │   ├── 6acdc3ef301fcdc06cb6c4fc07bb28ae723754
│   │   │   └── dc41ecee5ec435200fe7cba2bde4107f823774
│   │   ├── a3
│   │   │   ├── 6a22742ce6d02c8c2a92a3c18bf17df346349a
│   │   │   ├── 9663e34765a9491e1fd2702bb07c60fd2a7cf3
│   │   │   └── f9e2d2704038a10b168b1d6be7e004ae6292d1
│   │   ├── a5
│   │   │   ├── 0c52fecede06e6be8828ac13c32a6cae53b9c3
│   │   │   ├── 41eebe3ba66dffa95e87e6b14add2ac44f94ed
│   │   │   ├── 6967e5f6925a30da01bf8a2fd2b4d3c90212d5
│   │   │   ├── 91473e04a9fd159d0c61a4308fce64a40861ef
│   │   │   └── e8e1fb1de0418b3ad1726826c2782427c433b0
│   │   ├── a6
│   │   │   ├── 14c93bc6f69d345145c3c542654967bc6a09fd
│   │   │   ├── 57b8b11da139ee091dc1534cd7ca7189f01d67
│   │   │   └── 94b225a1f288245f4d53944934154f68a09e78
│   │   ├── a7
│   │   │   ├── 12b20cabf3b8694ca0320fd2387f17e8a809f4
│   │   │   └── 2ee82fcb0b296466094dd3d499c6c544503427
│   │   ├── a8
│   │   │   ├── 050e067db8241c2d54133fe7f039ba7426176e
│   │   │   ├── 2e154a177cd72015c84460e17725ba1d7d74ff
│   │   │   ├── 57ac6488fb587d098e0c5427e26a5ed240920c
│   │   │   ├── bb40b77df91e4d94b01f27dcafd381d064a943
│   │   │   └── c364ef11cf6287217c3893da5a6bc74110285c
│   │   ├── a9
│   │   │   └── b9ebd75b81dcd5de33f90410dbb05e45ffb838
│   │   ├── aa
│   │   │   ├── 104a119ab589cf1313f0d66b8ca27b2de19f1e
│   │   │   ├── 243b733e704c4a55f2a5681cbad0f63278aec9
│   │   │   └── ad6f9e6e9b2262b043340091540f96d909e849
│   │   ├── ab
│   │   │   ├── 35ea493266e71887e89fc54670a8a20762b598
│   │   │   ├── 84d5367e4576533bcace775fc9808d35659b5c
│   │   │   └── c42a2a9598506c4618371a37086904c7e5d9ec
│   │   ├── ac
│   │   │   ├── 3010aaf318556fb8dad42c2c536c1aed11802b
│   │   │   ├── 54d8f9dd20d06aa3cb50cd88c9610fef438493
│   │   │   ├── 5f774584a459947eba4ae6924c3cbffe795f3e
│   │   │   ├── 7948fbd8711b8ced7c3393a2731347361c0792
│   │   │   └── eb6b40bd52da1885bb93ce0376e2e801503e66
│   │   ├── ae
│   │   │   ├── 4af8a2d462370662d40d21e41e06b38ad5ec6b
│   │   │   ├── 8b81d707cc0fbd69fff5bd7a300418bfefb790
│   │   │   └── af6010097933dc1419a424393f861ba6b4215a
│   │   ├── af
│   │   │   ├── 2f8d71ce3b3d348a9bfd091931f3ecd6c75485
│   │   │   └── a8c75144dee526bd5db0dbe37c33963e64338f
│   │   ├── b0
│   │   │   ├── 43215504c26a302f47378a169a7fd92d071809
│   │   │   ├── 8137f8fe7295c9355588272fa51874fac08e62
│   │   │   └── 9512775e5ac76b11bb1893fc5dfeb8f2b18fa2
│   │   ├── b1
│   │   │   ├── 4b3b5f8b3e172a04ac2133477e916100e2bfea
│   │   │   └── 79c0414b448240bb6b7edae5b985c3492e6e3f
│   │   ├── b2
│   │   │   └── b2a44f6ebc70c450043c05a002e7a93ba5d651
│   │   ├── b3
│   │   │   ├── 0affec3cccf8d2d576b2dfdc4f887e00575468
│   │   │   ├── 3d11d2fa357fb68909a1073e8a990c5764d5a9
│   │   │   ├── 5ffef1ae46f9e25de64e79e7f5313304f4084b
│   │   │   ├── 7ff860529f404872990764bc7ca6ec392d77ed
│   │   │   └── f6b7d796cc810c477568ce1c3fae6c1fcd6fab
│   │   ├── b4
│   │   │   ├── 0d63d590fc272bc2e06ff11dbfc28c9a4eb4be
│   │   │   └── 31b46901bb358d1cbc1ddfa38eabc5d0ef8e0a
│   │   ├── b5
│   │   │   ├── 9b99bbba5d6199cb5661df6c1a8a553223e601
│   │   │   ├── be8a220a818df50f5a3334e98d140f5bf00303
│   │   │   ├── c00bffbb624b9f5075c4ec811a3460d07bffb9
│   │   │   └── d42f2d6153c5cfaf9c5d9f79a07e391092f5ee
│   │   ├── b6
│   │   │   ├── 2ae6033eebb1fa12188b98720bc02e74632201
│   │   │   ├── 5ce59fcb3111d86e39b79d6ac27f70356b5cc4
│   │   │   ├── 807fa1e0255e7564262a1eed638f835461ce98
│   │   │   ├── a00f96a9ad86187797fb06e59097bc5db83bbd
│   │   │   ├── aeae3e3c1997071ae2fb36a2ab10337e170b06
│   │   │   ├── b792c5f81cca3d5930f481ad4739d247de0f0f
│   │   │   └── bcac4347fcd4179b38917e4777a25671492bc7
│   │   ├── b7
│   │   │   └── c6aa4345283710fd0d2057224d0228604e4dd5
│   │   ├── b8
│   │   │   ├── 27122a52b9685eb556f43eb18f3ec03d9364c2
│   │   │   ├── 29e25000fb383298f9ecf9410d67b64e8b39e9
│   │   │   ├── 3c1a95cf725f54b89989cec9aaa72b5b13e9dd
│   │   │   ├── 3e19d7baa65158a046dda96cc45b0213afb3b1
│   │   │   ├── 60f2f1e5e356e8161ca7b31d23664903d03286
│   │   │   ├── a62350bdd39491de7f91cb17feff0476aec4ba
│   │   │   └── aedb04de049fdf8c4b46cd4c86ad21364a3c2e
│   │   ├── b9
│   │   │   ├── 6e1e83fddd80579e8dc6fbe21922d9a2db0bee
│   │   │   ├── 72a336ac76e2b7561ff089f66be319826cf0f0
│   │   │   ├── bde3e27e784bece39c85da128aafba7493c49b
│   │   │   ├── c706418b5d93963e89f1d67ea8e47c1c2b6202
│   │   │   └── f6644009fb6d28a499b3fbb7587b83fb01fe6d
│   │   ├── ba
│   │   │   ├── 512d945cb5e8ae6480ac980182580583cb1471
│   │   │   └── a28ccea7d53ceb5396d72e8706b924c796e6a7
│   │   ├── bc
│   │   │   ├── 9db81acf83bd4426dd0703be61012d0b716625
│   │   │   ├── b5055dd14f94daf8b4d54426e2a7ac54d8da72
│   │   │   ├── d20d50622030b045c6fafbc9d498f48274054c
│   │   │   └── fee0495a91f076f5f89454ab6da6eaa512db25
│   │   ├── bd
│   │   │   ├── 0343c562783177a42820c546c95ee464cd6727
│   │   │   ├── 5f0fb3cfd5658463eb830f753c1a5ff5bbc197
│   │   │   ├── 8e3ee190e25153dcece1cb7f7d9250a3965cb6
│   │   │   └── bf82f943c1b3b7403724818b02a1e132de6729
│   │   ├── be
│   │   │   ├── 7664c777d57a57b2a11a6f43b121ded4445a71
│   │   │   └── 94a2663df9b33afa2c904c8b383943d0c799e5
│   │   ├── bf
│   │   │   ├── 098ff79155bbf4eda618e058d423c3760cbfca
│   │   │   ├── 53897f8dcd7f853a219b86f78e2dc880a4c9e1
│   │   │   ├── 561a008ee7a1de93a7e72a96367d218acabf1e
│   │   │   ├── 5856c9e06d448c1cbdcf6b336943ddda564377
│   │   │   ├── 64423f33d2f1e21d70c0cef45c1a555155fda2
│   │   │   └── 7ab6c3e5dbb69df9125795dc4a04fba3f21a1a
│   │   ├── c0
│   │   │   ├── 7cbd1d5e15e7cc2e5aac44ece89f32d8101b17
│   │   │   ├── 8cc6ae59148fb2691c5354bd16ea0af345da74
│   │   │   └── c775974a514b1cef0414e7839a877991458c4b
│   │   ├── c1
│   │   │   ├── 3ac22293ba01c82e7ea1f82e67208658f85465
│   │   │   ├── 8287a85c6b43b43b19cbcf0a76a59db2a4a839
│   │   │   └── ae06092f0be9fac8ac38a5ff19554fd8cb3ea2
│   │   ├── c2
│   │   │   ├── 048059e815393465da8aafd2a3e474e4096575
│   │   │   ├── 61e38ed499f4d247707079c98f4e4c1e08b02f
│   │   │   ├── a0f573b87d904a96bd74a7bb03b788f2a36e6e
│   │   │   ├── e366092f989f71220d905088de450abe73816b
│   │   │   └── e599d835e5cae1bd4032bdfad977a1e8b77680
│   │   ├── c3
│   │   │   ├── 1932ae408c9aa18e202efd1620525e81ae1742
│   │   │   ├── 1b53f14e7ea500b787f04883762514e7109d8c
│   │   │   ├── 2f10c10bbbb5c3a7341c115e0304e165ecbbb2
│   │   │   ├── 5142462549129aa7e715f7ea4159b7ffc0d965
│   │   │   ├── 7c083502e03911e3a804136bfa2dccf3299fb8
│   │   │   ├── 916e1cbd113afac45c720518158ff68cb64745
│   │   │   └── cf3dc879480568aa6b18f55556a7d648c37b56
│   │   ├── c4
│   │   │   ├── 3df598287bddf40922123f319fac304d4006b1
│   │   │   ├── 9666f8458029437e59c80f91de1ca48323d61d
│   │   │   ├── a6967055c1467d80d966d289614b9c5c10f1bb
│   │   │   ├── afcda3cbf287268a5c2532ce4d6b0c141d9397
│   │   │   ├── b79bbc54166e31cde5b0ff7d8a6449ca02fe80
│   │   │   ├── cebbb656595b7e2689d0fdb6205549cfda6e6a
│   │   │   └── e587ff01b3d61ee57eac00369a57a234264205
│   │   ├── c5
│   │   │   └── 9642ab47fe410d3f53bc8747d8c1b5cbf49acc
│   │   ├── c6
│   │   │   ├── 8f3cfcd0d32fb84c9815afb35398dc50a45942
│   │   │   └── fa2c94e590eb4726e621b26bf03e3f3aaa328b
│   │   ├── c7
│   │   │   └── 90ee2159fa8d433c9a9a359329db1830806da8
│   │   ├── c8
│   │   │   ├── 3b8bde585180c668610ffd24c36ad0333cc79a
│   │   │   ├── 8f389de09f418da376598c42e8788d4fb6d172
│   │   │   └── eebc3b3e73d0d9de9c5d1290cd57c79b8c05a9
│   │   ├── c9
│   │   │   ├── a93f3f3c79bcf94f0c6cfb0e6a2c5a7eff145e
│   │   │   ├── b24106a6b73bbc5af45f9c3077aae19d149df5
│   │   │   ├── b438833576df6864ea08cce3ebe86bda9df538
│   │   │   └── e8e66d9392e9814068859712cfa9d9be7dd441
│   │   ├── ca
│   │   │   └── b8578683fd664da09c17300198ef8c1acc71de
│   │   ├── cb
│   │   │   ├── 00b65b8267f131bba4574665e34e53e1d1641b
│   │   │   ├── 46be426de8687da7c1d00766bc51fbcb522fce
│   │   │   └── b2ccd2ac03c24767efbad394851c45db6ae934
│   │   ├── cc
│   │   │   ├── 046bfdb61be3306115a20bc91f9a126dc22392
│   │   │   ├── 3675a32b2e303558947771ba7bd8f989900d38
│   │   │   └── 501c035e59e25e1992562017720a7e5eddac40
│   │   ├── cd
│   │   │   └── 43a3dfb9c40dda769b684e3aa5efbc34c97ee4
│   │   ├── ce
│   │   │   ├── 40cfe2f868af6b31274c51c03d228f5fc35606
│   │   │   ├── 891dfa9c5e080ab2571fcf2c82243db37b7267
│   │   │   ├── b9a81761081dee102bed8c97f0d821c3313d6d
│   │   │   ├── e0907b7e7cbc66a82b00933185a67456bd6115
│   │   │   └── edd4f14ebc59c467ca0025e944db77c758b798
│   │   ├── cf
│   │   │   ├── 15e0de86306dee1c6a495239bfce0be64270d0
│   │   │   ├── 3aeeb9e008f9c0ea619a013d173f397edf538c
│   │   │   └── b15609831558e3cf174cdff065fc3849a24a07
│   │   ├── d0
│   │   │   ├── 529914c4247adceb9e0efe33b2f5323f976d33
│   │   │   ├── 8f0a5bf288cdc9c72cf1718d2f8ad1cdf25a57
│   │   │   ├── 9b5314a8a2ff3af492fcc235f42016ff6035f6
│   │   │   ├── b375b17ef9cdc2a31b46c8c15ec36b209bbaca
│   │   │   └── e06523feda206f9001f46cc14970dfe7bb9bc4
│   │   ├── d1
│   │   │   ├── 082c5e389ee468cd412b33a03d81d86401319b
│   │   │   ├── 319a820cb2e7fb21fc60dbe2b11fa19318c528
│   │   │   ├── 574741088f5bbf60087956c9a45458c48df966
│   │   │   ├── bf79b5b5b3b96efe4ca20235d89d949b5a2db1
│   │   │   └── c987e5cd4aa09ea482db732a4d62591f58ec5b
│   │   ├── d2
│   │   │   ├── 20639d88e34d86347f70900b5b0281fe80c2cf
│   │   │   ├── 24263a40a8ebac73dfd6b44c656a0652a8193f
│   │   │   ├── 461b41a3257d540e8f2d9751ed664c49a1e8d5
│   │   │   └── e1002513c12aa68889465a3c76cc148fa6e1d7
│   │   ├── d3
│   │   │   ├── 04b956391e6ee8255017a2973146b6e0591202
│   │   │   ├── a17686c2628f5a1cf46fef95a48cd00fe3ed66
│   │   │   ├── ebd0a85b17f04b3c14c81a78e31593cfb976e9
│   │   │   └── f9dc04d8c5d6258a016ec0d9e6a3349385ba30
│   │   ├── d4
│   │   │   ├── 185a631d6561a74de83f1d6471482979747692
│   │   │   ├── 3225b3d1d62a7ec86b2175a73781d663618755
│   │   │   ├── c4af3805715167f660a7c11bac58825634b5b2
│   │   │   ├── ce8e56fbff630654a395d7b7983bcc963bfa8b
│   │   │   ├── cfdba5ede464dbf2796d484e0664c595d81537
│   │   │   ├── eb1c32f75c809ad2c12d55950f4dd4869ae825
│   │   │   └── f23458bb690a2b0a9f1c261227d22be92b861e
│   │   ├── d5
│   │   │   ├── 0081b62e4fac9753ed2d4432631703cfc06b79
│   │   │   ├── 561f5939a6d0ba07e1d78d633e61d28c65f7ce
│   │   │   ├── 5d4b0d5083cd80f48b9b38b313fdf0b94f2346
│   │   │   ├── 98fa265bbb10b06e9e85415a28e0281b920b0f
│   │   │   └── f085642e5685682aec1e74ace8c66e4794fdbe
│   │   ├── d6
│   │   │   ├── 0fe3c09cbb3feb73af75e2df667d5667ec7567
│   │   │   └── 798e8ceb5d421787d02f5693cdb7e583d6ca78
│   │   ├── d7
│   │   │   ├── 589702c080ab8e5f19e8e9f23816fa8badb722
│   │   │   ├── 7e63a1c84e40a09031e69e0efffc829d2e9600
│   │   │   ├── 9c068facd518e3ded00ce0c1e80c30039ed5ad
│   │   │   ├── a7e233674fa7a1d33557b1661158e1d2a64186
│   │   │   └── f7ed787d33b37926e0f3eefe1b49756db7fcbf
│   │   ├── d8
│   │   │   ├── 62d8f80dcf116c148f59aeeaad9e55236cd5be
│   │   │   ├── 6bb90551f4e605d0cd377c514cf740951c8422
│   │   │   ├── 7f553651c168afd6d1c81a60b573af5f5729ba
│   │   │   ├── d0be3730dc9be49a0568b506a6064d64d3fa3a
│   │   │   ├── e9bf90a4dfe785747ef9905d400f08f061bbe8
│   │   │   └── f7ddc7a7cf8faa797a9f0fd2b1e56f43089dce
│   │   ├── d9
│   │   │   ├── 2a30768993ed5daa7dafdf93f91f9cb0f1c581
│   │   │   ├── 351f4e6fd1a0f974151fe3c4169d86909d688b
│   │   │   ├── b3230ecef05fafe0f2bf27672bd3d5625fc81d
│   │   │   ├── c9b360490816fba04aad77d674b8e5454c971b
│   │   │   └── eecedba03e8cfdc49c57c52ee2468eef4aeb40
│   │   ├── da
│   │   │   ├── 249d63ea71614a20a96e85d05fdb920b2b6d7a
│   │   │   ├── 55a220b322e5d7d870277b42db6aa6f484ceaf
│   │   │   ├── 94a6a6bd9a995b9e723b272b60b0adcd9ce200
│   │   │   └── a4df17a92bd55571038d8d49de2da1c7adda7b
│   │   ├── db
│   │   │   ├── 3db2b73a57f7561c20647da3b25d79fed950fb
│   │   │   └── 4f79d03b16a5c6f7345591f07e008f04102c50
│   │   ├── dc
│   │   │   ├── 1b0e86c2a5918154f7b1207ff2ec526b859984
│   │   │   ├── 7b1ecf579e4f4951a169da64d4b65501c2ae9a
│   │   │   └── a20cbb1da92a4c463cb63545a62be589faa0e4
│   │   ├── dd
│   │   │   ├── 8626a5d810d77b3bd29b7c6f5051b9a934a06a
│   │   │   ├── d9e02aa63213dcc33f23fb37be1a82ad59d08c
│   │   │   └── da17d7b7d9569e84198b3382f920ae89838f09
│   │   ├── de
│   │   │   ├── 3eb5d0ef215158aa3fd9965e0d55fdee88c985
│   │   │   ├── 833b2449010062a2d5626d3655978b3605fa34
│   │   │   └── f9f13c60a07a0fcd269f9cb13e199ec06f99b9
│   │   ├── df
│   │   │   ├── 401e3226488334424dd298e4ad5252c8bd5b76
│   │   │   └── 6c5ef7a8137627017248132e57f1bb1292bde1
│   │   ├── e1
│   │   │   └── 6879c95980e66fd50737d88f4fef4f3524e84b
│   │   ├── e2
│   │   │   ├── 15bc4ccf138bbc38ad58ad57e92135484b3c0f
│   │   │   └── d57cc5997b5cd05260704369e2639221ad42b8
│   │   ├── e3
│   │   │   ├── 59f40453d2432a60a7ede804d60c0a4940b575
│   │   │   └── a0ad4eeee35b7d22051aea8d3b09212f3e917f
│   │   ├── e4
│   │   │   ├── bfb79930977c7c9c7d333dede9195d82a06ae4
│   │   │   └── de6701b3eaf3e6206271045aae706af6f0af83
│   │   ├── e5
│   │   │   ├── 3dc91011c30166fe5ec142279815353d883ae9
│   │   │   ├── 44750e7fa925893d524e318fc8aa0075f8fa9f
│   │   │   ├── 75cc8f5d61613962dde66b8720caa484915ce8
│   │   │   ├── aa2a9ec323b00a065b22b9f0ab8d0f61b1a5db
│   │   │   └── ed42749de21f0c22f9a7f0360671f5171e7c20
│   │   ├── e6
│   │   │   ├── 4cf6e3cbd001069367388c82ae42c9d68a53d4
│   │   │   ├── 9de29bb2d1d6434b8b29ae775ad8c2e48c5391
│   │   │   └── e8fba1ee4c2fc3a8eff993f13965dae2b58955
│   │   ├── e7
│   │   │   ├── 2607f79dd420511d5c88c435bb8baeb827f5c0
│   │   │   └── 5515deb20f6ff1853f032fd85d4fde5edc5d84
│   │   ├── e9
│   │   │   ├── 34601ff53eb5ac488879fba9665f540daee1f4
│   │   │   ├── 6c4a1785a0b6a994b620c9601c9b38add83e8e
│   │   │   ├── a5271000d47bb187484a599af3b48c74ba8140
│   │   │   ├── ab86a4326eeaa67251dda7a2593fa279a035df
│   │   │   └── ffa3083ad279ecf95fd8eae59cb253e9a539c4
│   │   ├── eb
│   │   │   └── 19fb45c06805abbf61f79bcc21402212f16b57
│   │   ├── ec
│   │   │   ├── 0ae4d77a8368ba13843aee8f1bf0f6725fe0f9
│   │   │   └── 11b24b2559e03cae487aa2fc41a09e06d295a6
│   │   ├── ed
│   │   │   ├── 49d17583eda5134e2339bedfa7455ff01553d5
│   │   │   └── abd1131859b6172c3de33f678cd1b5ec64dbd0
│   │   ├── ef
│   │   │   ├── 0f27144d47fdc9e6736d8afd15e2bf4bda034c
│   │   │   ├── 14a463734886adbca33cd414c4ce169fb83fc1
│   │   │   ├── 16f0b70ba176b010f0db18c8fe472c1ecc5eb9
│   │   │   ├── 76aa53c64855a39e0fc7771276974e762a7937
│   │   │   └── a906a3c9129a272b7e6c1a7399caa8dbea2209
│   │   ├── f0
│   │   │   ├── 3ee597143c968d01da4a75d93e94224519d8d1
│   │   │   ├── 6c16c4683b441de360ec26358120b5326fc66c
│   │   │   └── 85e13dcf3e8032b5fdede99305a62d82c249d8
│   │   ├── f1
│   │   │   ├── 10a145f55fbefd2068f012fd6c106bd63aa65a
│   │   │   └── 35d299140954410f6f3f25c254d8bf4326deb0
│   │   ├── f2
│   │   │   ├── a487b6bf0cec284f8cec392e661a2d4002b597
│   │   │   └── a61d0c3e93a41435e192dac546bb94531c6680
│   │   ├── f3
│   │   │   └── bf5269c6d4f70f9ab7df745643cb9ac63d48dd
│   │   ├── f4
│   │   │   ├── 96ac783c789d895ac26ef99f85d3348f75f31b
│   │   │   ├── a16719c17bb88c98551770e84136d313c28f7e
│   │   │   ├── b82dd18861ecba6910474949825b9ff42b51ab
│   │   │   ├── df37bb5eb1fe7f7a215e10d2487f5637af2bb8
│   │   │   └── f09ba5e9061bbd9b5d05c9aed97d7bb09efc1c
│   │   ├── f6
│   │   │   ├── 5934a5165a8c768442be1381847abdf22052fa
│   │   │   └── 86fefc978702484e082d38b18bae245a1f1249
│   │   ├── f7
│   │   │   ├── c3b49366c844d323c49b9096dee100847bd2e2
│   │   │   └── fa87eb875260ed98651bc419c8139b5119e554
│   │   ├── f8
│   │   │   ├── 6636571f6946c495ba79193c455861637cd8df
│   │   │   ├── a22820db6e9db08bc546bb0e4726ccb754c527
│   │   │   ├── d53d0c7898a7d445c3218699c5d9237c710d7d
│   │   │   └── de00e530ec82458f0f64d340784c289d5f746f
│   │   ├── f9
│   │   │   ├── 54283ad2ea1e8a28d148155be2367063174334
│   │   │   └── 70366eb8ab2ea9a7c4657e1cecea24ee8d2c00
│   │   ├── fa
│   │   │   ├── 7f8231d1e19e62a27704dbe8f95860bc7c5e82
│   │   │   └── dd9c3b4c78a571ca1c5738c0b5c476fb642776
│   │   ├── fb
│   │   │   ├── 60711b4a84d47476343658d4b12de639fb9073
│   │   │   └── 7ab5fea133e3476f86e675686ac26648ec6409
│   │   ├── fc
│   │   │   ├── 3d2ee52244729eb953c442e06ff640ed405a65
│   │   │   ├── 5da66087e6ddd135559b563892998a6eba3512
│   │   │   ├── 8638fef2619867c737c07e55a3da7bd6e36aa0
│   │   │   ├── da7617f4555c1826cf6e0c3ac1607dd9d9f077
│   │   │   ├── e81371e627d3ba1254b6e18a77d3850cfa94f7
│   │   │   └── ed9f8ee1699eab00ea2ee3b0d26ae7e8bbd50f
│   │   ├── fd
│   │   │   ├── 257a1fdb811e6e2b859b94e7e5535ff471c083
│   │   │   └── cbd1aff894f31ebfe9e29331719b5ead3c60bd
│   │   ├── fe
│   │   │   ├── 10dcc1a669633b061c26d1677d25758d97e8bc
│   │   │   └── c93eccc9bfd9142908bf93fdd0d729f7da0c61
│   │   ├── ff
│   │   │   ├── 13f68b886af1c25d8a6bc793cf7e8ef1ac1591
│   │   │   ├── 36667911ebb61df19fa6901761173c7c18822a
│   │   │   ├── 63b42ca13527d59e77ca3ed0a4a8e3cc151ed4
│   │   │   ├── 8321b92852b05ccdd037e2ed670feafa8848f5
│   │   │   ├── 90bf7d4d9b7fd23ad571c79ae8711c4aec75a8
│   │   │   ├── b0ceb24de959555afe74dd0fb439f96a20868f
│   │   │   ├── c00155ca2f9772279c9bebbd6f27dd34c714ae
│   │   │   ├── c9ed7d54ed174ea20ef50f149f1b3487041e3b
│   │   │   ├── efe900c5243fcf63eb76e2b84a5aa3990dbc06
│   │   │   └── f056841153b1a6b95af1bb40d2878f0519f4dc
│   │   ├── info
│   │   └── pack
│   ├── ORIG_HEAD
│   └── refs
│       ├── heads
│       │   ├── develop
│       │   ├── feature
│       │   │   ├── crear-admin
│       │   │   ├── disseny
│       │   │   ├── guia-landing-dashbaord-temas
│       │   │   └── intro
│       │   ├── main
│       │   └── release
│       ├── remotes
│       │   └── origin
│       │       ├── develop
│       │       ├── feature
│       │       │   ├── crear-admin
│       │       │   ├── disseny
│       │       │   ├── guia-landing-dashbaord-temas
│       │       │   └── intro
│       │       ├── HEAD
│       │       ├── main
│       │       └── release
│       └── tags
├── .github
│   └── workflows
├── .gitignore
├── .vscode
│   └── settings.json
├── AGENTS.md
├── codi_i_estructura_edutech.txt
├── content
│   └── legal
├── docs
│   └── TECH_SPECS.md
├── eslint.config.mjs
├── esquema.sql
├── init-structure.js
├── merge.js
├── messages
│   ├── ca.ts
│   ├── en.ts
│   └── es.ts
├── next-env.d.ts
├── next.config.ts
├── package.json
├── pnpm-workspace.yaml
├── postcss.config.mjs
├── PRD.md
├── README.md
├── src
│   ├── app
│   │   ├── globals.css
│   │   ├── layout.tsx
│   │   └── [locale]
│   │       ├── (admin)
│   │       │   └── sys-ops
│   │       │       ├── challenges
│   │       │       │   ├── create
│   │       │       │   │   └── page.tsx
│   │       │       │   ├── page.tsx
│   │       │       │   └── [id]
│   │       │       │       └── edit
│   │       │       │           └── page.tsx
│   │       │       ├── topics
│   │       │       └── users
│   │       ├── (auth)
│   │       │   ├── layout.tsx
│   │       │   ├── login
│   │       │   │   ├── LoginForm.tsx
│   │       │   │   └── page.tsx
│   │       │   └── register
│   │       │       ├── page.tsx
│   │       │       └── RegisterForm.tsx
│   │       ├── (dashboard)
│   │       │   └── dashboard
│   │       │       └── page.tsx
│   │       ├── (game)
│   │       │   ├── arena
│   │       │   └── learn
│   │       │       └── [slug]
│   │       │           ├── page.tsx
│   │       │           └── play
│   │       │               └── page.tsx
│   │       ├── api
│   │       │   └── webhooks
│   │       ├── layout.tsx
│   │       └── page.tsx
│   ├── application
│   │   ├── dto
│   │   │   ├── challenge.schema.ts
│   │   │   ├── dashboard-topic.dto.ts
│   │   │   ├── level-node.dto.ts
│   │   │   └── session-result.dto.ts
│   │   └── use-cases
│   │       ├── auth
│   │       │   ├── logout.use-case.test.ts
│   │       │   ├── logout.use-case.ts
│   │       │   └── README.md
│   │       ├── challenges
│   │       │   ├── create-challenge.use-case.test.ts
│   │       │   ├── create-challenge.use-case.ts
│   │       │   ├── delete-challenge.use-case.test.ts
│   │       │   ├── delete-challenge.use-case.ts
│   │       │   ├── get-next-challenge.use-case.test.ts
│   │       │   ├── get-next-challenge.use-case.ts
│   │       │   ├── README.md
│   │       │   ├── update-challenge.use-case.test.ts
│   │       │   └── update-challenge.use-case.ts
│   │       ├── dashboard
│   │       │   └── get-user-dashboard.use-case.ts
│   │       ├── gamification
│   │       │   ├── complete-session.use-case.test.ts
│   │       │   ├── complete-session.use-case.ts
│   │       │   └── README.md
│   │       └── topics
│   │           ├── get-active-topics.use-case.ts
│   │           ├── get-all-topics.use-case.ts
│   │           ├── get-topic-path.use-case.ts
│   │           ├── README.md
│   │           └── __tests__
│   │               ├── get-active-topics.use-case.test.ts
│   │               └── get-topic-path.use-case.test.ts
│   ├── core
│   │   ├── entities
│   │   │   ├── challenges
│   │   │   │   ├── challenge.entitiy.test.ts
│   │   │   │   ├── challenge.entity.ts
│   │   │   │   ├── definitions
│   │   │   │   │   ├── binary.content.ts
│   │   │   │   │   ├── code-fix.content.ts
│   │   │   │   │   ├── ctf.content.ts
│   │   │   │   │   ├── logic-order.content.ts
│   │   │   │   │   ├── matching.content.ts
│   │   │   │   │   ├── quiz.content.ts
│   │   │   │   │   ├── shared.ts
│   │   │   │   │   ├── terminal.content.ts
│   │   │   │   │   └── theory.content.ts
│   │   │   │   └── index.ts
│   │   │   └── topic.entity.ts
│   │   ├── errors
│   │   │   ├── auth.error.ts
│   │   │   ├── domain-error.ts
│   │   │   ├── topic.errors.ts
│   │   │   └── user-not-found.error.ts
│   │   ├── README.md
│   │   ├── repositories
│   │   │   ├── challenge.repository.ts
│   │   │   ├── topic.repository.ts
│   │   │   └── user.repository.ts
│   │   ├── services
│   │   │   ├── auth.service.ts
│   │   │   └── level-calculator.service.ts
│   │   ├── types
│   │   └── utils
│   │       └── i18n-utils.ts
│   ├── i18n.ts
│   ├── infrastructure
│   │   ├── adapters
│   │   ├── config
│   │   ├── database
│   │   ├── mappers
│   │   │   ├── challenge.mappers.ts
│   │   │   ├── level-node.mapper.ts
│   │   │   ├── mapper.utils.ts
│   │   │   ├── README.md
│   │   │   └── __tests__
│   │   │       ├── level-node.mapper.test.ts
│   │   │       └── TerminalMapper.test.ts
│   │   ├── repositories
│   │   │   └── supabase
│   │   │       ├── challenge.repository.test.ts
│   │   │       ├── challenge.repository.ts
│   │   │       ├── topic.repository.ts
│   │   │       └── user.repository.ts
│   │   ├── service
│   │   │   └── supabase-auth.service.ts
│   │   └── utils
│   │       └── supabase
│   │           ├── middleware.ts
│   │           └── server.ts
│   ├── navigation.ts
│   ├── presentation
│   │   ├── actions
│   │   │   ├── admin
│   │   │   │   ├── challenge.actions.test.ts
│   │   │   │   └── challenge.actions.ts
│   │   │   ├── auth
│   │   │   │   ├── auth.action.ts
│   │   │   │   └── logout.actions.ts
│   │   │   ├── challenges
│   │   │   │   └── get-next-challenge.action.ts
│   │   │   ├── gamification
│   │   │   │   └── submit-session.action.ts
│   │   │   └── topics
│   │   │       └── get-topics.action.ts
│   │   ├── components
│   │   │   ├── admin
│   │   │   │   └── challenges
│   │   │   │       ├── challenge-editor.tsx
│   │   │   │       ├── create-challenge-from.test.tsx
│   │   │   │       ├── create-challenge-from.tsx
│   │   │   │       ├── form
│   │   │   │       │   ├── binary-editor.tsx
│   │   │   │       │   ├── challenge-from.router.tsx
│   │   │   │       │   ├── code-fix-editor.tsx
│   │   │   │       │   ├── ctf-editor.tsx
│   │   │   │       │   ├── form-config.ts
│   │   │   │       │   ├── json-editor.tsx
│   │   │   │       │   ├── logic-order-editor.tsx
│   │   │   │       │   ├── matching-editor.tsx
│   │   │   │       │   ├── quiz-editor.tsx
│   │   │   │       │   ├── terminal-editor.tsx
│   │   │   │       │   └── theory-editor.tsx
│   │   │   │       ├── list
│   │   │   │       │   ├── challenge-filters.tsx
│   │   │   │       │   └── challenge-table.tsx
│   │   │   │       ├── navigation
│   │   │   │       │   └── challenge-navigation.tsx
│   │   │   │       └── preview
│   │   │   │           ├── cards
│   │   │   │           │   ├── binary-card.tsx
│   │   │   │           │   ├── code-fix-card.tsx
│   │   │   │           │   ├── ctf-card.tsx
│   │   │   │           │   ├── logic-order-card.tsx
│   │   │   │           │   ├── matching-card.tsx
│   │   │   │           │   ├── quiz-card.tsx
│   │   │   │           │   ├── terminal-card.tsx
│   │   │   │           │   └── theory-card.tsx
│   │   │   │           └── live-preview.tsx
│   │   │   ├── auth
│   │   │   │   └── LogoutButton.tsx
│   │   │   ├── features
│   │   │   │   ├── auth
│   │   │   │   ├── dashboard
│   │   │   │   │   └── TopicCard.tsx
│   │   │   │   ├── game-engine
│   │   │   │   │   ├── binary
│   │   │   │   │   │   └── BinaryView.tsx
│   │   │   │   │   ├── ChallengeRenderer.tsx
│   │   │   │   │   ├── challenges
│   │   │   │   │   ├── code-fix
│   │   │   │   │   │   ├── CodeWindow.tsx
│   │   │   │   │   │   ├── HintPanel.tsx
│   │   │   │   │   │   ├── SmartTerminal.tsx
│   │   │   │   │   │   └── SolutionDeck.tsx
│   │   │   │   │   ├── CodeFixView.tsx
│   │   │   │   │   ├── CtfView.tsx
│   │   │   │   │   ├── GameArena.tsx
│   │   │   │   │   ├── GameError.tsx
│   │   │   │   │   ├── GameResult.tsx
│   │   │   │   │   ├── layout
│   │   │   │   │   │   ├── GameHeader.tsx
│   │   │   │   │   │   └── GameSessionLayout.tsx
│   │   │   │   │   ├── LogicOrderView.tsx
│   │   │   │   │   ├── MatchingView.tsx
│   │   │   │   │   ├── QuizView.tsx
│   │   │   │   │   ├── README.md
│   │   │   │   │   ├── TerminalView.tsx
│   │   │   │   │   └── TheoryView.tsx
│   │   │   │   ├── leaderboard
│   │   │   │   ├── learning-path
│   │   │   │   │   ├── BossMarker.tsx
│   │   │   │   │   ├── HorizontalPath.tsx
│   │   │   │   │   ├── LearningPathOrchestrator.tsx
│   │   │   │   │   ├── LevelNode.tsx
│   │   │   │   │   └── VerticalPath.tsx
│   │   │   │   └── topics
│   │   │   │       └── TopicCard.tsx
│   │   │   ├── feedback
│   │   │   ├── layout
│   │   │   │   ├── DesktopNavbar.tsx
│   │   │   │   └── MobileBottomBar.tsx
│   │   │   └── ui
│   │   │       ├── admin-pagination.tsx
│   │   │       └── gamified
│   │   │           ├── Button3D.tsx
│   │   │           └── LanguagerSwitcher.tsx
│   │   ├── context
│   │   │   └── GameSessionContext.tsx
│   │   ├── hooks
│   │   │   └── game
│   │   │       └── useGameSession.ts
│   │   └── utils
│   │       ├── auth-guards.test.ts
│   │       ├── auth-guards.ts
│   │       └── icon-mapper.tsx
│   ├── proxy.ts
│   ├── routing.ts
│   └── test
│       └── setup.ts
├── supabase
│   ├── .branches
│   │   └── _current_branch
│   ├── .temp
│   │   ├── cli-latest
│   │   ├── gotrue-version
│   │   ├── pooler-url
│   │   ├── postgres-version
│   │   ├── project-ref
│   │   ├── rest-version
│   │   └── storage-version
│   └── snippets
│       └── Untitled query 908.sql
├── tests
│   └── e2e
├── tsconfig.json
└── vitest.config.ts


CONTINGUT DELS FITXERS


// =================== FILE: .vscode/settings.json ===================

{
  "files.associations": {
    "*.css": "tailwindcss"
  },
  "i18n-ally.localesPaths": [
    "messages"
],
  "i18n-ally.keystyle": "nested",
  "i18n-ally.sortKeys": true,
  "i18n-ally.namespace": true,
  "i18n-ally.pathMatcher": "{locale}.ts",
  "i18n-ally.enabledParsers": ["ts", "js", "json"]
}


// =================== FILE: esquema.sql ===================


\restrict wnl4Es8opMfvLlmWkvGjAJcxLfQphjYkRptR7BpteVMmwQ9TEzKWO9h9jgAgah8


SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;


CREATE SCHEMA IF NOT EXISTS "public";


ALTER SCHEMA "public" OWNER TO "pg_database_owner";


COMMENT ON SCHEMA "public" IS 'standard public schema';



CREATE TYPE "public"."challenge_type" AS ENUM (
    'QUIZ',
    'CODE_FIX',
    'TERMINAL',
    'DRAG_DROP',
    'MATCHING',
    'LOGIC_ORDER',
    'BINARY_DECISION',
    'THEORY',
    'CTF'
);


ALTER TYPE "public"."challenge_type" OWNER TO "postgres";


CREATE OR REPLACE FUNCTION "public"."handle_new_user"() RETURNS "trigger"
    LANGUAGE "plpgsql" SECURITY DEFINER
    SET "search_path" TO 'public'
    AS $$
begin
  insert into public.profiles (id, username, total_xp, current_level)
  values (
    new.id, 
    coalesce(new.raw_user_meta_data->>'full_name', new.email), -- Agafem el nom o l'email
    0, -- XP Inicial
    1  -- Nivell Inicial
  );
  return new;
end;
$$;


ALTER FUNCTION "public"."handle_new_user"() OWNER TO "postgres";


CREATE OR REPLACE FUNCTION "public"."update_topic_stats"() RETURNS "trigger"
    LANGUAGE "plpgsql" SECURITY DEFINER
    AS $$
BEGIN
  -- Intentem inserir o actualitzar (UPSERT)
  INSERT INTO public.user_topic_stats (user_id, topic_id, total_xp, completed_count, last_activity_at)
  VALUES (NEW.user_id, NEW.topic_id, NEW.xp_earned, 1, NOW())
  ON CONFLICT (user_id, topic_id) 
  DO UPDATE SET 
    total_xp = user_topic_stats.total_xp + NEW.xp_earned,
    completed_count = user_topic_stats.completed_count + 1,
    last_activity_at = NOW();
    
  RETURN NEW;
END;
$$;


ALTER FUNCTION "public"."update_topic_stats"() OWNER TO "postgres";

SET default_tablespace = '';

SET default_table_access_method = "heap";


CREATE TABLE IF NOT EXISTS "public"."challenges" (
    "id" "uuid" DEFAULT "extensions"."uuid_generate_v4"() NOT NULL,
    "topic_id" "uuid" NOT NULL,
    "difficulty_tier" integer NOT NULL,
    "type" "public"."challenge_type" NOT NULL,
    "content" "jsonb" DEFAULT '{}'::"jsonb" NOT NULL,
    "created_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "map_config" "jsonb",
    CONSTRAINT "challenges_difficulty_tier_check" CHECK ((("difficulty_tier" > 0) AND ("difficulty_tier" <= 100)))
);


ALTER TABLE "public"."challenges" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."profiles" (
    "id" "uuid" NOT NULL,
    "username" "text",
    "total_xp" integer DEFAULT 0 NOT NULL,
    "current_level" integer DEFAULT 1 NOT NULL,
    "streak_days" integer DEFAULT 0 NOT NULL,
    "updated_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "level" integer DEFAULT 1
);


ALTER TABLE "public"."profiles" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."topics" (
    "id" "uuid" DEFAULT "extensions"."uuid_generate_v4"() NOT NULL,
    "slug" "text" NOT NULL,
    "name_key" "text" NOT NULL,
    "icon_name" "text" NOT NULL,
    "color_theme" "text" NOT NULL,
    "parent_topic_id" "uuid",
    "is_active" boolean DEFAULT false,
    "created_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "updated_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "title" "jsonb" DEFAULT '{}'::"jsonb",
    "description" "jsonb" DEFAULT '{}'::"jsonb"
);


ALTER TABLE "public"."topics" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."user_progress" (
    "id" "uuid" DEFAULT "extensions"."uuid_generate_v4"() NOT NULL,
    "user_id" "uuid" NOT NULL,
    "challenge_id" "uuid" NOT NULL,
    "topic_id" "uuid" NOT NULL,
    "completed_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "xp_earned" integer NOT NULL
);


ALTER TABLE "public"."user_progress" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."user_topic_stats" (
    "user_id" "uuid" NOT NULL,
    "topic_id" "uuid" NOT NULL,
    "total_xp" integer DEFAULT 0 NOT NULL,
    "completed_count" integer DEFAULT 0 NOT NULL,
    "last_activity_at" timestamp with time zone DEFAULT "now"()
);


ALTER TABLE "public"."user_topic_stats" OWNER TO "postgres";


ALTER TABLE ONLY "public"."challenges"
    ADD CONSTRAINT "challenges_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."profiles"
    ADD CONSTRAINT "profiles_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."topics"
    ADD CONSTRAINT "topics_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."topics"
    ADD CONSTRAINT "topics_slug_key" UNIQUE ("slug");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_user_id_challenge_id_key" UNIQUE ("user_id", "challenge_id");



ALTER TABLE ONLY "public"."user_topic_stats"
    ADD CONSTRAINT "user_topic_stats_pkey" PRIMARY KEY ("user_id", "topic_id");



CREATE INDEX "idx_challenges_content" ON "public"."challenges" USING "gin" ("content");



CREATE INDEX "idx_user_progress_topic_xp" ON "public"."user_progress" USING "btree" ("topic_id", "xp_earned" DESC);



CREATE INDEX "idx_user_progress_user_topic" ON "public"."user_progress" USING "btree" ("user_id", "topic_id");



CREATE OR REPLACE TRIGGER "on_challenge_complete" AFTER INSERT ON "public"."user_progress" FOR EACH ROW EXECUTE FUNCTION "public"."update_topic_stats"();



ALTER TABLE ONLY "public"."challenges"
    ADD CONSTRAINT "challenges_topic_id_fkey" FOREIGN KEY ("topic_id") REFERENCES "public"."topics"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."profiles"
    ADD CONSTRAINT "profiles_id_fkey" FOREIGN KEY ("id") REFERENCES "auth"."users"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."topics"
    ADD CONSTRAINT "topics_parent_topic_id_fkey" FOREIGN KEY ("parent_topic_id") REFERENCES "public"."topics"("id");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_challenge_id_fkey" FOREIGN KEY ("challenge_id") REFERENCES "public"."challenges"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_topic_id_fkey" FOREIGN KEY ("topic_id") REFERENCES "public"."topics"("id");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "public"."profiles"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."user_topic_stats"
    ADD CONSTRAINT "user_topic_stats_topic_id_fkey" FOREIGN KEY ("topic_id") REFERENCES "public"."topics"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."user_topic_stats"
    ADD CONSTRAINT "user_topic_stats_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "auth"."users"("id") ON DELETE CASCADE;



CREATE POLICY "Challenges are viewable by everyone" ON "public"."challenges" FOR SELECT USING (true);



CREATE POLICY "Dev allow all profiles" ON "public"."profiles" USING (true);



CREATE POLICY "Dev allow all progress" ON "public"."user_progress" USING (true);



CREATE POLICY "Public topics are viewable by everyone" ON "public"."topics" FOR SELECT USING (("is_active" = true));



CREATE POLICY "Users can insert own progress" ON "public"."user_progress" FOR INSERT WITH CHECK (("auth"."uid"() = "user_id"));



CREATE POLICY "Users can view own progress" ON "public"."user_progress" FOR SELECT USING (("auth"."uid"() = "user_id"));



CREATE POLICY "Users can view own stats" ON "public"."user_topic_stats" FOR SELECT USING (("auth"."uid"() = "user_id"));



ALTER TABLE "public"."challenges" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."profiles" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."topics" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."user_progress" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."user_topic_stats" ENABLE ROW LEVEL SECURITY;


GRANT USAGE ON SCHEMA "public" TO "postgres";
GRANT USAGE ON SCHEMA "public" TO "anon";
GRANT USAGE ON SCHEMA "public" TO "authenticated";
GRANT USAGE ON SCHEMA "public" TO "service_role";



GRANT ALL ON FUNCTION "public"."handle_new_user"() TO "anon";
GRANT ALL ON FUNCTION "public"."handle_new_user"() TO "authenticated";
GRANT ALL ON FUNCTION "public"."handle_new_user"() TO "service_role";



GRANT ALL ON FUNCTION "public"."update_topic_stats"() TO "anon";
GRANT ALL ON FUNCTION "public"."update_topic_stats"() TO "authenticated";
GRANT ALL ON FUNCTION "public"."update_topic_stats"() TO "service_role";



GRANT ALL ON TABLE "public"."challenges" TO "anon";
GRANT ALL ON TABLE "public"."challenges" TO "authenticated";
GRANT ALL ON TABLE "public"."challenges" TO "service_role";



GRANT ALL ON TABLE "public"."profiles" TO "anon";
GRANT ALL ON TABLE "public"."profiles" TO "authenticated";
GRANT ALL ON TABLE "public"."profiles" TO "service_role";



GRANT ALL ON TABLE "public"."topics" TO "anon";
GRANT ALL ON TABLE "public"."topics" TO "authenticated";
GRANT ALL ON TABLE "public"."topics" TO "service_role";



GRANT ALL ON TABLE "public"."user_progress" TO "anon";
GRANT ALL ON TABLE "public"."user_progress" TO "authenticated";
GRANT ALL ON TABLE "public"."user_progress" TO "service_role";



GRANT ALL ON TABLE "public"."user_topic_stats" TO "anon";
GRANT ALL ON TABLE "public"."user_topic_stats" TO "authenticated";
GRANT ALL ON TABLE "public"."user_topic_stats" TO "service_role";



ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "postgres";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "anon";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "authenticated";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "service_role";






ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "postgres";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "anon";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "authenticated";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "service_role";






ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "postgres";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "anon";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "authenticated";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "service_role";






\unrestrict wnl4Es8opMfvLlmWkvGjAJcxLfQphjYkRptR7BpteVMmwQ9TEzKWO9h9jgAgah8

RESET ALL;


// =================== FILE: init-structure.js ===================

import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

// En la sintaxi moderna (ESM), __dirname no existeix per defecte,
// així que el creem nosaltres manualment:
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// DEFINICIÓ DE L'ARQUITECTURA (TECHMASTERY)
// ==========================================

const structure = [
  // --- ARREL I CONFIGURACIÓ ---
  '.github/workflows',
  '.vscode',
  'content/legal',
  'messages',
  'public/images/badges',
  'public/images/topics',
  'tests/e2e',

  // --- CAPA DE DOMINI (CORE) ---
  'src/core/entities',
  'src/core/repositories',
  'src/core/errors',
  'src/core/types',
  'src/core/services',

  // --- CAPA D'APLICACIÓ (USE CASES) ---
  'src/application/use-cases/auth',
  'src/application/use-cases/challenges',
  'src/application/use-cases/topics',
  'src/application/use-cases/gamification',
  'src/application/dto',

  // --- CAPA D'INFRAESTRUCTURA (ADAPTERS) ---
  'src/infrastructure/repositories/supabase',
  'src/infrastructure/adapters',
  'src/infrastructure/config',
  'src/infrastructure/database',

  // --- CAPA DE PRESENTACIÓ (UI & ACTIONS) ---
  'src/presentation/actions',
  'src/presentation/hooks',
  'src/presentation/utils',
  
  // Components UI
  'src/presentation/components/ui',
  'src/presentation/components/layout',
  'src/presentation/components/feedback',
  
  // Components de Features
  'src/presentation/components/features/auth',
  'src/presentation/components/features/topics',
  'src/presentation/components/features/leaderboard',
  'src/presentation/components/features/game-engine',
  'src/presentation/components/features/game-engine/challenges',
  
  // Components d'Administració
  'src/presentation/components/admin',

  // --- NEXT.JS APP ROUTER ---
  'src/app/[locale]/api/webhooks',
  'src/app/[locale]/(auth)',
  'src/app/[locale]/(dashboard)',
  'src/app/[locale]/(game)/learn',
  'src/app/[locale]/(game)/arena',
  'src/app/[locale]/(admin)/admin/topics',
  'src/app/[locale]/(admin)/admin/users',
];

const filesToCreate = [
  {
    path: 'messages/ca.json',
    content: `{
  "app": { "name": "TechMastery" },
  "game": { "start": "Comença", "check": "Comprovar" }
}`
  },
  {
    path: 'messages/en.json',
    content: `{
  "app": { "name": "TechMastery" },
  "game": { "start": "Start", "check": "Check" }
}`
  },
  {
    path: 'src/core/README.md',
    content: `# Core Layer (Domini)
Aquesta capa conté les regles de negoci pures del joc.
⚠️ NO importis res de React, Next.js o Supabase aquí.`
  },
  {
    path: 'src/application/README.md',
    content: `# Application Layer (Casos d'Ús)
Aquí resideix l'orquestració de l'aplicació.`
  },
  {
    path: 'src/presentation/components/features/game-engine/README.md',
    content: `# Game Engine Components
Components polimòrfics per a Quiz, Terminal, etc.`
  },
  {
    path: 'src/app/globals.css',
    content: `@tailwind base;\n@tailwind components;\n@tailwind utilities;`
  }
];

console.log('🚀 Iniciant creació d\'estructura Enterprise (ESM)...\n');

// 1. CREACIÓ DE CARPETES
structure.forEach(dir => {
  const fullPath = path.join(__dirname, dir);
  if (!fs.existsSync(fullPath)) {
    fs.mkdirSync(fullPath, { recursive: true });
    console.log(`✅ Carpeta creada: ${dir}`);
  }
});

// 2. CREACIÓ D'ARXIUS BASE
filesToCreate.forEach(file => {
  const fullPath = path.join(__dirname, file.path);
  if (!fs.existsSync(fullPath)) {
    const dirName = path.dirname(fullPath);
    if (!fs.existsSync(dirName)) {
      fs.mkdirSync(dirName, { recursive: true });
    }
    fs.writeFileSync(fullPath, file.content);
    console.log(`📄 Fitxer creat: ${file.path}`);
  }
});

console.log('\n🎉 ESTRUCTURA COMPLETADA!');

// =================== FILE: merge.js ===================

import { readdirSync, statSync, readFileSync, writeFileSync } from "fs";
import { join, extname } from "path";

// --- Configuració ---
const rootFolder = "./";
const outputFile = "codi_i_estructura_edutech.txt";
const extensionsToInclude = [".ts", ".tsx", ".js", ".jsx", ".css", ".json", ".sql"];

const ignoreList = [
  "public",
  "node_modules",
  ".next",
  "dist",
  "build",
  ".DS_Store",
  "package-lock.json",
  "pnpm-lock.yaml",
];

let treeOutput = `ESTRUCTURA DEL PROJECTE (./src)\n\n`;
let contentOutput = "\n\nCONTINGUT DELS FITXERS\n";

function processDirectory(dir, prefix = "") {
  // Llegim i filtrem els arxius i carpetes del directori actual
  const items = readdirSync(dir).filter(item => !ignoreList.includes(item));

  items.forEach((item, index) => {
    const fullPath = join(dir, item);
    const stat = statSync(fullPath);
    const isLast = index === items.length - 1;

    // Afegim la línia corresponent a l'arbre de directoris
    treeOutput += `${prefix}${isLast ? "└── " : "├── "}${item}\n`;

    if (stat.isDirectory()) {
      // Si és un directori, fem la crida recursiva amb el nou prefix
      const newPrefix = prefix + (isLast ? "    " : "│   ");
      processDirectory(fullPath, newPrefix);
    } else if (extensionsToInclude.includes(extname(item))) {
      // Si és un fitxer vàlid, llegim el seu contingut
      const normalizedPath = fullPath.replace(/\\/g, "/");
      contentOutput += `\n\n// =================== FILE: ${normalizedPath} ===================\n\n`;
      contentOutput += readFileSync(fullPath, "utf8");
    }
  });
}

try {
  console.log("🌳 Generant l'arbre de directoris i llegint fitxers...");
  processDirectory(rootFolder);

  // Unim l'arbre i el contingut en un sol fitxer
  const finalOutput = treeOutput + contentOutput;

  writeFileSync(outputFile, finalOutput);
  console.log(`✅ Fitxer creat amb èxit: ${outputFile}`);
} catch (error) {
  console.error("❌ Hi ha hagut un error en crear el fitxer:", error);
}

// =================== FILE: messages/ca.ts ===================

// filepath: messages/ca.ts
export default {
  app: {
    name: "TechMastery"
  },
  game: {
    start: "Comença",
    check: "Comprovar",
    next: "Següent",
    finish: "Acabar",
    loading: "Carregant...",
    arena: {
      loading: "Guardant el teu progrés...",
      progress: "Progrés",
      construction: "En construcció...",
      skip: "Saltar",
      unauthorized_title: "Inicia sessió",
      unauthorized_desc: "Necessites un compte per guardar el teu progrés i pujar de nivell.",
      error_title: "Ups! Alguna cosa ha fallat",
      login_btn: "Entrar",
      retry_btn: "Reintentar",
      lesson_complete: "Lliçó Completada!",
      xp_earned: "XP Guanyada",
      dashboard_btn: "Tornar al Dashboard",
      level_up: "NIVELL SUPERAT!",
      continue_btn: "Continuar",
      quit: "Sortir"
    },
    modes: {
      logic_order: {
        label: "Ordre Lògic",
        your_answer: "La teva resposta",
        placeholder: "Arrossega els elements aquí",
        empty_options: "Tot col·locat ✨",
        drag_hint: "Clica o arrossega"
      },
      terminal: {
        label: "Terminal",
        prompt_user: "usuari",
        placeholder: "Escriu la comanda...",
        session_closed: "--- Sessió finalitzada ---"
      }
    },
    actions: {
      check: "Comprovar",
      verify: "Verificar",
      continue: "Continuar",
      reset: "Reiniciar",
      retry: "Tornar a provar"
    },
    feedback: {
      correct: "Correcte!",
      incorrect: "Incorrecte",
      solution: "Solució",
      hint: "Pista"
    },
    level_node: {
      level: "NIVELL",
      locked: "Bloquejat",
      completed: "Completat"
    }

  },
  // AFEGEIX AIXÒ:
  dashboard: {
    welcome_title: "Hola de nou",
    subtitle: "Quina tecnologia vols dominar avui?",
    availableTopics: "Temes Disponibles"
  },
  topic: {
    react: { title: "Fonaments de React" },
    typescript: { title: "TypeScript Pro" },
    supabase: { title: "Supabase i SQL" },
    legacy: { title: "PHP Legacy" },
    security: { title: "Seguretat OWASP" },
    docker_basics: { title: "Contenidors Docker" },
    owasp: {
      title: "Ciberseguretat (OWASP Top 10)"
    }
  },

  // --- NOVA SECCIÓ AUTH ---
  auth: {
    login: {
      title: "Benvingut a eduTech 🚀",
      subtitle: "Inicia sessió per continuar aprenent.",
      submit_button: "Entrar",
      forgot_password: "Has oblidat la contrasenya?",
      no_account: "Encara no tens compte?",
      register_link: "Crea un compte gratuït"
    },
    register: {
      title: "Uneix-te a eduTech",
      subtitle: "Comença a aprendre avui mateix.",
      submit_button: "Crear Compte",
      have_account: "Ja tens compte?",
      login_link: "Inicia sessió"
    },
    fields: {
      email: "Correu electrònic",
      email_placeholder: "usuari@exemple.com",
      password: "Contrasenya",
      password_placeholder: "••••••••"
    },
    errors: {
      generic: "Hi ha hagut un error inesperat.",
      invalid_credentials: "El correu o la contrasenya són incorrectes.",
      user_already_exists: "Aquest correu ja està registrat.",
      weak_password: "La contrasenya ha de tenir mínim 6 caràcters."
    },
    success: {
      check_email: "Compte creat! Revisa el teu correu."
    },
    logout: "Tancar Sessió"
  },
  landing: {
    badge: "Aprèn programació jugant",
    title_prefix: "Converteix-te en",
    title_highlight: "Senior Developer",
    description: "Domina React, Docker i Ciberseguretat amb reptes interactius. Sense vídeos avorrits. Només pràctica real.",
    cta_primary: "COMENÇAR GRATIS",
    cta_secondary: "SABER-NE MÉS",
    login_button: "ENTRAR"
  },
  milestones: {
    junior: "Desenvolupador Junior",
    senior: "Enginyer Senior",
    architect: "Tech Lead Architect",
    legend: "Llegenda del Codi",
    junior_architect: "Arquitecte Junior", 
    grandmaster: "Gran Mestre del Sistema"
  },
  Admin: {
    Challenges: {
      title: "Crear Nou Repte",
      form: {
        topicLabel: "Tema",
        topicPlaceholder: "Selecciona un tema...",
        difficultyLabel: "Dificultat (1-5)",
        typeLabel: "Tipus de Repte",
        questionLabel: "Enunciat / Pregunta",
        submitButton: "Crear Repte",
        saving: "Guardant...",
        success: "Repte creat correctament!",
        error: "Error al crear el repte."
      }
    }
  }
} as const;

// =================== FILE: messages/en.ts ===================

// filepath: messages/en.ts
export default {
  app: {
    name: "TechMastery"
  },
  game: {
    start: "Start",
    check: "Check",
    next: "Next",
    finish: "Finish",
    loading: "Loading...",
    arena: {
      loading: "Saving your progress...",
      progress: "Progress",
      construction: "Under construction...",
      skip: "Skip",
      unauthorized_title: "Log in",
      unauthorized_desc: "You need an account to save your progress and level up.",
      error_title: "Oops! Something went wrong",
      login_btn: "Log in",
      retry_btn: "Retry",
      lesson_complete: "Lesson Completed!",
      xp_earned: "XP Earned",
      dashboard_btn: "Back to Dashboard",
      level_up: "LEVEL UP!",
      continue_btn: "Continue",
      quit: "Quit"
    },
    modes: {
      logic_order: {
        label: "Logical Order",
        your_answer: "Your answer",
        placeholder: "Drag items here",
        empty_options: "All set ✨",
        drag_hint: "Click or drag"
      },
      terminal: {
        label: "Terminal",
        prompt_user: "user",
        placeholder: "Type the command...",
        session_closed: "--- Session ended ---"
      }
    },
    actions: {
      check: "Check",
      verify: "Verify",
      continue: "Continue",
      reset: "Reset",
      retry: "Try again"
    },
    feedback: {
      correct: "Correct!",
      incorrect: "Incorrect",
      solution: "Solution",
      hint: "Hint"
    },
    level_node: {
      level: "LEVEL",
      locked: "Locked",
      completed: "Completed"
    }
  },

  dashboard: {
    welcome_title: "Welcome back",
    subtitle: "What technology do you want to master today?",
    availableTopics: "Available Topics"
  },
  topic: {
    react: { title: "React Basics" },
    typescript: { title: "TypeScript Pro" },
    supabase: { title: "Supabase & SQL" },
    legacy: { title: "Legacy PHP" }, // Encara que estigui desactivat
    security: { title: "OWASP Top 10" }, // Exemple extra
    docker_basics: { title: "Docker Containers" },

    owasp: {
      title: "Cybersecurity (OWASP Top 10)"
    }
  },
  auth: {
    login: {
      title: "Welcome to eduTech 🚀",
      subtitle: "Login to continue learning.",
      submit_button: "Login",
      forgot_password: "Forgot password?",
      no_account: "Don't have an account?",
      register_link: "Create free account"
    },
    register: {
      title: "Join eduTech",
      subtitle: "Start learning today.",
      submit_button: "Create Account",
      have_account: "Already have an account?",
      login_link: "Login"
    },
    fields: {
      email: "Email",
      email_placeholder: "user@example.com",
      password: "Password",
      password_placeholder: "••••••••"
    },
    errors: {
      generic: "An unexpected error occurred.",
      invalid_credentials: "Invalid email or password.",
      user_already_exists: "Email already registered.",
      weak_password: "Password must be at least 6 characters."
    },
    success: {
      check_email: "Account created! Check your email."
    },
    logout: "Logout"
  },
  landing: {
    badge: "Learn coding by playing",
    title_prefix: "Become a",
    title_highlight: "Senior Developer",
    description: "Master React, Docker, and Cybersecurity with interactive challenges. No boring videos. Just real practice.",
    cta_primary: "START FOR FREE",
    cta_secondary: "LEARN MORE",
    login_button: "LOGIN"
  },
  milestones: {
    junior: "Junior Developer",
    senior: "Senior Engineer",
    architect: "Tech Lead Architect",
    legend: "Code Legend",
    junior_architect: "Junior Architect",
    grandmaster: "System Grandmaster"
  }
  ,
  Admin: {
    Challenges: {
      title: "Create New Challenge",
      form: {
        topicLabel: "Topic",
        topicPlaceholder: "Select a topic...",
        difficultyLabel: "Difficulty (1-5)",
        typeLabel: "Challenge Type",
        questionLabel: "Prompt / Question",
        submitButton: "Create Challenge",
        saving: "Saving...",
        success: "Challenge created successfully!",
        error: "Error creating the challenge."
      }
    }
  }


} as const;

// =================== FILE: messages/es.ts ===================

// filepath: messages/es.ts
export default {
  app: {
    name: "TechMastery"
  },
  game: {
    start: "Comenzar",
    check: "Comprobar",
    next: "Siguiente",
    finish: "Finalizar",
    loading: "Cargando...",
    arena: {
      loading: "Guardando tu progreso...",
      progress: "Progreso",
      construction: "En construcción...",
      skip: "Saltar",
      unauthorized_title: "Inicia sesión",
      unauthorized_desc: "Necesitas una cuenta para guardar tu progreso y subir de nivel.",
      error_title: "¡Ups! Algo ha fallado",
      login_btn: "Entrar",
      retry_btn: "Reintentar",
      lesson_complete: "¡Lección completada!",
      xp_earned: "XP ganada",
      dashboard_btn: "Volver al Dashboard",
      level_up: "¡NIVEL SUPERADO!",
      continue_btn: "Continuar",
      quit: "Salir"
    },
    modes: {
      logic_order: {
        label: "Orden lógico",
        your_answer: "Tu respuesta",
        placeholder: "Arrastra los elementos aquí",
        empty_options: "Todo colocado ✨",
        drag_hint: "Haz clic o arrastra"
      },
      terminal: {
        label: "Terminal",
        prompt_user: "usuario",
        placeholder: "Escribe el comando...",
        session_closed: "--- Sesión finalizada ---"
      }
    },
    actions: {
      check: "Comprobar",
      verify: "Verificar",
      continue: "Continuar",
      reset: "Reiniciar",
      retry: "Volver a intentar"
    },
    feedback: {
      correct: "¡Correcto!",
      incorrect: "Incorrecto",
      solution: "Solución",
      hint: "Pista"
    },
    level_node: {
      level: "NIVEL",
      locked: "Bloqueado",
      completed: "Completado"
    }
  },

  dashboard: {
    welcome_title: "Hola de nuevo",
    subtitle: "¿Qué tecnología quieres dominar hoy?",
    availableTopics: "Temas Disponibles"
  },
  topic: {
    react: { title: "Fundamentos de React" },
    typescript: { title: "TypeScript Pro" },
    supabase: { title: "Supabase y SQL" },
    legacy: { title: "PHP Legacy" },
    security: { title: "Seguridad OWASP" },
    docker_basics: { title: "Contenedores Docker" },
    owasp: { title: "Ciberseguridad (OWASP Top 10)" }
  },
  auth: {
    login: {
      title: "Bienvenido a eduTech 🚀",
      subtitle: "Inicia sesión para seguir aprendiendo.",
      submit_button: "Iniciar sesión",
      forgot_password: "¿Olvidaste tu contraseña?",
      no_account: "¿No tienes una cuenta?",
      register_link: "Crear cuenta gratis"
    },
    register: {
      title: "Únete a eduTech",
      subtitle: "Empieza a aprender hoy.",
      submit_button: "Crear cuenta",
      have_account: "¿Ya tienes una cuenta?",
      login_link: "Iniciar sesión"
    },
    fields: {
      email: "Correo electrónico",
      email_placeholder: "usuario@ejemplo.com",
      password: "Contraseña",
      password_placeholder: "••••••••"
    },
    errors: {
      generic: "Ocurrió un error inesperado.",
      invalid_credentials: "Correo electrónico o contraseña incorrectos.",
      user_already_exists: "El correo electrónico ya está registrado.",
      weak_password: "La contraseña debe tener al menos 6 caracteres."
    },
    success: {
      check_email: "¡Cuenta creada! Revisa tu correo electrónico."
    },
    logout: "Cerrar sesión"
  },
  landing: {
    badge: "Aprende programación jugando",
    title_prefix: "Conviértete en",
    title_highlight: "Senior Developer",
    description: "Domina React, Docker y Ciberseguridad con retos interactivos. Sin vídeos aburridos. Solo práctica real.",
    cta_primary: "EMPEZAR GRATIS",
    cta_secondary: "SABER MÁS",
    login_button: "ENTRAR"
  },
  milestones: {
    junior: "Desarrollador Junior",
    senior: "Ingeniero Senior",
    architect: "Arquitecto Tech Lead",
    legend: "Leyenda del Código",
    junior_architect: "Arquitecto Junior",
    grandmaster: "Gran Maestro del Sistema"
  },

  Admin: {
    Challenges: {
      title: "Crear Nuevo Reto",
      form: {
        topicLabel: "Tema",
        topicPlaceholder: "Selecciona un tema...",
        difficultyLabel: "Dificultad (1-5)",
        typeLabel: "Tipo de Reto",
        questionLabel: "Enunciado / Pregunta",
        submitButton: "Crear Reto",
        saving: "Guardando...",
        success: "¡Reto creado correctamente!",
        error: "Error al crear el reto."
      }
    }
  }


} as const;


// =================== FILE: next-env.d.ts ===================

/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


// =================== FILE: next.config.ts ===================

import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n.ts'); // Apunta al fitxer que crearem ara

/** @type {import('next').NextConfig} */
const nextConfig = {};

export default withNextIntl(nextConfig);

// =================== FILE: package.json ===================

{
  "name": "edu-tech",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:ci": "vitest run"
  },
  "dependencies": {
    "@hookform/resolvers": "^5.2.2",
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.90.1",
    "clsx": "^2.1.1",
    "framer-motion": "^12.24.11",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "next-intl": "^4.7.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "react-hook-form": "^7.71.0",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.3.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@testing-library/dom": "^10.4.1",
    "@testing-library/react": "^16.3.1",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@vitejs/plugin-react": "^5.1.2",
    "dotenv": "^17.2.3",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "jsdom": "^27.4.0",
    "tailwindcss": "^4",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5",
    "vite-tsconfig-paths": "^6.0.3",
    "vitest": "^4.0.16"
  }
}

// =================== FILE: src/app/globals.css ===================

/* filepath: src/app/globals.css */
@import "tailwindcss";
@plugin "tailwindcss-animate";

@theme {
  --font-sans: var(--font-nunito), ui-sans-serif, system-ui;

  /* Colors Brand */
  --color-brand-primary: #3B82F6;
  --color-brand-primaryDark: #1D4ED8;
  --color-brand-success: #58CC02;
  --color-brand-successDark: #46A302;
  --color-brand-danger: #FF4B4B;
  --color-brand-dangerDark: #D62F2F;
  --color-brand-warning: #FFC800;
  --color-brand-warningDark: #D9AA00;
  --color-brand-surface: #1E293B;
  --color-brand-surfaceDark: #0F172A;

  --animate-bounce-sm: bounce-sm 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  @keyframes bounce-sm {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(0.95); }
  }



  /* Girar molt lent (per anells d'energia) */
  --animate-spin-slow: spin 10s linear infinite;
  @keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
  }

  /* Girar lent al revés */
  --animate-spin-reverse: spin-reverse 25s linear infinite;
  @keyframes spin-reverse {
    from { transform: rotate(360deg); }
    to { transform: rotate(0deg); }
  }

  /* Pols de llum (Glow) */
  --animate-pulse-glow: pulse-glow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  @keyframes pulse-glow {
    0%, 100% { opacity: 1; filter: brightness(1.2); }
    50% { opacity: .7; filter: brightness(1); }
  }

}

@layer components {
  /* TRUC: En lloc de fer @apply btn-game a tot arreu, 
     apliquem els estils base a TOTS els botons de cop.
  */
  .btn-game, 
  .btn-primary, 
  .btn-success, 
  .btn-danger, 
  .btn-outline {
    @apply relative w-full py-4 px-6 rounded-2xl font-black text-lg uppercase tracking-wider transition-all active:translate-y-1 active:border-b-0 cursor-pointer flex items-center justify-center gap-2;
  }

  /* Ara només definim els colors específics per cada variant */
  .btn-primary {
    @apply bg-brand-primary text-white border-b-4 border-brand-primaryDark hover:bg-blue-400;
  }
  
  .btn-success {
    @apply bg-brand-success text-white border-b-4 border-brand-successDark hover:bg-green-400;
  }

  .btn-danger {
    @apply bg-brand-danger text-white border-b-4 border-brand-dangerDark hover:bg-red-400;
  }

  .btn-outline {
    @apply bg-slate-800 text-slate-300 border-2 border-b-4 border-slate-700 hover:bg-slate-700;
  }

  /* Inputs */
  .input-game {
    @apply w-full p-4 bg-slate-800 border-2 border-slate-700 rounded-xl text-white font-bold placeholder-slate-500 focus:outline-none focus:border-brand-primary focus:bg-slate-900 transition-all;
  }

  
}

// =================== FILE: src/app/layout.tsx ===================

// filepath: src/app/layout.tsx
import { ReactNode } from 'react';

// Aquest layout és necessari per Next.js però no ha de fer RES visualment
// perquè tota la teva app viu dins de /[locale]/
export default function RootLayout({ children }: { children: ReactNode }) {
  return children;
}

// =================== FILE: src/app/[locale]/(admin)/sys-ops/challenges/create/page.tsx ===================

// filepath: src/app/[locale]/(admin)/sys-ops/challenges/create/page.tsx
import { getTranslations, getLocale } from 'next-intl/server'; // ✅ 1. AFEGIR getLocale
import { assertAdmin } from '@/presentation/utils/auth-guards';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { GetAllTopicsUseCase } from '@/application/use-cases/topics/get-all-topics.use-case';
import { ChallengeEditor } from '@/presentation/components/admin/challenges/challenge-editor';
import { getLocalizedText } from '@/core/utils/i18n-utils'; // ✅ 2. IMPORTAR UTILITAT

export default async function CreateChallengePage() {
  // 1. Seguretat
  await assertAdmin();

  // 2. Traduccions i Idioma
  const t = await getTranslations('Admin.Challenges');
  const locale = await getLocale(); // ✅ Obtenim l'idioma actual
  // ❌ ELIMINAT: const tTopics = await getTranslations('Topics'); 

  // 3. Composition Root
  const topicRepo = new SupabaseTopicRepository();
  const getAllTopics = new GetAllTopicsUseCase(topicRepo);

  // 4. Fetching
  const topics = await getAllTopics.execute();

  // 5. ViewModel (Molt més net, sense hacks de TypeScript)
  const topicOptions = topics.map(topic => {
    return {
      id: topic.id,
      // ✅ 3. FIX: Traducció dinàmica directa
      name: getLocalizedText(topic.title, locale) 
    };
  });

  return (
    <div className="container mx-auto py-10 px-4 max-w-5xl">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">{t('createTitle')}</h1>
        <p className="text-gray-500 mt-2">
          {t.has('subtitle') ? t('subtitle') : "Gestor de contingut avançat per a reptes tecnològics."}
        </p>
      </div>

      <div className="bg-white p-0 rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <ChallengeEditor topics={topicOptions} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(admin)/sys-ops/challenges/page.tsx ===================

// filepath: src/app/[locale]/(admin)/sys-ops/challenges/page.tsx
import Link from 'next/link';

import { assertAdmin } from '@/presentation/utils/auth-guards';
import { SupabaseChallengeRepository } from '@/infrastructure/repositories/supabase/challenge.repository';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';

// Components UI Modulars
import { ChallengeFilters } from '@/presentation/components/admin/challenges/list/challenge-filters';
import { ChallengeTable } from '@/presentation/components/admin/challenges/list/challenge-table'; 
import { AdminPagination } from '@/presentation/components/ui/admin-pagination';

interface PageProps {
  searchParams: Promise<{ [key: string]: string | string[] | undefined }>;
}
export default async function AdminChallengesList({ searchParams }: PageProps) {
  await assertAdmin();

  const params = await searchParams;
  const page = Number(params.page) || 1;
  const topicFilter = params.topic as string || 'ALL';
  const typeFilter = params.type as string || 'ALL'; // <--- NOU

  const challengeRepo = new SupabaseChallengeRepository();
  const topicRepo = new SupabaseTopicRepository();

  const [paginatedResult, topics] = await Promise.all([
    // Passem el nou filtre al repo
    challengeRepo.findAllPaginated(page, 10, topicFilter, typeFilter),
    topicRepo.findAll()
  ]);

  const { data: challenges, totalPages, total } = paginatedResult;
  const topicOptions = topics.map(t => ({ id: t.id, name: t.slug }));

  return (
    <div className="min-h-screen bg-gray-50 dark:bg-slate-950 py-8 px-4 sm:px-6 transition-colors">
      <div className="max-w-7xl mx-auto space-y-4">
        
        {/* HEADER UNIFICAT (Títol + Filtres + Accions) */}
        <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 bg-white dark:bg-slate-900 p-4 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm">
          
          {/* Esquerra: Títol i Comptador */}
          <div>
            <h1 className="text-xl font-bold text-gray-900 dark:text-white tracking-tight flex items-center gap-2">
              Gestió de Reptes
              <span className="px-2 py-0.5 rounded-full bg-gray-100 dark:bg-slate-800 text-gray-600 dark:text-slate-400 text-xs font-mono border border-gray-200 dark:border-slate-700">
                {total}
              </span>
            </h1>
          </div>

          {/* Dreta: Toolbar (Filtres i Botó) */}
          <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
             {/* ELS FILTRES ARA VIUEN AQUÍ */}
             <ChallengeFilters topics={topicOptions} />
             
             <div className="w-px h-8 bg-gray-200 dark:bg-slate-800 hidden sm:block"></div>

             <Link 
              href="/sys-ops/challenges/create" 
              className="bg-black dark:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:opacity-90 transition-all shadow-sm flex items-center justify-center gap-2 whitespace-nowrap"
            >
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Nou Repte
            </Link>
          </div>
        </div>

        {/* TAULA + PAGINACIÓ (Integrats visualment) */}
        <div className="bg-white dark:bg-slate-900 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm overflow-hidden">
           <ChallengeTable challenges={challenges} />
           <AdminPagination currentPage={page} totalPages={totalPages} />
        </div>
        
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(admin)/sys-ops/challenges/[id]/edit/page.tsx ===================

// filepath: src/app/[locale]/(admin)/sys-ops/challenges/[id]/edit/page.tsx
import { notFound } from 'next/navigation';
import { assertAdmin } from '@/presentation/utils/auth-guards';
import { SupabaseChallengeRepository } from '@/infrastructure/repositories/supabase/challenge.repository';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { ChallengeEditor } from '@/presentation/components/admin/challenges/challenge-editor';
import { ChallengeFormValues } from '@/presentation/components/admin/challenges/form/form-config';
// Importem el nou component de navegació
import { ChallengeNavigation } from '@/presentation/components/admin/challenges/navigation/challenge-navigation';

interface EditPageProps {
  params: Promise<{ id: string }>;
}

export default async function EditChallengePage({ params }: EditPageProps) {
  // 1. Seguretat
  await assertAdmin();
  
  // 2. Setup
  const { id } = await params;
  const challengeRepo = new SupabaseChallengeRepository();
  const topicRepo = new SupabaseTopicRepository();

  // 3. Fetching Paral·lel (Optimitzat)
  // Ara necessitem: El Repte, Els Topics (pel select) i saber qui són els veïns.
  
  // Primer obtenim el repte per tenir la data de creació
  const challenge = await challengeRepo.findById(id);
  
  if (!challenge) {
    notFound();
  }

  // Ara busquem la resta en paral·lel
  const [topics, navigation] = await Promise.all([
    topicRepo.findAll(),
    // Busquem anterior/següent basant-nos en la data d'aquest repte
    challengeRepo.findAdjacentChallenges(challenge.id, challenge.createdAt.toISOString())
  ]);

  // 4. Preparació de Dades
  const topicOptions = topics.map(t => ({ id: t.id, name: t.slug }));

  const initialFormValues = {
    topicId: challenge.topicId,
    difficultyTier: challenge.difficultyTier,
    type: challenge.type,
    content: challenge.content,
  } as unknown as ChallengeFormValues;

  return (
    <div className="container mx-auto py-6 px-4 max-w-7xl">
      {/* HEADER DE LA PÀGINA (Amb Navegació) */}
      <div className="mb-6 flex items-center justify-between bg-white dark:bg-slate-900 p-4 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm">
        <div>
          <h1 className="text-xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
            <span className="text-gray-400">#</span>
            Editar Repte
          </h1>
          <p className="text-gray-500 dark:text-gray-400 text-xs font-mono mt-1 flex items-center gap-2">
            ID: {id.split('-')[0]}... 
            <span className="bg-gray-100 dark:bg-slate-800 px-2 py-0.5 rounded text-gray-600 dark:text-gray-300">
              {challenge.type}
            </span>
          </p>
        </div>

        {/* COMPONENT DE NAVEGACIÓ NOU */}
        <ChallengeNavigation prevId={navigation.prevId} nextId={navigation.nextId} />
      </div>

      {/* EDITOR */}
      <div className="bg-white dark:bg-slate-950 rounded-xl shadow-sm border border-gray-200 dark:border-slate-800 overflow-hidden">
        <ChallengeEditor 
          topics={topicOptions} 
          initialData={initialFormValues} 
          challengeId={id} 
        />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/layout.tsx ===================

// filepath: src/app/[locale]/(auth)/layout.tsx
import { ReactNode } from 'react';

export default function AuthLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-slate-950 relative overflow-hidden">
      {/* Fons decoratiu (Opcional: efecte grid o gradient) */}
      <div className="absolute inset-0 bg-[linear-gradient(to_right,#4f4f4f2e_1px,transparent_1px),linear-gradient(to_bottom,#4f4f4f2e_1px,transparent_1px)] bg-[size:14px_24px] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]" />
      
      {/* Contingut centrat (Login/Register) */}
      <div className="relative z-10 w-full max-w-md p-4">
        {children}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/login/LoginForm.tsx ===================

// filepath: src/app/[locale]/(auth)/login/LoginForm.tsx
'use client';

import { useActionState } from 'react';
import { authAction } from '@/presentation/actions/auth/auth.action';
import { Loader2, LogIn } from 'lucide-react';
import { useTranslations } from 'next-intl';

// 1. IMPORTACIÓ CORRECTA (Arquitectura Centralitzada)
import { Link } from '@/navigation'; 

export function LoginForm() {
  const t = useTranslations('auth');
  
  // 2. HEM ELIMINAT 'const locale = useLocale();' -> Ja no cal!

  const [state, action, isPending] = useActionState(authAction, {});

  return (
    <form action={action} className="flex flex-col gap-4">
      <input type="hidden" name="intent" value="login" />

      {/* EMAIL */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.email')}
        </label>
        <input 
          name="email" 
          type="email" 
          required 
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.email_placeholder')}
        />
      </div>
      
      {/* PASSWORD */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.password')}
        </label>
        <div className="text-right mb-1">
            {/* TODO: Crear ruta real /forgot-password */}
            <Link href="/forgot-password" className="text-xs text-blue-400 hover:underline">
              {t('login.forgot_password')}
            </Link>
        </div>
        <input 
          name="password" 
          type="password" 
          required 
          minLength={6}
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.password_placeholder')}
        />
      </div>

      {/* ERRORS */}
      {state?.errorKey && (
        <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm flex items-center gap-2">
          ⚠️ <span>{t(state.errorKey)}</span>
        </div>
      )}

      {/* BOTÓ */}
      <button 
        type="submit" 
        disabled={isPending}
        className="w-full py-3 mt-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-lg transition-all flex justify-center items-center shadow-lg shadow-blue-900/20"
      >
        {isPending ? <Loader2 className="animate-spin w-5 h-5" /> : (
            <span className="flex items-center gap-2">
                {t('login.submit_button')} <LogIn className="w-4 h-4" />
            </span>
        )}
      </button>

      {/* FOOTER LINK - MOLT MÉS NET */}
      <div className="text-center mt-6 text-sm text-slate-500">
        {t('login.no_account')}{' '}
        <Link 
          href="/register" 
          className="text-blue-400 hover:text-blue-300 font-medium hover:underline transition-colors"
        >
          {t('login.register_link')}
        </Link>
      </div>
    </form>
  );
}

// =================== FILE: src/app/[locale]/(auth)/login/page.tsx ===================

// filepath: src/app/[locale]/(auth)/login/page.tsx
import { LoginForm } from './LoginForm';
import { getTranslations } from 'next-intl/server'; // <--- Import de servidor

interface Props {
  params: Promise<{ locale: string }>;
}

export default async function LoginPage({ params }: Props) {
  // 1. Esperem els paràmetres (Next.js 15 requires await)
  const { locale } = await params;
  
  // 2. Carreguem les traduccions al servidor
  const t = await getTranslations({ locale, namespace: 'auth.login' });

  return (
    <div className="bg-slate-900 border border-slate-800 rounded-xl p-8 shadow-2xl backdrop-blur-sm w-full">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-white mb-2">{t('title')}</h1>
        <p className="text-slate-400">{t('subtitle')}</p>
      </div>

      <LoginForm />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/register/page.tsx ===================

// filepath: src/app/[locale]/(auth)/register/page.tsx
import { RegisterForm } from './RegisterForm';
import { getTranslations } from 'next-intl/server';

interface Props {
  params: Promise<{ locale: string }>;
}

export default async function RegisterPage({ params }: Props) {
  const { locale } = await params;
  
  // namespace 'auth.register' coincideix amb el teu fitxer .ts
  const t = await getTranslations({ locale, namespace: 'auth.register' });

  return (
    <div className="bg-slate-900 border border-slate-800 rounded-xl p-8 shadow-2xl backdrop-blur-sm w-full">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-white mb-2">{t('title')}</h1>
        <p className="text-slate-400">{t('subtitle')}</p>
      </div>
      <RegisterForm />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/register/RegisterForm.tsx ===================

// filepath: src/app/[locale]/(auth)/register/RegisterForm.tsx
'use client';

import { useActionState } from 'react';
import { authAction } from '@/presentation/actions/auth/auth.action';
import { Loader2 } from 'lucide-react';
import { useTranslations } from 'next-intl';

// 1. IMPORTACIÓ CORRECTA
import { Link } from '@/navigation';

export function RegisterForm() {
  const t = useTranslations('auth');
  // 2. HEM ELIMINAT 'const locale = useLocale();'

  const [state, action, isPending] = useActionState(authAction, {});

  return (
    <form action={action} className="flex flex-col gap-4">
      <input type="hidden" name="intent" value="signup" />

      {/* EMAIL */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.email')}
        </label>
        <input 
          name="email" 
          type="email" 
          required 
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.email_placeholder')} 
        />
      </div>

      {/* PASSWORD */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.password')}
        </label>
        <input 
          name="password" 
          type="password" 
          required 
          minLength={6} 
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.password_placeholder')} 
        />
      </div>

      {/* MISSATGES */}
      {state?.errorKey && (
        <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
          ⚠️ {t(state.errorKey)}
        </div>
      )}
      {state?.messageKey && (
        <div className="p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm">
          ✅ {t(state.messageKey)}
        </div>
      )}

      {/* BOTÓ */}
      <button 
        disabled={isPending} 
        className="w-full py-3 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white font-bold rounded-lg transition-all flex justify-center items-center shadow-lg"
      >
        {isPending ? <Loader2 className="animate-spin" /> : t('register.submit_button')}
      </button>

      {/* FOOTER - SENSE LOCALE MANUAL */}
      <div className="text-center mt-4 text-sm text-slate-500">
        {t('register.have_account')}{' '}
        <Link 
          href="/login" 
          className="text-blue-400 hover:underline"
        >
          {t('register.login_link')}
        </Link>
      </div>
    </form>
  );
}

// =================== FILE: src/app/[locale]/(dashboard)/dashboard/page.tsx ===================

import { createClient } from '@/infrastructure/utils/supabase/server';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { GetUserDashboardUseCase } from '@/application/use-cases/dashboard/get-user-dashboard.use-case';
import { TopicCard } from '@/presentation/components/features/dashboard/TopicCard';
import { getTranslations } from 'next-intl/server';
import { redirect } from 'next/navigation';
import { getLocalizedText } from '@/core/utils/i18n-utils'; // ✅ 1. IMPORTAR

interface DashboardPageProps {
  params: Promise<{ locale: string }>;
}

export default async function DashboardPage({ params }: DashboardPageProps) {
  const { locale } = await params;

  const t = await getTranslations();
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/login');
  }

  const topicRepo = new SupabaseTopicRepository();
  const useCase = new GetUserDashboardUseCase(topicRepo);
  const topics = await useCase.execute(user.id, locale, supabase);

  return (
    <div className="min-h-screen bg-slate-950 p-6 md:p-12">
      <div className="max-w-6xl mx-auto mb-10">
        <h1 className="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight">
          {t('dashboard.welcome_title')}, <span className="text-blue-500">{user.email?.split('@')[0]}</span>! 👋
        </h1>
        <p className="text-slate-400 text-lg">
          {t('dashboard.subtitle')}
        </p>
      </div>

      <div className="max-w-6xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        {topics.map((topic) => (
          <TopicCard
            key={topic.id}
            topic={topic}
            translatedTitle={getLocalizedText(topic.title, locale)}
            locale={locale} // ✅ FIX: Passem el locale cap avall
          />
        ))}
      </div>

      {topics.length === 0 && (
        <div className="text-center py-20">
          <p className="text-slate-500">No s'han trobat temes actius.</p>
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(game)/learn/[slug]/page.tsx ===================

// filepath: src/app/[locale]/(game)/learn/[slug]/page.tsx
import { createClient } from '@/infrastructure/utils/supabase/server';
import { GetTopicPathUseCase } from '@/application/use-cases/topics/get-topic-path.use-case';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { ArrowLeft } from 'lucide-react';
import { redirect } from 'next/navigation';
// ❌ ELIMINAT: import { getTranslations } from 'next-intl/server'; (ja no cal per al títol)
import { Link } from '@/navigation'; 
import { LearningPathOrchestrator } from '@/presentation/components/features/learning-path/LearningPathOrchestrator';
import { getLocalizedText } from '@/core/utils/i18n-utils'; // ✅ 1. IMPORTAR UTILITAT

interface TopicPageProps {
  params: Promise<{ slug: string; locale: string }>;
}

export default async function TopicMapPage({ params }: TopicPageProps) {
  // ✅ 2. EXTREIEM EL LOCALE DELS PARAMS
  const { slug, locale } = await params;
  
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const topicRepo = new SupabaseTopicRepository();
  const topic = await topicRepo.findBySlug(slug);
  
  if (!topic) return <div className="text-white text-center pt-20">Tema no trobat (404)</div>;

  const pathUseCase = new GetTopicPathUseCase(topicRepo);
  const { levels, totalXp } = await pathUseCase.execute(user.id, topic.id);

  return (
    <div className="min-h-screen bg-slate-950 flex flex-col items-center relative overflow-hidden">
      
      {/* HEADER */}
      <header className="sticky top-0 w-full bg-slate-900/90 backdrop-blur-md border-b border-slate-800 p-3 md:p-4 flex items-center justify-between z-50 shadow-2xl">
         <Link href="/dashboard" className="text-slate-400 hover:text-white transition-colors">
            <ArrowLeft className="w-6 h-6" />
         </Link>
         
         {/* ✅ 3. FIX: Títol dinàmic des de la BD */}
         <h1 className="font-bold text-white text-base md:text-xl tracking-tight">
            {getLocalizedText(topic.title, locale)}
         </h1>
         
         <div className="text-xs md:text-sm font-bold text-yellow-500 bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
            {totalXp} XP
         </div>
      </header>

      {/* RUTA */}
      <div className="w-full flex-1 relative">
         <LearningPathOrchestrator levels={levels} slug={slug} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(game)/learn/[slug]/play/page.tsx ===================

// filepath: src/app/[locale]/(game)/learn/[slug]/play/page.tsx
import { getNextChallengeAction } from '@/presentation/actions/challenges/get-next-challenge.action';
import { GameArena } from '@/presentation/components/features/game-engine/GameArena';
// 1. IMPORT CORRECTE PER A i18n
import { Link } from '@/navigation';
import { ArrowLeft } from 'lucide-react';

interface PlayPageProps {
  params: Promise<{ slug: string; locale: string }>;
  searchParams: Promise<{ tier?: string }>;
}

export default async function PlayPage({ params, searchParams }: PlayPageProps) {
  const { slug } = await params;
  const { tier } = await searchParams;

  // 2. Determinar Dificultat (Tier)
  const difficulty = tier ? parseInt(tier, 10) : 1;

  // 3. Cridar l'Acció passant el NIVELL
  // (Nota: Ara haurem d'actualitzar l'acció per acceptar aquest paràmetre)
  const response = await getNextChallengeAction(slug, difficulty);

  return (
    <main className="min-h-screen bg-slate-950 flex flex-col">
      {/* HEADER DE JOC */}
      <header className="border-b border-slate-800 bg-slate-900/80 backdrop-blur-md p-4 sticky top-0 z-20">
        <div className="max-w-5xl mx-auto flex items-center justify-between">

          {/* 4. UX MILLORADA: Tornar al MAPA, no a l'inici */}
          <Link
            href={`/learn/${slug}`}
            className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors group"
          >
            <div className="p-1.5 rounded-full bg-slate-800 group-hover:bg-slate-700 transition-colors">
              <ArrowLeft className="w-4 h-4" />
            </div>
            <span className="font-medium text-sm">Sortir del nivell</span>
          </Link>

          {/* Badge de Nivell */}
          <div className="px-3 py-1 bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-bold rounded-full uppercase tracking-wider">
            Tier {difficulty}
          </div>
        </div>
      </header>

      {/* ZONA DE JOC */}
      <div className="flex-1 flex flex-col items-center justify-center p-4 md:p-6 w-full max-w-5xl mx-auto">
        {!response.success ? (
          <div className="text-center max-w-md p-8 bg-slate-900 border border-red-900/50 rounded-2xl">
            <h1 className="text-xl font-bold text-red-400 mb-2">Error de càrrega</h1>
            <p className="text-slate-400 mb-6">{response.error}</p>
            <Link href={`/learn/${slug}`} className="px-6 py-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors">
              Tornar al Mapa
            </Link>
          </div>
        ) : !response.data || response.data.length === 0 ? (
          <div className="text-center py-10 animate-in fade-in zoom-in duration-500">
            <div className="text-6xl mb-4">🎉</div>
            <h1 className="text-3xl font-black text-transparent bg-clip-text bg-linear-to-r from-yellow-400 to-orange-500 mb-4">
              Nivell Completat!
            </h1>
            <p className="text-xl text-slate-400 max-w-lg mx-auto mb-8">
              Ja has superat tots els reptes d'aquest nivell de dificultat.
            </p>
            <Link
              href={`/learn/${slug}`}
              className="inline-flex items-center px-8 py-4 bg-blue-600 rounded-xl font-bold text-white hover:bg-blue-500 hover:scale-105 transition-all shadow-lg shadow-blue-600/20"
            >
              Tornar al Mapa
            </Link>
          </div>
        ) : (
          // ✅ AQUÍ ESTÀ EL CANVI: PASSEM EL SLUG
          <GameArena
            challenges={response.data}
            topicSlug={slug} // <--- CONNEXIÓ FINAL
          />
        )}
      </div>
    </main>
  );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

// filepath: src/app/[locale]/layout.tsx
import type { Metadata } from "next";
import { Nunito } from "next/font/google";
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { createClient } from '@/infrastructure/utils/supabase/server'; // Importem el client
import "../globals.css";

// Components de Navegació
import { MobileBottomBar } from "@/presentation/components/layout/MobileBottomBar";
import { DesktopNavbar } from "@/presentation/components/layout/DesktopNavbar";

const nunito = Nunito({ 
  subsets: ["latin"],
  weight: ["400", "700", "800", "900"],
  variable: "--font-nunito",
});

export const metadata: Metadata = {
  title: "EduTech",
  description: "Aprèn tecnologia jugant",
};

export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  const messages = await getMessages();

  // 1. COMPROVACIÓ DE SESSIÓ AL SERVIDOR
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  const isLoggedIn = !!user; // true si hi ha usuari, false si no

  return (
    <html lang={locale}>
      <body className={`${nunito.variable} font-sans bg-slate-950 text-white antialiased pb-24 md:pb-0 md:pt-20`}>
        {/* pb-24: Padding inferior al mòbil perquè la barra no tapi contingut.
            md:pt-20: Padding superior a l'escriptori perquè la navbar no tapi contingut.
        */}

        <NextIntlClientProvider messages={messages}>
          
          {/* BARRA SUPERIOR (ESCRIPTORI) */}
          <DesktopNavbar isLoggedIn={isLoggedIn} />

          {/* CONTINGUT PRINCIPAL */}
          <main className="min-h-screen relative">
             {children}
          </main>

          {/* BARRA INFERIOR (MÒBIL) */}
          <MobileBottomBar isLoggedIn={isLoggedIn} />

        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/app/[locale]/page.tsx ===================

// ✅ ARA (CORRECTE - Apuntant al teu fitxer v4):
import { Link } from '@/navigation';   // <-- AQUEST ÉS EL CANVI CLAU
import { redirect } from 'next/navigation'; // El redirect aquí pot ser el natiu pq ja tenim el locale als params

import { createClient } from '@/infrastructure/utils/supabase/server';
import { ArrowRight, Code2, Terminal } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

interface LandingPageProps {
  params: Promise<{ locale: string }>;
}

export default async function LandingPage({ params }: LandingPageProps) {
  // 1. OBTENIR LOCALE I TRADUCCIONS
  const { locale } = await params;
  const t = await getTranslations('landing');
  const supabase = await createClient();

  // 2. SI JA TÉ SESSIÓ -> CAP AL DASHBOARD (AMB LOCALE CORRECTE!)
  const { data: { user } } = await supabase.auth.getUser();
  
  if (user) {
    redirect(`/${locale}/dashboard`);
  }

  return (
    <main className="flex min-h-screen flex-col bg-slate-950 text-white overflow-hidden relative">
      


      {/* Fons Decoratiu */}
      <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
          <div className="absolute top-[-10%] left-[-10%] w-[500px] h-125 bg-blue-600/20 rounded-full blur-[100px]" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-emerald-500/10 rounded-full blur-[100px]" />
      </div>

      {/* Contingut */}
      <div className="z-10 flex flex-col items-center justify-center min-h-screen px-4 text-center max-w-4xl mx-auto pt-20">
        
        {/* Badge */}
        <div className="mb-8 px-4 py-1.5 rounded-full border border-slate-700 bg-slate-900/50 backdrop-blur-sm text-sm text-slate-300 font-medium inline-flex items-center gap-2 animate-in fade-in slide-in-from-bottom-4 duration-700">
           <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
           {t('badge')}
        </div>

        {/* Títol Hero */}
        <h1 className="text-5xl md:text-7xl font-black mb-6 leading-tight tracking-tight animate-in fade-in slide-in-from-bottom-8 duration-700">
           {t('title_prefix')} <br/>
           <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-emerald-400">
             {t('title_highlight')}
           </span>
        </h1>

        <p className="text-lg md:text-xl text-slate-400 mb-10 max-w-2xl leading-relaxed animate-in fade-in slide-in-from-bottom-12 duration-700">
           {t('description')}
        </p>

        {/* Botons */}
        <div className="flex flex-col sm:flex-row gap-4 w-full sm:w-auto animate-in fade-in slide-in-from-bottom-16 duration-700">
           <Link 
             href="/login" 
             className="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all hover:scale-105 active:scale-95 shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"
           >
             {t('cta_primary')} <ArrowRight className="w-5 h-5" />
           </Link>
           <Link 
             href="/about" 
             className="px-8 py-4 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-xl transition-all border border-slate-700"
           >
             {t('cta_secondary')}
           </Link>
        </div>

        {/* Icones Flotants (Decoració) */}
        <div className="absolute top-1/4 left-10 md:left-20 opacity-20 rotate-[-12deg] animate-pulse pointer-events-none">
            <Code2 className="w-24 h-24" />
        </div>
        <div className="absolute bottom-1/4 right-10 md:right-20 opacity-20 rotate-[12deg] animate-pulse pointer-events-none">
            <Terminal className="w-24 h-24" />
        </div>
      </div>
    </main>
  );
}

// =================== FILE: src/application/dto/challenge.schema.ts ===================

// filepath: src/application/dto/challenge.schema.ts
import { z } from 'zod';

// --- BUILDING BLOCKS ---

// Acceptem String simple (per a codi o termes tècnics) o Objecte i18n
const LocalizedOrString = z.union([
  z.string(),
  z.object({
    ca: z.string().optional(),
    es: z.string().optional(),
    en: z.string().optional(),
  })
]);

// Forcem i18n complet per a textos narratius (preguntes, explicacions)
const LocalizedTextStrict = z.object({
  ca: z.string().min(1, "Falta CA"),
  es: z.string().min(1, "Falta ES"),
  en: z.string().min(1, "Falta EN"),
});

// --- CONTENT SCHEMAS ---

const BinaryDecisionSchema = z.object({
  isTrue: z.boolean(),
  variant: z.enum(['HOT_OR_NOT', 'TRUE_FALSE', 'YES_NO']).default('TRUE_FALSE'),
  statement: LocalizedTextStrict,
  explanation: LocalizedTextStrict,
});

const QuizSchema = z.object({
  question: LocalizedTextStrict,
  explanation: LocalizedTextStrict,
  options: z.array(z.object({
    id: z.string(),
    text: LocalizedTextStrict
  })),
  correctOptionIndex: z.number()
});

const MatchingSchema = z.object({
  instruction: LocalizedTextStrict,
  pairs: z.array(z.object({
    left: z.object({ id: z.string(), text: LocalizedOrString }),
    right: z.object({ id: z.string(), text: LocalizedOrString })
  }))
});

const CodeFixSchema = z.object({
  description: LocalizedTextStrict,
  initialCode: z.string(),
  solution: z.string(), // La solució és codi únic
  hint: LocalizedTextStrict,
  options: z.array(z.object({
    id: z.string(),
    code: z.string(),
    isCorrect: z.boolean()
  }))
});

const TerminalSchema = z.object({
  instruction: LocalizedTextStrict,
  initialCommand: z.string().optional(),
  validCommands: z.array(z.string()),
  hint: LocalizedTextStrict,
  explanation: LocalizedTextStrict,
  outputParams: z.object({
    success: z.string(),
    error: z.string()
  })
});

const LogicOrderSchema = z.object({
  description: LocalizedTextStrict,
  items: z.array(z.object({
    id: z.string(),
    text: LocalizedTextStrict
  }))
});

const CtfSchema = z.object({
  description: LocalizedTextStrict,
  flag: z.string().min(1, "La Flag és obligatòria"),
  hint: LocalizedTextStrict,
  // Opcional: Podries afegir un enllaç a un fitxer extern si calgués
});

const TheorySchema = z.object({
  title: LocalizedTextStrict,
  markdownContent: LocalizedTextStrict, // Contingut teòric llarg
  timeToRead: z.coerce.number().optional()
});
// --- MASTER SCHEMA ---

export const CreateChallengeSchema = z.object({
  topicId: z.string().uuid(),
  difficultyTier: z.coerce.number().min(1).max(10),
  // 1. ACTUALITZEM L'ENUM AMB TOTS ELS TIPUS
  type: z.enum([
    'BINARY_DECISION', 
    'QUIZ', 
    'CODE_FIX', 
    'MATCHING', 
    'TERMINAL', 
    'LOGIC_ORDER',
    'CTF',    // 👈 NOU
    'THEORY'  // 👈 NOU
  ]),
  
  // Unió discriminada: Zod validarà l'estructura segons el 'type' del pare (si ho féssim amb superRefine)
  // Per simplificar el formulari, usem una unió oberta i validem lògica a UI o backend
  content: z.union([
    BinaryDecisionSchema,
    QuizSchema,
    MatchingSchema,
    CodeFixSchema,
    TerminalSchema,
    LogicOrderSchema,
    CtfSchema,    // 👈 NOU
    TheorySchema  // 👈 NOU
  ])
});

export type CreateChallengeSchemaType = z.infer<typeof CreateChallengeSchema>;

// 👇👇👇 AFEGEIX AIXÒ AL FINAL DEL FITXER 👇👇👇

// Creem l'schema d'Update fent que tot sigui opcional (.partial())
// Això permet enviar només el 'difficultyTier' sense haver d'enviar tot el 'content' de nou, per exemple.
export const UpdateChallengeSchema = CreateChallengeSchema.partial();

export type UpdateChallengeSchemaType = z.infer<typeof UpdateChallengeSchema>;

// =================== FILE: src/application/dto/dashboard-topic.dto.ts ===================

// filepath: src/application/dto/dashboard-topic.dto.ts
import { Topic } from "@/core/entities/topic.entity";

export interface DashboardTopicDTO extends Topic {
  progressPercentage: number; // 0 a 100
  totalXpEarned: number;
  currentLevel: number;
  isLocked: boolean; // Per si volem bloquejar temes avançats
}

// =================== FILE: src/application/dto/level-node.dto.ts ===================

// filepath: src/application/dto/level-node.dto.ts
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';

export type LevelStatus = 'LOCKED' | 'ACTIVE' | 'COMPLETED';

export interface LevelNodeDTO {
  tier: number;
  status: LevelStatus;
  label: string;
  
  // Stats
  totalChallenges: number;
  completedChallenges: number;
  
  // Visuals
  isCurrentPosition: boolean;
  predominantType: ChallengeType;
  
  // --- BOSS & MILESTONES ---
  isBoss: boolean;
  bossTitleKey?: string; // 👈 Canviat a Key
  bossColorClass?: string;
  bossIconName?: string; // 👈 Nou camp per la icona
}

// =================== FILE: src/application/dto/session-result.dto.ts ===================

// filepath: src/application/dto/session-result.dto.ts
export interface SessionResultDTO {
  xpEarned: number;
  newTotalXp: number;
  newLevel: number;
  leveledUp: boolean;
}

// =================== FILE: src/application/use-cases/auth/logout.use-case.test.ts ===================

// filepath: src/application/use-cases/auth/logout.use-case.test.ts
import { describe, it, expect, vi } from 'vitest';
import { LogoutUseCase } from './logout.use-case';
import { IAuthService } from '@/core/services/auth.service';

const mockAuthService = {
  login: vi.fn(),
  register: vi.fn(),
  logout: vi.fn(), // <--- Això és el que provarem
  getUser: vi.fn(),
} as unknown as IAuthService;

describe('LogoutUseCase', () => {
  it('should call auth service to sign out', async () => {
    // ARRANGE
    const useCase = new LogoutUseCase(mockAuthService);

    // ACT
    await useCase.execute();

    // ASSERT
    expect(mockAuthService.logout).toHaveBeenCalled();
  });
});

// =================== FILE: src/application/use-cases/auth/logout.use-case.ts ===================

// filepath: src/application/use-cases/auth/logout.use-case.ts
import { IAuthService } from '@/core/services/auth.service';

export class LogoutUseCase {
  constructor(private readonly authService: IAuthService) {}

  async execute(): Promise<void> {
    await this.authService.logout();
  }
}

// =================== FILE: src/application/use-cases/challenges/create-challenge.use-case.test.ts ===================

// filepath: src/application/use-cases/challenges/create-challenge.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { CreateChallengeUseCase } from './create-challenge.use-case';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { CreateChallengeSchemaType } from '@/application/dto/challenge.schema';

describe('CreateChallengeUseCase', () => {
  let useCase: CreateChallengeUseCase;
  let mockChallengeRepo: IChallengeRepository;

  // Dades de prova vàlides
  const validInput: CreateChallengeSchemaType = {
    topicId: '123e4567-e89b-12d3-a456-426614174000',
    difficultyTier: 1,
    type: 'QUIZ',
    content: {
      question: 'Què és React?',
      options: ['Una llibreria', 'Un framework', 'Un idioma', 'Un servidor'],
      correctAnswerIndex: 0,
      explanation: 'React és una llibreria de JS.'
    }
  };

  beforeEach(() => {
    // 1. Mockejem el Repositori (simulacre)
    mockChallengeRepo = {
      findNextForUser: vi.fn(),
      findByTopicId: vi.fn(),
      findById: vi.fn(),
      create: vi.fn().mockResolvedValue({
        id: 'new-id',
        createdAt: new Date(),
        ...validInput
      }),
      update: vi.fn(),
      delete: vi.fn(),
    };

    // 2. Instanciem el Cas d'Ús injectant el mock
    useCase = new CreateChallengeUseCase(mockChallengeRepo);
  });

  it('hauria de cridar al repositori amb les dades correctes', async () => {
    // Act
    const result = await useCase.execute(validInput);

    // Assert
    expect(mockChallengeRepo.create).toHaveBeenCalledTimes(1);
    expect(mockChallengeRepo.create).toHaveBeenCalledWith(validInput);
    expect(result.id).toBe('new-id');
  });

  it('hauria de propagar errors si el repositori falla', async () => {
    // Arrange
    const error = new Error('Database connection failed');
    mockChallengeRepo.create = vi.fn().mockRejectedValue(error);

    // Act & Assert
    await expect(useCase.execute(validInput)).rejects.toThrow('Database connection failed');
  });
});

// =================== FILE: src/application/use-cases/challenges/create-challenge.use-case.ts ===================

// filepath: src/application/use-cases/challenges/create-challenge.use-case.ts
import { IChallengeRepository, CreateChallengeInput } from '@/core/repositories/challenge.repository';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { CreateChallengeSchemaType } from '@/application/dto/challenge.schema';

export class CreateChallengeUseCase {
  constructor(private readonly challengeRepository: IChallengeRepository) {}

  /**
   * Executa la creació d'un nou repte.
   * Assumeix que les dades ja han passat la validació Zod a la capa superior.
   */
  async execute(input: CreateChallengeSchemaType): Promise<Challenge> {
    // ⚠️ CRITICAL: Type Assertion
    // El Zod Schema permet 'Record<string, any>' per a tipus futurs (fallback),
    // però el Domini és estricte (ChallengeContent).
    // Fem el cast aquí perquè estem entrant a la capa de Domini.
    // En el futur, quan definim tots els Zod Schemas (Terminal, Matching...), podrem treure el cast.
    
    const domainInput = input as unknown as CreateChallengeInput;

    return await this.challengeRepository.create(domainInput);
  }
}

// =================== FILE: src/application/use-cases/challenges/delete-challenge.use-case.test.ts ===================

// filepath: src/application/use-cases/challenges/delete-challenge.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { DeleteChallengeUseCase } from './delete-challenge.use-case';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';

describe('DeleteChallengeUseCase', () => {
  let useCase: DeleteChallengeUseCase;
  let mockChallengeRepo: IChallengeRepository;

  const challengeId = 'to-delete-uuid';

  beforeEach(() => {
    mockChallengeRepo = {
      findNextForUser: vi.fn(),
      findByTopicId: vi.fn(),
      findById: vi.fn(),
      create: vi.fn(),
      update: vi.fn(),
      delete: vi.fn().mockResolvedValue(undefined), // Delete retorna void
    };

    useCase = new DeleteChallengeUseCase(mockChallengeRepo);
  });

  it('hauria de cridar al mètode delete del repositori', async () => {
    // Act
    await useCase.execute(challengeId);

    // Assert
    expect(mockChallengeRepo.delete).toHaveBeenCalledTimes(1);
    expect(mockChallengeRepo.delete).toHaveBeenCalledWith(challengeId);
  });

  it('hauria de propagar errors del sistema', async () => {
    // Arrange
    mockChallengeRepo.delete = vi.fn().mockRejectedValue(new Error('DB Error'));

    // Act & Assert
    await expect(useCase.execute(challengeId)).rejects.toThrow('DB Error');
  });
});

// =================== FILE: src/application/use-cases/challenges/delete-challenge.use-case.ts ===================

// filepath: src/application/use-cases/challenges/delete-challenge.use-case.ts
import { IChallengeRepository } from '@/core/repositories/challenge.repository';

export class DeleteChallengeUseCase {
  constructor(private readonly challengeRepository: IChallengeRepository) {}

  async execute(id: string): Promise<void> {
    // Aquí podries afegir lògica de seguretat extra, 
    // com verificar que no hi hagi dependències crítiques, 
    // tot i que la BD té ON DELETE CASCADE.
    
    await this.challengeRepository.delete(id);
  }
}

// =================== FILE: src/application/use-cases/challenges/get-next-challenge.use-case.test.ts ===================

// filepath: src/application/use-cases/challenges/get-next-challenge.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { GetNextChallengeUseCase } from './get-next-challenge.use-case';
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { Challenge, ChallengeType, QuizContent } from '@/core/entities/challenges/index';
import { Topic } from '@/core/entities/topic.entity';

// Mocks
const mockTopicRepo = {
  findBySlug: vi.fn(),
} as unknown as ITopicRepository;

const mockChallengeRepo = {
  findNextForUser: vi.fn(),
} as unknown as IChallengeRepository;

describe('GetNextChallengeUseCase', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should return challenges translated to the requested locale', async () => {
    // ARRANGE
    const locale = 'en';
    const topicSlug = 'react-basics';
    const userId = 'user-123';
    const topicId = 'topic-abc';
    const difficulty = 1;

    // 1. Simulem que trobem el tema
    const mockTopic: Topic = {
      id: topicId,
      slug: topicSlug,
      nameKey: 'topic.react.title',
      description: 'Test Description', // 👈 AFEGIT (soluciona l'error TS)
      iconName: 'brand-react',     
      colorTheme: 'bg-blue-500',
      isActive: true,              
      createdAt: new Date(),
      updatedAt: new Date()
    };

    vi.mocked(mockTopicRepo.findBySlug).mockResolvedValue(mockTopic);

    // 2. Simulem que el repositori retorna reptes
    const mockChallenges: Challenge[] = [
      {
        id: 'c1',
        topicId: topicId,
        difficultyTier: difficulty,
        type: 'QUIZ' as ChallengeType,
        content: {
          question: 'Question in English',
          explanation: 'Explanation',
          correctOptionIndex: 0,
          options: [{ id: 'o1', text: 'Option 1' }]
        },
        createdAt: new Date()
      }
    ];

    vi.mocked(mockChallengeRepo.findNextForUser).mockResolvedValue(mockChallenges);

    const useCase = new GetNextChallengeUseCase(mockTopicRepo, mockChallengeRepo);

    // ACT
    const result = await useCase.execute(topicSlug, userId, locale, difficulty);

    // ASSERT
    expect(mockTopicRepo.findBySlug).toHaveBeenCalledWith(topicSlug);
    expect(mockChallengeRepo.findNextForUser).toHaveBeenCalledWith(topicId, userId, locale, difficulty);
    
    expect(result).toHaveLength(1);
    
    const content = result[0].content as QuizContent;
    expect(content.question).toBe('Question in English');
  });
});

// =================== FILE: src/application/use-cases/challenges/get-next-challenge.use-case.ts ===================

// filepath: src/application/use-cases/challenges/get-next-challenge.use-case.ts
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { TopicNotFoundError } from '@/core/errors/topic.errors';

export class GetNextChallengeUseCase {
  constructor(
    private readonly topicRepository: ITopicRepository,
    private readonly challengeRepository: IChallengeRepository
  ) {}

  // 1. AFEGIM 'difficulty' A LA SIGNATURA
  async execute(topicSlug: string, userId: string, locale: string, difficulty: number): Promise<Challenge[]> {
    const topic = await this.topicRepository.findBySlug(topicSlug);

    if (!topic) {
      throw new TopicNotFoundError(topicSlug);
    }

    // 2. PASSEM 'difficulty' AL REPOSITORI
    return this.challengeRepository.findNextForUser(topic.id, userId, locale, difficulty);
  }
}

// =================== FILE: src/application/use-cases/challenges/update-challenge.use-case.test.ts ===================

// filepath: src/application/use-cases/challenges/update-challenge.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { UpdateChallengeUseCase } from './update-challenge.use-case';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { UpdateChallengeSchemaType } from '@/application/dto/challenge.schema';

describe('UpdateChallengeUseCase', () => {
  let useCase: UpdateChallengeUseCase;
  let mockChallengeRepo: IChallengeRepository;

  // Dades de prova (Parcials)
  const challengeId = 'existing-uuid';
  const updateInput: UpdateChallengeSchemaType = {
    difficultyTier: 5,
    // Només actualitzem la dificultat, la resta undefined
  };

  beforeEach(() => {
    // 1. Mockejem el Repositori
    mockChallengeRepo = {
      findNextForUser: vi.fn(),
      findByTopicId: vi.fn(),
      findById: vi.fn(),
      create: vi.fn(),
      // Simulem que l'update retorna l'objecte fusionat
      update: vi.fn().mockResolvedValue({
        id: challengeId,
        topicId: 'some-topic',
        difficultyTier: 5, // Valor actualitzat
        type: 'QUIZ',
        content: {}, 
        createdAt: new Date()
      }),
      delete: vi.fn(),
    };

    useCase = new UpdateChallengeUseCase(mockChallengeRepo);
  });

  it('hauria de cridar al repositori amb l\'ID i les dades correctes', async () => {
    // Act
    const result = await useCase.execute(challengeId, updateInput);

    // Assert
    expect(mockChallengeRepo.update).toHaveBeenCalledTimes(1);
    expect(mockChallengeRepo.update).toHaveBeenCalledWith(challengeId, updateInput);
    expect(result.difficultyTier).toBe(5);
  });

  it('hauria de llançar error si el repositori falla (ex: ID no trobat)', async () => {
    // Arrange
    const error = new Error('Challenge not found');
    mockChallengeRepo.update = vi.fn().mockRejectedValue(error);

    // Act & Assert
    await expect(useCase.execute(challengeId, updateInput)).rejects.toThrow('Challenge not found');
  });
});

// =================== FILE: src/application/use-cases/challenges/update-challenge.use-case.ts ===================

// filepath: src/application/use-cases/challenges/update-challenge.use-case.ts
import { IChallengeRepository, UpdateChallengeInput } from '@/core/repositories/challenge.repository';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { UpdateChallengeSchemaType } from '@/application/dto/challenge.schema';

export class UpdateChallengeUseCase {
  constructor(private readonly challengeRepository: IChallengeRepository) {}

  async execute(id: string, input: UpdateChallengeSchemaType): Promise<Challenge> {
    // 1. Validacions de negoci addicionals podrien anar aquí
    // (Ex: Comprovar si el repte existeix abans d'intentar update, 
    // tot i que el repositori ja llançarà error si no el troba).

    // 2. Adaptació de tipus (Zod -> Domain)
    const domainInput = input as unknown as UpdateChallengeInput;

    // 3. Persistència
    return await this.challengeRepository.update(id, domainInput);
  }
}

// =================== FILE: src/application/use-cases/dashboard/get-user-dashboard.use-case.ts ===================

// filepath: src/application/use-cases/dashboard/get-user-dashboard.use-case.ts
import { ITopicRepository } from "@/core/repositories/topic.repository";
import { DashboardTopicDTO } from "@/application/dto/dashboard-topic.dto";
import { SupabaseClient } from "@supabase/supabase-js"; 

// Nota: Normalment injectariem un IUserProgressRepository, 
// però per agilitzar la demo farem la consulta de progrés aquí o passarem el client.
// Per Clean Arch estricta, hauries de crear IUserProgressRepository.

export class GetUserDashboardUseCase {
  constructor(private topicRepository: ITopicRepository) {}

  async execute(userId: string, locale: string, supabaseClient: SupabaseClient): Promise<DashboardTopicDTO[]> {
    // 1. Obtenir tots els temes actius (traduïts)
    // Assumim que el teu repo ja suporta locale, si no, usa el que tinguis
    const topics = await this.topicRepository.findAllActive(); 

    // 2. Obtenir el progrés de l'usuari (Raw query a Supabase per velocitat)
    const { data: progressData } = await supabaseClient
        .from('user_progress')
        .select('topic_id, xp_earned')
        .eq('user_id', userId);

    // 3. Fusionar dades (Mapping)
    return topics.map(topic => {
        // Calculem XP total per aquest tema
        const topicProgress = progressData?.filter(p => p.topic_id === topic.id) || [];
        const totalXp = topicProgress.reduce((sum, p) => sum + (p.xp_earned || 0), 0);
        
        // Càlcul simplificat de percentatge (Ex: 1000 XP = 100%)
        // Més endavant ho farem comptant reptes totals vs reptes fets
        const percentage = Math.min(100, (totalXp / 500) * 100); 

        return {
            ...topic,
            progressPercentage: Math.round(percentage),
            totalXpEarned: totalXp,
            currentLevel: Math.floor(totalXp / 100) + 1,
            isLocked: false // Lògica futura de bloqueig
        };
    });
  }
}

// =================== FILE: src/application/use-cases/gamification/complete-session.use-case.test.ts ===================

// filepath: src/application/use-cases/gamification/complete-session.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { CompleteSessionUseCase } from './complete-session.use-case';
import { IUserRepository, UserProfile } from '@/core/repositories/user.repository';

// Mock del Repositori
const mockUserRepo = {
  findById: vi.fn(),
  saveProgress: vi.fn(),
  updateXp: vi.fn(),
} as unknown as IUserRepository;

describe('CompleteSessionUseCase', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should calculate XP, save progress and level up user', async () => {
    // ARRANGE (Preparem l'escenari)
    const userId = 'user-123';
    const challengeIds = ['c1', 'c2', 'c3']; // 3 reptes fets
    const topicId = 'topic-react';
    
    // Simulem un usuari que té 90 XP (i pujarà de nivell aviat)
    const mockUser: UserProfile = { 
      id: userId, 
      totalXp: 90, 
      level: 1 
    };

    vi.mocked(mockUserRepo.findById).mockResolvedValue(mockUser);

    const useCase = new CompleteSessionUseCase(mockUserRepo);

    // ACT (Executem)
    const result = await useCase.execute(userId, challengeIds, topicId);

    // ASSERT (Verifiquem)
    
    // 1. Ha de guanyar 30 XP (3 reptes * 10 XP)
    expect(result.xpEarned).toBe(30);
    
    // 2. XP Total: 90 + 30 = 120
    expect(result.newTotalXp).toBe(120);
    
    // 3. Com que supera els 100 XP, ha de ser Nivell 2
    expect(result.newLevel).toBe(2); 
    expect(result.leveledUp).toBe(true);

    // 4. Verifiquem que s'ha cridat al repositori per guardar
    expect(mockUserRepo.saveProgress).toHaveBeenCalledWith(userId, challengeIds, topicId, 10);
    expect(mockUserRepo.updateXp).toHaveBeenCalledWith(userId, 120, 2);
  });
});

// =================== FILE: src/application/use-cases/gamification/complete-session.use-case.ts ===================

// filepath: src/application/use-cases/gamification/complete-session.use-case.ts
import { IUserRepository } from '@/core/repositories/user.repository';
import { LevelCalculatorService } from '@/core/services/level-calculator.service';

export interface SessionResult {
  xpEarned: number;
  newTotalXp: number;
  newLevel: number;
  leveledUp: boolean;
}

export class CompleteSessionUseCase {
  private levelService = new LevelCalculatorService();

  constructor(private readonly userRepository: IUserRepository) {}

  async execute(userId: string, challengeIds: string[], topicId: string): Promise<SessionResult> {
    const XP_PER_CHALLENGE = 10;
    const totalXpEarned = challengeIds.length * XP_PER_CHALLENGE;

    // 1. Obtenim estat actual
    const userProfile = await this.userRepository.findById(userId);
    
    if (!userProfile) {
      throw new Error(`User ${userId} not found`);
    }

    // 2. Guardem el progrés detallat
    await this.userRepository.saveProgress(userId, challengeIds, topicId, XP_PER_CHALLENGE);

    // 3. Calculem nous valors
    const oldLevel = userProfile.level;
    const newTotalXp = userProfile.totalXp + totalXpEarned;
    const newLevel = this.levelService.calculateLevel(newTotalXp);

    // 4. Actualitzem el perfil si ha canviat alguna cosa
    if (newTotalXp !== userProfile.totalXp) {
        await this.userRepository.updateXp(userId, newTotalXp, newLevel);
    }

    return {
      xpEarned: totalXpEarned,
      newTotalXp,
      newLevel,
      leveledUp: newLevel > oldLevel
    };
  }
}

// =================== FILE: src/application/use-cases/topics/get-active-topics.use-case.ts ===================

// filepath: src/application/use-cases/topics/get-active-topics.use-case.ts
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { Topic } from '@/core/entities/topic.entity';

/**
 * Cas d'Ús: Obtenir el llistat de temes disponibles per als usuaris.
 * Només retorna els que tenen isActive: true.
 */
export class GetActiveTopicsUseCase {
  // Injectem la interfície, no la implementació de Supabase!
  constructor(private readonly topicRepository: ITopicRepository) {}

  async execute(): Promise<Topic[]> {
    return this.topicRepository.findAllActive();
  }
}

// =================== FILE: src/application/use-cases/topics/get-all-topics.use-case.ts ===================

// filepath: src/application/use-cases/topics/get-all-topics.use-case.ts
// CORRECCIÓ: Importem la interfície amb la "I"
import { ITopicRepository } from "@/core/repositories/topic.repository";
// CORRECCIÓ: Ruta plana, sense subdirectori 'topics/' si el fitxer està a l'arrel de entities
import { Topic } from "@/core/entities/topic.entity";

export class GetAllTopicsUseCase {
  // Injecció de dependència utilitzant la Interfície correcta
  constructor(private topicRepo: ITopicRepository) {}

  async execute(): Promise<Topic[]> {
    return await this.topicRepo.findAll();
  }
}

// =================== FILE: src/application/use-cases/topics/get-topic-path.use-case.ts ===================

// filepath: src/application/use-cases/topics/get-topic-path.use-case.ts
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { LevelNodeMapper } from '@/infrastructure/mappers/level-node.mapper';

export class GetTopicPathUseCase {
  constructor(private topicRepo: ITopicRepository) {}

  async execute(userId: string, topicId: string) {
    const stats = await this.topicRepo.getTopicProgressSummary(topicId, userId);
    
    // 1. Determinem quin és el "Current Tier" (el primer que NO està completat)
    // Si tots estan complets, el current és l'últim + 1.
    const lastCompletedStat = [...stats].reverse().find(s => s.completedChallenges >= s.totalChallenges && s.totalChallenges > 0);
    const maxTierReached = lastCompletedStat ? lastCompletedStat.tier : 0;
    const currentTier = maxTierReached + 1;

    const levels: LevelNodeDTO[] = [];
    
    // 2. Mapegem NOMÉS els nivells que tenim a la Base de Dades (stats)
    for (const stat of stats) {
      const isNextPlayable = stat.tier === currentTier;
      const node = LevelNodeMapper.toDTO(stat, currentTier, isNextPlayable);
      levels.push(node);
    }

    // 3. AFEGIM NOMÉS EL SEGÜENT NIVELL (si no existeix ja a stats)
    // Això evita mostrar el Boss 20 si estem al 8.
    // Només mostrarem el nivell on estàs ara, encara que estigui buit de dades de progrés.
    const hasCurrentInStats = levels.some(l => l.tier === currentTier);
    
    if (!hasCurrentInStats) {
        // Creem un node "fake" per al nivell on estem ara, perquè l'usuari vegi l'objectiu
        const fakeStat = {
            tier: currentTier,
            totalChallenges: 10, // Placeholder
            completedChallenges: 0,
            mostCommonType: 'QUIZ' as const // Default
        };
        // Aquí és on la màgia del Mapper detectarà si aquest 'currentTier' és un Boss o no
        levels.push(LevelNodeMapper.toDTO(fakeStat, currentTier, true));
    }

    // Calcular XP Total
    const totalXp = levels.reduce((acc, curr) => acc + (curr.completedChallenges * 10), 0);

    // Ordenem per tier per si de cas
    return { levels: levels.sort((a, b) => a.tier - b.tier), totalXp };
  }
}

// =================== FILE: src/application/use-cases/topics/__tests__/get-active-topics.use-case.test.ts ===================

// filepath: src/application/use-cases/topics/__tests__/get-active-topics.use-case.test.ts
import { describe, it, expect, vi } from 'vitest';
// 🔴 ABANS (MALAMENT): import { GetActiveTopicsUseCase } from "./get-active-topics.use-case";
// 🟢 ARA (CORRECTE): Pugem un nivell
import { GetActiveTopicsUseCase } from '../get-active-topics.use-case';
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { Topic } from '@/core/entities/topic.entity';

// ... resta del codi igual

// 1. Creem un Mock del Repositori
const mockTopicRepo = {
  findAllActive: vi.fn(),
  findAll: vi.fn(),
  findById: vi.fn(),
  findBySlug: vi.fn(),
  create: vi.fn(),
  update: vi.fn(),
} as unknown as ITopicRepository;

describe('GetActiveTopicsUseCase', () => {
  it('should return a list of active topics', async () => {
    // ARRANGE (Preparar)
    const mockTopics: Topic[] = [
      {
        id: '123',
        slug: 'react',

        // ❌ ELIMINAT: nameKey: 'topic.react', 

        // ✅ NOU: Afegim 'title' com a objecte LocalizedText
        title: {
          ca: 'React Basics',
          es: 'Fundamentos React',
          en: 'React Basics'
        },

        // ✅ ACTUALITZAT: 'description' ara és un objecte, no un string
        description: {
          ca: 'Descripció de prova',
          es: 'Descripción de prueba',
          en: 'Test Description'
        },

        iconName: 'react',
        colorTheme: 'blue',
        isActive: true,
        createdAt: new Date(),
        updatedAt: new Date()
      }
    ];

    // Configurem el mock per retornar les dades falses
    vi.mocked(mockTopicRepo.findAllActive).mockResolvedValue(mockTopics);

    const useCase = new GetActiveTopicsUseCase(mockTopicRepo);

    // ACT (Executar)
    const result = await useCase.execute();

    // ASSERT (Verificar)
    expect(result).toHaveLength(1);
    expect(result[0].slug).toBe('react');
    expect(mockTopicRepo.findAllActive).toHaveBeenCalledTimes(1);
  });

  it('should return empty list if no topics found', async () => {
    vi.mocked(mockTopicRepo.findAllActive).mockResolvedValue([]);
    const useCase = new GetActiveTopicsUseCase(mockTopicRepo);

    const result = await useCase.execute();

    expect(result).toEqual([]);
  });
});

// =================== FILE: src/application/use-cases/topics/__tests__/get-topic-path.use-case.test.ts ===================

// filepath: src/application/use-cases/topics/__tests__/get-topic-path.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { GetTopicPathUseCase } from '../get-topic-path.use-case';
import { ITopicRepository } from '@/core/repositories/topic.repository';

// Mock del Repositori
const mockTopicRepo = {
  getTopicProgressSummary: vi.fn(),
} as unknown as ITopicRepository;

describe('GetTopicPathUseCase', () => {
  let useCase: GetTopicPathUseCase;

  beforeEach(() => {
    useCase = new GetTopicPathUseCase(mockTopicRepo);
    vi.clearAllMocks();
  });

  it('hauria de generar una llista de nivells i detectar el BOSS al Tier 10', async () => {
    // ARRANGE: Simulem una seqüència a punt d'arribar al primer Boss (Tier 10)
    mockTopicRepo.getTopicProgressSummary = vi.fn().mockResolvedValue([
      { tier: 8, totalChallenges: 5, completedChallenges: 5, mostCommonType: 'TUTORIAL', mapConfig: null },
      { tier: 9, totalChallenges: 5, completedChallenges: 2, mostCommonType: 'CODE', mapConfig: null },
      
      // ✅ FIX: Afegim mapConfig al Tier 10
      { 
        tier: 10, 
        totalChallenges: 10, 
        completedChallenges: 0, 
        mostCommonType: 'QUIZ',
        mapConfig: {
           isBoss: true,
           bossTitle: "milestones.junior",
           bossIcon: "medal",
           bossColor: "bg-blue-500"
        }
      } 
    ]);

    // ACT
    const { levels, totalXp } = await useCase.execute('user-123', 'topic-abc');

    // ASSERT
    expect(levels).toHaveLength(3);
    
    // Nivell 8: Completat
    expect(levels[0].tier).toBe(8);
    expect(levels[0].status).toBe('COMPLETED');

    // Nivell 9: Actiu (Current Position)
    expect(levels[1].tier).toBe(9);
    expect(levels[1].status).toBe('ACTIVE');
    expect(levels[1].isCurrentPosition).toBe(true);

    // Nivell 10: Bloquejat i és BOSS (ara sí!)
    expect(levels[2].tier).toBe(10);
    expect(levels[2].status).toBe('LOCKED');
    expect(levels[2].isBoss).toBe(true); 
    expect(levels[2].bossTitleKey).toBeDefined();
    
    // XP Calculation check
    expect(totalXp).toBe(70); 
  });
});

// =================== FILE: src/core/entities/challenges/challenge.entitiy.test.ts ===================

// filepath: src/core/entities/challenges/challenge.entity.test.ts
import { describe, it, expect } from 'vitest';

// ✅ CORRECCIÓ 1: Importem des del './index' (Barrel File)
// Aquest fitxer agrupa totes les exportacions de la carpeta 'challenges'
import { Challenge, CodeFixContent } from './index'; 

describe('Challenge Entity Polymorphism', () => {
  
  it('should correctly type a CODE_FIX challenge', () => {
    // Arrange
    const codeChallenge: Challenge = {
      id: '1',
      topicId: 'react',
      difficultyTier: 1,
      type: 'CODE_FIX',
      createdAt: new Date(),
      content: {
        description: 'Completa el hook',
        initialCode: 'const [val, setVal] = ___(0);',
        solution: 'useState',
        tests: [],
        // ✅ CORRECCIÓ 2: Afegim camps obligatoris definits a la interfície
        hint: 'Pensa en el hook d\'estat',
        options: [] 
      } as CodeFixContent
    };

    // Act & Assert
    if (codeChallenge.type === 'CODE_FIX') {
        // TypeScript ara sap segur que és CodeFixContent gràcies a l'import correcte
        const content = codeChallenge.content as CodeFixContent;
        
        expect(content.initialCode).toContain('___');
        expect(content.solution).toBe('useState');
    } else {
        throw new Error('Type guard failed');
    }
  });
});

// =================== FILE: src/core/entities/challenges/challenge.entity.ts ===================

// 1. IMPORTEM I RE-EXPORTEM (Barrel Pattern)
// Això permet fer: import { TerminalContent } from './challenge.entity'
export * from './definitions/quiz.content';
export * from './definitions/code-fix.content';
export * from './definitions/matching.content';
export * from './definitions/terminal.content'; // ✅ Això soluciona el teu error
export * from './definitions/logic-order.content';
export * from './definitions/binary.content';
export * from './definitions/theory.content';
export * from './definitions/ctf.content';

// Importem localment per definir el tipus de la unió
import { QuizContent } from './definitions/quiz.content';
import { CodeFixContent } from './definitions/code-fix.content';
import { MatchingContent } from './definitions/matching.content';
import { TerminalContent } from './definitions/terminal.content';
import { LogicOrderContent } from './definitions/logic-order.content';
import { BinaryContent } from './definitions/binary.content';
import { TheoryContent } from './definitions/theory.content';
import { CtfContent } from './definitions/ctf.content';

export type ChallengeType = 
  | 'THEORY' 
  | 'QUIZ' 
  | 'CODE_FIX' 
  | 'MATCHING' 
  | 'TERMINAL' 
  | 'BINARY_DECISION'
  | 'CTF'
  | 'LOGIC_ORDER';

export type ChallengeContent = 
  | QuizContent 
  | CodeFixContent 
  | MatchingContent
  | TerminalContent 
  | LogicOrderContent
  | BinaryContent
  | TheoryContent
  | CtfContent;

export interface Challenge {
  id: string;
  topicId: string;
  difficultyTier: number;
  type: ChallengeType;
  content: ChallengeContent;
  createdAt: Date;
}

// =================== FILE: src/core/entities/challenges/definitions/binary.content.ts ===================

// filepath: src/core/entities/challenges/definitions/binary.content.ts
export interface BinaryContent {
  // Ara acceptem string (legacy) o Record (multidioma)
  statement: string | Record<string, string>; 
  isTrue: boolean;
  explanation: string | Record<string, string>;
  variant?: 'HOT_OR_NOT' | 'TRUE_FALSE';
}

// =================== FILE: src/core/entities/challenges/definitions/code-fix.content.ts ===================

// filepath: src/core/entities/challenges/definitions/code-fix.content.ts
export interface CodeFixOption {
  id: string;
  code: string;
  isCorrect: boolean;
}

export interface CodeFixContent {
  description: string;
  initialCode: string;
  solution: string;
  hint: string;
  tests: { input: string; output: string }[];
  options: CodeFixOption[];
}

// =================== FILE: src/core/entities/challenges/definitions/ctf.content.ts ===================

// filepath: src/core/entities/challenges/definitions/ctf.content.ts
import { LocalizedText } from './theory.content';

// Una "Flag" és un objectiu que l'usuari ha de trobar
export interface CtfFlag {
  id: string;
  name: LocalizedText;       // Ex: "Accés a la BD"
  description: LocalizedText; // Ex: "Troba la contrasenya de l'admin"
  secret: string;            // El text que han de trobar (ex: "flag{sql_master}")
  points: number;            // Punts per trobar-la
}

// Un fitxer virtual en el sistema
export interface VirtualFile {
  name: string;
  content: string; // Contingut del fitxer (ex: notes.txt)
  isLocked?: boolean; // Si necessita permisos per llegir-se
}

export interface CtfContent {
  missionTitle: LocalizedText;
  missionBriefing: LocalizedText; // La història introductòria
  
  // L'estat inicial de la màquina virtual
  initialFileSystem: VirtualFile[];
  
  // Les comandes vàlides que fan avançar la història
  validCommands: {
    commandRegex: string; // Ex: "^nmap .*"
    output: string;       // El que respon la terminal
    unlocksFile?: string; // Si aquesta comanda crea/revela un fitxer
    unlocksFlag?: string; // Si aquesta comanda descobreix una flag automàticament
  }[];

  flags: CtfFlag[];
}

// =================== FILE: src/core/entities/challenges/definitions/logic-order.content.ts ===================

// filepath: src/core/entities/challenges/definitions/logic-order.content.ts
import { ChallengeOption } from './shared';

export interface LogicOrderContent {
  description: string;    
  items: ChallengeOption[]; // Els items que arribaran DESORDENATS al client
}

// =================== FILE: src/core/entities/challenges/definitions/matching.content.ts ===================

// filepath: src/core/entities/challenges/definitions/matching.content.ts
import { ChallengeOption } from './shared';

export interface MatchingContent {
  instruction: string;
  pairs: { 
    left: ChallengeOption; 
    right: ChallengeOption 
  }[];
}

// =================== FILE: src/core/entities/challenges/definitions/quiz.content.ts ===================

// filepath: src/core/entities/challenges/definitions/quiz.content.ts
import { ChallengeOption } from './shared';

export interface QuizContent {
  question: string;
  explanation: string;
  options: ChallengeOption[]; 
  correctOptionIndex: number;
}

// =================== FILE: src/core/entities/challenges/definitions/shared.ts ===================

// filepath: src/core/entities/challenges/definitions/shared.ts
export interface ChallengeOption {
  id: string;
  text: string;
}

// =================== FILE: src/core/entities/challenges/definitions/terminal.content.ts ===================

// filepath: src/core/entities/challenges/definitions/terminal.content.ts
export interface TerminalContent {
  instruction: string;      
  initialCommand?: string;  
  validCommands: string[];  
  hint: string;             
  explanation: string;      
  outputParams: {
    success: string;        
    error: string;          
  };
}

// =================== FILE: src/core/entities/challenges/definitions/theory.content.ts ===================

// filepath: src/core/entities/challenges/definitions/theory.content.ts

// Tipus auxiliar per a textos multi-idioma
export type LocalizedText = { ca: string; es: string; en?: string };

// Blocs individuals
export interface BlockText {
  type: 'text';
  content: LocalizedText;
}

export interface BlockList {
  type: 'list';
  items: LocalizedText[];
}

export interface BlockCode {
  type: 'code';
  value: string;
  lang?: string;
}

export type TheoryBlock = BlockText | BlockList | BlockCode;

// El contingut principal
export interface TheoryContent {
  title: LocalizedText;
  blocks: TheoryBlock[];
}

// =================== FILE: src/core/entities/challenges/index.ts ===================

// filepath: src/core/entities/challenges/index.ts
export * from './definitions/shared';
export * from './definitions/quiz.content';
export * from './definitions/code-fix.content';
export * from './definitions/matching.content';
export * from './definitions/terminal.content';
export * from './definitions/logic-order.content';
export * from './definitions/binary.content'; // 👈 AFEGIT
export * from './challenge.entity';

// =================== FILE: src/core/entities/topic.entity.ts ===================

// filepath: src/core/entities/topic.entity.ts
// Definim una interfície reutilitzable per a textos multi-idioma
export interface LocalizedText {
  ca: string;
  es: string;
  en: string;
  [key: string]: string; // Per si afegeixes més idiomes futur
}
/**
 * Representa una categoria o àrea d'aprenentatge dins del sistema.
 * Aquesta entitat és agnòstica a la base de dades.
 */
export interface Topic {
  id: string;              // UUID
  slug: string;            // URL friendly ID (ex: 'react-basics')
  // nameKey: string; ❌ ELIMINAT
  title: LocalizedText; // ✅ NOU: Guardem els 3 idiomes
  description: LocalizedText; // ✅ NOU
  iconName: string;        // Identificador de la icona (ex: 'brand-react')
  colorTheme: string;      // Classe CSS o Hex (ex: 'bg-blue-500')
  parentTopicId?: string;  // Opcional: Per a jerarquies
  isActive: boolean;       // Per a soft-deletes i control de visibilitat
  // Metadades d'auditoria (opcionals al domini pur, però útils)
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Tipus per a la creació d'un nou tema (sense ID ni dates)
 */
export type CreateTopicInput = Omit<Topic, 'id' | 'createdAt' | 'updatedAt'>;

// =================== FILE: src/core/errors/auth.error.ts ===================

// filepath: src/core/errors/auth.errors.ts

/**
 * Error base del domini per a problemes d'autenticació/autorització.
 */
export class DomainAuthError extends Error {
  constructor(message: string) {
    super(message);
    this.name = 'DomainAuthError';
  }
}

/**
 * Llançat quan l'usuari no està identificat (No hi ha sessió).
 * Equival a un 401 Unauthorized.
 */
export class AuthenticationError extends DomainAuthError {
  constructor(message: string = 'Usuari no autenticat.') {
    super(message);
    this.name = 'AuthenticationError';
  }
}

/**
 * Llançat quan l'usuari està identificat però no té permisos.
 * Equival a un 403 Forbidden.
 */
export class UnauthorizedError extends DomainAuthError {
  constructor(message: string = 'Accés denegat: Permisos insuficients.') {
    super(message);
    this.name = 'UnauthorizedError';
  }
}

// =================== FILE: src/core/errors/domain-error.ts ===================

// filepath: src/core/errors/domain-error.ts
export abstract class DomainError extends Error {
  constructor(message: string) {
    super(message);
    this.name = this.constructor.name;
    Object.setPrototypeOf(this, new.target.prototype);
  }
}

// =================== FILE: src/core/errors/topic.errors.ts ===================

// filepath: src/core/errors/topic.errors.ts
import { DomainError } from './domain-error';

export class TopicNotFoundError extends DomainError {
  constructor(identifier: string) {
    super(`El tema amb identificador '${identifier}' no s'ha trobat.`);
  }
}

export class TopicAlreadyExistsError extends DomainError {
  constructor(slug: string) {
    super(`Ja existeix un tema amb l'slug '${slug}'.`);
  }
}

// =================== FILE: src/core/errors/user-not-found.error.ts ===================

// filepath: src/core/errors/user-not-found.error.ts
export class UserNotFoundError extends Error {
  constructor(userId: string) {
    super(`User with ID ${userId} could not be found.`);
    this.name = 'UserNotFoundError';
  }
}

// =================== FILE: src/core/repositories/challenge.repository.ts ===================

// filepath: src/core/repositories/challenge.repository.ts
import { Challenge } from '../entities/challenges/challenge.entity';

// Definim DTOs derivats de l'entitat per no repetir codi
export type CreateChallengeInput = Omit<Challenge, 'id' | 'createdAt'>;
export type UpdateChallengeInput = Partial<Omit<Challenge, 'id' | 'createdAt'>>;

export interface IChallengeRepository {
  // --- LECTURA (GAME LOOP) ---
  /**
   * Obté el següent repte per a un usuari en un tema,
   * traduït a l'idioma especificat.
   */
  findNextForUser(topicId: string, userId: string, locale: string, difficulty: number): Promise<Challenge[]>;

  findByTopicId(topicId: string, locale: string): Promise<Challenge[]>;
  findById(id: string, locale: string): Promise<Challenge | null>;

  // --- ESCRIPTURA (ADMIN - CMS) ---
  // Nota: Retornem l'Entitat creada/actualitzada. 
  // Acceptem un locale opcional per al retorn (per defecte 'ca'), 
  // encara que al CMS solem treballar amb dades "raw" o l'idioma base.
  
  create(data: CreateChallengeInput): Promise<Challenge>;
  update(id: string, data: UpdateChallengeInput): Promise<Challenge>;
  delete(id: string): Promise<void>;
}

// =================== FILE: src/core/repositories/topic.repository.ts ===================

// filepath: src/core/repositories/topic.repository.ts
import { Topic, CreateTopicInput } from '../entities/topic.entity';
import { ChallengeType } from '../entities/challenges/challenge.entity';
// 1. ✅ DEFINIM EL TIPUS EXPLICIT (Ja no és anònim)
export interface MapConfig {
  isBoss: boolean;
  bossTitle?: string;
  bossIcon?: string;
  bossColor?: string;
}
export interface TierProgressStats {
  tier: number;
  totalChallenges: number;
  completedChallenges: number;
  mostCommonType: ChallengeType;
  // 2. ✅ L'USEM AQUÍ
  mapConfig?: MapConfig | null;
}

export interface ITopicRepository {
  findAllActive(): Promise<Topic[]>;
  findAll(): Promise<Topic[]>; // Aquest és el que fallava
  findById(id: string): Promise<Topic | null>;
  findBySlug(slug: string): Promise<Topic | null>;
  create(topic: CreateTopicInput): Promise<Topic>;
  update(id: string, topic: Partial<CreateTopicInput>): Promise<Topic>;
  getTopicProgressSummary(topicId: string, userId: string): Promise<TierProgressStats[]>;
  delete(id: string): Promise<void>;
}

// =================== FILE: src/core/repositories/user.repository.ts ===================

// filepath: src/core/repositories/user.repository.ts
export interface UserProfile {
  id: string;
  totalXp: number;
  level: number;
}

export interface IUserRepository {
  findById(userId: string): Promise<UserProfile | null>;
  saveProgress(userId: string, challengeIds: string[], topicId: string, xpPerChallenge: number): Promise<void>;
  updateXp(userId: string, newXp: number, newLevel: number): Promise<void>;
}

// =================== FILE: src/core/services/auth.service.ts ===================

// filepath: src/core/services/auth.service.ts
export interface UserIdentity {
  id: string;
  email: string;
}

export interface IAuthService {
  logout(): Promise<void>;
  getUser(): Promise<UserIdentity | null>;
  // Login i Register els gestiona Supabase directament via Actions, 
  // però el Logout és millor passar-lo per aquí per neteja.
}

// =================== FILE: src/core/services/level-calculator.service.ts ===================

// filepath: src/core/services/level-calculator.service.ts
export class LevelCalculatorService {
  /**
   * Fórmula simple: Nivell = (TotalXP / 100) + 1
   * 0-99 XP -> Nivell 1
   * 100-199 XP -> Nivell 2
   */
  calculateLevel(totalXp: number): number {
    if (totalXp < 0) return 1;
    return Math.floor(totalXp / 100) + 1;
  }

  /**
   * Calcula el % de progrés cap al següent nivell.
   */
  calculateProgressToNextLevel(totalXp: number): number {
    const currentLevel = this.calculateLevel(totalXp);
    const xpForCurrentLevel = (currentLevel - 1) * 100;
    const xpInCurrentLevel = totalXp - xpForCurrentLevel;
    
    return Math.min(100, Math.max(0, xpInCurrentLevel));
  }
}

// =================== FILE: src/core/utils/i18n-utils.ts ===================

// src/core/utils/i18n-utils.ts
import { LocalizedText } from '@/core/entities/topic.entity';

export function getLocalizedText(obj: LocalizedText | null, locale: string): string {
  if (!obj) return '';
  // 1. Retorna l'idioma actual
  // 2. Si no existeix, retorna 'ca' (o 'en') com a fallback
  // 3. Si no, retorna string buit
  return obj[locale] || obj['ca'] || obj['en'] || '';
}

// =================== FILE: src/i18n.ts ===================

// filepath: src/i18n.ts
import { notFound } from 'next/navigation';
import { getRequestConfig } from 'next-intl/server';
import { routing, type Locale } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  const locale = await requestLocale;

  // Validació sense 'any':
  // Convertim routing.locales a llista d'strings genèrics per comprovar
  if (!locale || !(routing.locales as readonly string[]).includes(locale)) {
    notFound(); // Ara sí que l'executem si la validació falla
  }

  return {
    // Aquí ja estem segurs que 'locale' és vàlid, podem fer el cast segur a Locale
    locale: locale as Locale,
    messages: (await import(`../messages/${locale}.ts`)).default
  };
});

// =================== FILE: src/infrastructure/mappers/challenge.mappers.ts ===================

// filepath: src/infrastructure/mappers/challenge.mappers.ts
import { ChallengeContent } from '@/core/entities/challenges/challenge.entity';
import { translate, LocalizedString } from './mapper.utils';
// IMPORTA ELS TIPUS ESPECÍFICS DE TEORIA
import {
  TheoryContent,
  TheoryBlock,
  LocalizedText
} from '@/core/entities/challenges/definitions/theory.content';
import { CtfContent, VirtualFile } from '@/core/entities/challenges/definitions/ctf.content';

// --- DEFINICIONS DE DADES "RAW" (JSON de la BD) ---
// --- HELPER DE CONVERSIÓ ---
// Transforma el tipus "Raw" (que pot ser qualsevol cosa) al tipus "Domain" (Estricte)
function toDomainText(raw: LocalizedString | undefined): LocalizedText {
  // Forcem un cast a Record per accedir a les claus de manera segura
  const r = (raw || {}) as Record<string, string>;
  return {
    ca: r.ca || '', // Assegurem que sempre hi ha string
    es: r.es || '',
    en: r.en // Opcional
  };
}
interface RawOption {
  id: string;
  text: LocalizedString;
}

interface RawQuizContent {
  question: LocalizedString;
  explanation: LocalizedString;
  options: RawOption[];
  correctOptionIndex: number;
}

interface LegacyRawQuizContent {
  question?: string;
  explanation?: string;
  options?: string[];
  correctOptionIndex?: number;
}

interface RawMatchingContent {
  instruction: LocalizedString;
  pairs: Array<{
    left: { id: string; text: LocalizedString };
    right: { id: string; text: LocalizedString };
  }>;
}

interface RawCodeFixContent {
  description: LocalizedString;
  initialCode: string;
  solution: string;
  hint: LocalizedString;
  tests?: Array<{ input: string; output: string }>;
  options: Array<{
    id: string;
    code: string;
    isCorrect: boolean;
  }>;
}

interface RawTerminalContent {
  instruction: LocalizedString;
  initialCommand?: string;
  validCommands: string[];
  hint: LocalizedString;
  explanation: LocalizedString;
  outputParams: {
    success: string;
    error: string;
  };
}

interface RawLogicOrderContent {
  description: LocalizedString;
  items: Array<{ id: string; text: LocalizedString }>;
}

interface RawBinaryContent {
  statement: LocalizedString;
  isTrue: boolean;
  explanation: LocalizedString;
  variant?: 'HOT_OR_NOT' | 'TRUE_FALSE';
}

// Actualitza la interfície RawTheoryBlock per usar LocalizedString (com ve de la BD/Utils)
interface RawTheoryBlock {
  type: 'text' | 'list' | 'code';
  content?: LocalizedString;
  items?: LocalizedString[];
  value?: string;
  lang?: string;
}

interface RawTheoryContent {
  title: LocalizedString;
  blocks: RawTheoryBlock[];
}

// --- INTERFÍCIE D'ESTRATÈGIA ---
interface ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent;
}
// 1. DEFINIR LES INTERFÍCIES "RAW" (El que ve del JSON de la BD)
interface RawCtfCommand {
  commandRegex: string;
  output: string;
  unlocksFile?: string;
  unlocksFlag?: string;
}

interface RawCtfFlag {
  id: string;
  name: LocalizedString;
  description: LocalizedString;
  secret: string;
  points?: number;
}

interface RawCtfContent {
  missionTitle: LocalizedString;
  missionBriefing: LocalizedString;
  initialFileSystem: VirtualFile[];
  validCommands: RawCtfCommand[]; // 👈 Ja no és any[]
  flags: RawCtfFlag[];            // 👈 Ja no és any[]
}
// --- MAPPERS EXISTENTS ---

class QuizMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as Partial<RawQuizContent>;
    const legacyContent = rawData as Partial<LegacyRawQuizContent>;

    const isNewFormat =
      content.options &&
      Array.isArray(content.options) &&
      content.options.length > 0 &&
      typeof content.options[0] === 'object';

    if (isNewFormat) {
      const validContent = content as RawQuizContent;
      return {
        question: translate(validContent.question, locale),
        explanation: translate(validContent.explanation, locale),
        correctOptionIndex: validContent.correctOptionIndex || 0,
        options: validContent.options.map((opt) => ({
          id: opt.id,
          text: translate(opt.text, locale)
        }))
      };
    } else {
      const opts = legacyContent.options || [];
      return {
        question: String(legacyContent.question || ''),
        explanation: String(legacyContent.explanation || ''),
        correctOptionIndex: legacyContent.correctOptionIndex || 0,
        options: Array.isArray(opts) ? opts.map((txt, idx) => ({
          id: `opt-${idx}`,
          text: String(txt)
        })) : []
      };
    }
  }
}

class MatchingMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawMatchingContent;
    return {
      instruction: translate(content.instruction, locale),
      pairs: Array.isArray(content.pairs)
        ? content.pairs.map((p) => ({
          left: { id: p.left.id, text: translate(p.left.text, locale) },
          right: { id: p.right.id, text: translate(p.right.text, locale) }
        }))
        : []
    };
  }
}

class CodeFixMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawCodeFixContent;
    return {
      description: translate(content.description, locale),
      initialCode: content.initialCode || '',
      solution: content.solution || '',
      hint: translate(content.hint, locale),
      tests: content.tests || [],
      options: Array.isArray(content.options) ? content.options.map((opt) => ({
        id: opt.id,
        code: opt.code,
        isCorrect: opt.isCorrect
      })) : []
    };
  }
}

class TerminalMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawTerminalContent;
    return {
      instruction: translate(content.instruction, locale),
      initialCommand: content.initialCommand || '',
      validCommands: Array.isArray(content.validCommands) ? content.validCommands : [],
      hint: translate(content.hint, locale),
      explanation: translate(content.explanation, locale),
      outputParams: {
        success: content.outputParams?.success || 'OK',
        error: content.outputParams?.error || 'Error'
      }
    };
  }
}

class LogicOrderMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawLogicOrderContent;
    return {
      description: translate(content.description, locale),
      items: Array.isArray(content.items)
        ? content.items.map(item => ({
          id: item.id,
          text: translate(item.text, locale)
        }))
        : []
    };
  }
}

class BinaryMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawBinaryContent;
    return {
      statement: translate(content.statement, locale),
      explanation: translate(content.explanation, locale),
      isTrue: content.isTrue,
      variant: content.variant || 'TRUE_FALSE'
    };
  }
}

// ✅ 2. NOU MAPPER PER A THEORY (CORREGIT)
class TheoryMapper implements ContentMapperStrategy {
  // FIX 1: Usem '_locale' per indicar que no el fem servir aquí (evita l'error eslint)
  map(rawData: unknown, _locale: string): ChallengeContent {
    const content = rawData as RawTheoryContent;

    // Mapegem els blocs convertint 'LocalizedString' -> 'LocalizedText'
    const blocks: TheoryBlock[] = Array.isArray(content.blocks)
      ? content.blocks.map((block): TheoryBlock => {

        if (block.type === 'text') {
          return {
            type: 'text',
            // FIX 2: Usem la funció auxiliar per convertir tipus
            content: toDomainText(block.content)
          };
        }

        if (block.type === 'list') {
          return {
            type: 'list',
            // FIX 2: Mapegem l'array d'items
            items: (block.items || []).map(toDomainText)
          };
        }

        if (block.type === 'code') {
          return {
            type: 'code',
            value: block.value || '',
            lang: block.lang
          };
        }

        // Fallback segur
        return { type: 'text', content: { ca: '', es: '' } };
      })
      : [];

    return {
      title: toDomainText(content.title),
      blocks: blocks
    } as TheoryContent;
  }
}
// 2. MAPPER TIPAT
class CtfMapper implements ContentMapperStrategy {
  map(rawData: unknown, _locale: string): ChallengeContent {
    const content = rawData as RawCtfContent;

    return {
      missionTitle: toDomainText(content.missionTitle),
      missionBriefing: toDomainText(content.missionBriefing),
      initialFileSystem: content.initialFileSystem || [],
      
      // Ara TS sap que 'cmd' és un RawCtfCommand
      validCommands: Array.isArray(content.validCommands) ? content.validCommands : [],
      
      // Ara TS sap que 'f' és un RawCtfFlag
      flags: Array.isArray(content.flags) ? content.flags.map((f) => ({
        id: f.id,
        name: toDomainText(f.name),
        description: toDomainText(f.description),
        secret: f.secret,
        points: f.points || 10
      })) : []
    } as CtfContent;
  }
}
// --- FACTORY ---
export const ChallengeMapperFactory = {
  getMapper(type: string): ContentMapperStrategy {
    switch (type) {
      case 'QUIZ': return new QuizMapper();
      case 'MATCHING': return new MatchingMapper();
      case 'CODE_FIX': return new CodeFixMapper();
      case 'TERMINAL': return new TerminalMapper();
      case 'LOGIC_ORDER': return new LogicOrderMapper();
      case 'BINARY_DECISION': return new BinaryMapper();

      // ✅ 3. REGISTREM EL NOU TIPUS
      case 'THEORY': return new TheoryMapper();
      case 'CTF': return new CtfMapper();


      default:
        console.warn(`Unknown challenge type: ${type}. Fallback to Quiz.`);
        return new QuizMapper();
    }
  }
};

// =================== FILE: src/infrastructure/mappers/level-node.mapper.ts ===================

// filepath: src/infrastructure/mappers/level-node.mapper.ts
import { LevelNodeDTO, LevelStatus } from '@/application/dto/level-node.dto';
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';
import { TierProgressStats } from '@/core/repositories/topic.repository';

export class LevelNodeMapper {
  static toDTO(
    stat: TierProgressStats, 
    currentTier: number,
    isNextPlayable: boolean
  ): LevelNodeDTO {
    
    const tier = Number(stat.tier);
    
    // ✅ FIX: Eliminem "|| {}" perquè això feia que TypeScript pensés que era un objecte buit.
    // Simplement accedim a stat.mapConfig directament.
    const config = stat.mapConfig; 
    
    // Si config és null/undefined, l'operador ?. retorna undefined.
    // !!undefined es converteix en false.
    const isBoss = !!config?.isBoss;

    // 2. Lògica d'Estat (Sense canvis)
    let status: LevelStatus = 'LOCKED';
    if (stat.completedChallenges >= stat.totalChallenges && stat.totalChallenges > 0) {
      status = 'COMPLETED';
    } else if (isNextPlayable) {
      status = 'ACTIVE';
    }

    return {
      tier: tier,
      status: status,
      label: isBoss ? 'BOSS LEVEL' : `Nivell ${tier}`,
      
      totalChallenges: stat.totalChallenges,
      completedChallenges: stat.completedChallenges,
      
      isCurrentPosition: tier === currentTier,
      predominantType: (stat.mostCommonType as ChallengeType) || 'QUIZ',
      
      // ✅ 3. FIX: Accedim a totes les propietats amb ?. (Optional Chaining)
      // Si config és null, aquestes propietats seran undefined, que és vàlid per al DTO.
      isBoss: isBoss,
      bossTitleKey: config?.bossTitle, 
      bossColorClass: config?.bossColor,
      bossIconName: config?.bossIcon 
    };
  }
}

// =================== FILE: src/infrastructure/mappers/mapper.utils.ts ===================

// filepath: src/infrastructure/mappers/mapper.utils.ts

export type LocalizedString = Record<string, string>;

/**
 * Tradueix un camp que pot ser string, objecte localitzat o null/unknown.
 */
export function translate(field: unknown, locale: string): string {
  if (typeof field === 'string') return field;
  
  if (!field || typeof field !== 'object') return '';

  // Fem un cast segur perquè sabem que és un objecte, 
  // però accedim amb comprovació de claus
  const localized = field as Record<string, unknown>;
  
  const val = localized[locale] || localized['ca'] || localized['en'] || Object.values(localized)[0];
  
  return typeof val === 'string' ? val : '';
}

/**
 * Parsea el JSON de forma segura retornant 'unknown' en lloc de 'any'.
 * Això obliga a qui ho usi a definir el tipus esperat.
 */
export function parseJsonContent(content: unknown): unknown {
  if (typeof content === 'string') {
    try {
      return JSON.parse(content);
    } catch (e) {
      console.error('Error parsing JSON content', e);
      return {};
    }
  }
  return content || {};
}

// =================== FILE: src/infrastructure/mappers/__tests__/level-node.mapper.test.ts ===================

// filepath: src/infrastructure/mappers/__tests__/level-node.mapper.test.ts
import { describe, it, expect } from 'vitest';
import { LevelNodeMapper } from '../level-node.mapper';
import { TierProgressStats } from '@/core/repositories/topic.repository';
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';

describe('LevelNodeMapper', () => {
  const mockStat: TierProgressStats = {
    tier: 1,
    totalChallenges: 10,
    completedChallenges: 0,
    mostCommonType: 'QUIZ' as ChallengeType,
    mapConfig: null // Per defecte no hi ha config
  };

  it('hauria de marcar status LOCKED si no és playable i no completat', () => {
    const dto = LevelNodeMapper.toDTO(mockStat, 5, false);
    expect(dto.status).toBe('LOCKED');
  });

  it('hauria de marcar status ACTIVE si isNextPlayable és true', () => {
    const dto = LevelNodeMapper.toDTO(mockStat, 1, true);
    expect(dto.status).toBe('ACTIVE');
  });

  it('hauria de detectar un BOSS al Tier 10 (Junior)', () => {
    // ARRANGE: Creem un stat pel tier 10 AMB CONFIGURACIÓ
    const bossStat = { 
      ...mockStat, 
      tier: 10,
      // ✅ FIX: Afegim la configuració simulada que vindria de la BD
      mapConfig: {
        isBoss: true,
        bossTitle: "milestones.junior",
        bossIcon: "medal",
        bossColor: "bg-blue-500 shadow-blue-500/50"
      }
    }; 
    
    // ACT
    const dto = LevelNodeMapper.toDTO(bossStat, 10, true);
    
    // ASSERT
    expect(dto.isBoss).toBe(true);
    expect(dto.bossTitleKey).toBe("milestones.junior");
    expect(dto.bossIconName).toBe("medal");
    expect(dto.bossColorClass).toContain("bg-blue-500");
  });

  it('hauria de detectar un BOSS al Tier 20 (Senior)', () => {
    const bossStat = { 
      ...mockStat, 
      tier: 20,
      // ✅ FIX: Config per al Senior
      mapConfig: {
        isBoss: true,
        bossTitle: "milestones.senior",
        bossIcon: "trophy",
        bossColor: "bg-orange-500"
      }
    };

    const dto = LevelNodeMapper.toDTO(bossStat, 20, true);
    
    expect(dto.isBoss).toBe(true);
    expect(dto.bossTitleKey).toBe("milestones.senior");
    expect(dto.bossIconName).toBe("trophy");
  });

  it('NO hauria de detectar Boss al Tier 5 (antic boss)', () => {
    const normalStat = { ...mockStat, tier: 5, mapConfig: null };
    const dto = LevelNodeMapper.toDTO(normalStat, 5, true);
    expect(dto.isBoss).toBe(false);
  });
});

// =================== FILE: src/infrastructure/mappers/__tests__/TerminalMapper.test.ts ===================

// filepath: src/infrastructure/mappers/__tests__/TerminalMapper.test.ts
import { describe, it, expect } from 'vitest';
import { ChallengeMapperFactory } from '../challenge.mappers';
import { TerminalContent } from '@/core/entities/challenges/challenge.entity';

describe('TerminalMapper', () => {
    const mapper = ChallengeMapperFactory.getMapper('TERMINAL');

    it('hauria de mapejar un JSON complet correctament al català', () => {
        const rawData = {
            instruction: { ca: 'Fes això', en: 'Do this' },
            initialCommand: 'docker',
            validCommands: ['docker ps', 'docker ls'],
            hint: { ca: 'Pista', en: 'Hint' },
            explanation: { ca: 'Explicació', en: 'Expl' },
            outputParams: { success: 'Ok', error: 'Fail' }
        };

        const result = mapper.map(rawData, 'ca') as TerminalContent;

        expect(result).toEqual({
            instruction: 'Fes això',
            initialCommand: 'docker',
            validCommands: ['docker ps', 'docker ls'],
            hint: 'Pista',
            explanation: 'Explicació',
            outputParams: { success: 'Ok', error: 'Fail' }
        });
    });

    it('hauria de fer fallback a langlès o valors per defecte si falta traducció', () => {
        const rawData = {
            instruction: { en: 'Do this' }, // No hi ha 'ca'
            
            // CORRECCIÓ: Posem comandes reals. Si posem null, el mapper retornarà [], no 2.
            // Volem provar que SI hi ha comandes, es mantenen encara que falti la traducció.
            validCommands: ['ls -la', 'ls -l -a'], 
            
            outputParams: {}
        };

        const result = mapper.map(rawData, 'ca') as TerminalContent;

        // Ara sí que té sentit esperar 2 comandes
        expect(result.validCommands).toHaveLength(2); 
        expect(result.instruction).toBe('Do this'); // Fallback a anglès
        expect(result.validCommands[0]).toBe('ls -la');
    });

    it('hauria de gestionar inputs corruptes sense llançar excepció', () => {
        const rawCorrupt = "Això no és un objecte";
        const result = mapper.map(rawCorrupt, 'ca');
        expect(result).toBeDefined();
        expect(result).toHaveProperty('instruction');
    });
});

// =================== FILE: src/infrastructure/repositories/supabase/challenge.repository.test.ts ===================

// filepath: src/infrastructure/repositories/supabase/challenge.repository.test.ts
import { describe, it, expect, vi } from 'vitest';
import { SupabaseChallengeRepository } from './challenge.repository';
import { QuizContent } from '@/core/entities/challenges/challenge.entity';
// Importem el client "RAW" de l'SDK oficial, no el nostre wrapper de Next.js
import { createClient as createRawSupabaseClient } from '@supabase/supabase-js';

// --- 1. CONFIGURACIÓ DE L'ENTORN DE TEST ---

// Necessitem l'URL i la Key. En test, solem usar la SERVICE_ROLE_KEY per saltar-nos les RLS i poder crear/esborrar dades lliurement.
// Si no tens SERVICE_ROLE_KEY al .env.test, usa l'ANON_KEY, però assegura't que les RLS permeten escriptura.
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || '';
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';

if (!SUPABASE_URL || !SUPABASE_KEY) {
  throw new Error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in .env.test');
}

// Creem un client real que funciona en Node (sense cookies)
const testClient = createRawSupabaseClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    persistSession: false, // No volem guardar sessió en disc durant els tests
  }
});

// --- 2. MOCK MÀGIC (DEPENDENCY INJECTION) ---
// Aquí diem: "Quan algú importi '@/infrastructure/utils/supabase/server',
// NO executis el codi real (que peta per les cookies).
// Retorna aquest objecte en el seu lloc."
vi.mock('@/infrastructure/utils/supabase/server', () => ({
  createClient: async () => testClient
}));

// --- 3. EL TEST ---

describe('SupabaseChallengeRepository (REAL DB INTEGRATION)', () => {
  // El repositori farà servir internament el nostre 'testClient' gràcies al mock
  const repository = new SupabaseChallengeRepository();

  it('should store and retrieve a localized JSONB challenge correctly', async () => {
    // A. SETUP: Creem les dades usant el client de test directament
    const topicId = '11111111-1111-4111-8111-111111111111';
    const challengeId = '22222222-2222-4222-8222-222222222222';
    const testSlug = 'integration-test-topic'; // Constant per evitar typos
    const userId = 'user-test-123';

    // 🔥 NETEJA AGRESSIVA (Idempotència)
    // Esborrem primer pel conflicte únic (slug) i després per ID.
    // Això garanteix que la taula està neta abans de començar, passi el que passi.
    await testClient.from('challenges').delete().eq('id', challengeId);
    await testClient.from('topics').delete().eq('slug', testSlug);
    await testClient.from('topics').delete().eq('id', topicId);

    // Crear Tema
    const { error: topicError } = await testClient.from('topics').insert({
      id: topicId,
      slug: 'integration-test-topic',
      name_key: 'test',
      icon_name: 'test',
      color_theme: 'red',
      is_active: true
    });
    if (topicError) throw new Error(`Error creating topic: ${topicError.message}`);

    // Crear Repte
    const { error: challengeError } = await testClient.from('challenges').insert({
      id: challengeId,
      topic_id: topicId,
      difficulty_tier: 1,
      type: 'QUIZ',
      content: {
        question: { en: 'Hello?', ca: 'Hola?' },
        explanation: { en: 'Yes', ca: 'Si' },
        options: [{ id: '1', text: { en: 'A', ca: 'A' } }],
        correctOptionIndex: 0
      },
      created_at: new Date().toISOString()
    });
    if (challengeError) throw new Error(`Error creating challenge: ${challengeError.message}`);

    // B. ACT: Provem el Repositori
    // Aquesta crida internament farà `await createClient()` que retornarà el nostre `testClient`
    const result = await repository.findNextForUser(topicId, userId, 'en', 1);

    // C. ASSERT
    expect(result).toHaveLength(1);
    const challenge = result[0];
    const content = challenge.content as QuizContent;

    expect(challenge.id).toBe(challengeId);
    expect(content.question).toBe('Hello?');

    // D. CLEANUP
    await testClient.from('challenges').delete().eq('id', challengeId);
    await testClient.from('topics').delete().eq('id', topicId);
  });
});

// =================== FILE: src/infrastructure/repositories/supabase/challenge.repository.ts ===================

// filepath: src/infrastructure/repositories/supabase/challenge.repository.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { IChallengeRepository, CreateChallengeInput, UpdateChallengeInput } from '@/core/repositories/challenge.repository';
import { Challenge, ChallengeType } from '@/core/entities/challenges/challenge.entity';
import { parseJsonContent } from '@/infrastructure/mappers/mapper.utils';
import { ChallengeMapperFactory } from '@/infrastructure/mappers/challenge.mappers';

// Tipus intern per al insert/update de Supabase
type ChallengePersistencePayload = {
  topic_id?: string;
  difficulty_tier?: number;
  type?: string;
  content?: unknown; // JSONB
};

type ChallengeRow = {
  id: string;
  topic_id: string;
  difficulty_tier: number;
  type: string;
  content: unknown;
  created_at: string;
};
// 1. DTO de Retorn (El que la UI espera)
export interface AdminChallengeSummary {
  id: string;
  difficultyTier: number;
  type: string;
  createdAt: string;
  topicSlug: string;
}
// 1. DEFINICIÓ STRICTA DE LA RESPOSTA DE SUPABASE
// Aquesta interfície reflecteix exactament els camps que demanes al .select()
interface ChallengeWithTopicResponse {
  id: string;
  difficulty_tier: number;
  type: string;
  created_at: string;
  // Com que és un JOIN (!inner), Supabase retorna un objecte per a la relació 'topics'
  topics: {
    id: string;
    slug: string;
  } | null; // Pot ser null si falla la relació, encara que !inner ho força.
}

export interface PaginatedChallenges {
  data: AdminChallengeSummary[];
  total: number;
  totalPages: number;
}
export class SupabaseChallengeRepository implements IChallengeRepository {

  // Aquesta funció ara és super neta gràcies al patró Strategy
  private mapToEntity(row: ChallengeRow, locale: string): Challenge {
    const rawData = parseJsonContent(row.content);
    // Usem el mapper per assegurar que el JSON de la BD compleix l'estructura del Domini
    const mapper = ChallengeMapperFactory.getMapper(row.type);

    // Deleguem la complexitat al mapper específic
    const localizedContent = mapper.map(rawData, locale);

    return {
      id: row.id,
      topicId: row.topic_id,
      difficultyTier: row.difficulty_tier,
      type: row.type as ChallengeType,
      content: localizedContent,
      createdAt: new Date(row.created_at),
    };
  }

  // --- PUBLIC METHODS: LECTURA (GAME) ---

  async findNextForUser(topicId: string, userId: string, locale: string, difficulty: number): Promise<Challenge[]> {
    const supabase = await createClient();

    // 1. Obtenir IDs completats
    const { data: completed } = await supabase
      .from('user_progress')
      .select('challenge_id')
      .eq('user_id', userId)
      .eq('topic_id', topicId);

    const completedIds = completed?.map(c => c.challenge_id) || [];

    // 2. Buscar reptes no completats
    let query = supabase
      .from('challenges')
      .select('*')
      .eq('topic_id', topicId)
      .eq('difficulty_tier', difficulty);

    if (completedIds.length > 0) {
      // Nota: filter amb not.in espera una llista formatada per a PostgREST
      query = query.filter('id', 'not.in', `(${completedIds.join(',')})`);
    }

    const { data: newChallenges } = await query.limit(10);

    if (newChallenges && newChallenges.length > 0) {
      return newChallenges.map(row => this.mapToEntity(row as ChallengeRow, locale));
    }

    // 3. Fallback: Mode Repàs
    const { data: reviewChallenges } = await supabase
      .from('challenges')
      .select('*')
      .eq('topic_id', topicId)
      .eq('difficulty_tier', difficulty)
      .limit(10);

    return (reviewChallenges || []).map(row => this.mapToEntity(row as ChallengeRow, locale));
  }

  async findByTopicId(topicId: string, locale: string = 'ca'): Promise<Challenge[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('challenges')
      .select('*')
      .eq('topic_id', topicId);

    if (error) throw new Error(error.message);
    return data.map((row) => this.mapToEntity(row as ChallengeRow, locale));
  }



  // --- PUBLIC METHODS: ESCRIPTURA (ADMIN) ---

  async create(data: CreateChallengeInput): Promise<Challenge> {
    const supabase = await createClient();

    const payload: ChallengePersistencePayload = {
      topic_id: data.topicId,
      difficulty_tier: data.difficultyTier,
      type: data.type,
      // Supabase converteix l'objecte JS a JSONB automàticament
      content: data.content
    };

    const { data: created, error } = await supabase
      .from('challenges')
      .insert(payload)
      .select()
      .single();

    if (error) throw new Error(`Error creant repte: ${error.message}`);

    // Retornem l'entitat mapejada (per defecte en 'ca' ja que acabem de crear-la)
    return this.mapToEntity(created as ChallengeRow, 'ca');
  }

  async update(id: string, data: UpdateChallengeInput): Promise<Challenge> {
    const supabase = await createClient();

    const payload: ChallengePersistencePayload = {};
    if (data.topicId) payload.topic_id = data.topicId;
    if (data.difficultyTier) payload.difficulty_tier = data.difficultyTier;
    if (data.type) payload.type = data.type;
    if (data.content) payload.content = data.content;

    const { data: updated, error } = await supabase
      .from('challenges')
      .update(payload)
      .eq('id', id)
      .select()
      .single();

    if (error) throw new Error(`Error actualitzant repte: ${error.message}`);

    return this.mapToEntity(updated as ChallengeRow, 'ca');
  }

  async delete(id: string): Promise<void> {
    const supabase = await createClient();

    const { error } = await supabase
      .from('challenges')
      .delete()
      .eq('id', id);

    if (error) throw new Error(`Error eliminant repte: ${error.message}`);
  }

 /**
   * Obté reptes paginats amb doble filtre (Topic i Type)
   */
  async findAllPaginated(
    page: number = 1,
    pageSize: number = 10,
    topicFilter?: string,
    typeFilter?: string // <--- NOU PARÀMETRE
  ): Promise<PaginatedChallenges> {
    const supabase = await createClient();

    // 1. Query Base
    let query = supabase
      .from('challenges')
      .select(`
        id, difficulty_tier, type, created_at,
        topics!inner ( id, slug )
      `, { count: 'exact' });

    // 2. Filtre per TEMA
    if (topicFilter && topicFilter !== 'ALL') {
      query = query.eq('topic_id', topicFilter);
    }

    // 3. Filtre per TIPUS (NOU)
    if (typeFilter && typeFilter !== 'ALL') {
      query = query.eq('type', typeFilter);
    }

    // 4. Paginació
    const from = (page - 1) * pageSize;
    const to = from + pageSize - 1;

    const { data, count, error } = await query
      .order('created_at', { ascending: false })
      .range(from, to);

    if (error) throw new Error(error.message);

    // 5. Mapeig (Recorda usar la interfície ChallengeWithTopicResponse que vam definir abans)
    const rawData = data as unknown as ChallengeWithTopicResponse[]; // O la interfície estricta si la tens importada

    const safeData = rawData.map((row) => ({
      id: row.id,
      difficultyTier: row.difficulty_tier,
      type: row.type,
      createdAt: row.created_at,
      topicSlug: row.topics?.slug ?? 'unknown'
    }));

    return {
      data: safeData,
      total: count || 0,
      totalPages: Math.ceil((count || 0) / pageSize)
    };
  }

  /**
   * NECESSARI PER A L'EDICIÓ
   */
  async findById(id: string, locale: string = 'ca'): Promise<Challenge | null> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('challenges')
      .select('*') // Agafem tot el contingut (JSON inclòs)
      .eq('id', id)
      .single();

    if (error) return null;
    
    // Mapeig manual al Domini
    return {
      id: data.id,
      topicId: data.topic_id,
      difficultyTier: data.difficulty_tier,
      type: data.type,
      content: data.content, // El JSONB directe
      createdAt: new Date(data.created_at)
    };
  }
  /**
   * Retorna l'ID del repte anterior i següent per a la navegació.
   * Ordenació per created_at DESC (mateix ordre que el llistat).
   */
  async findAdjacentChallenges(currentId: string, currentCreatedAt: string): Promise<{ prevId: string | null; nextId: string | null }> {
    const supabase = await createClient();

    // 1. Buscar el PREVIOUS (Més nou que l'actual)
    // Ordenem ASC per agafar el "primer" que sigui més gran que l'actual
    const { data: prev } = await supabase
      .from('challenges')
      .select('id')
      .gt('created_at', currentCreatedAt)
      .order('created_at', { ascending: true }) // El més proper per dalt
      .limit(1)
      .single();

    // 2. Buscar el NEXT (Més vell que l'actual)
    // Ordenem DESC per agafar el "primer" que sigui més petit que l'actual
    const { data: next } = await supabase
      .from('challenges')
      .select('id')
      .lt('created_at', currentCreatedAt)
      .order('created_at', { ascending: false }) // El més proper per baix
      .limit(1)
      .single();

    return {
      prevId: prev?.id || null,
      nextId: next?.id || null
    };
  }

}

// =================== FILE: src/infrastructure/repositories/supabase/topic.repository.ts ===================

// filepath: src/infrastructure/repositories/supabase/topic.repository.ts
import { ITopicRepository, TierProgressStats, MapConfig } from '@/core/repositories/topic.repository';
import { Topic, CreateTopicInput } from '@/core/entities/topic.entity';
import { TopicNotFoundError } from '@/core/errors/topic.errors';
import { createClient } from '@/infrastructure/utils/supabase/server';
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';
import { LocalizedText } from '@/core/entities/topic.entity';

// Tipus intern de la BD (Snake Case)
type TopicRow = {
  id: string;
  slug: string;
  title: LocalizedText;
  
  icon_name: string;
  color_theme: string;
  parent_topic_id: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
  description?: LocalizedText;
};

type TopicPersistencePayload = {
  slug?: string;
  name_key?: string;
  icon_name?: string;
  color_theme?: string;
  parent_topic_id?: string | null;
  is_active?: boolean;
};

export class SupabaseTopicRepository implements ITopicRepository {

  // Aquest mètode és la clau per evitar duplicar lògica de mapeig
  private mapToEntity(row: TopicRow): Topic {
    return {
      id: row.id,
      slug: row.slug,

      iconName: row.icon_name,
      colorTheme: row.color_theme,
      parentTopicId: row.parent_topic_id || undefined,
      isActive: row.is_active,
      createdAt: new Date(row.created_at),
      updatedAt: new Date(row.updated_at),
      // ✅ Mapeig directe del JSONB
      title: row.title as LocalizedText,
      description: row.description as LocalizedText,
    };
  }

  async findAllActive(): Promise<Topic[]> {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .eq('is_active', true);

    if (error) throw new Error(`Supabase Error: ${error.message}`);

    const rows = data as TopicRow[];
    return rows.map((row) => this.mapToEntity(row));
  }

  // CORRECCIÓ PRINCIPAL AQUÍ:
  async findAll(): Promise<Topic[]> {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      // Ordenem per clau de nom per defecte
      .order('name_key', { ascending: true });

    if (error) {
      console.error('Error fetching topics:', error);
      throw new Error('Could not fetch topics');
    }

    // Convertim les dades crues al tipus TopicRow
    const rows = data as TopicRow[];

    // Usem el mètode centralitzat per convertir a Entitat de Domini
    // Això garanteix que camps com 'nameKey', 'iconName' i 'isActive' existeixin.
    return rows.map((row) => this.mapToEntity(row));
  }

  async findById(id: string): Promise<Topic | null> {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .eq('id', id)
      .single();

    if (error) {
      if (error.code === 'PGRST116') return null;
      throw new Error(error.message);
    }

    return this.mapToEntity(data as TopicRow);
  }

  async findBySlug(slug: string): Promise<Topic | null> {
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .eq('slug', slug)
      .single();

    if (error) {
      if (error.code === 'PGRST116') return null;
      throw new Error(error.message);
    }

    return this.mapToEntity(data as TopicRow);
  }

  async create(input: CreateTopicInput): Promise<Topic> {
    const supabase = await createClient();

    const dbPayload: TopicPersistencePayload = {
      slug: input.slug,
    icon_name: input.iconName,
      color_theme: input.colorTheme,
      parent_topic_id: input.parentTopicId || null,
      is_active: input.isActive
    };

    const { data, error } = await supabase
      .from('topics')
      .insert(dbPayload)
      .select()
      .single();

    if (error) throw new Error(error.message);
    return this.mapToEntity(data as TopicRow);
  }

  async update(id: string, input: Partial<CreateTopicInput>): Promise<Topic> {
    const supabase = await createClient();

    const dbPayload: TopicPersistencePayload = {};

    if (input.slug !== undefined) dbPayload.slug = input.slug;

    if (input.iconName !== undefined) dbPayload.icon_name = input.iconName;
    if (input.colorTheme !== undefined) dbPayload.color_theme = input.colorTheme;
    if (input.isActive !== undefined) dbPayload.is_active = input.isActive;
    if (input.parentTopicId !== undefined) dbPayload.parent_topic_id = input.parentTopicId;

    const { data, error } = await supabase
      .from('topics')
      .update(dbPayload)
      .eq('id', id)
      .select()
      .single();

    if (error) {
      if (error.code === 'PGRST116') {
        throw new TopicNotFoundError(id);
      }
      throw new Error(error.message);
    }

    return this.mapToEntity(data as TopicRow);
  }

  async getTopicProgressSummary(topicId: string, userId: string): Promise<TierProgressStats[]> {
    const supabase = await createClient();

    // 1. ✅ AFEGIM 'map_config' AL SELECT
    const { data: challenges, error: chalError } = await supabase
      .from('challenges')
      .select('id, difficulty_tier, type, map_config') // 👈 Aquí!
      .eq('topic_id', topicId);

    if (chalError) throw new Error(chalError.message);
    if (!challenges || challenges.length === 0) return [];

    const { data: progress, error: progError } = await supabase
      .from('user_progress')
      .select('challenge_id')
      .eq('user_id', userId)
      .eq('topic_id', topicId);

    if (progError) throw new Error(progError.message);

    const completedSet = new Set(progress?.map(p => p.challenge_id));
    const statsMap = new Map<number, TierProgressStats>();

    for (const c of challenges) {
      const tier = c.difficulty_tier;
      const type = c.type as ChallengeType;

      if (!statsMap.has(tier)) {
        statsMap.set(tier, {
          tier,
          totalChallenges: 0,
          completedChallenges: 0,
          mostCommonType: type,
          // ✅ INICIALITZEM mapConfig (per defecte null)
          mapConfig: null
        });
      }

      const stat = statsMap.get(tier)!;
      stat.totalChallenges++;

      // ✅ LOGICA DE BOSS:
      // Si *algun* challenge d'aquest nivell té configuració de boss,
      // la guardem a l'estadística del nivell.
      // (Això permet que només un challenge del tier 41 tingui la config i funcioni igualment)
      if (c.map_config && !stat.mapConfig) {
        stat.mapConfig = c.map_config as unknown as MapConfig;
      }

      if (completedSet.has(c.id)) {
        stat.completedChallenges++;
      }
    }

    return Array.from(statsMap.values()).sort((a, b) => a.tier - b.tier);
  }

  async delete(id: string): Promise<void> {
    const supabase = await createClient();
    const { error } = await supabase
      .from('topics')
      .delete()
      .eq('id', id);

    if (error) {
      throw new Error(`Error eliminant el topic: ${error.message}`);
    }
  }
}

// =================== FILE: src/infrastructure/repositories/supabase/user.repository.ts ===================

// filepath: src/infrastructure/repositories/supabase/user.repository.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { IUserRepository, UserProfile } from '@/core/repositories/user.repository'; // Assegura't que aquesta interfície existeix al Core

export class SupabaseUserRepository implements IUserRepository {
  
  async findById(userId: string): Promise<UserProfile | null> {
    const supabase = await createClient();
    
    // Obtenim el perfil de la taula 'profiles'
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (error) {
      console.error('Error fetching user profile:', error);
      return null;
    }

    return {
      id: data.id,
      totalXp: data.total_xp || 0,
      level: data.level || 1,
      // Mapem altres camps si cal
    };
  }

  async saveProgress(userId: string, challengeIds: string[], topicId: string, xpPerChallenge: number): Promise<void> {
    const supabase = await createClient();

    // Guardem cada repte completat a 'user_progress'
    // Usem upsert per evitar errors si ja existeix
    const progressInserts = challengeIds.map(challengeId => ({
      user_id: userId,
      challenge_id: challengeId,
      topic_id: topicId,
      completed_at: new Date().toISOString(),
      xp_earned: xpPerChallenge
    }));

    const { error } = await supabase
      .from('user_progress') // Assegura't que aquesta taula existeix
      .upsert(progressInserts, { onConflict: 'user_id, challenge_id' });

    if (error) {
      console.error('Error saving progress:', error);
      throw new Error('Database error saving progress');
    }
  }

  async updateXp(userId: string, newTotalXp: number, newLevel: number): Promise<void> {
    const supabase = await createClient();

    const { error } = await supabase
      .from('profiles')
      .update({ 
        total_xp: newTotalXp,
        level: newLevel,
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      console.error('Error updating XP:', error);
      throw new Error('Database error updating XP');
    }
  }
}

// =================== FILE: src/infrastructure/service/supabase-auth.service.ts ===================

// filepath: src/infrastructure/services/supabase-auth.service.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { IAuthService, UserIdentity } from '@/core/services/auth.service';

export class SupabaseAuthService implements IAuthService {
  
  async logout(): Promise<void> {
    const supabase = await createClient();
    await supabase.auth.signOut();
  }

  async getUser(): Promise<UserIdentity | null> {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user || !user.email) return null;
    
    return {
      id: user.id,
      email: user.email
    };
  }
}

// =================== FILE: src/infrastructure/utils/supabase/middleware.ts ===================

// filepath: src/infrastructure/utils/supabase/middleware.ts
import { createServerClient } from '@supabase/ssr';
import { type NextRequest, NextResponse } from 'next/server';

export async function createMiddlewareClient(request: NextRequest) {
  // Creem una resposta inicial buida per poder setear cookies
  let response = NextResponse.next({
    request: {
      headers: request.headers,
    },
  });

  const supabase = createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return request.cookies.getAll();
        },
        setAll(cookiesToSet) {
          // Això actualitza tant la Request (per seguir) com la Response (pel navegador)
          cookiesToSet.forEach(({ name, value }) => request.cookies.set(name, value));
          response = NextResponse.next({ request });
          cookiesToSet.forEach(({ name, value, options }) =>
            response.cookies.set(name, value, options)
          );
        },
      },
    }
  );

  return { supabase, response };
}

// =================== FILE: src/infrastructure/utils/supabase/server.ts ===================

// filepath: src/infrastructure/utils/supabase/server.ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  );
}

// =================== FILE: src/navigation.ts ===================

// filepath: src/navigation.ts
import { createNavigation } from 'next-intl/navigation';
import { routing } from './routing';

// Creem wrappers amb tipatge segur per al routing definit
export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);

// =================== FILE: src/presentation/actions/admin/challenge.actions.test.ts ===================

// filepath: src/presentation/actions/admin/challenge.actions.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { createChallengeAction, deleteChallengeAction } from './challenge.actions';
import { CreateChallengeSchemaType } from '@/application/dto/challenge.schema';

// 1. HOISTING
const mocks = vi.hoisted(() => ({
  executeCreate: vi.fn(),
  executeDelete: vi.fn(),
  assertAdmin: vi.fn(),
  revalidatePath: vi.fn(),
}));

// 2. Mocks
vi.mock('@/presentation/utils/auth-guards', () => ({
  assertAdmin: mocks.assertAdmin
}));

vi.mock('@/application/use-cases/challenges/create-challenge.use-case', () => ({
  CreateChallengeUseCase: vi.fn().mockImplementation(function () {
    return { execute: mocks.executeCreate };
  })
}));

vi.mock('@/application/use-cases/challenges/delete-challenge.use-case', () => ({
  DeleteChallengeUseCase: vi.fn().mockImplementation(function () {
    return { execute: mocks.executeDelete };
  })
}));

vi.mock('@/infrastructure/repositories/supabase/challenge.repository', () => ({
  SupabaseChallengeRepository: vi.fn()
}));

vi.mock('next/cache', () => ({
  revalidatePath: mocks.revalidatePath
}));

describe('Server Actions: Challenge Admin', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('createChallengeAction', () => {
    it('hauria de retornar error si les dades Zod són invàlides', async () => {
      const invalidInput = { 
        topicId: 'bad-uuid', // UUID invàlid
        difficultyTier: 99 
      } as unknown as CreateChallengeSchemaType;

      const result = await createChallengeAction(invalidInput);

      expect(result.success).toBe(false);
      expect(result.message).toBeDefined(); 
      expect(mocks.executeCreate).not.toHaveBeenCalled();
    });

    it('hauria de cridar al UseCase i retornar success si tot és correcte', async () => {
      // FIX: Dades correctes segons l'esquema multilingüe
      const validInput: CreateChallengeSchemaType = {
        topicId: '123e4567-e89b-12d3-a456-426614174000',
        difficultyTier: 1,
        type: 'QUIZ',
        content: {
          question: { ca: 'Pregunta', es: 'Pregunta', en: 'Question' },
          explanation: { ca: 'Exp', es: 'Exp', en: 'Exp' },
          options: [
            { id: '1', text: { ca: 'A', es: 'A', en: 'A' } },
            { id: '2', text: { ca: 'B', es: 'B', en: 'B' } },
            { id: '3', text: { ca: 'C', es: 'C', en: 'C' } },
            { id: '4', text: { ca: 'D', es: 'D', en: 'D' } }
          ],
          correctOptionIndex: 0
        }
      };

      mocks.executeCreate.mockResolvedValue({ id: 'new-id', ...validInput });

      const result = await createChallengeAction(validInput);

      expect(result.success).toBe(true);
      expect(mocks.executeCreate).toHaveBeenCalled();
    });
  });

  describe('deleteChallengeAction', () => {
    it('hauria de gestionar errors si el UseCase falla', async () => {
      mocks.executeDelete.mockRejectedValue(new Error('DB Error'));
      const result = await deleteChallengeAction('some-id');
      expect(result.success).toBe(false);
    });
  });
});

// =================== FILE: src/presentation/actions/admin/challenge.actions.ts ===================

// filepath: src/presentation/actions/admin/challenge.actions.ts
'use server';

import { revalidatePath } from 'next/cache';
import { assertAdmin } from '@/presentation/utils/auth-guards';

// DTOs i Schemas
import { CreateChallengeSchema, CreateChallengeSchemaType, UpdateChallengeSchema, UpdateChallengeSchemaType } from '@/application/dto/challenge.schema';

// Core & Application
import { SupabaseChallengeRepository } from '@/infrastructure/repositories/supabase/challenge.repository';
import { CreateChallengeUseCase } from '@/application/use-cases/challenges/create-challenge.use-case';
import { UpdateChallengeUseCase } from '@/application/use-cases/challenges/update-challenge.use-case';
import { DeleteChallengeUseCase } from '@/application/use-cases/challenges/delete-challenge.use-case';

// Tipus de retorn per a la UI
export type ActionState = {
  success: boolean;
  message?: string;
  errors?: Record<string, string[]>;
};

/**
 * Server Action per CREAR un repte
 */
export async function createChallengeAction(data: CreateChallengeSchemaType): Promise<ActionState> {
  try {
    // 1. Seguretat: Només admins
    await assertAdmin();

    // 2. Validació Zod (Doble check, per si el client es salta la validació JS)
    const validated = CreateChallengeSchema.safeParse(data);
    if (!validated.success) {
      return {
        success: false,
        message: 'Dades invàlides',
        errors: validated.error.flatten().fieldErrors
      };
    }

    // 3. Injecció de Dependències
    const repo = new SupabaseChallengeRepository();
    const useCase = new CreateChallengeUseCase(repo);

    // 4. Execució
    await useCase.execute(validated.data);

    // 5. Neteja de Cache (perquè aparegui al llistat immediatament)
    revalidatePath('/sys-ops/challenges'); 
    revalidatePath('/learn'); // També refresquem la part pública

    return { success: true, message: 'Repte creat correctament' };

  } catch (error) {
    console.error('Create Challenge Error:', error);
    return { 
      success: false, 
      message: error instanceof Error ? error.message : 'Error desconegut al crear el repte' 
    };
  }
}

/**
 * Server Action per ACTUALITZAR un repte
 */
export async function updateChallengeAction(id: string, data: UpdateChallengeSchemaType): Promise<ActionState> {
  try {
    await assertAdmin();

    const validated = UpdateChallengeSchema.safeParse(data);
    if (!validated.success) {
      return {
        success: false,
        message: 'Dades invàlides',
        errors: validated.error.flatten().fieldErrors
      };
    }

    const repo = new SupabaseChallengeRepository();
    const useCase = new UpdateChallengeUseCase(repo);

    await useCase.execute(id, validated.data);

    revalidatePath('/sys-ops/challenges');
    revalidatePath('/learn');

    return { success: true, message: 'Repte actualitzat correctament' };

  } catch (error) {
    console.error('Update Challenge Error:', error);
    return { 
      success: false, 
      message: error instanceof Error ? error.message : 'Error al actualitzar' 
    };
  }
}

/**
 * Server Action per ELIMINAR un repte
 */
export async function deleteChallengeAction(id: string): Promise<ActionState> {
  try {
    await assertAdmin();

    if (!id) return { success: false, message: 'ID obligatori' };

    const repo = new SupabaseChallengeRepository();
    const useCase = new DeleteChallengeUseCase(repo);

    await useCase.execute(id);

    revalidatePath('/sys-ops/challenges');
    
    return { success: true, message: 'Repte eliminat' };

  } catch (error) {
    console.error('Delete Challenge Error:', error);
    return { 
      success: false, 
      message: error instanceof Error ? error.message : 'Error al eliminar' 
    };
  }
}

// =================== FILE: src/presentation/actions/auth/auth.action.ts ===================

// filepath: src/presentation/actions/auth/auth.action.ts
'use server';

import { createClient } from '@/infrastructure/utils/supabase/server';
import { redirect } from 'next/navigation';

export type AuthState = {
  errorKey?: string;
  messageKey?: string;
};

export async function authAction(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;
  const intent = formData.get('intent') as string;
  
  const supabase = await createClient();

  if (intent === 'signup') {
    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: { data: { full_name: email.split('@')[0] } }
    });

    if (error) {
      // ✅ FIX: Retornem claus relatives, sense "auth." al principi
      if (error.message.includes('already registered')) return { errorKey: 'errors.user_already_exists' };
      if (error.message.includes('Password')) return { errorKey: 'errors.weak_password' };
      return { errorKey: 'errors.generic' };
    }

    // ✅ FIX: Clau relativa
    return { messageKey: 'success.check_email' };
  } 
  
  else {
    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
       // ✅ FIX: Clau relativa
      return { errorKey: 'errors.invalid_credentials' };
    }

    redirect('/');
  }
}

// =================== FILE: src/presentation/actions/auth/logout.actions.ts ===================

// filepath: src/presentation/actions/auth/logout.action.ts
'use server';

import { LogoutUseCase } from '@/application/use-cases/auth/logout.use-case';
import { SupabaseAuthService } from '@/infrastructure/service/supabase-auth.service';
import { redirect } from 'next/navigation'; // Aquí SÍ usem el natiu

export async function logoutAction() {
  const authService = new SupabaseAuthService();
  const useCase = new LogoutUseCase(authService);
  
  await useCase.execute();
  
  // Truc d'Arquitecte: Redirigim a l'arrel "/"
  // El Middleware detectarà "/" -> Detectarà l'idioma del navegador -> Redirigirà a "/ca/login"
  redirect('/login'); 
}

// =================== FILE: src/presentation/actions/challenges/get-next-challenge.action.ts ===================

// filepath: src/presentation/actions/challenges/get-next-challenge.action.ts
'use server';

import { GetNextChallengeUseCase } from '@/application/use-cases/challenges/get-next-challenge.use-case';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { SupabaseChallengeRepository } from '@/infrastructure/repositories/supabase/challenge.repository';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { getLocale } from 'next-intl/server';
import { createClient } from '@/infrastructure/utils/supabase/server'; // <--- Necessari per user real

type ActionResponse = 
  | { success: true; data: Challenge[] } 
  | { success: false; error: string };

// 1. AFEGIM EL PARÀMETRE difficulty AMB VALOR PER DEFECTE
export async function getNextChallengeAction(topicSlug: string, difficulty: number = 1): Promise<ActionResponse> {
  console.log(`🚀 [ACTION] Rebuda petició: Slug="${topicSlug}", Tier=${difficulty}`);
  
  try {
    const locale = await getLocale();
    const supabase = await createClient(); 

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        console.warn('⛔ [ACTION] Usuari no autenticat');
        return { success: false, error: 'Has d\'iniciar sessió per jugar.' };
    }

    const topicRepo = new SupabaseTopicRepository();
    // Afegim log per veure si troba el tema
    const topic = await topicRepo.findBySlug(topicSlug);
    if (!topic) {
        console.error(`❌ [ACTION] Tema no trobat pel slug: ${topicSlug}`);
        return { success: false, error: 'Tema no trobat' };
    }
    console.log(`✅ [ACTION] Tema trobat: ID=${topic.id}`);

    const challengeRepo = new SupabaseChallengeRepository();
    
    // NOTA: Ara cridem directament al repo aquí per saltar-nos el UseCase en el debug, 
    // o bé deixem el UseCase però sabent que el log està dins del repo.
    // Mantenim l'estructura neta cridant al UseCase:
    
    const useCase = new GetNextChallengeUseCase(topicRepo, challengeRepo);
    const challenges = await useCase.execute(topicSlug, user.id, locale, difficulty); 

    console.log(`🏁 [ACTION] Retornant ${challenges.length} reptes al client.`);
    return { success: true, data: challenges };

  } catch (error) {
    console.error('❌ [ACTION] Exception:', error);
    return { 
      success: false, 
      error: 'No s\'ha pogut carregar el repte.' 
    };
  }
}

// =================== FILE: src/presentation/actions/gamification/submit-session.action.ts ===================

// filepath: src/presentation/actions/gamification/submit-session.action.ts
'use server';

import { CompleteSessionUseCase, SessionResult } from '@/application/use-cases/gamification/complete-session.use-case';
import { SupabaseUserRepository } from '@/infrastructure/repositories/supabase/user.repository';
import { createClient } from '@/infrastructure/utils/supabase/server'; // <--- Nou import

type ActionResponse = 
  | { success: true; data: SessionResult }
  | { success: false; error: string };

export async function submitSessionAction(challengeIds: string[], topicId: string): Promise<ActionResponse> {
  try {
    // 1. Obtenim l'usuari real de la sessió
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return { success: false, error: 'Unauthorized: Please login first' };
    }

    // 2. Ja tenim l'ID real!
    const userId = user.id;

    // 3. Executem el cas d'ús
    const userRepo = new SupabaseUserRepository();
    const useCase = new CompleteSessionUseCase(userRepo);

    const result = await useCase.execute(userId, challengeIds, topicId);

    return { success: true, data: result };
  } catch (error) {
    console.error('Error submitting session:', error);
    return { success: false, error: 'Failed to save progress' };
  }
}

// =================== FILE: src/presentation/actions/topics/get-topics.action.ts ===================

// filepath: src/presentation/actions/topics/get-topics.action.ts
'use server';

import { GetActiveTopicsUseCase } from '@/application/use-cases/topics/get-active-topics.use-case';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { Topic } from '@/core/entities/topic.entity';

// Definim un tipus de retorn estàndard per a les accions
type ActionResponse<T> = 
  | { success: true; data: T }
  | { success: false; error: string };

export async function getTopicsAction(): Promise<ActionResponse<Topic[]>> {
  try {
    // 1. Instanciem les dependències (Composition Root per request)
    // Nota: Més endavant injectarem el client de Supabase amb cookies aquí.
    const repository = new SupabaseTopicRepository();
    const useCase = new GetActiveTopicsUseCase(repository);

    // 2. Executem el cas d'ús
    const topics = await useCase.execute();

    // 3. Retornem l'èxit
    // Next.js serialitzarà això automàticament
    return { success: true, data: topics };
  } catch (error) {
    console.error('Error fetching topics:', error);
    // 4. Gestió d'errors segura (no enviem stack trace al client)
    return { 
      success: false, 
      error: 'No s\'han pogut carregar els temes. Torna-ho a provar més tard.' 
    };
  }
}

// =================== FILE: src/presentation/components/admin/challenges/challenge-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/challenge-editor.tsx
'use client';

import { useState, useTransition } from 'react';
import { useForm, FormProvider, SubmitHandler, Resolver } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { CreateChallengeSchema } from '@/application/dto/challenge.schema';
import { createChallengeAction, updateChallengeAction } from '@/presentation/actions/admin/challenge.actions';

// IMPORTS NOUS
import { INITIAL_VALUES, ChallengeFormValues, Lang } from './form/form-config';
import { JsonEditor } from './form/json-editor';
import { LivePreview } from './preview/live-preview';
import { ChallengeFormRouter } from './form/challenge-from.router'; // <--- EL ROUTER

interface Topic {
  id: string;
  name: string;
}

interface ChallengeEditorProps {
  topics: Topic[];
  initialData?: Partial<ChallengeFormValues>;
  challengeId?: string;
}

export function ChallengeEditor({ topics, initialData, challengeId }: ChallengeEditorProps) {
  const [mode, setMode] = useState<'VISUAL' | 'JSON'>('VISUAL');
  const [activeLang, setActiveLang] = useState<Lang>('ca');
  const [isPending, startTransition] = useTransition();

  const defaultValues = initialData 
    ? { ...INITIAL_VALUES, ...initialData } as ChallengeFormValues
    : INITIAL_VALUES;

  const methods = useForm<ChallengeFormValues>({
    resolver: zodResolver(CreateChallengeSchema) as Resolver<ChallengeFormValues>,
    defaultValues,
    mode: 'onChange' // Vital per al Live Preview
  });

  const { register, handleSubmit, watch, reset } = methods;
  const currentType = watch('type');

  const onSubmit: SubmitHandler<ChallengeFormValues> = (data) => {
    startTransition(async () => {
      const result = challengeId 
        ? await updateChallengeAction(challengeId, data)
        : await createChallengeAction(data);

      if (result?.success) {
        // Podries posar un Toast aquí
        alert(challengeId ? "✅ Actualitzat" : "🚀 Creat");
        if (!challengeId) reset(INITIAL_VALUES);
      } else {
        alert("❌ Error: " + JSON.stringify(result?.message || result?.errors));
      }
    });
  };

  // ESTILS
  const inputClass = "w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-700 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2 transition-colors";
  const labelClass = "block mb-1 text-[10px] font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wide";

  return (
    <FormProvider {...methods}>
      <form onSubmit={handleSubmit(onSubmit)} className="flex flex-col h-[calc(100vh-100px)] bg-white dark:bg-slate-950 text-slate-900 dark:text-slate-100">
        
        {/* === HEADER ULTRA-COMPACTE === */}
        <div className="shrink-0 flex items-center justify-between px-4 py-2 border-b border-gray-200 dark:border-slate-800 bg-white/80 dark:bg-slate-950/80 backdrop-blur-md z-20">
          <div className="flex items-center gap-3">
             {/* TOGGLE MODE */}
             <div className="flex bg-gray-100 dark:bg-slate-900 rounded-md p-0.5 border border-gray-200 dark:border-slate-800">
              <button type="button" onClick={() => setMode('VISUAL')} className={`px-2.5 py-1 text-[10px] font-bold rounded transition-all ${mode === 'VISUAL' ? 'bg-white dark:bg-slate-800 shadow text-indigo-600 dark:text-indigo-400' : 'text-gray-500'}`}>VISUAL</button>
              <button type="button" onClick={() => setMode('JSON')} className={`px-2.5 py-1 text-[10px] font-bold rounded transition-all ${mode === 'JSON' ? 'bg-white dark:bg-slate-800 shadow text-emerald-600 dark:text-emerald-400' : 'text-gray-500'}`}>JSON</button>
            </div>
            <div className="h-4 w-px bg-gray-300 dark:bg-slate-700"></div>
            <span className="text-xs font-semibold text-gray-500 dark:text-gray-400 hidden sm:inline">
              {challengeId ? 'Edit Mode' : 'Create Mode'}
            </span>
          </div>
          
          <button
            type="submit"
            disabled={isPending}
            className="px-4 py-1.5 bg-black dark:bg-white text-white dark:text-black text-xs font-bold rounded-md hover:opacity-80 transition-all disabled:opacity-50"
          >
            {isPending ? 'Saving...' : (challengeId ? 'Update' : 'Create')}
          </button>
        </div>

        {/* === MAIN LAYOUT === */}
        <div className="flex-1 overflow-hidden grid grid-cols-1 lg:grid-cols-12">
          
          {/* ESQUERRA: EDITOR */}
          <div className="lg:col-span-7 overflow-y-auto p-0 border-r border-gray-200 dark:border-slate-800 custom-scrollbar">
            <div className="p-6 space-y-6">
                
                {/* 1. CONFIG GLOBAL (Compacta) */}
                <div className="grid grid-cols-3 gap-3 p-3 bg-gray-50/50 dark:bg-slate-900/50 rounded-lg border border-gray-100 dark:border-slate-800/50">
                  <div>
                    <label className={labelClass}>Topic</label>
                    <select {...register('topicId')} className={inputClass}>
                      <option value="">...</option>
                      {topics.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className={labelClass}>Tipus</label>
                    <select {...register('type')} className={inputClass}>
                      <option value="BINARY_DECISION">Binary</option>
                      <option value="QUIZ">Quiz</option>
                      <option value="CODE_FIX">Code Fix</option>
                      <option value="MATCHING">Matching</option>
                      <option value="TERMINAL">Terminal</option>
                    </select>
                  </div>
                  <div>
                    <label className={labelClass}>Lvl</label>
                    <input type="number" {...register('difficultyTier')} className={inputClass} min={1} max={10} />
                  </div>
                </div>

                {/* 2. EDITOR DE CONTINGUT */}
                {mode === 'JSON' ? (
                  <JsonEditor />
                ) : (
                  <div className="space-y-4">
                    {/* TABS IDIOMA */}
                    <div className="flex gap-1 border-b border-gray-100 dark:border-slate-800 pb-1">
                      {(['ca', 'es', 'en'] as Lang[]).map((lang) => (
                        <button
                          key={lang}
                          type="button"
                          onClick={() => setActiveLang(lang)}
                          className={`px-3 py-1 text-[10px] font-bold uppercase rounded-t-md transition-all ${
                            activeLang === lang 
                              ? 'text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/10' 
                              : 'text-gray-400 hover:text-gray-600 dark:hover:text-gray-300'
                          }`}
                        >
                          {lang}
                        </button>
                      ))}
                    </div>

                    {/* ROUTER DINÀMIC */}
                    <ChallengeFormRouter type={currentType} activeLang={activeLang} />
                  </div>
                )}
            </div>
          </div>

          {/* DRETA: PREVIEW */}
          <div className="lg:col-span-5 bg-gray-100 dark:bg-black border-l border-gray-200 dark:border-slate-800 hidden lg:block overflow-hidden relative">
             <div className="absolute inset-0 flex items-center justify-center">
                <LivePreview activeLang={activeLang} />
             </div>
          </div>

        </div>
      </form>
    </FormProvider>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/create-challenge-from.test.tsx ===================

// filepath: src/presentation/components/admin/challenges/create-challenge-form.test.tsx
import React from 'react';
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
// IMPORTEM LA INTERFÍCIE AQUÍ
import { CreateChallengeForm, TopicOption } from './create-challenge-from';
import * as actions from '@/presentation/actions/admin/challenge.actions';
import { NextIntlClientProvider } from 'next-intl';

const messages = {
  Admin: {
    Challenges: {
      title: "Crear Nou Repte",
      form: {
        topicLabel: "Tema",
        topicPlaceholder: "Selecciona un tema...",
        difficultyLabel: "Dificultat",
        typeLabel: "Tipus",
        questionLabel: "Pregunta",
        submitButton: "Crear",
        saving: "Guardant...",
        success: "Èxit",
        error: "Error"
      }
    }
  }
};

const mockCreateAction = vi.spyOn(actions, 'createChallengeAction');

const TestWrapper = ({ children }: { children: React.ReactNode }) => {
  return (
    <NextIntlClientProvider locale="ca" messages={messages}>
      {children}
    </NextIntlClientProvider>
  );
};

describe('CreateChallengeForm Component', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('hauria de renderitzar tots els camps del formulari', () => {
    render(<CreateChallengeForm topics={[]} />, { wrapper: TestWrapper });

    expect(screen.getByLabelText(/Tema/i)).toBeDefined();
    expect(screen.getByLabelText(/Dificultat/i)).toBeDefined();
    expect(screen.getByLabelText(/Tipus/i)).toBeDefined();
    expect(screen.getByRole('button', { name: /Crear/i })).toBeDefined();
  });

  it('hauria de mostrar errors de validació client-side si es deixa buit', async () => {
    render(<CreateChallengeForm topics={[]} />, { wrapper: TestWrapper });

    const submitBtn = screen.getByRole('button', { name: /Crear/i });
    fireEvent.click(submitBtn);

    await waitFor(() => {
       expect(mockCreateAction).not.toHaveBeenCalled();
    });
  });

  it('hauria de cridar a la Server Action amb les dades correctes', async () => {
    mockCreateAction.mockResolvedValue({ success: true, message: 'Creat' });

    // FIX NO-ANY: Definim les dades tipades segons el contracte del component.
    // Si tenim camps extra (com createdAt) però volem complir la interfície, 
    // podem fer un cast a 'unknown' i després a 'TopicOption[]', però el més net 
    // en tests és passar el que es necessita.
    const mockTopics: TopicOption[] = [
      { id: 'topic-1', name: 'React' }
    ];
    
    render(<CreateChallengeForm topics={mockTopics} />, { wrapper: TestWrapper });

    // Omplim el formulari
    fireEvent.change(screen.getByLabelText(/Tema/i), { target: { value: 'topic-1' } });
    fireEvent.change(screen.getByLabelText(/Dificultat/i), { target: { value: 2 } }); // Note: value can be number in fireEvent for strict inputs
    fireEvent.change(screen.getByLabelText(/Tipus/i), { target: { value: 'QUIZ' } });
    fireEvent.change(screen.getByLabelText(/Pregunta/i), { target: { value: 'Què és un Hook?' } });

    const submitBtn = screen.getByRole('button', { name: /Crear/i });
    fireEvent.click(submitBtn);

    await waitFor(() => {
      expect(mockCreateAction).toHaveBeenCalled();
      const calledArg = mockCreateAction.mock.calls[0][0];
      expect(calledArg.topicId).toBe('topic-1');
      expect(calledArg.difficultyTier).toBe(2);
    });
  });
});

// =================== FILE: src/presentation/components/admin/challenges/create-challenge-from.tsx ===================

// filepath: src/presentation/components/admin/challenges/create-challenge-form.tsx
'use client';

import { useState, useTransition } from 'react';
import { useForm, SubmitHandler } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTranslations } from 'next-intl';
import { z } from 'zod';
import { createChallengeAction } from '@/presentation/actions/admin/challenge.actions';

// 1. EXPORTEM la interfície per poder-la usar als tests (Clean Arch)
export interface TopicOption {
  id: string;
  name: string;
}

interface CreateChallengeFormProps {
  topics: TopicOption[];
}

const ChallengeTypeEnum = z.enum(['QUIZ', 'CODE_FIX', 'TERMINAL', 'DRAG_DROP']);

// 2. ESQUEMA ROBUST:
// Eliminem 'invalid_type_error' que et donava problemes.
// Si valueAsNumber falla (NaN), el .min(1) ho atraparà igualment perquè NaN < 1.
const formSchema = z.object({
  topicId: z.string().min(1, "Has de seleccionar un tema"),
  difficultyTier: z.number()
    .min(1, "La dificultat és obligatòria i ha de ser mínim 1")
    .max(5, "Màxim 5"),
  type: ChallengeTypeEnum,
  question: z.string().min(5, "La pregunta ha de tenir mínim 5 caràcters"),
});

type FormValues = z.infer<typeof formSchema>;

export function CreateChallengeForm({ topics }: CreateChallengeFormProps) {
  const t = useTranslations('Admin.Challenges.form');
  const [isPending, startTransition] = useTransition();
  const [serverMessage, setServerMessage] = useState<{ type: 'success' | 'error'; text: string } | null>(null);

  const {
    register,
    handleSubmit,
    reset,
    formState: { errors },
  } = useForm<FormValues>({
    resolver: zodResolver(formSchema),
    defaultValues: {
      topicId: '',
      difficultyTier: 1,
      type: 'QUIZ',
      question: ''
    },
  });

  const onSubmit: SubmitHandler<FormValues> = (data) => {
    setServerMessage(null);

    const payload = {
      topicId: data.topicId,
      difficultyTier: data.difficultyTier,
      type: data.type,
      content: {
        question: data.question,
        options: ['Exemple A', 'Exemple B'],
        correctAnswerIndex: 0
      }
    };

    startTransition(async () => {
      // @ts-expect-error - Ignorem l'error de tipus estricte del DTO vs Form temporalment
      const result = await createChallengeAction(payload);

      if (result.success) {
        setServerMessage({ type: 'success', text: t('success') });
        reset({
            topicId: '',
            difficultyTier: 1,
            type: 'QUIZ',
            question: ''
        });
      } else {
        setServerMessage({ type: 'error', text: result.message || t('error') });
      }
    });
  };

  return (
    <form onSubmit={handleSubmit(onSubmit)} className="space-y-6 bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto">
      
      {serverMessage && (
        <div className={`p-4 rounded-md ${serverMessage.type === 'success' ? 'bg-green-50 text-green-700' : 'bg-red-50 text-red-700'}`}>
          {serverMessage.text}
        </div>
      )}

      {/* Camp: Tema */}
      <div className="flex flex-col gap-2">
        <label htmlFor="topicId" className="font-semibold text-gray-700">
          {t('topicLabel')}
        </label>
        <select
          id="topicId"
          {...register('topicId')}
          className="border border-gray-300 p-2 rounded-md focus:ring-2 focus:ring-indigo-500"
        >
          <option value="">{t('topicPlaceholder')}</option>
          {topics.map((topic) => (
            <option key={topic.id} value={topic.id}>
              {topic.name}
            </option>
          ))}
        </select>
        {errors.topicId && <span className="text-sm text-red-500">{errors.topicId.message}</span>}
      </div>

      {/* Camp: Dificultat */}
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div className="flex flex-col gap-2">
          <label htmlFor="difficultyTier" className="font-semibold text-gray-700">
            {t('difficultyLabel')}
          </label>
          <input
            type="number"
            id="difficultyTier"
            min={1}
            max={5}
            // valueAsNumber gestiona la conversió HTML -> Number
            {...register('difficultyTier', { valueAsNumber: true })}
            className="border border-gray-300 p-2 rounded-md"
          />
          {errors.difficultyTier && <span className="text-sm text-red-500">{errors.difficultyTier.message}</span>}
        </div>

        <div className="flex flex-col gap-2">
          <label htmlFor="type" className="font-semibold text-gray-700">
            {t('typeLabel')}
          </label>
          <select
            id="type"
            {...register('type')}
            className="border border-gray-300 p-2 rounded-md"
          >
            <option value="QUIZ">Quiz</option>
            <option value="CODE_FIX">Code Fix</option>
            <option value="TERMINAL">Terminal</option>
          </select>
        </div>
      </div>

      {/* Camp: Pregunta */}
      <div className="flex flex-col gap-2">
        <label htmlFor="question" className="font-semibold text-gray-700">
          {t('questionLabel')}
        </label>
        <textarea
          id="question"
          rows={3}
          {...register('question')}
          className="border border-gray-300 p-2 rounded-md w-full"
        />
        {errors.question && <span className="text-sm text-red-500">{errors.question.message}</span>}
      </div>

      <button
        type="submit"
        disabled={isPending}
        className="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
      >
        {isPending ? t('saving') : t('submitButton')}
      </button>
    </form>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/binary-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/binary-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

interface BinaryEditorProps {
  activeLang: Lang;
}

export function BinaryEditor({ activeLang }: BinaryEditorProps) {
  // Usem el context per connectar amb el formulari del pare
  const { register } = useFormContext<ChallengeFormValues>();

  return (
    <div className="space-y-4 animate-in fade-in slide-in-from-bottom-2">
      <div className="p-4 bg-blue-50 border border-blue-100 rounded-md mb-4">
        <h3 className="text-blue-900 font-bold text-sm mb-2">Mode: Binary Decision</h3>
        <p className="text-blue-700 text-xs">Configura una pregunta de Verdader/Fals o Hot/Not.</p>
      </div>

      <div>
        <label className="block text-sm font-bold text-gray-700 mb-1">Enunciat ({activeLang.toUpperCase()})</label>
        <textarea
          {...register(`content.statement.${activeLang}` as Path<ChallengeFormValues>)}
          className="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 min-h-20"
          placeholder="Escriu la afirmació aquí..."
        />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div className="flex items-center gap-3 p-3 bg-gray-50 rounded border">
          <label className="text-sm font-semibold text-gray-700">És cert?</label>
          <input
            type="checkbox"
            {...register('content.isTrue' as Path<ChallengeFormValues>)}
            className="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold text-gray-700 mb-1">Variant Visual</label>
          <select
            {...register('content.variant' as Path<ChallengeFormValues>)}
            className="w-full border border-gray-300 p-2 rounded focus:ring-indigo-500"
          >
            <option value="TRUE_FALSE">Veritat / Fals</option>
            <option value="HOT_OR_NOT">Hot or Not (Foc)</option>
          </select>
        </div>
      </div>

      <div>
        <label className="block text-sm font-bold text-gray-700 mb-1">Explicació / Feedback ({activeLang.toUpperCase()})</label>
        <textarea
          {...register(`content.explanation.${activeLang}` as Path<ChallengeFormValues>)}
          className="w-full border border-gray-300 p-2 rounded focus:ring-2 focus:ring-indigo-500 min-h-20"
          placeholder="Per què és cert o fals?"
        />
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/challenge-from.router.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/challenge-form-router.tsx
import {  Lang } from './form-config';

// Importem els editors existents
import { BinaryEditor } from './binary-editor';
import { CodeFixEditor } from './code-fix-editor';
import { QuizEditor } from './quiz-editor';
import { CtfEditor } from './ctf-editor'; // <--- NOU IMPORT

interface Props {
  type: string;
  activeLang: Lang;
}

export function ChallengeFormRouter({ type, activeLang }: Props) {
  
  switch (type) {
    case 'BINARY_DECISION':
      return <BinaryEditor activeLang={activeLang} />;
    
    case 'CODE_FIX':
      return <CodeFixEditor activeLang={activeLang} />;
    
    case 'QUIZ':
      return <QuizEditor activeLang={activeLang} />;

    case 'CTF': // <--- NOU CAS
      return <CtfEditor activeLang={activeLang} />;

    // --- CASOS PENDENTS (PLACEHOLDERS) ---
    // A mesura que creïs 'theory-editor.tsx', 'matching-editor.tsx', etc., els afegeixes aquí.
    
    case 'THEORY':
    case 'MATCHING':
    case 'TERMINAL':
    case 'LOGIC_ORDER':
      return <PlaceholderEditor type={type} />;
    
    default:
      return <PlaceholderEditor type={type} unknown />;
  }
}

// Un petit component auxiliar per no repetir el codi de "En construcció"
function PlaceholderEditor({ type, unknown = false }: { type: string, unknown?: boolean }) {
  return (
    <div className="flex flex-col items-center justify-center h-64 text-center border-2 border-dashed border-gray-200 dark:border-slate-800 rounded-xl bg-gray-50 dark:bg-slate-900/30 animate-in fade-in">
       <span className="text-3xl mb-2">{unknown ? '❓' : '🚧'}</span>
       <p className="text-sm text-gray-500 dark:text-gray-400">
         L'editor visual per a <strong>{type}</strong> {unknown ? 'és desconegut' : 'està en construcció'}.
       </p>
       <p className="text-xs text-indigo-500 mt-2 font-medium">
         Si us plau, utilitza la pestanya <strong>JSON</strong> per editar aquest contingut.
       </p>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/code-fix-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/code-fix-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

// 1. TRUC DE MÀGIA 🎩: Creem un tipus que només conté l'estructura de CODE_FIX
// Això elimina l'ambigüitat de la Unió.
type CodeFixFormValues = Extract<ChallengeFormValues, { type: 'CODE_FIX' }>;

export function CodeFixEditor({ activeLang }: { activeLang: Lang }) {
  // 2. Diem al context que, DINS d'aquest component, les dades són de tipus CodeFix
  const { register } = useFormContext<CodeFixFormValues>();

  const inputClass = "w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-700 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 mb-2";
  const labelClass = "block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase";

  return (
    <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
      <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-100 dark:border-blue-800">
        <h3 className="text-blue-800 dark:text-blue-300 font-bold text-sm mb-1">Mode: Code Fix</h3>
        <p className="text-xs text-blue-600 dark:text-blue-400">L'usuari haurà de trobar i arreglar un bug en el codi inicial.</p>
      </div>

      {/* 1. DESCRIPCIÓ DEL PROBLEMA */}
      <div>
        <label className={labelClass}>Descripció del Problema ({activeLang})</label>
        <textarea
          // ✅ FIX: Usem 'as Path<...>' per assegurar a TS que la ruta construïda és vàlida
          {...register(`content.description.${activeLang}` as Path<CodeFixFormValues>)}
          rows={3}
          className={inputClass}
          placeholder="Explica què ha de fer l'alumne..."
        />
      </div>

      {/* 2. CODI INICIAL (BUGGED) */}
      <div>
        <label className={labelClass}>Codi Inicial (Amb Errors)</label>
        <div className="relative">
          <span className="absolute top-2 right-2 text-[10px] bg-red-100 text-red-600 px-2 rounded">BUGGY</span>
          <textarea
            // ✅ FIX: Ara TS sap que 'content.initialCode' existeix dins de CodeFixFormValues
            // Si encara es queixa, afegim el cast 'as Path<CodeFixFormValues>' per seguretat extra
            {...register('content.initialCode' as Path<CodeFixFormValues>)}
            rows={6}
            className={`${inputClass} font-mono bg-slate-900 text-red-300`}
            placeholder="function suma(a, b) { return a - b; }"
          />
        </div>
      </div>

      {/* 3. SOLUCIÓ (CORRECTA) */}
      <div>
        <label className={labelClass}>Solució Esperada (Regex o String)</label>
        <div className="relative">
          <span className="absolute top-2 right-2 text-[10px] bg-green-100 text-green-600 px-2 rounded">CORRECT</span>
          <textarea
            // ✅ FIX: Mateix cast aquí
            {...register('content.solution' as Path<CodeFixFormValues>)}
            rows={4}
            className={`${inputClass} font-mono bg-slate-900 text-green-300`}
            placeholder="return a + b;"
          />
        </div>
        <p className="text-[10px] text-gray-400 mt-1">
          * El sistema compararà l'input de l'usuari amb aquesta solució.
        </p>
      </div>

       {/* 4. PISTA */}
       <div>
        <label className={labelClass}>Pista / Hint ({activeLang})</label>
        <input
          // ✅ FIX: Cast per a la clau dinàmica
          {...register(`content.hint.${activeLang}` as Path<CodeFixFormValues>)}
          className={inputClass}
          placeholder="Dóna una petita ajuda..."
        />
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/ctf-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/ctf-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

// 🎩 TRUC DE MÀGIA: Aïllem el tipus CTF
type CtfFormValues = Extract<ChallengeFormValues, { type: 'CTF' }>;

export function CtfEditor({ activeLang }: { activeLang: Lang }) {
  const { register } = useFormContext<CtfFormValues>();

  const inputClass = "w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-700 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 mb-2";
  const labelClass = "block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase";

  return (
    <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
      <div className="bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg border border-emerald-100 dark:border-emerald-800 flex items-start gap-3">
        <span className="text-xl">🚩</span>
        <div>
          <h3 className="text-emerald-800 dark:text-emerald-300 font-bold text-sm mb-1">Mode: Capture The Flag (CTF)</h3>
          <p className="text-xs text-emerald-600 dark:text-emerald-400">
            L'estudiant ha de trobar una "Flag" oculta (string exacte) investigant o hackejant.
          </p>
        </div>
      </div>

      {/* 1. DESCRIPCIÓ DE LA MISSIÓ */}
      <div>
        <label className={labelClass}>Missió / Descripció ({activeLang})</label>
        <textarea
          {...register(`content.description.${activeLang}` as Path<CtfFormValues>)}
          rows={3}
          className={inputClass}
          placeholder="Ex: Troba la contrasenya oculta en els headers de la petició..."
        />
      </div>

      {/* 2. LA FLAG (SECRET) */}
      <div>
        <label className={labelClass}>La Flag (Solució Exacta)</label>
        <div className="relative group">
          <input
            {...register('content.flag' as Path<CtfFormValues>)}
            className={`${inputClass} font-mono tracking-wider bg-slate-100 dark:bg-slate-950 border-l-4 border-l-emerald-500`}
            placeholder="CTF{th1s_1s_th3_fl4g}"
          />
          <span className="absolute top-2 right-2 text-[10px] bg-emerald-100 text-emerald-600 px-1.5 rounded font-bold">SECRET</span>
        </div>
        <p className="text-[10px] text-gray-400">
          * Aquesta cadena és la que l'usuari haurà d'introduir per guanyar.
        </p>
      </div>

       {/* 3. PISTA */}
       <div>
        <label className={labelClass}>Pista / Hint ({activeLang})</label>
        <input
          {...register(`content.hint.${activeLang}` as Path<CtfFormValues>)}
          className={inputClass}
          placeholder="Ex: Mira les cookies del navegador..."
        />
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/form-config.ts ===================

// filepath: src/presentation/components/admin/challenges/form/form-config.ts
import { DefaultValues } from 'react-hook-form';
import { CreateChallengeSchemaType } from '@/application/dto/challenge.schema';

export type ChallengeFormValues = CreateChallengeSchemaType;
export type Lang = 'ca' | 'es' | 'en';

// 1. Definim un estat inicial concret (només per a BINARY_DECISION)
// Això és el que tindrà el formulari quan es carregui.
const DEFAULT_STATE = {
  type: 'BINARY_DECISION', // Aquest string ha de coincidir amb l'enum de Zod
  difficultyTier: 1,
  topicId: '', // String buit inicial
  content: {
    isTrue: false,
    variant: 'TRUE_FALSE',
    statement: { ca: '', es: '', en: '' },
    explanation: { ca: '', es: '', en: '' }
  }
};

// 2. EL FIX DEFINITIU:
// Fem un "Type Assertion" doble.
// Primer a 'unknown' per esborrar la inferència estricta de l'objecte literal.
// Segon a 'DefaultValues<ChallengeFormValues>' perquè useForm s'ho empassi.
export const INITIAL_VALUES = DEFAULT_STATE as unknown as DefaultValues<ChallengeFormValues>;

// =================== FILE: src/presentation/components/admin/challenges/form/json-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/json-editor.tsx
import { useFormContext } from 'react-hook-form';
import { ChallengeFormValues } from './form-config';

export function JsonEditor() {
    const { watch, reset } = useFormContext<ChallengeFormValues>();

    const formValues = watch();
    const jsonString = JSON.stringify(formValues, null, 2);

    const handleJsonChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
        try {
            const parsed = JSON.parse(e.target.value);
            reset(parsed);
        } catch {
            // Silenciosament ignorem errors de parseig mentre s'escriu
        }
    };

    return (
        <div className="bg-slate-950 p-4 rounded-lg">
            <p className="text-gray-400 text-xs mb-2 font-mono">
                {/* CORRECCIÓ JSX COMMENT: Usar claus */}
                {/* Edita el JSON directament. Es sincronitza amb el visual. */}
                JSON MODE: Validació automàtica al desar.
            </p>
            <textarea
                className="w-full h-125 bg-transparent border-none text-green-400 font-mono text-sm focus:outline-none resize-none"
                value={jsonString}
                onChange={handleJsonChange}
                spellCheck={false}
            />
        </div>
    );
}

// =================== FILE: src/presentation/components/admin/challenges/form/logic-order-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/logic-order-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

type LogicFormValues = Extract<ChallengeFormValues, { type: 'LOGIC_ORDER' }>;

export function LogicOrderEditor({ activeLang }: { activeLang: Lang }) {
  const { register } = useFormContext<LogicFormValues>();
  const inputClass = "w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded-lg p-2 text-sm dark:text-white";

  return (
    <div className="space-y-5 animate-in fade-in slide-in-from-right-4">
      {/* DESCRIPCIÓ */}
      <div>
        <label className="block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Enunciat ({activeLang})</label>
        <textarea
          // FIX: Tipatge estricte
          {...register(`content.description.${activeLang}` as Path<LogicFormValues>)}
          className={inputClass}
          rows={2}
          placeholder="Ordena els passos del cicle de vida de React..."
        />
      </div>

      {/* ITEMS ORDENATS */}
      <div className="space-y-2">
        <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">
           Passos (Escriu-los en l'ordre CORRECTE)
        </label>
        
        {[0, 1, 2, 3].map((idx) => (
          <div key={idx} className="flex gap-2 items-center">
             <div className="w-6 h-6 flex items-center justify-center bg-gray-200 dark:bg-slate-700 rounded text-xs font-bold text-gray-500">
               {idx + 1}
             </div>
             <input
               // FIX: Tipatge estricte
               {...register(`content.items.${idx}.text.${activeLang}` as Path<LogicFormValues>)}
               className={inputClass}
               placeholder={`Pas ${idx + 1}...`}
             />
             {/* FIX: ID ocult */}
             <input type="hidden" {...register(`content.items.${idx}.id` as Path<LogicFormValues>)} value={`step-${idx}`} />
          </div>
        ))}
        <p className="text-[10px] text-gray-400 flex items-center gap-1">
           ℹ️ Al preview es mostraran barrejats.
        </p>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/matching-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/matching-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

type MatchingFormValues = Extract<ChallengeFormValues, { type: 'MATCHING' }>;

export function MatchingEditor({ activeLang }: { activeLang: Lang }) {
  const { register } = useFormContext<MatchingFormValues>();
  
  const inputClass = "w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded-lg p-2 text-sm dark:text-white focus:ring-2 focus:ring-indigo-500";

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
      {/* INSTRUCCIÓ */}
      <div>
        <label className="block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Instrucció ({activeLang})</label>
        <textarea
          // FIX: Tipatge estricte
          {...register(`content.instruction.${activeLang}` as Path<MatchingFormValues>)}
          className={inputClass}
          rows={2}
          placeholder="Relaciona cada concepte amb la seva definició..."
        />
      </div>

      {/* PARELLES */}
      <div className="space-y-3">
        <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Parelles (Esquerra - Dreta)</label>
        {[0, 1, 2, 3].map((idx) => (
          <div key={idx} className="flex items-center gap-2 bg-gray-50 dark:bg-slate-900/50 p-2 rounded-lg border border-gray-200 dark:border-slate-700">
             <div className="flex flex-col flex-1 gap-1">
                <span className="text-[10px] text-gray-400 font-mono">ITEM A{idx+1}</span>
                <input
                  // FIX: Tipatge estricte per arrays niuats
                  {...register(`content.pairs.${idx}.left.text.${activeLang}` as Path<MatchingFormValues>)} 
                  className={inputClass}
                  placeholder="Concepte..."
                />
             </div>
             <span className="text-gray-400">↔</span>
             <div className="flex flex-col flex-1 gap-1">
                <span className="text-[10px] text-gray-400 font-mono">ITEM B{idx+1}</span>
                <input
                  // FIX: Tipatge estricte
                  {...register(`content.pairs.${idx}.right.text.${activeLang}` as Path<MatchingFormValues>)}
                  className={inputClass}
                  placeholder="Definició..."
                />
             </div>
             {/* IDs ocults necessaris */}
             <input type="hidden" {...register(`content.pairs.${idx}.left.id` as Path<MatchingFormValues>)} value={`l-${idx}`} />
             <input type="hidden" {...register(`content.pairs.${idx}.right.id` as Path<MatchingFormValues>)} value={`r-${idx}`} />
          </div>
        ))}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/quiz-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/quiz-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

// 1. Definim el tipus específic
type QuizFormValues = Extract<ChallengeFormValues, { type: 'QUIZ' }>;

export function QuizEditor({ activeLang }: { activeLang: Lang }) {
  const { register, watch } = useFormContext<QuizFormValues>();
  
  // Watch segur
  const correctIdx = watch('content.correctOptionIndex' as Path<QuizFormValues>);

  const inputClass = "w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded-lg p-3 text-sm font-medium dark:text-white focus:ring-2 focus:ring-indigo-500 block";

  return (
    <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
      {/* PREGUNTA */}
      <div>
        <label className="block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Pregunta ({activeLang})</label>
        <textarea
          // FIX: Construcció de path segura
          {...register(`content.question.${activeLang}` as Path<QuizFormValues>)}
          className={inputClass}
          rows={2}
          placeholder="Escriu la pregunta aquí..."
        />
      </div>

      {/* OPCIONS */}
      <div className="space-y-3">
        <label className="block text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Opcions (Marca la correcta)</label>
        {[0, 1, 2, 3].map((index) => (
          <div key={index} className={`flex gap-2 items-center p-2 rounded-lg border transition-colors ${Number(correctIdx) === index ? 'border-green-500 bg-green-50 dark:bg-green-900/20' : 'border-transparent hover:bg-gray-50 dark:hover:bg-slate-800'}`}>
             
             {/* RÀDIO CUSTOM */}
             <div className="relative flex items-center justify-center">
                <input 
                  type="radio" 
                  value={index}
                  // FIX: Tipatge explícit per al path numèric
                  {...register('content.correctOptionIndex' as Path<QuizFormValues>, { valueAsNumber: true })}
                  className="peer sr-only"
                  id={`opt-${index}`}
                />
                <label 
                  htmlFor={`opt-${index}`}
                  className="w-8 h-8 rounded-full border-2 border-gray-300 dark:border-slate-600 flex items-center justify-center cursor-pointer peer-checked:bg-green-500 peer-checked:border-green-500 text-gray-400 peer-checked:text-white font-bold transition-all"
                >
                  {String.fromCharCode(65 + index)}
                </label>
             </div>

             {/* TEXT INPUT */}
             <input
                // FIX: Path construït dinàmicament però castat a Path<T>
                {...register(`content.options.${index}.text.${activeLang}` as Path<QuizFormValues>)} 
                className="flex-1 bg-transparent border-b border-gray-300 dark:border-slate-700 focus:border-indigo-500 outline-none text-sm py-1 dark:text-white"
                placeholder={`Opció ${index + 1}`}
             />
             
             {/* INPUT ID HIDDEN */}
             <input 
                type="hidden" 
                // FIX: Path segur per a l'ID
                {...register(`content.options.${index}.id` as Path<QuizFormValues>)} 
                value={index.toString()} 
             />
          </div>
        ))}
      </div>

      {/* EXPLICACIÓ */}
      <div>
        <label className="block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Explicació ({activeLang})</label>
        <textarea
          {...register(`content.explanation.${activeLang}` as Path<QuizFormValues>)}
          className={inputClass}
          rows={2}
          placeholder="Per què és aquesta la resposta correcta?"
        />
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/terminal-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/terminal-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

type TerminalFormValues = Extract<ChallengeFormValues, { type: 'TERMINAL' }>;

export function TerminalEditor({ activeLang }: { activeLang: Lang }) {
  const { register } = useFormContext<TerminalFormValues>();
  const inputClass = "w-full bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded-lg p-2 text-sm dark:text-white font-mono";

  return (
    <div className="space-y-5 animate-in fade-in slide-in-from-right-4">
      {/* INSTRUCCIÓ */}
      <div>
        <label className="block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Objectiu ({activeLang})</label>
        <textarea
          // FIX: Tipatge estricte
          {...register(`content.instruction.${activeLang}` as Path<TerminalFormValues>)}
          className={inputClass.replace('font-mono', '')}
          rows={2}
          placeholder="Navega al directori /var/www..."
        />
      </div>

      {/* COMMANDES VÀLIDES */}
      <div>
        <label className="block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase">Commandes Acceptades</label>
        <div className="space-y-2">
           {[0, 1].map(i => (
             <input 
               key={i}
               // FIX: Tipatge estricte per array de strings
               {...register(`content.validCommands.${i}` as Path<TerminalFormValues>)}
               className={inputClass}
               placeholder={i === 0 ? "cd /var/www" : "Alternativa (opcional)..."}
             />
           ))}
        </div>
        <p className="text-[10px] text-gray-400 mt-1">Commandes exactes que validen el repte.</p>
      </div>

      {/* FEEDBACK */}
      <div className="grid grid-cols-2 gap-4">
         <div>
            <label className="block mb-1 text-xs font-bold text-green-600 dark:text-green-400 uppercase">Output Èxit</label>
            <textarea
              // FIX: Tipatge estricte
              {...register('content.outputParams.success' as Path<TerminalFormValues>)}
              className={`${inputClass} bg-green-50 dark:bg-green-900/10 border-green-200 dark:border-green-900`}
              placeholder="Correcte! Has accedit."
            />
         </div>
         <div>
            <label className="block mb-1 text-xs font-bold text-red-600 dark:text-red-400 uppercase">Output Error</label>
            <textarea
              // FIX: Tipatge estricte
              {...register('content.outputParams.error' as Path<TerminalFormValues>)}
              className={`${inputClass} bg-red-50 dark:bg-red-900/10 border-red-200 dark:border-red-900`}
              placeholder="Permís denegat."
            />
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/form/theory-editor.tsx ===================

// filepath: src/presentation/components/admin/challenges/form/theory-editor.tsx
import { useFormContext, Path } from 'react-hook-form';
import { ChallengeFormValues, Lang } from './form-config';

type TheoryFormValues = Extract<ChallengeFormValues, { type: 'THEORY' }>;

export function TheoryEditor({ activeLang }: { activeLang: Lang }) {
  const { register } = useFormContext<TheoryFormValues>();

  const inputClass = "w-full bg-gray-50 dark:bg-slate-900 border border-gray-300 dark:border-slate-700 text-gray-900 dark:text-white text-sm rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-2.5 mb-2";
  const labelClass = "block mb-1 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase";

  return (
    <div className="space-y-4 animate-in fade-in slide-in-from-right-4">
      <div className="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg border border-purple-100 dark:border-purple-800 flex items-start gap-3">
        <span className="text-xl">📚</span>
        <div>
          <h3 className="text-purple-800 dark:text-purple-300 font-bold text-sm mb-1">Mode: Theory Lesson</h3>
          <p className="text-xs text-purple-600 dark:text-purple-400">
            Contingut educatiu pur. Suporta Markdown per a format ric.
          </p>
        </div>
      </div>

      {/* TITOL */}
      <div>
        <label className={labelClass}>Títol de la Lliçó ({activeLang})</label>
        <input
          {...register(`content.title.${activeLang}` as Path<TheoryFormValues>)}
          className={inputClass}
          placeholder="Introducció a..."
        />
      </div>

      {/* TEMPS DE LECTURA */}
      <div>
        <label className={labelClass}>Temps de lectura (minuts)</label>
        <input
          type="number"
          {...register('content.timeToRead' as Path<TheoryFormValues>)}
          className={inputClass}
          placeholder="5"
        />
      </div>

      {/* CONTINGUT MARKDOWN */}
      <div>
        <label className={labelClass}>Contingut Markdown ({activeLang})</label>
        <div className="relative">
          <textarea
            {...register(`content.markdownContent.${activeLang}` as Path<TheoryFormValues>)}
            rows={15}
            className={`${inputClass} font-mono text-xs leading-relaxed`}
            placeholder="# Títol principal\n\nEl text va aquí amb **negreta** i *cursiva*..."
          />
          <div className="absolute bottom-2 right-2 text-[10px] text-gray-400 bg-white dark:bg-slate-900 px-2 rounded border border-gray-200 dark:border-slate-700">
             Markdown Supported
          </div>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/list/challenge-filters.tsx ===================

// filepath: src/presentation/components/admin/challenges/list/challenge-filters.tsx
'use client';

import { useRouter, useSearchParams } from 'next/navigation';

interface Props {
  topics: { id: string; name: string }[];
}

const CHALLENGE_TYPES = ['QUIZ', 'CODE_FIX', 'TERMINAL', 'BINARY_DECISION', 'MATCHING', 'LOGIC_ORDER'];

export function ChallengeFilters({ topics }: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();
  
  const currentTopic = searchParams.get('topic') || 'ALL';
  const currentType = searchParams.get('type') || 'ALL'; // <--- NOU

  const handleFilterChange = (key: 'topic' | 'type', value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    params.set(key, value);
    params.set('page', '1'); // Reset paginació
    router.push(`?${params.toString()}`);
  };

  // Classe comuna per als selects (Dark Mode)
  const selectClass = "appearance-none pl-3 pr-8 py-2 text-sm font-medium bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 text-gray-900 dark:text-white rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer shadow-sm min-w-[160px]";

  return (
    <div className="flex flex-col sm:flex-row gap-3">
      {/* SELECTOR DE TEMES */}
      <div className="relative">
        <select 
          value={currentTopic} 
          onChange={(e) => handleFilterChange('topic', e.target.value)}
          className={selectClass}
        >
          <option value="ALL">Tots els Temes</option>
          {topics.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
        </select>
      </div>

      {/* SELECTOR DE TIPUS (NOU) */}
      <div className="relative">
        <select 
          value={currentType} 
          onChange={(e) => handleFilterChange('type', e.target.value)}
          className={selectClass}
        >
          <option value="ALL">Tots els Tipus</option>
          {CHALLENGE_TYPES.map(type => (
            <option key={type} value={type}>{type}</option>
          ))}
        </select>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/list/challenge-table.tsx ===================

// filepath: src/presentation/components/admin/challenges/list/challenge-table.tsx
import Link from 'next/link';
import { deleteChallengeAction } from '@/presentation/actions/admin/challenge.actions';
import { AdminChallengeSummary } from '@/infrastructure/repositories/supabase/challenge.repository';

interface Props {
  challenges: AdminChallengeSummary[];
}

export function ChallengeTable({ challenges }: Props) {
  return (
    <div className="bg-white dark:bg-slate-900 rounded-xl border border-gray-200 dark:border-slate-800 shadow-sm overflow-hidden transition-colors">
      <div className="overflow-x-auto">
        <table className="w-full text-left border-collapse">
          <thead className="bg-gray-50 dark:bg-slate-950 border-b border-gray-100 dark:border-slate-800">
            <tr>
              <HeaderCell>Tipus</HeaderCell>
              <HeaderCell>Tema</HeaderCell>
              <HeaderCell align="center">Nivell</HeaderCell>
              <HeaderCell>Creat</HeaderCell>
              <HeaderCell align="right">Accions</HeaderCell>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100 dark:divide-slate-800">
            {challenges.map((challenge) => (
              <tr key={challenge.id} className="hover:bg-gray-50 dark:hover:bg-slate-800/50 transition-colors group">
                <td className="px-6 py-4 whitespace-nowrap">
                  <Badge type={challenge.type} />
                </td>
                <td className="px-6 py-4 font-mono text-xs text-gray-600 dark:text-slate-400">
                  {challenge.topicSlug}
                </td>
                <td className="px-6 py-4 text-center">
                  <div className="inline-flex items-center justify-center w-6 h-6 rounded bg-gray-100 dark:bg-slate-800 text-gray-700 dark:text-slate-300 text-xs font-bold">
                    {challenge.difficultyTier}
                  </div>
                </td>
                <td className="px-6 py-4 text-xs text-gray-500 dark:text-slate-500 whitespace-nowrap">
                  {new Date(challenge.createdAt).toLocaleDateString()}
                </td>
                <td className="px-6 py-4 text-right whitespace-nowrap">
                  <ActionsCell id={challenge.id} />
                </td>
              </tr>
            ))}

            {challenges.length === 0 && (
              <tr>
                <td colSpan={5} className="px-6 py-16 text-center text-gray-500 dark:text-slate-400">
                  <div className="flex flex-col items-center gap-2">
                    <span className="text-2xl">📭</span>
                    <p>No s'han trobat reptes amb aquests filtres.</p>
                  </div>
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
}

// --- SUB-COMPONENTS PER MANTENIR EL CODI NET ---

function HeaderCell({ children, align = 'left' }: { children: React.ReactNode; align?: 'left' | 'center' | 'right' }) {
  return (
    <th className={`px-6 py-4 text-xs font-semibold text-gray-500 dark:text-slate-400 uppercase tracking-wider text-${align}`}>
      {children}
    </th>
  );
}

function Badge({ type }: { type: string }) {
  const styles = getTypeColor(type);
  return (
    <span className={`inline-flex items-center px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide border ${styles}`}>
      {type}
    </span>
  );
}

function ActionsCell({ id }: { id: string }) {
  return (
    <div className="flex justify-end items-center gap-3">
      <Link
        href={`/sys-ops/challenges/${id}/edit`}
        className="text-indigo-600 dark:text-indigo-400 hover:text-indigo-900 dark:hover:text-indigo-300 font-medium text-xs flex items-center gap-1 hover:underline"
      >
        ✏️ Editar
      </Link>

      <form action={async () => {
        'use server';
        await deleteChallengeAction(id);
      }}>
        <button
          type="submit"
          className="text-gray-400 hover:text-red-600 dark:hover:text-red-400 transition-colors text-xs font-medium"
          title="Eliminar"
        >
          🗑️
        </button>
      </form>
    </div>
  );
}

// Helper de colors adaptat a Dark Mode
function getTypeColor(type: string) {
  switch (type) {
    case 'QUIZ': 
      return 'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-950/30 dark:text-blue-400 dark:border-blue-900';
    case 'TERMINAL': 
      return 'bg-gray-900 text-green-400 border-gray-700 dark:bg-black dark:text-green-500 dark:border-green-900';
    case 'BINARY_DECISION': 
      return 'bg-purple-50 text-purple-700 border-purple-200 dark:bg-purple-950/30 dark:text-purple-400 dark:border-purple-900';
    case 'CODE_FIX': 
      return 'bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-950/30 dark:text-amber-400 dark:border-amber-900';
    default: 
      return 'bg-gray-50 text-gray-700 border-gray-200 dark:bg-slate-800 dark:text-slate-400 dark:border-slate-700';
  }
}

// =================== FILE: src/presentation/components/admin/challenges/navigation/challenge-navigation.tsx ===================

// filepath: src/presentation/components/admin/challenges/navigation/challenge-navigation.tsx
import Link from 'next/link';

interface Props {
  prevId: string | null;
  nextId: string | null;
}

export function ChallengeNavigation({ prevId, nextId }: Props) {
  // Estils comuns per als botons de navegació
  const btnClass = "flex items-center px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed";

  return (
    <div className="flex items-center gap-2">
      {/* BOTÓ TORNAR AL LLISTAT */}
      <Link 
        href="/sys-ops/challenges" 
        className="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-slate-800/50 hover:bg-gray-200 dark:hover:bg-slate-700 rounded-lg transition-colors mr-2"
        title="Tornar al llistat"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
        <span className="hidden sm:inline">Llista</span>
      </Link>

      <div className="h-6 w-px bg-gray-300 dark:bg-slate-700 mx-1"></div>

      {/* PREVIOUS */}
      {prevId ? (
        <Link href={`/sys-ops/challenges/${prevId}/edit`} className={btnClass} title="Repte anterior (més nou)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </Link>
      ) : (
        <button disabled className={btnClass}>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="opacity-50"><polyline points="15 18 9 12 15 6"></polyline></svg>
        </button>
      )}

      {/* NEXT */}
      {nextId ? (
        <Link href={`/sys-ops/challenges/${nextId}/edit`} className={btnClass} title="Repte següent (més antic)">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </Link>
      ) : (
        <button disabled className={btnClass}>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="opacity-50"><polyline points="9 18 15 12 9 6"></polyline></svg>
        </button>
      )}
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/preview/cards/binary-card.tsx ===================

import { Lang } from '../../form/form-config';


// --- TIPUS DE DADES PER AL PREVIEW (EVITEM ANY) ---
interface BinaryData {
  statement?: Record<string, string>;
  variant?: 'TRUE_FALSE' | 'HOT_OR_NOT';
  explanation?: Record<string, string>;
}

// 2. BINARY DECISION
export function BinaryCardPreview({ content, lang }: { content: BinaryData, lang: Lang }) {
  const statement = content?.statement?.[lang] || "";
  const variant = content?.variant || 'TRUE_FALSE';
  const isHot = variant === 'HOT_OR_NOT';

  return (
    <div className="space-y-6 mt-8 animate-in zoom-in-95 duration-300">
      <div className="flex justify-center">
        <div className={`w-28 h-28 rounded-full flex items-center justify-center text-5xl shadow-xl mb-4 ${isHot
            ? 'bg-linear-to-br from-orange-100 to-red-100 dark:from-orange-900/40 dark:to-red-900/40'
            : 'bg-linear-to-br from-blue-100 to-indigo-100 dark:from-blue-900/40 dark:to-indigo-900/40'
          }`}>
          {isHot ? '🌶️' : '🧠'}
        </div>
      </div>

      <div className="text-center px-2">
        <h3 className="text-xl font-black text-slate-800 dark:text-white leading-tight drop-shadow-sm">
          {statement || "Escriu alguna cosa..."}
        </h3>
      </div>

      <div className="grid grid-cols-2 gap-4 mt-8">
        <div className="aspect-square rounded-2xl bg-white dark:bg-slate-800 border-2 border-gray-100 dark:border-slate-700 flex flex-col items-center justify-center gap-2 shadow-sm hover:border-green-500 dark:hover:border-green-500 transition-all cursor-pointer group">
          <span className="text-3xl group-hover:scale-110 transition-transform">{isHot ? '🔥' : '✅'}</span>
          <span className="text-xs font-bold text-gray-400 group-hover:text-green-500">{isHot ? 'HOT' : 'TRUE'}</span>
        </div>
        <div className="aspect-square rounded-2xl bg-white dark:bg-slate-800 border-2 border-gray-100 dark:border-slate-700 flex flex-col items-center justify-center gap-2 shadow-sm hover:border-red-500 dark:hover:border-red-500 transition-all cursor-pointer group">
          <span className="text-3xl group-hover:scale-110 transition-transform">{isHot ? '❄️' : '❌'}</span>
          <span className="text-xs font-bold text-gray-400 group-hover:text-red-500">{isHot ? 'NOT' : 'FALSE'}</span>
        </div>
      </div>
    </div>
  );
}


// =================== FILE: src/presentation/components/admin/challenges/preview/cards/code-fix-card.tsx ===================

import { Lang } from '../../form/form-config';
interface CodeFixData {
  description?: Record<string, string>;
  initialCode?: string;
  hint?: Record<string, string>;
}

// 1. CODE FIX (Simulador IDE)
export function CodeFixCardPreview({ content, lang }: { content: CodeFixData, lang: Lang }) {
  const description = content?.description?.[lang] || "Descripció del problema...";
  const code = content?.initialCode || "// El teu codi apareixerà aquí...";

  return (
    <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-500">
      {/* Bombolla de Chat / Instrucció */}
      <div className="bg-white dark:bg-slate-800 p-4 rounded-tl-2xl rounded-tr-2xl rounded-br-2xl shadow-sm border border-gray-100 dark:border-slate-700">
        <p className="text-sm text-gray-700 dark:text-gray-200 leading-relaxed">
          {description}
        </p>
      </div>

      {/* Editor de Codi Simulat */}
      <div className="rounded-xl overflow-hidden shadow-lg border border-slate-200 dark:border-slate-800 bg-[#1e1e1e] font-mono text-xs">
        {/* Fake Tabs */}
        <div className="flex bg-[#252526] px-2 pt-2 border-b border-[#333]">
          <div className="bg-[#1e1e1e] text-blue-400 px-3 py-1.5 rounded-t-md flex items-center gap-2">
            <span className="text-[10px]">TS</span>
            <span>solution.ts</span>
          </div>
        </div>

        {/* Code Area */}
        <div className="p-4 text-gray-300 overflow-x-auto">
          <pre className="whitespace-pre-wrap leading-relaxed">
            <code>
              <span className="text-pink-400">function</span> <span className="text-yellow-200">fixMe</span>() {'{'}
              {'\n'}  {code}
              {'\n'}
              {'}'}
            </code>
          </pre>
        </div>
      </div>

      {/* Fake Terminal Output */}
      <div className="bg-black/90 rounded-lg p-3 font-mono text-[10px] text-green-400 border border-slate-800 shadow-inner">
        <div className="opacity-50 mb-1">$ running tests...</div>
        <div>❌ Error: Expected output '42', got 'undefined'</div>
      </div>
    </div>
  );
}


// =================== FILE: src/presentation/components/admin/challenges/preview/cards/ctf-card.tsx ===================

import { Lang } from '../../form/form-config';

// 1. Afegeix interfície
interface CtfData {
  description?: Record<string, string>;
  flag?: string;
}

// 3. Crea el component visual
export function CtfCardPreview({ content, lang }: { content: CtfData, lang: Lang }) {
  return (
    <div className="space-y-4 animate-in zoom-in-95 duration-300 mt-4">
      <div className="bg-emerald-950 border border-emerald-800 p-4 rounded-lg font-mono text-xs text-emerald-400 shadow-2xl">
        <div className="border-b border-emerald-900 pb-2 mb-2 flex justify-between">
           <span>MISSION_BRIEFING.TXT</span>
           <span>TOP SECRET</span>
        </div>
        <p className="leading-relaxed">
          {content?.description?.[lang] || "Waiting for mission details..."}
        </p>
      </div>

      <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700">
        <label className="text-[10px] font-bold text-gray-400 uppercase mb-1 block">Enter Flag</label>
        <div className="flex gap-2">
           <input disabled className="flex-1 bg-gray-100 dark:bg-slate-900 border border-gray-200 dark:border-slate-700 rounded-md px-3 py-2 text-sm font-mono" placeholder="CTF{...}" />
           <button className="bg-emerald-600 text-white px-3 py-1 rounded-md text-xs font-bold">SUBMIT</button>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/preview/cards/logic-order-card.tsx ===================

import { Lang } from '../../form/form-config';

interface LogicData {
  description?: Record<string, string>;
  items?: Array<{ id: string; text: Record<string, string> }>;
}

export function LogicOrderCardPreview({ content, lang }: { content: LogicData, lang: Lang }) {
  const desc = content?.description?.[lang] || "Ordena la seqüència...";
  const items = content?.items || [];

  return (
    <div className="space-y-4 animate-in zoom-in-95 duration-300 mt-4">
      <h3 className="text-center font-bold text-slate-700 dark:text-white text-sm">{desc}</h3>

      <div className="space-y-2 relative">
         {/* LÍNIA CONNECTORA */}
         <div className="absolute left-4 top-4 bottom-4 w-0.5 bg-gray-200 dark:bg-slate-700 -z-10"></div>

         {items.map((item, i) => (
            item?.text?.[lang] && (
              <div key={i} className="flex items-center gap-3 bg-white dark:bg-slate-800 p-3 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 cursor-grab active:cursor-grabbing hover:scale-[1.02] transition-transform">
                 <div className="bg-gray-100 dark:bg-slate-700 w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs text-gray-500 dark:text-gray-300 shrink-0 z-10">
                    {i + 1}
                 </div>
                 <span className="text-sm text-gray-700 dark:text-gray-200">{item.text[lang]}</span>
                 <div className="ml-auto text-gray-300 dark:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
                 </div>
              </div>
            )
         ))}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/preview/cards/matching-card.tsx ===================

import { Lang } from '../../form/form-config';

interface MatchingData {
  instruction?: Record<string, string>;
  pairs?: Array<{ left: { text: Record<string, string> }; right: { text: Record<string, string> } }>;
}

export function MatchingCardPreview({ content, lang }: { content: MatchingData, lang: Lang }) {
  const instruction = content?.instruction?.[lang] || "Relaciona els conceptes...";
  const pairs = content?.pairs || [];

  return (
    <div className="space-y-4 animate-in zoom-in-95 duration-300 mt-4">
      <div className="bg-white dark:bg-slate-800 p-4 rounded-xl shadow-sm border border-gray-100 dark:border-slate-700 text-center">
        <h3 className="font-bold text-slate-800 dark:text-white text-sm">{instruction}</h3>
      </div>

      <div className="flex justify-between gap-2 relative">
         {/* COLUMNA ESQUERRA */}
         <div className="flex flex-col gap-3 w-1/2">
            {pairs.map((p, i) => (
               p?.left?.text?.[lang] && (
                 <div key={i} className="bg-indigo-50 dark:bg-indigo-900/20 border border-indigo-200 dark:border-indigo-800 p-3 rounded-lg text-xs font-medium text-indigo-700 dark:text-indigo-300 shadow-sm relative h-12 flex items-center">
                    {p.left.text[lang]}
                    <div className="absolute -right-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-indigo-400 rounded-full border-2 border-white dark:border-slate-900"></div>
                 </div>
               )
            ))}
         </div>

         {/* COLUMNA DRETA (Desordenada visualment per efecte) */}
         <div className="flex flex-col gap-3 w-1/2">
            {pairs.map((p, i) => (
               p?.right?.text?.[lang] && (
                 <div key={i} className="bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 p-3 rounded-lg text-xs text-gray-600 dark:text-gray-300 shadow-sm h-12 flex items-center justify-end relative">
                    <div className="absolute -left-1.5 top-1/2 -translate-y-1/2 w-3 h-3 bg-gray-300 dark:bg-slate-600 rounded-full border-2 border-white dark:border-slate-900"></div>
                    {p.right.text[lang]}
                 </div>
               )
            ))}
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/preview/cards/quiz-card.tsx ===================

import { Lang } from '../../form/form-config';

interface QuizData {
  question?: Record<string, string>;
  options?: Array<{ id: string; text: Record<string, string> }>;
}
// 3. QUIZ
export function QuizCardPreview({ content, lang }: { content: QuizData, lang: Lang }) {
  const question = content?.question?.[lang] || "Pregunta...";
  // Simulació d'opcions si no n'hi ha encara
  const options = content?.options && content.options.length > 0
    ? content.options
    : [{ id: '1', text: { [lang]: 'Opció A' } }, { id: '2', text: { [lang]: 'Opció B' } }];

  return (
    <div className="space-y-6 mt-4">
      <div className="bg-white dark:bg-slate-800 p-5 rounded-2xl shadow-sm border border-gray-100 dark:border-slate-700">
        <h3 className="text-lg font-bold text-slate-800 dark:text-white leading-snug">
          {question}
        </h3>
      </div>

      <div className="space-y-3">
        {options.map((opt, idx) => (
          <div key={idx} className="p-4 rounded-xl bg-white dark:bg-slate-800 border-2 border-gray-100 dark:border-slate-700 flex items-center gap-3 cursor-pointer hover:border-indigo-500 dark:hover:border-indigo-500 transition-all">
            <div className="w-6 h-6 rounded-full border-2 border-gray-300 dark:border-slate-600 flex items-center justify-center text-[10px] font-bold text-gray-400">
              {String.fromCharCode(65 + idx)}
            </div>
            <span className="text-sm font-medium text-slate-600 dark:text-slate-300">
              {opt.text?.[lang] || `Opció ${idx + 1}`}
            </span>
          </div>
        ))}
      </div>
    </div>
  );
}



// =================== FILE: src/presentation/components/admin/challenges/preview/cards/terminal-card.tsx ===================

import { Lang } from '../../form/form-config';

interface TerminalData {
  instruction?: Record<string, string>;
  initialCommand?: string;
  outputParams?: { success: string; error: string };
}

export function TerminalCardPreview({ content, lang }: { content: TerminalData, lang: Lang }) {
  const instruction = content?.instruction?.[lang] || "Executa la comanda...";
  const initialCmd = content?.initialCommand || "";

  return (
    <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-500 mt-4">
      {/* INSTRUCCIÓ */}
      <div className="bg-white dark:bg-slate-800 p-3 rounded-lg border-l-4 border-green-500 shadow-sm">
         <p className="text-xs font-mono text-gray-600 dark:text-gray-300">
           <span className="font-bold text-green-600 dark:text-green-400">MISSION:</span> {instruction}
         </p>
      </div>

      {/* TERMINAL WINDOW */}
      <div className="bg-gray-900 rounded-xl shadow-2xl overflow-hidden border border-gray-700 font-mono text-xs">
         {/* HEADER */}
         <div className="bg-gray-800 px-3 py-2 flex gap-1.5 border-b border-gray-700">
            <div className="w-2.5 h-2.5 rounded-full bg-red-500"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-yellow-500"></div>
            <div className="w-2.5 h-2.5 rounded-full bg-green-500"></div>
            <div className="ml-auto text-[9px] text-gray-500">bash — 80x24</div>
         </div>

         {/* BODY */}
         <div className="p-4 text-green-400 h-48 flex flex-col gap-1">
            <div><span className="text-blue-400">user@hacklab</span>:<span className="text-white">~</span>$ ls -la</div>
            <div className="text-gray-400">drwxr-xr-x  secrets</div>
            <div><span className="text-blue-400">user@hacklab</span>:<span className="text-white">~</span>$ {initialCmd}<span className="animate-pulse inline-block w-2 h-4 bg-green-400 align-middle ml-1"></span></div>
         </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/preview/cards/theory-card.tsx ===================

// filepath: src/presentation/components/admin/challenges/preview/cards/theory-card.tsx
import { Lang } from '../../form/form-config';

interface TheoryData {
  title?: Record<string, string>;
  markdownContent?: Record<string, string>;
  timeToRead?: number;
}

export function TheoryCardPreview({ content, lang }: { content: TheoryData, lang: Lang }) {
  const title = content?.title?.[lang] || "Títol de la lliçó...";
  const markdown = content?.markdownContent?.[lang] || "El contingut apareixerà aquí...";
  const time = content?.timeToRead || 5;

  return (
    <div className="bg-white dark:bg-slate-900 min-h-full animate-in fade-in duration-500">
      {/* HEADER IMATGE */}
      <div className="h-40 bg-linear-to-br from-purple-500 to-indigo-600 relative">
        <div className="absolute bottom-0 left-0 p-4 w-full bg-linear-to-t from-black/50 to-transparent">
           <span className="text-[10px] font-bold text-white/80 uppercase tracking-widest bg-black/30 px-2 py-0.5 rounded backdrop-blur-md">
             THEORY
           </span>
        </div>
      </div>

      <div className="p-5 -mt-6 relative z-10">
        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg p-5 border border-gray-100 dark:border-slate-700">
           <div className="flex items-center gap-2 mb-3 text-xs text-gray-500 dark:text-gray-400">
              <span>⏱️ {time} min read</span>
              <span>•</span>
              <span>📚 Lesson 1</span>
           </div>
           
           <h1 className="text-2xl font-bold text-gray-900 dark:text-white leading-tight mb-4">
             {title}
           </h1>

           {/* SIMULACIÓ MARKDOWN RENDERER */}
           <div className="prose prose-sm dark:prose-invert max-w-none">
              <p className="whitespace-pre-wrap text-gray-600 dark:text-gray-300 leading-relaxed text-sm">
                {markdown}
              </p>
           </div>
        </div>

        <div className="mt-8 flex justify-center">
           <button className="bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-300 px-6 py-2 rounded-full text-sm font-bold hover:bg-purple-200 transition-colors">
             Mark as Completed
           </button>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/admin/challenges/preview/live-preview.tsx ===================

// filepath: src/presentation/components/admin/challenges/preview/live-preview.tsx
'use client';

import { useFormContext } from 'react-hook-form';
import { ChallengeFormValues, Lang } from '../form/form-config';

// Importem TOTS els components de targetes
import { BinaryCardPreview } from './cards/binary-card';
import { CodeFixCardPreview } from './cards/code-fix-card';
import { QuizCardPreview } from './cards/quiz-card';
import { CtfCardPreview } from './cards/ctf-card';
import { TheoryCardPreview } from './cards/theory-card';
import { MatchingCardPreview } from './cards/matching-card'; // 👈 NOU
import { TerminalCardPreview } from './cards/terminal-card'; // 👈 NOU
import { LogicOrderCardPreview } from './cards/logic-order-card'; // 👈 NOU

// Definim interfícies per al casting segur (Unió de tots els tipus possibles)
// Definim interfícies per al casting segur (Unió de tots els tipus possibles)
export interface PreviewContent {
  // --- BINARY DECISION ---
  statement?: Record<string, string>;
  variant?: 'TRUE_FALSE' | 'HOT_OR_NOT';
  explanation?: Record<string, string>;

  // --- CODE FIX / CTF ---
  description?: Record<string, string>;
  initialCode?: string;
  flag?: string;
  hint?: Record<string, string>;

  // --- QUIZ ---
  question?: Record<string, string>;
  options?: Array<{ 
    id: string; 
    text: Record<string, string> 
  }>;

  // --- THEORY ---
  title?: Record<string, string>;
  markdownContent?: Record<string, string>;
  timeToRead?: number;

  // --- MATCHING (Fix 'any') ---
  instruction?: Record<string, string>;
  pairs?: Array<{
    left: { id: string; text: Record<string, string> };
    right: { id: string; text: Record<string, string> };
  }>;

  // --- TERMINAL (Fix 'any') ---
  initialCommand?: string;
  outputParams?: {
    success: string;
    error: string;
  };
  validCommands?: string[];

  // --- LOGIC ORDER (Fix 'any') ---
  items?: Array<{
    id: string;
    text: Record<string, string>;
  }>;
}

interface Props {
  activeLang: Lang;
}

export function LivePreview({ activeLang }: Props) {
  const { watch } = useFormContext<ChallengeFormValues>();
  
  // Watch optimitzat
  const [type, content, difficulty] = watch(['type', 'content', 'difficultyTier']);

  // Casting segur: Tractem el contingut com una unió de tots els possibles camps
  const safeContent = content as unknown as PreviewContent;

  const getHeaderTitle = () => {
    switch (type) {
      case 'CODE_FIX': return 'BUG HUNTER';
      case 'QUIZ': return 'KNOWLEDGE CHECK';
      case 'CTF': return 'HACKER MODE';
      case 'THEORY': return 'LEARNING';
      case 'MATCHING': return 'CONNECT';
      case 'TERMINAL': return 'TERMINAL';
      case 'LOGIC_ORDER': return 'SEQUENCE';
      default: return 'CHALLENGE';
    }
  };

  return (
    <div className="h-full flex flex-col items-center justify-center p-4 bg-gray-100 dark:bg-black/50 border-l border-gray-200 dark:border-slate-800">
      
      {/* --- DEVICE FRAME (IPHONE) --- */}
      <div className="relative w-full max-w-[360px] h-[640px] bg-white dark:bg-slate-950 rounded-[3rem] shadow-2xl border-8 border-gray-900 dark:border-gray-800 overflow-hidden flex flex-col">
        
        {/* NOTCH */}
        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-6 bg-gray-900 dark:bg-gray-800 rounded-b-xl z-20"></div>
        
        {/* STATUS BAR */}
        <div className="h-12 bg-gray-50 dark:bg-slate-900 border-b border-gray-100 dark:border-slate-800 flex items-center justify-between px-6 pt-2 shrink-0">
           <span className="text-[10px] font-mono text-gray-400">9:41</span>
           <span className="text-[10px] font-mono text-gray-400">100%</span>
        </div>

        {/* --- SCREEN CONTENT (SCROLLABLE) --- */}
        <div className="flex-1 flex flex-col relative overflow-y-auto custom-scrollbar bg-gray-50 dark:bg-slate-900">
            
            {/* APP HEADER (Excepte per teoria que té header propi) */}
            {type !== 'THEORY' && (
              <div className="p-4 flex justify-between items-center z-10 sticky top-0 bg-gray-50/90 dark:bg-slate-900/90 backdrop-blur-sm">
                 <div className="flex flex-col">
                   <span className="text-[10px] font-black tracking-widest text-gray-400 uppercase">{getHeaderTitle()}</span>
                   <div className="flex gap-1 mt-1">
                     {[1,2,3,4,5].map(i => (
                       <div key={i} className={`h-1 w-4 rounded-full ${i <= (difficulty || 1) ? 'bg-indigo-500' : 'bg-gray-200 dark:bg-slate-800'}`}></div>
                     ))}
                   </div>
                 </div>
                 <span className="text-xs font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-1 rounded-md">XP +{(difficulty || 1) * 10}</span>
              </div>
            )}

            {/* CONTENT AREA */}
            <div className={`flex-1 ${type !== 'THEORY' ? 'p-4 pb-20' : ''}`}>
                {/* RENDERITZACIÓ CONDICIONAL PER A TOTS ELS TIPUS */}
                {type === 'BINARY_DECISION' && <BinaryCardPreview content={safeContent} lang={activeLang} />}
                {type === 'CODE_FIX' && <CodeFixCardPreview content={safeContent} lang={activeLang} />}
                {type === 'QUIZ' && <QuizCardPreview content={safeContent} lang={activeLang} />}
                {type === 'CTF' && <CtfCardPreview content={safeContent} lang={activeLang} />}
                {type === 'THEORY' && <TheoryCardPreview content={safeContent} lang={activeLang} />}
                {type === 'MATCHING' && <MatchingCardPreview content={safeContent} lang={activeLang} />}
                {type === 'TERMINAL' && <TerminalCardPreview content={safeContent} lang={activeLang} />}
                {type === 'LOGIC_ORDER' && <LogicOrderCardPreview content={safeContent} lang={activeLang} />}

                {/* Fallback per si ens deixem algun tipus futur */}
                {!['BINARY_DECISION', 'CODE_FIX', 'QUIZ', 'CTF', 'THEORY', 'MATCHING', 'TERMINAL', 'LOGIC_ORDER'].includes(type) && (
                  <div className="flex flex-col items-center justify-center h-full text-center text-gray-400 opacity-50 p-8">
                    <span className="text-4xl mb-4">🚧</span>
                    <p className="text-xs uppercase font-mono">Preview not available for<br/>{type}</p>
                  </div>
                )}
            </div>

            {/* ACTION BUTTON (Excepte per teoria) */}
            {type !== 'THEORY' && (
              <div className="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-white via-white to-transparent dark:from-slate-900 dark:via-slate-900 pt-10">
                 <button className="w-full py-3.5 bg-black dark:bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg transform active:scale-95 transition-all">
                   {type === 'TERMINAL' ? 'EXECUTE' : 'CHECK ANSWER'}
                 </button>
              </div>
            )}
        </div>

        {/* HOME INDICATOR */}
        <div className="absolute bottom-1 left-1/2 -translate-x-1/2 w-32 h-1 bg-gray-300 dark:bg-gray-700 rounded-full z-20"></div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/auth/LogoutButton.tsx ===================

// filepath: src/presentation/components/auth/LogoutButton.tsx
'use client';

import { LogOut } from 'lucide-react';
import { logoutAction } from '@/presentation/actions/auth/logout.actions';

export function LogoutButton() {
  return (
    <button 
      onClick={() => logoutAction()}
      className="flex items-center gap-2 text-slate-400 hover:text-red-400 transition-colors text-sm font-medium p-2 rounded-lg hover:bg-red-500/10 w-full"
    >
      <LogOut className="w-4 h-4" />
      <span>Tancar Sessió</span>
    </button>
  );
}

// =================== FILE: src/presentation/components/features/dashboard/TopicCard.tsx ===================

'use client'; // Assegura't que és un client component

import Link from 'next/link';
import { DashboardTopicDTO } from '@/application/dto/dashboard-topic.dto';
import { getTopicIcon } from '@/presentation/utils/icon-mapper';
import { getLocalizedText } from '@/core/utils/i18n-utils'; // ✅ Importem la utilitat
import { clsx } from 'clsx';
import { ArrowRight, Lock } from 'lucide-react';

interface TopicCardProps {
  topic: DashboardTopicDTO;
  translatedTitle: string;
  locale: string; // ✅ NOU: Rebem l'idioma des del pare
}

export function TopicCard({ topic, translatedTitle, locale }: TopicCardProps) {
  const themeColor = topic.colorTheme || 'bg-slate-700';
  
  // ✅ FIX: Ara no peta perquè usem la prop directa, no el hook
  const translatedDescription = getLocalizedText(topic.description, locale);

  return (
    <Link 
      href={topic.isLocked ? '#' : `/learn/${topic.slug}`}
      className={clsx(
        "group relative flex flex-col bg-slate-900 border-2 border-slate-800 rounded-2xl overflow-hidden transition-all duration-200",
        !topic.isLocked && "hover:-translate-y-1 hover:border-blue-500/50 hover:shadow-[0_8px_0_0_#1e293b] active:translate-y-0 active:shadow-none",
        topic.isLocked && "opacity-60 cursor-not-allowed grayscale"
      )}
    >
      {/* HEADER DE COLOR */}
      <div className={clsx("h-24 flex items-center justify-center relative overflow-hidden", themeColor)}>
         <div className="absolute inset-0 bg-black/10" /> 
         <div className="text-white drop-shadow-md transform group-hover:scale-110 transition-transform duration-300">
            {getTopicIcon(topic.iconName, "w-12 h-12")}
         </div>
      </div>

      {/* BODY */}
      <div className="p-5 flex-1 flex flex-col">
       <h3 className="text-lg font-bold text-white mb-1">{translatedTitle}</h3>
       
       {/* ✅ FIX: Ara pintem un string, no l'objecte sencer */}
       <p className="text-slate-400 text-xs mb-4 line-clamp-2">
         {translatedDescription}
       </p>

       {/* BARRA DE PROGRÉS */}
       <div className="mt-auto">
           <div className="flex justify-between text-xs font-bold mb-1.5 uppercase tracking-wider">
              <span className={topic.isLocked ? "text-slate-600" : "text-blue-400"}>
                 {topic.isLocked ? "Bloquejat" : `Nivell ${topic.currentLevel}`}
              </span>
              <span className="text-slate-500">{topic.progressPercentage}%</span>
           </div>
           
           <div className="h-3 w-full bg-slate-800 rounded-full overflow-hidden border border-slate-700/50">
              <div 
                className={clsx("h-full rounded-full transition-all duration-1000", 
                    topic.isLocked ? "bg-slate-600" : "bg-blue-500"
                )}
                style={{ width: `${topic.progressPercentage}%` }}
              />
           </div>
        </div>
      </div>

      {/* BOTÓ D'ACCIÓ */}
      {!topic.isLocked && (
          <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
              <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                 <ArrowRight className="w-4 h-4 text-white" />
              </div>
          </div>
      )}
      
      {topic.isLocked && (
         <div className="absolute top-3 right-3">
             <Lock className="w-5 h-5 text-white/50" />
         </div>
      )}
    </Link>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/binary/BinaryView.tsx ===================

// filepath: src/presentation/components/features/game-engine/binary/BinaryView.tsx
'use client';

import { useState, useEffect } from 'react';
import { Challenge, BinaryContent } from '@/core/entities/challenges';
import { Check, X, ArrowRight, CheckCircle2, XCircle, Zap } from 'lucide-react';
import { clsx } from 'clsx';
import { GameSessionLayout } from '../layout/GameSessionLayout';
import { GameHeader } from '../layout/GameHeader';
import { useTranslations, useLocale } from 'next-intl';

interface BinaryViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function BinaryView({ challenge, onNext }: BinaryViewProps) {
  const t = useTranslations('game');
  const locale = useLocale(); 
  const content = challenge.content as BinaryContent;

  // 1. ESTAT INICIAL (Sempre net perquè el component es recrea de zero)
  const [status, setStatus] = useState<'IDLE' | 'CORRECT' | 'WRONG'>('IDLE');
  
  // 2. GHOST CLICK PROTECTION
  // Comencem bloquejats per evitar clics accidentals de la pantalla anterior
  const [isInteractive, setIsInteractive] = useState(false);

  // Aquest Effect només s'executa 1 cop quan el component "neix" (Mount)
  useEffect(() => {
    const timer = setTimeout(() => {
        setIsInteractive(true);
    }, 500); // 0.5 segons de "cooldown"

    return () => clearTimeout(timer);
  }, []); // Array buit = Només al muntar. No depèn de challenge.id

  // --- HELPER TEXT ---
  const getLocalizedText = (text: string | Record<string, string> | undefined) => {
    if (!text) return '';
    if (typeof text === 'string') return text;
    return text[locale] || text['ca'] || text['en'] || Object.values(text)[0] || '';
  };

  if (!content) return null;

  const handleDecision = (userSaysTrue: boolean) => {
    // Si encara estem en "cooldown" o ja hem contestat, ignorem el clic
    if (!isInteractive || status !== 'IDLE') return;

    const isCorrect = userSaysTrue === content.isTrue;
    setStatus(isCorrect ? 'CORRECT' : 'WRONG');
  };

  const handleManualNext = () => {
    onNext(status === 'CORRECT');
  };

  // --- FOOTER ---
  const Footer = (
    <div className={clsx(
        "w-full transition-all duration-300 ease-out transform z-50",
        status === 'IDLE' ? "translate-y-full opacity-0 h-0" : "translate-y-0 opacity-100"
    )}>
       {status !== 'IDLE' && (
        <div className={clsx(
            "p-6 pb-8 flex flex-col gap-4 backdrop-blur-xl border-t-4 rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.5)]",
            status === 'CORRECT' ? "bg-green-950/90 border-green-500" : "bg-red-950/90 border-red-500"
        )}>
            <div className="flex items-start gap-4">
               <div className={clsx(
                   "p-3 rounded-full shrink-0 shadow-lg animate-in zoom-in", 
                   status === 'CORRECT' ? "bg-green-500 text-white" : "bg-red-500 text-white"
               )}>
                  {status === 'CORRECT' ? <CheckCircle2 className="w-8 h-8" /> : <XCircle className="w-8 h-8" />}
               </div>
               <div className="flex-1 space-y-1">
                   <h3 className={clsx("font-black text-xl tracking-tight", status === 'CORRECT' ? "text-green-400" : "text-red-400")}>
                       {status === 'CORRECT' ? t('feedback.correct') : t('feedback.incorrect')}
                   </h3>
                   <p className="text-slate-200 text-sm md:text-base leading-relaxed font-medium">
                       {getLocalizedText(content.explanation)}
                   </p>
               </div>
            </div>
            
            <button 
                onClick={handleManualNext}
                className={clsx(
                    "w-full py-4 font-bold text-lg rounded-2xl transition-all active:scale-95 flex items-center justify-center gap-2 shadow-xl mt-2 animate-in slide-in-from-bottom-2 fade-in duration-500",
                    status === 'CORRECT' ? "bg-green-600 text-white" : "bg-red-600 text-white"
                )}
            >
                {t('arena.continue_btn')} <ArrowRight className="w-6 h-6" />
            </button>
        </div>
       )}
    </div>
  );

  return (
    <GameSessionLayout header={<GameHeader />} footer={Footer}>
      <div className="w-full max-w-lg mx-auto flex flex-col h-full px-4 py-4 md:py-8 gap-4 md:gap-8">
        
        {/* TARGETA */}
        <div className="flex-1 flex flex-col justify-center min-h-0 relative"> 
            <div className={clsx(
              "relative w-full h-full max-h-125 rounded-4xl border-4 shadow-2xl flex flex-col items-center justify-center p-6 md:p-10 text-center transition-all duration-500 transform overflow-hidden bg-slate-800",
              status === 'CORRECT' && "border-green-500 bg-green-900/20 shadow-green-500/20",
              status === 'WRONG' && "border-red-500 bg-red-900/20 shadow-red-500/20",
              status === 'IDLE' && "border-slate-700 shadow-black/50"
            )}>
              <div className="absolute inset-0 bg-linear-to-b from-white/5 to-transparent pointer-events-none" />

              <div className="absolute inset-0 flex items-center justify-center pointer-events-none transition-opacity duration-300 z-0"
                   style={{ opacity: status !== 'IDLE' ? 0.2 : 0 }}>
                  {status === 'CORRECT' ? <Check className="w-64 h-64 text-green-500" /> : status === 'WRONG' ? <X className="w-64 h-64 text-red-500" /> : null}
              </div>

              <div className={clsx("relative z-10 transition-all duration-300 flex flex-col gap-6 items-center w-full", status !== 'IDLE' && "scale-95")}>
                  <div className="inline-flex items-center justify-center gap-2 bg-blue-500/10 text-blue-400 px-4 py-1.5 rounded-full border border-blue-500/20 shadow-inner">
                      <Zap className="w-4 h-4 fill-current" />
                      <span className="font-bold tracking-widest text-[10px] uppercase">RÀPID</span>
                  </div>
                  <h2 className="text-xl md:text-3xl font-black text-white leading-snug select-none text-balance">
                      {getLocalizedText(content.statement)}
                  </h2>
              </div>
            </div>
        </div>

        {/* BOTONS */}
        <div className={clsx(
            "grid grid-cols-2 gap-4 w-full transition-all duration-500",
            status !== 'IDLE' ? "opacity-0 translate-y-20 pointer-events-none h-0" : "opacity-100 translate-y-0 h-auto pb-4",
            !isInteractive && "opacity-50 grayscale" // Feedback visual del cooldown
        )}>
           <button
              onClick={() => handleDecision(false)}
              disabled={!isInteractive} 
              className="group relative bg-red-600/10 hover:bg-red-600 active:bg-red-700 border-2 border-red-600/40 hover:border-red-500 rounded-2xl py-6 md:py-8 flex flex-col items-center justify-center gap-2 transition-all active:scale-90 touch-manipulation shadow-lg disabled:cursor-not-allowed"
           >
              <X className="w-8 h-8 md:w-10 md:h-10 text-red-500 group-hover:text-white transition-colors" />
              <span className="font-bold uppercase tracking-widest text-xs md:text-sm text-red-400 group-hover:text-white transition-colors">Fals</span>
           </button>

           <button
              onClick={() => handleDecision(true)}
              disabled={!isInteractive} 
              className="group relative bg-green-600/10 hover:bg-green-600 active:bg-green-700 border-2 border-green-600/40 hover:border-green-500 rounded-2xl py-6 md:py-8 flex flex-col items-center justify-center gap-2 transition-all active:scale-90 touch-manipulation shadow-lg disabled:cursor-not-allowed"
           >
              <Check className="w-8 h-8 md:w-10 md:h-10 text-green-500 group-hover:text-white transition-colors" />
              <span className="font-bold uppercase tracking-widest text-xs md:text-sm text-green-400 group-hover:text-white transition-colors">Cert</span>
           </button>
        </div>
      </div>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/ChallengeRenderer.tsx ===================

// filepath: src/presentation/components/features/game-engine/ChallengeRenderer.tsx
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { QuizView } from './QuizView';
import { MatchingView } from './MatchingView';
import { CodeFixView } from './CodeFixView';
import { TerminalView } from './TerminalView';
import { LogicOrderView } from './LogicOrderView';
import { BinaryView } from './binary/BinaryView'; // 👈 Importem
import { TheoryView } from './TheoryView';
import { CtfView } from './CtfView';
// Definició de les dades de sessió (Tipatge estricte)

interface ChallengeRendererProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function ChallengeRenderer({ challenge, onNext }: ChallengeRendererProps) {
  // ⚠️ AFEGIM key={challenge.id} A TOTS ELS COMPONENTS
  // Això reseteja l'estat (useState) i les animacions CSS quan canvia el repte.

  switch (challenge.type) {
    case 'QUIZ':
      return <QuizView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'CODE_FIX':
      return <CodeFixView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'TERMINAL':
      return <TerminalView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'MATCHING':
      return <MatchingView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'LOGIC_ORDER':
      return <LogicOrderView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'BINARY_DECISION':
      return <BinaryView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'THEORY':
      return <TheoryView key={challenge.id} challenge={challenge} onNext={onNext} />;
    case 'CTF':
      return <CtfView key={challenge.id} challenge={challenge} onNext={onNext} />;
    default:
      return <div>Tipus desconegut</div>;
  }
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/CodeWindow.tsx ===================

// filepath: src/presentation/components/features/game/code-fix/CodeWindow.tsx
import { clsx } from 'clsx';

const SyntaxHighlighter = ({ code }: { code: string }) => {
  if (!code) return null;
  // Regex millorada per tokenitzar millor símbols
  const parts = code.split(/(\s+|[(){}[\]<>=;:"'`.,])/g);
  
  return (
    <span className="font-mono leading-relaxed whitespace-pre">
      {parts.map((part, i) => {
        if (['function', 'const', 'let', 'var', 'return', 'if', 'else', 'import', 'from', 'export', 'default', 'async', 'await'].includes(part)) 
          return <span key={i} className="text-pink-400 font-semibold">{part}</span>;
        if (['useState', 'useEffect', 'console', 'log'].includes(part)) 
          return <span key={i} className="text-yellow-300">{part}</span>;
        if (part.match(/^[A-Z][a-zA-Z0-9]*$/)) // Components/Classes
          return <span key={i} className="text-yellow-200">{part}</span>;
        if (['=', '=>', '{', '}', '<', '>', '(', ')', '[', ']', '.', ';'].includes(part)) 
          return <span key={i} className="text-blue-300">{part}</span>;
        if (part.startsWith('"') || part.startsWith("'") || part.startsWith('`'))
           return <span key={i} className="text-green-300">{part}</span>;
        if (!isNaN(Number(part)) && part.trim() !== '')
           return <span key={i} className="text-purple-300">{part}</span>;

        return <span key={i} className="text-blue-100/90">{part}</span>;
      })}
    </span>
  );
};

interface CodeWindowProps {
  initialCode: string;
  selectedCode?: string | null;
  status: 'IDLE' | 'RUNNING' | 'SUCCESS' | 'ERROR';
}

export function CodeWindow({ initialCode, selectedCode, status }: CodeWindowProps) {
  const lines = initialCode.split('\n');

  return (
    <div className="bg-[#1e1e1e] relative shadow-inner w-full">
      {/* Scroll Horitzontal per al codi */}
      <div className="overflow-x-auto custom-scrollbar">
          <div className="flex flex-col font-mono text-[11px] sm:text-xs md:text-sm py-4 min-w-fit">
            
            {lines.map((lineContent, index) => {
              const hasGap = lineContent.includes('???');
              let preGap = '', postGap = '';

              if (hasGap) {
                const parts = lineContent.split('???');
                preGap = parts[0];
                postGap = parts[1] || '';
              }

              return (
                <div 
                  key={index} 
                  className={clsx(
                    "group flex hover:bg-[#2a2a2b] transition-colors w-full min-w-max", // min-w-max assegura que la línia no es trenqui
                    hasGap && "bg-blue-900/10"
                  )}
                >
                  {/* Números de línia */}
                  <div className="w-8 sm:w-10 shrink-0 text-right pr-3 select-none text-[#5a5a5a] border-r border-[#333] group-hover:text-slate-400 bg-[#1e1e1e] sticky left-0 z-10">
                    {index + 1}
                  </div>

                  {/* Codi */}
                  <div className="pl-3 sm:pl-4 pr-4 whitespace-pre">
                    {hasGap ? (
                      <div className="inline-block">
                        <SyntaxHighlighter code={preGap} />
                        
                        {/* INPUT BOX */}
                        <span className={clsx(
                          "inline-flex items-center justify-center px-1.5 py-0.5 mx-1 rounded-sm align-middle",
                          "font-bold text-[10px] sm:text-xs min-w-10 transition-all duration-300",
                          "border border-dashed shadow-sm",
                          !selectedCode 
                            ? "bg-slate-800 border-slate-600 text-slate-500 animate-pulse" 
                            : status === 'SUCCESS' 
                              ? "bg-green-500/20 border-green-500 text-green-400 scale-105" 
                              : status === 'ERROR' 
                                ? "bg-red-500/20 border-red-500 text-red-400" 
                                : "bg-blue-500/20 border-blue-400 text-blue-300"
                        )}>
                           {selectedCode || "?"}
                        </span>

                        <SyntaxHighlighter code={postGap} />
                      </div>
                    ) : (
                      <SyntaxHighlighter code={lineContent} />
                    )}
                  </div>
                </div>
              );
            })}
          </div>
      </div>
      
      {/* Footer Info */}
      <div className="bg-[#252526] px-3 py-1 text-[10px] text-slate-500 flex justify-between items-center border-t border-[#333]">
        <span className="uppercase tracking-wider">ReadOnly</span>
        <div className="flex gap-2">
            <span>Ln {lines.length}</span>
            <span>TSX</span>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/HintPanel.tsx ===================

// filepath: src/presentation/components/features/game-engine/code-fix/HintPanel.tsx
import { useState } from 'react';
import { Lightbulb, X } from 'lucide-react';


interface HintPanelProps {
  hintText: string;
}

export function HintPanel({ hintText }: HintPanelProps) {
  const [isOpen, setIsOpen] = useState(false);

  if (!isOpen) {
    return (
      <button 
        onClick={() => setIsOpen(true)}
        className="flex items-center gap-2 text-xs text-yellow-500/80 hover:text-yellow-400 transition-colors mt-2 ml-auto"
      >
        <Lightbulb className="w-4 h-4" /> Necessito una pista
      </button>
    );
  }

  return (
    <div className="mt-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3 flex items-start gap-3 animate-in fade-in slide-in-from-top-1">
       <Lightbulb className="w-4 h-4 text-yellow-500 shrink-0 mt-0.5" />
       <p className="text-yellow-200/90 text-sm flex-1">{hintText}</p>
       <button onClick={() => setIsOpen(false)} className="text-yellow-500/50 hover:text-yellow-500">
         <X className="w-4 h-4" />
       </button>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/SmartTerminal.tsx ===================

// filepath: src/presentation/components/features/game/code-fix/SmartTerminal.tsx
'use client';

import { FileText, Lightbulb } from 'lucide-react';
import { clsx } from 'clsx';

interface SmartTerminalProps {
  language: string;
  fileName: string;
  activeTab: 'CODE' | 'MISSION' | 'HINT';
  onTabChange: (tab: 'CODE' | 'MISSION' | 'HINT') => void;
}

export function SmartTerminal({ 
  language, 
  fileName, 
  activeTab,
  onTabChange 
}: SmartTerminalProps) {

  return (
    <div className="bg-[#252526] flex items-center border-b border-[#333] select-none overflow-x-auto no-scrollbar">
      
      {/* 1. TAB: EDITOR (Fitxer) */}
      <button
        onClick={() => onTabChange('CODE')}
        className={clsx(
           "flex items-center gap-2 px-4 py-2.5 text-xs font-medium border-r border-[#333] transition-colors min-w-fit",
           activeTab === 'CODE' 
             ? "bg-[#1e1e1e] text-slate-200 border-t-2 border-t-blue-500" 
             : "bg-[#2d2d2d] text-slate-500 hover:bg-[#2a2a2a] hover:text-slate-400 border-t-2 border-t-transparent"
        )}
      >
         {/* Icona de llenguatge (TS/JS/PY) */}
         <span className={clsx(
             "font-bold text-[10px]",
             language === 'typescript' ? "text-blue-400" : "text-yellow-400"
         )}>
             {language === 'typescript' ? 'TS' : 'JS'}
         </span>
         <span>{fileName}</span>
      </button>

      {/* 2. TAB: MISSION (Instruccions) */}
      <button
        onClick={() => onTabChange('MISSION')}
        className={clsx(
           "flex items-center gap-2 px-4 py-2.5 text-xs font-medium border-r border-[#333] transition-colors min-w-fit",
           activeTab === 'MISSION' 
             ? "bg-[#1e1e1e] text-slate-200 border-t-2 border-t-purple-500" 
             : "bg-[#2d2d2d] text-slate-500 hover:bg-[#2a2a2a] hover:text-slate-400 border-t-2 border-t-transparent"
        )}
      >
         <FileText className="w-3.5 h-3.5" />
         <span>Brief</span>
      </button>

      {/* 3. TAB: HINT (Pista) */}
      <button
        onClick={() => onTabChange('HINT')}
        className={clsx(
           "flex items-center gap-2 px-4 py-2.5 text-xs font-medium border-r border-[#333] transition-colors min-w-fit",
           activeTab === 'HINT' 
             ? "bg-[#1e1e1e] text-yellow-400 border-t-2 border-t-yellow-500" 
             : "bg-[#2d2d2d] text-slate-500 hover:bg-[#2a2a2a] hover:text-slate-400 border-t-2 border-t-transparent"
        )}
      >
         <Lightbulb className="w-3.5 h-3.5" />
         <span>Hint</span>
      </button>

      {/* Espai buit restant (Estètica IDE) */}
      <div className="flex-1 bg-[#252526] h-full" />
      
      {/* Botons de finestra (Decoració Mac) */}
      <div className="hidden xs:flex gap-1.5 px-3 opacity-50">
         <div className="w-2.5 h-2.5 rounded-full bg-[#ff5f56]" />
         <div className="w-2.5 h-2.5 rounded-full bg-[#ffbd2e]" />
         <div className="w-2.5 h-2.5 rounded-full bg-[#27c93f]" />
      </div>

    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/SolutionDeck.tsx ===================

// filepath: src/presentation/components/features/game/code-fix/SolutionDeck.tsx
'use client';

import { CodeFixOption } from '@/core/entities/challenges';
import { clsx } from 'clsx';
import { CheckCircle2, Circle } from 'lucide-react';

interface SolutionDeckProps {
  options: CodeFixOption[];
  selectedId: string | null;
  onSelect: (id: string) => void;
  isSubmitted: boolean;
}

export function SolutionDeck({ options, selectedId, onSelect, isSubmitted }: SolutionDeckProps) {
  return (
    // Grid: 1 columna en mòbil, 2 en tablet+
    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
      {options.map((option) => {
        const isSelected = selectedId === option.id;

        return (
          <button
            key={option.id}
            onClick={() => !isSubmitted && onSelect(option.id)}
            disabled={isSubmitted}
            className={clsx(
              "relative group text-left p-3 rounded-lg border-2 transition-all duration-200 w-full active:scale-[0.98]",
              "min-h-15 flex items-center",
              isSelected
                ? "border-blue-500 bg-blue-500/10 shadow-[0_0_15px_rgba(59,130,246,0.2)]"
                : "border-slate-800 bg-[#1e1e1e] hover:border-slate-600",
              isSubmitted && isSelected && "border-green-500 bg-green-500/10"
            )}
          >
            {/* Checkbox */}
            <div className={clsx(
                "absolute right-3 top-1/2 -translate-y-1/2",
                isSelected ? "text-blue-400" : "text-slate-700"
            )}>
                {isSelected ? <CheckCircle2 className="w-5 h-5" /> : <Circle className="w-5 h-5" />}
            </div>

            {/* Code Snippet */}
            <div className="pr-8 w-full"> 
                <code className={clsx(
                    "block font-mono text-[11px] md:text-xs leading-tight text-slate-300",
                    // Assegurem que el codi trenqui línies si és molt llarg
                    "break-all whitespace-pre-wrap" 
                )}>
                    {option.code}
                </code>
            </div>
          </button>
        );
      })}
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/CodeFixView.tsx ===================

// filepath: src/presentation/components/features/game/code-fix/CodeFixView.tsx
'use client';

import { useState } from 'react';
import { Challenge, CodeFixContent } from '@/core/entities/challenges';
import { SmartTerminal } from './code-fix/SmartTerminal'; 
import { CodeWindow } from './code-fix/CodeWindow';
import { SolutionDeck } from './code-fix/SolutionDeck';
import { GameSessionLayout } from '@/presentation/components/features/game-engine/layout/GameSessionLayout';
import { GameHeader } from '@/presentation/components/features/game-engine/layout/GameHeader';
import { useTranslations } from 'next-intl';
import { Play, ArrowRight, Loader2 } from 'lucide-react';
import { clsx } from 'clsx';

interface CodeFixViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function CodeFixView({ challenge, onNext }: CodeFixViewProps) {
  const t = useTranslations('game');
  const content = challenge.content as CodeFixContent;
  
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [status, setStatus] = useState<'IDLE' | 'RUNNING' | 'SUCCESS' | 'ERROR'>('IDLE');
  
  // NOU ESTAT: Quina pestanya estem veient a la terminal? ('CODE', 'MISSION', 'HINT')
  const [activeTab, setActiveTab] = useState<'CODE' | 'MISSION' | 'HINT'>('CODE');

  const handleRun = async () => {
    if (!selectedId) return;
    setStatus('RUNNING');
    // Forcem veure el codi quan s'executa per veure l'efecte visual
    setActiveTab('CODE');
    await new Promise(resolve => setTimeout(resolve, 800));
    
    const selectedOption = content.options.find(opt => opt.id === selectedId);
    if (selectedOption?.isCorrect) {
       setStatus('SUCCESS');
    } else {
       setStatus('ERROR');
       setTimeout(() => setStatus('IDLE'), 2000);
    }
  };

  const currentCode = selectedId 
    ? content.options.find(o => o.id === selectedId)?.code 
    : null;

  // --- FOOTER (Botó d'acció) ---
  const Footer = (
    <div className="w-full px-4 py-3 md:pb-6 bg-slate-950/80 backdrop-blur-md border-t border-slate-800">
        {status === 'SUCCESS' ? (
            <button
                onClick={() => onNext(true)}
                className="w-full py-4 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-green-900/20 active:scale-95 transition-all"
            >
                {t('arena.continue_btn')} <ArrowRight className="w-5 h-5" />
            </button>
        ) : (
            <button
                onClick={handleRun}
                disabled={!selectedId || status === 'RUNNING'}
                className={clsx(
                    "w-full py-4 font-bold rounded-xl flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95",
                    !selectedId 
                        ? "bg-slate-800 text-slate-500 cursor-not-allowed border border-slate-700"
                        : status === 'ERROR'
                        ? "bg-red-600 text-white animate-shake"
                        : "bg-blue-600 hover:bg-blue-500 text-white shadow-blue-900/20"
                )}
            >
                {status === 'RUNNING' ? <Loader2 className="w-5 h-5 animate-spin" /> : <Play className="w-5 h-5 fill-current" />}
                <span className="uppercase tracking-wide text-xs md:text-sm ml-2">
                    {status === 'RUNNING' ? t('loading') : status === 'ERROR' ? t('feedback.incorrect') : t('actions.verify')}
                </span>
            </button>
        )}
    </div>
  );

  return (
    <GameSessionLayout header={<GameHeader />} footer={Footer}>
      
      {/* CONTENIDOR PRINCIPAL (Flex column per ocupar alçada i ajustar-se) */}
      <div className="flex flex-col w-full h-full gap-4">
        
        {/* 1. SMART TERMINAL INTEGRADA (Tabs + Contingut) */}
        <div className="w-full rounded-xl overflow-hidden border border-slate-800 shadow-2xl flex flex-col bg-[#1e1e1e]">
            
            {/* Header amb Pestanyes estil VSCode */}
            <SmartTerminal 
               language="typescript" // Això podria venir del topic
               fileName="Solution.tsx"
               activeTab={activeTab}
               onTabChange={setActiveTab}
            />

            {/* Contingut Canviant segons la pestanya */}
            <div className="relative min-h-50">
                
                {/* VISTA 1: EDITOR DE CODI (Per defecte) */}
                <div className={clsx("transition-opacity duration-300", activeTab === 'CODE' ? "block" : "hidden")}>
                    <CodeWindow 
                       initialCode={content.initialCode}
                       selectedCode={currentCode}
                       status={status}
                    />
                </div>

                {/* VISTA 2: INSTRUCCIONS (MISSION) */}
                {activeTab === 'MISSION' && (
                    <div className="p-6 text-slate-300 text-sm leading-relaxed animate-in fade-in slide-in-from-top-2">
                        <h3 className="text-blue-400 font-bold uppercase tracking-widest text-xs mb-4 border-b border-slate-700 pb-2">
                            Mission Briefing
                        </h3>
                        {content.description}
                    </div>
                )}

                {/* VISTA 3: PISTA (HINT) */}
                {activeTab === 'HINT' && (
                    <div className="p-6 animate-in fade-in slide-in-from-top-2">
                        <div className="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-4">
                            <h3 className="text-yellow-500 font-bold uppercase tracking-widest text-xs mb-2 flex items-center gap-2">
                                Developer Hint
                            </h3>
                            <p className="text-yellow-100/80 text-sm italic">
                                {content.hint}
                            </p>
                        </div>
                    </div>
                )}
            </div>
        </div>

        {/* 2. OPCIONS (Sempre visibles a sota, scrollable si cal) */}
        <div className="flex-1 pb-4">
           <div className="flex justify-between items-end mb-2 px-1">
              <h3 className="text-slate-500 text-[10px] font-bold uppercase tracking-widest">
                  Available Patches
              </h3>
           </div>

           <SolutionDeck 
              options={content.options} 
              selectedId={selectedId} 
              onSelect={(id) => { 
                 if (status !== 'SUCCESS') { 
                    setSelectedId(id); 
                    setStatus('IDLE'); 
                    // Opcional: Si cliques una opció, et tornem al codi automàticament
                    setActiveTab('CODE');
                 } 
              }} 
              isSubmitted={status === 'SUCCESS'} 
           />
        </div>

      </div>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/CtfView.tsx ===================

// filepath: src/presentation/components/features/game-engine/CtfView.tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { CtfContent, VirtualFile } from '@/core/entities/challenges/definitions/ctf.content';
import { Terminal, Flag, CheckCircle, Lock } from 'lucide-react';
import { useLocale } from 'next-intl';
import { LocalizedText } from '@/core/entities/challenges/definitions/theory.content';
interface CtfViewProps {
    challenge: Challenge;
    onNext: (isCorrect: boolean) => void;
}

export function CtfView({ challenge, onNext }: CtfViewProps) {
    const content = challenge.content as CtfContent;
    const locale = useLocale() as 'ca' | 'es' | 'en';

    // ESTAT DEL JOC
    const [history, setHistory] = useState<string[]>(['Initializing Kali Linux Environment...', 'Connected to Target.']);
    const [input, setInput] = useState('');
    const [files, setFiles] = useState<VirtualFile[]>(content.initialFileSystem);
    const [capturedFlags, setCapturedFlags] = useState<string[]>([]);
    const scrollRef = useRef<HTMLDivElement>(null);

    // Helper per textos
    // ✅ SOLUCIÓ: Tipar l'entrada. Acceptem undefined per seguretat.
    const getText = (obj: LocalizedText | undefined): string => {
        if (!obj) return '';
        return obj[locale] || obj['ca'] || '';
    };

    // Auto-scroll terminal
    useEffect(() => {
        if (scrollRef.current) {
            scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
        }
    }, [history]);

    // Comprovar victòria
    useEffect(() => {
        if (capturedFlags.length === content.flags.length) {
            setTimeout(() => onNext(true), 2000); // Victòria automàtica al tenir totes les flags
        }
    }, [capturedFlags, content.flags.length, onNext]);

    const handleCommand = (e: React.FormEvent) => {
        e.preventDefault();
        if (!input.trim()) return;

        const cmd = input.trim();
        const newHistory = [...history, `root@kali:~# ${cmd}`];

        // 1. COMANDES BÀSIQUES SIMULADES
        if (cmd === 'ls') {
            const fileList = files.map(f => f.name).join('  ');
            newHistory.push(fileList || '(empty directory)');
        }
        else if (cmd.startsWith('cat ')) {
            const fileName = cmd.split(' ')[1];
            const file = files.find(f => f.name === fileName);
            if (file) {
                newHistory.push(file.content);
                // Detectar si el contingut és una flag (format flag{...})
                if (file.content.includes('flag{')) {
                    const match = file.content.match(/flag\{([^}]+)\}/);
                    if (match) verifyFlag(match[0]);
                }
            } else {
                newHistory.push(`cat: ${fileName}: No such file or directory`);
            }
        }
        else if (cmd === 'clear') {
            setHistory([]);
            setInput('');
            return;
        }
        // 2. COMANDES DE GUIÓ (STORYLINE)
        else {
            // Busquem si la comanda encaixa amb alguna del JSON
            const validCmd = content.validCommands.find(c => new RegExp(c.commandRegex).test(cmd));

            if (validCmd) {
                newHistory.push(validCmd.output);

                // Desbloquejar fitxer si cal
                if (validCmd.unlocksFile) {
                    const [name, content] = validCmd.unlocksFile.split('::'); // Format "nom::contingut"
                    if (!files.find(f => f.name === name)) {
                        setFiles(prev => [...prev, { name, content }]);
                        newHistory.push(`[SYSTEM] New file created: ${name}`);
                    }
                }
            } else {
                newHistory.push(`bash: ${cmd.split(' ')[0]}: command not found`);
            }
        }

        setHistory(newHistory);
        setInput('');
    };

    const verifyFlag = (secret: string) => {
        const flag = content.flags.find(f => f.secret === secret);
        if (flag && !capturedFlags.includes(flag.id)) {
            setCapturedFlags(prev => [...prev, flag.id]);
            setHistory(prev => [...prev, `🎉 CAPTURED FLAG: ${secret}`]);
        }
    };

    return (
        <div className="flex flex-col md:flex-row h-150 w-full max-w-6xl mx-auto bg-slate-950 rounded-xl overflow-hidden border border-slate-800 shadow-2xl">

            {/* SIDEBAR (Missions) */}
            <div className="w-full md:w-1/4 bg-slate-900 p-4 border-r border-slate-800 flex flex-col gap-4">
                <div>
                    <h2 className="text-xl font-bold text-white flex items-center gap-2">
                        <Lock className="w-5 h-5 text-red-500" />
                        CTF MISSION
                    </h2>
                    <p className="text-xs text-slate-400 mt-1 uppercase tracking-widest">Operation: {getText(content.missionTitle)}</p>
                </div>

                <div className="bg-slate-800/50 p-3 rounded text-sm text-slate-300">
                    {getText(content.missionBriefing)}
                </div>

                <div className="flex-1 overflow-y-auto space-y-2">
                    <h3 className="text-xs font-bold text-slate-500 uppercase">Flags to Capture</h3>
                    {content.flags.map(flag => {
                        const isCaptured = capturedFlags.includes(flag.id);
                        return (
                            <div key={flag.id} className={`p-3 rounded border transition-all ${isCaptured ? 'bg-emerald-900/20 border-emerald-500/50' : 'bg-slate-900 border-slate-700'}`}>
                                <div className="flex justify-between items-center">
                                    <span className={`font-mono text-sm ${isCaptured ? 'text-emerald-400' : 'text-slate-400'}`}>
                                        {getText(flag.name)}
                                    </span>
                                    {isCaptured ? <CheckCircle className="w-4 h-4 text-emerald-500" /> : <Flag className="w-4 h-4 text-slate-600" />}
                                </div>
                                <div className="text-xs text-slate-500 mt-1">{getText(flag.description)}</div>
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* TERMINAL AREA */}
            <div className="flex-1 flex flex-col bg-black font-mono text-sm">

                {/* Terminal Header */}
                <div className="bg-slate-800 px-4 py-2 flex items-center gap-2 border-b border-slate-700">
                    <Terminal className="w-4 h-4 text-slate-400" />
                    <span className="text-slate-400">root@kali: ~</span>
                </div>

                {/* Terminal Output */}
                <div ref={scrollRef} className="flex-1 p-4 overflow-y-auto space-y-1 text-green-400">
                    {history.map((line, i) => (
                        <div key={i} className="whitespace-pre-wrap wrap-break-word">{line}</div>
                    ))}
                </div>

                {/* Input Area */}
                <form onSubmit={handleCommand} className="p-4 bg-slate-900 border-t border-slate-800 flex gap-2">
                    <span className="text-green-500 font-bold">root@kali:~#</span>
                    <input
                        autoFocus
                        type="text"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        className="flex-1 bg-transparent border-none outline-none text-white focus:ring-0"
                        placeholder="type command..."
                    />
                </form>
            </div>

        </div>
    );
}

// =================== FILE: src/presentation/components/features/game-engine/GameArena.tsx ===================

// filepath: src/presentation/components/features/game-engine/GameArena.tsx
'use client';

import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { useGameSession } from '@/presentation/hooks/game/useGameSession';
import { ChallengeRenderer } from './ChallengeRenderer';
import { GameResult } from './GameResult';
import { GameError } from './GameError';
import { Loader2 } from 'lucide-react';
// 1. Importem el Provider
import { GameSessionProvider } from '@/presentation/context/GameSessionContext';

interface GameArenaProps {
  challenges: Challenge[];
  topicSlug: string;
}

export function GameArena({ challenges, topicSlug }: GameArenaProps) {
  const {
    currentChallenge, currentIndex, totalChallenges, progress,
    status, result, error, handleNext, handleRetry
  } = useGameSession(challenges);

  if (status === 'SUBMITTING') return <FullScreenMsg><Loader2 className="w-12 h-12 animate-spin text-blue-500" /></FullScreenMsg>;
  if (status === 'SUCCESS' && result) return <GameResult xpEarned={result.xpEarned} newLevel={result.newLevel} leveledUp={result.leveledUp} topicSlug={topicSlug} />;
  if (status === 'ERROR' && error) return <GameError message={error} onRetry={handleRetry} />;

  // 2. EMBOLCALLEM EL JOC AMB EL CONTEXT
  // Ara tots els components fills poden accedir a 'progress' sense passar-ho per props.
  return (
    <GameSessionProvider value={{ 
        progress, 
        currentIndex, 
        totalChallenges, 
        topicSlug 
    }}>
        <ChallengeRenderer
            challenge={currentChallenge}
            onNext={handleNext}
            // JA NO PASSEM sessionData AQUÍ!
        />
    </GameSessionProvider>
  );
}

function FullScreenMsg({ children }: { children: React.ReactNode }) {
  return <div className="fixed inset-0 flex items-center justify-center bg-slate-950 z-50">{children}</div>;
}

// =================== FILE: src/presentation/components/features/game-engine/GameError.tsx ===================

// filepath: src/presentation/components/features/game-engine/GameError.tsx
import { AlertTriangle, RotateCcw, LogIn } from 'lucide-react';
import { Link } from '@/navigation';
import { useTranslations } from 'next-intl';

interface GameErrorProps {
  message: string;
  onRetry: () => void;
}

export function GameError({ message, onRetry }: GameErrorProps) {
  const t = useTranslations('game.arena');
  const isAuthError = message.includes('Unauthorized');

  return (
    <div className="text-center max-w-sm bg-slate-800 p-8 rounded-2xl border border-red-500/20 mx-auto">
      <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
         {isAuthError ? <LogIn className="w-8 h-8 text-blue-400" /> : <AlertTriangle className="w-8 h-8 text-red-400" />}
      </div>
      
      <h3 className="text-xl font-bold text-white mb-2">
        {isAuthError ? t('unauthorized_title') : t('error_title')}
      </h3>
      
      {/* Si l'error és tècnic, el mostrem tal qual o un genèric si prefereixes */}
      <p className="text-slate-400 mb-6 text-sm">
        {isAuthError ? t('unauthorized_desc') : message}
      </p>

      <div className="flex gap-3 justify-center">
        {isAuthError ? (
           <Link href="/login">
             <button className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">
                {t('login_btn')}
             </button>
           </Link>
        ) : (
           <button onClick={onRetry} className="px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg flex items-center gap-2">
             <RotateCcw className="w-4 h-4" /> {t('retry_btn')}
           </button>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/GameResult.tsx ===================

// filepath: src/presentation/components/features/game-engine/GameResult.tsx
import { Trophy, Star, ArrowRight } from 'lucide-react';
import { Link } from '@/navigation'; // ✅ Import correcte
import { useTranslations } from 'next-intl';

interface GameResultProps {
  xpEarned: number;
  newLevel: number;
  leveledUp: boolean;
  topicSlug: string; // <--- NOVA PROP NECESSÀRIA
}

export function GameResult({ xpEarned, newLevel, leveledUp, topicSlug }: GameResultProps) {
  const t = useTranslations('game.arena');

  return (
    <div className="flex flex-col items-center animate-in zoom-in-50">
      <div className="w-32 h-32 bg-yellow-500/10 rounded-full flex items-center justify-center mb-6 relative">
        <Trophy className="w-16 h-16 text-yellow-400" />
        {leveledUp && (
          <div className="absolute -top-2 -right-2 bg-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full animate-bounce">
            {t('level_up')}
          </div>
        )}
      </div>
      
      <h2 className="text-3xl font-bold text-white mb-6">{t('lesson_complete')}</h2>
      
      <div className="bg-slate-800 p-6 rounded-xl w-full max-w-sm mb-6 space-y-4">
         <div className="flex justify-between items-center text-slate-300">
            <span>{t('xp_earned')}</span>
            <span className="text-green-400 font-bold flex gap-1 items-center">
                +{xpEarned} <Star className="w-4 h-4 fill-green-400" />
            </span>
         </div>
         <div className="flex justify-between items-center text-slate-300 pt-4 border-t border-slate-700">
            <span>Nivell Actual</span>
            <span className="text-white font-bold text-xl">{newLevel}</span>
         </div>
      </div>

      {/* ARA TORNA AL MAPA DEL TEMA */}
      <Link href={`/learn/${topicSlug}`}>
        <button className="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-500 transition-all flex items-center gap-2">
            {t('continue_btn') || "Continuar"} <ArrowRight className="w-5 h-5" />
        </button>
      </Link>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/layout/GameHeader.tsx ===================

// filepath: src/presentation/components/features/game-engine/layout/GameHeader.tsx
'use client';

import { X } from 'lucide-react';
import { Link } from '@/navigation';
import { useGameSessionContext } from '@/presentation/context/GameSessionContext';
import { useTranslations } from 'next-intl'; // 1. Importem hook

interface GameHeaderProps {
  rightContent?: React.ReactNode;
}

export function GameHeader({ rightContent }: GameHeaderProps) {
  const t = useTranslations('game'); // 2. Namespace 'game'
  const { progress, currentIndex, totalChallenges, topicSlug } = useGameSessionContext();

  const visualProgress = Math.max(progress, 5);

  return (
    <div className="flex items-center gap-4 w-full h-full max-w-5xl mx-auto">
      <Link 
        href={`/learn/${topicSlug}`} 
        className="text-slate-400 hover:text-white p-2 transition-colors hover:bg-white/10 rounded-xl"
        aria-label={t('arena.quit')} // Accesibilitat
      >
        <X className="w-6 h-6" />
      </Link>

      <div className="flex-1 flex flex-col justify-center gap-2">
         <div className="flex justify-between text-[10px] uppercase font-bold text-slate-400 tracking-widest px-1">
            {/* 3. Usem la clau correcta */}
            <span>{t('arena.progress')}</span>
            <span>{currentIndex + 1} / {totalChallenges}</span>
         </div>

         <div className="h-3 bg-slate-800/80 rounded-full overflow-hidden border border-slate-700/50 relative backdrop-blur-sm">
            <div 
              className="h-full rounded-full relative overflow-hidden transition-all duration-700 cubic-bezier(0.4, 0, 0.2, 1)"
              style={{ width: `${visualProgress}%` }}
            >
               <div className="absolute inset-0 bg-linear-to-r from-blue-600 via-blue-500 to-cyan-400"></div>
               <div className="absolute inset-0 bg-linear-to-r from-transparent via-white/20 to-transparent w-full -translate-x-full animate-[shimmer_2s_infinite]"></div>
               <div className="absolute right-0 top-0 bottom-0 w-2 bg-white/30 blur-[2px]"></div>
            </div>
         </div>
      </div>

      <div className="w-8 flex justify-end">
          {rightContent}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/layout/GameSessionLayout.tsx ===================

// filepath: src/presentation/components/features/game-engine/layout/GameSessionLayout.tsx
'use client';

import { ReactNode } from 'react';
import { clsx } from 'clsx';

interface GameSessionLayoutProps {
  header: ReactNode;
  children: ReactNode;
  footer: ReactNode;
  className?: string;
}

export function GameSessionLayout({ header, children, footer, className }: GameSessionLayoutProps) {
  return (
    // Usem 'dvh' (dynamic viewport height) per mòbils.
    <div className="fixed inset-0 z-50 flex flex-col bg-[#0a0a0a] h-dvh w-screen overflow-hidden text-slate-200">
      
      {/* 1. HEADER (Fix a dalt) */}
      <header className="shrink-0 px-4 py-3 bg-[#0a0a0a]/90 backdrop-blur-md z-20 border-b border-white/5">
        {header}
      </header>

      {/* 2. ZONA DE JOC (Flexible i Centrada) */}
      <main className="flex-1 w-full relative overflow-hidden flex flex-col">
        {/* Aquest div intern és el que fa la màgia del centrat.
            - overflow-y-auto: Permet scroll si el contingut és molt alt (com CodeFix).
            - flex items-center justify-center: Centra continguts petits (com Quiz).
        */}
        <div className={clsx(
            "flex-1 w-full h-full overflow-y-auto overflow-x-hidden",
            "flex flex-col items-center", // Centrat Horitzontal
            // Centrat Vertical 'intel·ligent': 
            // Si hi ha scroll, es queda a dalt. Si no, es centra.
            "justify-center py-4 px-4 md:px-0" 
        )}>
           {/* Wrapper per limitar l'amplada màxima */}
           <div className={clsx("w-full max-w-3xl animate-in zoom-in-95 duration-300", className)}>
              {children}
           </div>
        </div>
      </main>

      {/* 3. FOOTER (Fix a baix) */}
      {/* 'pb-safe' és crucial per als iPhones moderns (la barra negra de baix) */}
      <footer className="shrink-0 w-full bg-[#0a0a0a]/90 backdrop-blur-md z-20 border-t border-white/5 pb-safe">
        <div className="max-w-3xl mx-auto px-4 py-4">
           {footer}
        </div>
      </footer>

    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/LogicOrderView.tsx ===================

// filepath: src/presentation/components/features/game-engine/LogicOrderView.tsx
'use client';

import { useState } from 'react';
import { Challenge, LogicOrderContent, ChallengeOption } from '@/core/entities/challenges/index';
import { RotateCcw, GripVertical, X } from 'lucide-react';
import { clsx } from 'clsx';
import { Reorder, AnimatePresence, motion, LayoutGroup } from 'framer-motion';
import { GameSessionLayout } from './layout/GameSessionLayout';
import { GameHeader } from './layout/GameHeader'; // ✅ Header Reutilitzable
import { useTranslations } from 'next-intl';

interface LogicOrderViewProps {
   challenge: Challenge;
   onNext: (isCorrect: boolean) => void;
   // ❌ sessionData ELIMINAT
}

export function LogicOrderView({ challenge, onNext }: LogicOrderViewProps) {
   const t = useTranslations('game');

   const content = challenge.content as LogicOrderContent;
   const [available, setAvailable] = useState<ChallengeOption[]>(content.items);
   const [selected, setSelected] = useState<ChallengeOption[]>([]);
   const [hasSubmitted, setHasSubmitted] = useState(false);
   const [isCorrect, setIsCorrect] = useState<boolean | null>(null);

   // ... (Lògica de handleSelect, handleDeselect, handleReset es manté igual) ...
   const handleSelect = (item: ChallengeOption) => {
      if (hasSubmitted) return;
      setAvailable(prev => prev.filter(i => i.id !== item.id));
      setSelected(prev => [...prev, item]);
   };
   const handleDeselect = (item: ChallengeOption) => {
      if (hasSubmitted) return;
      setSelected(prev => prev.filter(i => i.id !== item.id));
      setAvailable(prev => [...prev, item]);
   };
   const handleReset = () => {
      setAvailable(content.items); setSelected([]); setHasSubmitted(false); setIsCorrect(null);
   };
   const handleSubmit = () => {
      if (hasSubmitted) return;
      const currentOrder = selected.map(s => s.id);
      const correctOrder = [...content.items].map(i => i.id).sort();
      const correct = JSON.stringify(currentOrder) === JSON.stringify(correctOrder);
      setIsCorrect(correct); setHasSubmitted(true);
      if (correct) setTimeout(() => onNext(true), 1500);
   };

   // --- FOOTER ---
   const Footer = (
      <div className="flex gap-3 w-full">
         <button
            onClick={handleReset}
            className="p-4 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700 transition-colors border border-slate-700"
            title={t('actions.reset')} // "Reiniciar"
         >
            <RotateCcw className="w-6 h-6" />
         </button>
         <button
            onClick={handleSubmit}
            disabled={selected.length === 0 || hasSubmitted}
            className={clsx(/* ... classes ... */)}
         >
            {hasSubmitted ? (
               isCorrect ? t('feedback.correct') : t('feedback.incorrect')
            ) : t('actions.check')} {/* "Comprovar" */}
         </button>
      </div>
   );

   return (
      // ✅ HEADER AUTOMÀTIC
      <GameSessionLayout header={<GameHeader />} footer={Footer}>
         <LayoutGroup>
            <div className="flex flex-col h-full gap-2">

               <div className="shrink-0 text-center pb-2">
                  <h2 className="text-lg font-bold text-white leading-tight">{content.description}</h2>
                  <div className="text-[10px] uppercase tracking-widest text-slate-500 font-bold mt-1">
                     {t('modes.logic_order.label')}
                  </div>
               </div>

               <div className="flex-1 min-h-0 flex flex-col gap-2">

                  {/* Zona de Resposta (Drop Zone) */}
                  <div className="flex-1 bg-slate-900/50 rounded-xl border-2 border-dashed border-slate-700 p-2 overflow-y-auto relative min-h-25">
                     <span className="absolute top-2 right-2 text-[9px] text-slate-500 uppercase font-bold tracking-widest pointer-events-none">
                        {t('modes.logic_order.your_answer')}
                     </span>

                     {selected.length === 0 && (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-600 pointer-events-none">
                           <GripVertical className="w-6 h-6 mb-1 opacity-50" />
                           <span className="text-xs">{t('modes.logic_order.placeholder')}</span>
                        </div>
                     )}

                     <Reorder.Group axis="y" values={selected} onReorder={setSelected} className="flex flex-col gap-2 w-full pb-8">
                        <AnimatePresence mode='popLayout'>
                           {selected.map((item, index) => (
                              <Reorder.Item key={item.id} value={item} dragListener={!hasSubmitted} layoutId={item.id}
                                 className="relative p-3 rounded-lg border bg-slate-800 border-slate-600 flex items-center gap-3 select-none touch-none"
                              >
                                 <span className="w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] font-bold">{index + 1}</span>
                                 <span className="flex-1 text-sm font-medium">{item.text}</span>
                                 {!hasSubmitted && <button onClick={() => handleDeselect(item)}><X className="w-4 h-4 text-slate-500" /></button>}
                              </Reorder.Item>
                           ))}
                        </AnimatePresence>
                     </Reorder.Group>
                  </div>

                  {/* Banc d'Opcions */}
                  <div className="shrink-0 h-auto max-h-[40%] overflow-y-auto bg-slate-950/30 rounded-xl border border-slate-800 p-2">
                     <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <AnimatePresence mode='popLayout'>
                           {available.map((item) => (
                              <motion.button
                                 layoutId={item.id} key={item.id} onClick={() => handleSelect(item)} disabled={hasSubmitted}
                                 className="p-3 rounded-lg bg-slate-800 border-b-2 border-slate-900 text-slate-300 text-xs font-medium text-left flex justify-between items-center group"
                              >
                                 <span className="line-clamp-2">{item.text}</span>
                                 <span className="text-blue-500 font-bold">+</span>
                              </motion.button>
                           ))}
                        </AnimatePresence>
                        {available.length === 0 && (
                           <div className="text-center text-xs text-slate-600 py-2">
                              {t('modes.logic_order.empty_options')}
                           </div>
                        )}
                     </div>
                  </div>

               </div>
            </div>
         </LayoutGroup>
      </GameSessionLayout>
   );
}

// =================== FILE: src/presentation/components/features/game-engine/MatchingView.tsx ===================

// filepath: src/presentation/components/features/game-engine/MatchingView.tsx
'use client';

import { useState, useMemo } from 'react';
import { Challenge, MatchingContent } from '@/core/entities/challenges/index';
import { Check, ArrowRight, Puzzle } from 'lucide-react';
import { clsx } from 'clsx';
import { GameSessionLayout } from './layout/GameSessionLayout';
import { GameHeader } from './layout/GameHeader';
import { useTranslations } from 'next-intl';

// --- UTILS (Es podrien moure a src/core/utils/random.ts) ---
function pseudoRandom(seed: number) {
  let t = seed += 0x6D2B79F5;
  t = Math.imul(t ^ t >>> 15, t | 1);
  t ^= t + Math.imul(t ^ t >>> 7, t | 61);
  return ((t ^ t >>> 14) >>> 0) / 4294967296;
}

function cyrb53(str: string, seed = 0) {
  let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
  for (let i = 0, ch; i < str.length; i++) {
    ch = str.charCodeAt(i);
    h1 = Math.imul(h1 ^ ch, 2654435761);
    h2 = Math.imul(h2 ^ ch, 1597334677);
  }
  h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
  h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
  return 4294967296 * (2097151 & h2) + (h1 >>> 0);
}

function seededShuffle<T>(array: T[] | undefined | null, seedString: string): T[] {
  if (!array || !Array.isArray(array)) return [];
  const copy = [...array];
  let seed = cyrb53(seedString);
  for (let i = copy.length - 1; i > 0; i--) {
    const randomFloat = pseudoRandom(seed++);
    const j = Math.floor(randomFloat * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

// --- COMPONENT ---

interface MatchingViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function MatchingView({ challenge, onNext }: MatchingViewProps) {
  const t = useTranslations('game');
  const content = challenge.content as MatchingContent;

  const [selectedLeft, setSelectedLeft] = useState<string | null>(null);
  const [matchedPairs, setMatchedPairs] = useState<Set<string>>(new Set());
  const [errorPair, setErrorPair] = useState<{ left: string, right: string } | null>(null);
  const [isCompleted, setIsCompleted] = useState(false);

  const rightOptions = useMemo(() => {
    if (!content || !content.pairs) return [];
    return seededShuffle(content.pairs, challenge.id);
  }, [content, challenge.id]);

  if (!content?.pairs || content.pairs.length === 0) {
    return <div className="text-center p-10 text-red-400">Error: No matching pairs found.</div>;
  }

  const handleLeftClick = (id: string) => {
    if (matchedPairs.has(id)) return;
    setSelectedLeft(id);
    setErrorPair(null);
  };

  const handleRightClick = (rightId: string) => {
    if (!selectedLeft) return;
    const pair = content.pairs.find(p => p.left.id === selectedLeft);

    if (pair && pair.right.id === rightId) {
      const newMatches = new Set(matchedPairs);
      newMatches.add(selectedLeft);
      setMatchedPairs(newMatches);
      setSelectedLeft(null);

      if (newMatches.size === content.pairs.length) {
        setIsCompleted(true);
      }
    } else {
      setErrorPair({ left: selectedLeft, right: rightId });
      setTimeout(() => {
        setErrorPair(null);
        setSelectedLeft(null);
      }, 800);
    }
  };

  // --- FOOTER ---
  const Footer = isCompleted ? (
    <div className="w-full p-4 animate-in slide-in-from-bottom-2">
      <button
        onClick={() => onNext(true)}
        className="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-green-900/20 active:scale-95 transition-all"
      >
        {/* Traducció: "Continuar" */}
        {t('arena.continue_btn')} <ArrowRight className="w-5 h-5" />
      </button>
    </div>
  ) : <div className="h-4" />;

  return (
    <GameSessionLayout header={<GameHeader />} footer={Footer}>
      <div className="w-full max-w-4xl mx-auto flex flex-col items-center pt-4 pb-8">

        <div className="text-center mb-6">
          <div className="inline-flex items-center justify-center p-3 bg-purple-500/10 rounded-full mb-2 border border-purple-500/20">
            <Puzzle className="w-6 h-6 text-purple-400" />
          </div>
          <h2 className="text-lg font-bold text-white leading-tight">
            {content.instruction}
          </h2>
        </div>

        <div className="grid grid-cols-2 gap-4 md:gap-12 w-full">

          {/* COLUMNA ESQUERRA */}
          <div className="flex flex-col gap-3">
            {content.pairs.map((pair) => {
              const isMatched = matchedPairs.has(pair.left.id);
              const isSelected = selectedLeft === pair.left.id;
              const isError = errorPair?.left === pair.left.id;

              return (
                <button
                  key={pair.left.id}
                  onClick={() => handleLeftClick(pair.left.id)}
                  disabled={isMatched}
                  className={clsx(
                    "p-4 rounded-xl border-2 text-left transition-all duration-300 relative select-none text-sm md:text-base",
                    isMatched ? "bg-green-500/10 border-green-500 text-green-400 opacity-50" :
                      isError ? "bg-red-500/10 border-red-500 text-red-400 shake-animation" :
                        isSelected ? "bg-blue-600/20 border-blue-500 text-blue-200 scale-105 shadow-lg z-10" :
                          "bg-slate-800 border-slate-700 text-slate-300 hover:border-slate-500 hover:bg-slate-700"
                  )}
                >
                  {pair.left.text}
                  {isMatched && <Check className="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4" />}
                </button>
              );
            })}
          </div>

          {/* COLUMNA DRETA */}
          <div className="flex flex-col gap-3">
            {rightOptions.map((pair) => {
              const originalPair = content.pairs.find(p => p.right.id === pair.right.id);
              const isMatched = originalPair && matchedPairs.has(originalPair.left.id);
              const isError = errorPair?.right === pair.right.id;

              return (
                <button
                  key={pair.right.id}
                  onClick={() => handleRightClick(pair.right.id)}
                  disabled={isMatched || !selectedLeft}
                  className={clsx(
                    "p-4 rounded-xl border-2 text-left transition-all duration-300 relative select-none text-sm md:text-base",
                    isMatched ? "bg-green-500/10 border-green-500 text-green-400 opacity-50" :
                      isError ? "bg-red-500/10 border-red-500 text-red-400 shake-animation" :
                        selectedLeft && !isMatched ? "bg-slate-800 border-slate-600 cursor-pointer hover:border-purple-400 hover:bg-slate-700" :
                          "bg-slate-800 border-slate-800 text-slate-500 cursor-not-allowed opacity-60"
                  )}
                >
                  {pair.right.text}
                </button>
              );
            })}
          </div>
        </div>

      </div>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/QuizView.tsx ===================

// filepath: src/presentation/components/features/game-engine/QuizView.tsx
'use client';

import { useState } from 'react';
import { Challenge, QuizContent } from '@/core/entities/challenges/index';
import { CheckCircle2, XCircle, ArrowRight } from 'lucide-react';
import { clsx } from 'clsx';
import { GameSessionLayout } from './layout/GameSessionLayout';
import { GameHeader } from './layout/GameHeader';
import { useTranslations } from 'next-intl';

interface QuizViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function QuizView({ challenge, onNext }: QuizViewProps) {
  const t = useTranslations('game'); 
  const content = challenge.content as QuizContent;

  const [selectedOptionId, setSelectedOptionId] = useState<string | null>(null);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const handleOptionClick = (optionId: string) => {
    if (isSubmitted) return; 
    setSelectedOptionId(optionId);
    setIsSubmitted(true);
  };

  const handleContinue = () => {
    const selectedIndex = content.options.findIndex(o => o.id === selectedOptionId);
    const isCorrect = selectedIndex === content.correctOptionIndex;
    onNext(isCorrect);
  };

  const selectedIndex = content.options.findIndex(o => o.id === selectedOptionId);
  const isCorrectAnswer = selectedIndex === content.correctOptionIndex;

  // --- STYLES HELPER ---
  const getOptionStyles = (optionId: string, index: number) => {
    if (!isSubmitted) {
      return "border-slate-700 bg-slate-800/50 hover:bg-slate-700 hover:border-blue-500/50 text-slate-300 cursor-pointer active:scale-[0.98]";
    }
    const isCorrect = index === content.correctOptionIndex;
    const isSelected = optionId === selectedOptionId;

    if (isCorrect) return "border-green-500 bg-green-500/20 text-green-400 shadow-[0_0_15px_rgba(34,197,94,0.3)] font-bold";
    if (isSelected && !isCorrect) return "border-red-500 bg-red-500/10 text-red-400 opacity-90 shake-animation"; 
    return "border-slate-800 bg-slate-900/50 text-slate-600 opacity-40 grayscale";
  };

  // --- FOOTER (FEEDBACK) ---
  const Footer = isSubmitted ? (
    <div className={clsx(
        "w-full animate-in slide-in-from-bottom-4 duration-300",
        // El fons del footer canvia segons l'encert (feedback visual fort)
        isCorrectAnswer ? "border-t-4 border-green-500 bg-green-900/20" : "border-t-4 border-red-500 bg-red-900/20"
    )}>
       <div className="p-4 flex flex-col gap-4 backdrop-blur-md rounded-t-xl">
           <div className="flex items-start gap-3">
              <div className={clsx("p-2 rounded-full shrink-0", isCorrectAnswer ? "bg-green-500 text-white" : "bg-red-500 text-white")}>
                  {isCorrectAnswer ? <CheckCircle2 className="w-6 h-6" /> : <XCircle className="w-6 h-6" />}
              </div>
              <div className="flex-1">
                  <h3 className={clsx("font-bold text-lg", isCorrectAnswer ? "text-green-400" : "text-red-400")}>
                      {isCorrectAnswer ? t('feedback.correct') : t('feedback.incorrect')}
                  </h3>
                  <p className="text-slate-300 text-sm leading-relaxed mt-1">
                      {content.explanation}
                  </p>
              </div>
           </div>
           
           <button 
             onClick={handleContinue}
             className={clsx(
                "w-full py-3.5 font-bold rounded-xl transition-transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg",
                isCorrectAnswer 
                ? "bg-green-600 hover:bg-green-500 text-white shadow-green-900/20"
                : "bg-red-600 hover:bg-red-500 text-white shadow-red-900/20"
             )}
           >
             {t('actions.continue')} <ArrowRight className="w-5 h-5" />
           </button>
       </div>
    </div>
  ) : <div className="h-4" />; // Espai buit per mantenir estructura

  return (
    <GameSessionLayout header={<GameHeader />} footer={Footer}>
      <div className="w-full max-w-2xl mx-auto flex flex-col gap-6 pt-4">
        
        {/* TARGETA DE PREGUNTA */}
        <div className="bg-slate-900/80 p-6 rounded-2xl border border-slate-800 shadow-xl backdrop-blur-sm relative overflow-hidden">
          <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2" />
          <h2 className="text-xl font-bold text-white leading-relaxed relative z-10">
            {content.question}
          </h2>
        </div>

        {/* LLISTA D'OPCIONS */}
        <div className="grid gap-3 pb-8">
          {content.options.map((option, index) => {
              const isOptCorrect = index === content.correctOptionIndex;
              const isOptSelected = option.id === selectedOptionId;

              return (
                <button
                  key={option.id}
                  onClick={() => handleOptionClick(option.id)}
                  disabled={isSubmitted}
                  className={clsx(
                    "w-full text-left p-4 rounded-xl border-2 transition-all duration-200 flex items-center justify-between group relative overflow-hidden",
                    getOptionStyles(option.id, index)
                  )}
                >
                  <div className="flex items-center gap-4 z-10 w-full">
                      {/* Badge A, B, C... */}
                      <div className={clsx(
                          "w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold border transition-colors shrink-0",
                          isSubmitted && isOptCorrect ? "bg-green-500 border-green-500 text-slate-900" :
                          isSubmitted && isOptSelected ? "bg-red-500 border-red-500 text-white" :
                          "bg-slate-800 border-slate-600 text-slate-400 group-hover:border-blue-500 group-hover:text-blue-400"
                      )}>
                          {String.fromCharCode(65 + index)}
                      </div>
                      
                      <span className="font-medium text-base md:text-lg flex-1 leading-snug">{option.text}</span>
                  </div>
                </button>
              );
          })}
        </div>
      </div>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/TerminalView.tsx ===================

// filepath: src/presentation/components/features/game-engine/TerminalView.tsx
'use client';

import { useState, useRef, useEffect } from 'react';
import { Challenge, TerminalContent } from '@/core/entities/challenges/index';
import { Terminal as TerminalIcon, ArrowRight, CheckCircle2, Command } from 'lucide-react';
import { HintPanel } from './code-fix/HintPanel';
import { GameSessionLayout } from './layout/GameSessionLayout';
import { GameHeader } from './layout/GameHeader'; // ✅ Importem el Header intel·ligent
import { useTranslations } from 'next-intl';

interface TerminalViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
  // ❌ sessionData ELIMINAT
}

type LogLine = {
  type: 'command' | 'output-success' | 'output-error';
  text: string;
};

export function TerminalView({ challenge, onNext }: TerminalViewProps) {
  const t = useTranslations('game');
  const content = challenge.content as TerminalContent;
  
  const [input, setInput] = useState(content.initialCommand || '');
  const [history, setHistory] = useState<LogLine[]>([]);
  const [isCompleted, setIsCompleted] = useState(false);
  
  const inputRef = useRef<HTMLInputElement>(null);
  const scrollRef = useRef<HTMLDivElement>(null);

  // Auto-scroll i Focus logic (igual que abans)
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [history]);

  useEffect(() => {
    if (!isCompleted) {
        setTimeout(() => inputRef.current?.focus(), 100);
    }
  }, [history, isCompleted]);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !isCompleted && input.trim()) {
      executeCommand();
    }
  };

  const executeCommand = () => {
    const cmd = input.trim();
    const newHistory: LogLine[] = [...history, { type: 'command', text: cmd }];

    const normalizedInput = cmd.replace(/\s+/g, ' ').trim();
    const isValid = content.validCommands.some(vc => vc.replace(/\s+/g, ' ').trim() === normalizedInput);

    if (isValid) {
      newHistory.push({ type: 'output-success', text: content.outputParams.success });
      setHistory(newHistory);
      setIsCompleted(true);
      setInput('');
    } else {
      newHistory.push({ type: 'output-error', text: `${cmd}: ${content.outputParams.error}` });
      setHistory(newHistory);
      setInput('');
    }
  };

  // --- FOOTER (Específic d'aquest joc) ---
  const Footer = isCompleted ? (
    <div className="animate-in slide-in-from-bottom-4 duration-500 w-full">
        <div className="bg-green-900/20 border border-green-500/30 rounded-xl p-4 flex flex-col gap-3 backdrop-blur-md">
            <div className="flex items-start gap-3">
                <CheckCircle2 className="w-5 h-5 text-green-400 shrink-0 mt-0.5" />
                <div>
                    <h3 className="text-green-400 font-bold text-sm">{t('feedback.correct')}</h3>
                    <p className="text-slate-300 text-xs leading-relaxed line-clamp-3">
                        {content.explanation}
                    </p>
                </div>
            </div>
            <button 
                onClick={() => onNext(true)}
                className="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95"
            >
                {t('actions.continue')} <ArrowRight className="w-5 h-5" />
            </button>
        </div>
    </div>
  ) : (
    content.hint ? <div className="w-full"><HintPanel hintText={content.hint} /></div> : <div className="h-4" />
  );

  return (
    // ✅ HEADER AUTOMÀTIC: Només el cridem, no li passem res
    <GameSessionLayout header={<GameHeader />} footer={Footer}>
      <div className="flex flex-col h-full gap-2">
        
        {/* TITOL (Fixe) */}
        <div className="shrink-0 flex items-start gap-3 px-1 pb-2">
           <div className="p-2 bg-slate-800 rounded-lg shrink-0 border border-slate-700 shadow-sm">
              <TerminalIcon className="w-5 h-5 text-green-400" />
           </div>
           <div className="min-w-0">
              <h2 className="font-bold text-white text-base leading-tight truncate">{t('modes.terminal.label')}</h2>
              <p className="text-slate-400 text-xs leading-snug mt-0.5 line-clamp-2">{content.instruction}</p>
           </div>
        </div>

        {/* TERMINAL UI */}
        <div 
          className="flex-1 min-h-0 bg-[#0c0c0c] rounded-xl overflow-hidden border border-slate-700 shadow-2xl font-mono text-sm relative flex flex-col"
          onClick={() => !isCompleted && inputRef.current?.focus()}
        >
          {/* Top Bar Decoration */}
          <div className="bg-[#1f1f1f] px-3 py-1.5 flex items-center gap-2 border-b border-[#333] shrink-0">
            <div className="flex gap-1.5">
               <div className="w-2.5 h-2.5 rounded-full bg-red-500/80"></div>
               <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/80"></div>
               <div className="w-2.5 h-2.5 rounded-full bg-green-500/80"></div>
            </div>
            <div className="text-slate-500 text-[10px] ml-2 flex items-center gap-1 opacity-60">
               <Command className="w-3 h-3" /> {t('modes.terminal.prompt_user')}@edutech:~
            </div>
          </div>

          {/* Logs Area */}
          <div 
            ref={scrollRef}
            className="flex-1 overflow-y-auto p-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent space-y-1"
          >
            {history.map((line, i) => (
              <div key={i} className="wrap-break-word leading-relaxed text-xs md:text-sm">
                {line.type === 'command' && (
                  <div className="text-white mt-2">
                    <span className="text-green-500 mr-2 font-bold">➜</span>
                    <span className="text-blue-400 mr-2 font-bold">~</span>
                    {line.text}
                  </div>
                )}
                {line.type === 'output-success' && (
                  <div className="text-emerald-400/90 whitespace-pre-wrap pl-4 border-l-2 border-emerald-500/30 ml-1 mt-1 font-medium pb-2">
                    {line.text}
                  </div>
                )}
                {line.type === 'output-error' && (
                  <div className="text-red-400 pl-4 mt-1 bg-red-500/5 p-1 rounded-sm inline-block">
                    {line.text}
                  </div>
                )}
              </div>
            ))}

            {/* Input Actiu */}
            {!isCompleted && (
              <div className="flex items-center text-white animate-in fade-in pt-1 pb-10">
                <span className="text-green-500 mr-2 shrink-0 font-bold">➜</span>
                <span className="text-blue-400 mr-2 shrink-0 font-bold">~</span>
                <input
                  ref={inputRef}
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={handleKeyDown}
                  placeholder={t('modes.terminal.placeholder')}
                  className="bg-transparent border-none outline-none flex-1 text-white placeholder-slate-700 font-mono caret-green-500 p-0 m-0"
                  autoComplete="off"
                  spellCheck="false"
                  autoFocus
                />
              </div>
            )}
            
            {isCompleted && (
               <div className="mt-4 text-slate-500 italic text-xs border-t border-slate-800 pt-2">
                  {t('modes.terminal.session_closed')}
               </div>
            )}
          </div>
        </div>

      </div>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/TheoryView.tsx ===================

// filepath: src/presentation/components/features/game-engine/TheoryView.tsx
'use client';

import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { BookOpen, ChevronRight, Terminal } from 'lucide-react';
import { useLocale } from 'next-intl';

// --- 1. DEFINICIÓ DE TIPUS (DOMAIN TYPES) ---

// Tipus per a textos traduïbles (potser incomplets, per això Partial)
type LocalizedText = Partial<Record<'ca' | 'es' | 'en', string>>;

// Estructura dels diferents tipus de blocs
interface BlockText {
  type: 'text';
  content: LocalizedText;
}

interface BlockList {
  type: 'list';
  items: LocalizedText[];
}

interface BlockCode {
  type: 'code';
  value: string;
  lang?: string;
}

// Unió Discriminada (El camp 'type' decideix la forma)
type TheoryBlock = BlockText | BlockList | BlockCode;

// L'estructura arrel del contingut de Teoria
interface TheoryContent {
  title: LocalizedText;
  blocks: TheoryBlock[];
}

// --- 2. COMPONENT ---

interface TheoryViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function TheoryView({ challenge, onNext }: TheoryViewProps) {
  const locale = useLocale() as 'ca' | 'es' | 'en';
  
  // Cast segur: Diem a TS que 'content' compleix la nostra interfície TheoryContent
  const content = challenge.content as unknown as TheoryContent;

  // Helper Type-Safe per treure text
  const getText = (field: LocalizedText | undefined): string => {
    if (!field) return '';
    return field[locale] || field['ca'] || field['es'] || '';
  };

  return (
    <div className="w-full max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
      
      {/* --- CAPÇALERA --- */}
      <div className="bg-slate-900/50 border border-slate-800 rounded-2xl overflow-hidden shadow-2xl backdrop-blur-sm">
        
        <div className="bg-indigo-600/10 border-b border-indigo-500/20 p-6 flex items-center gap-4">
          <div className="bg-indigo-600 p-3 rounded-lg shadow-lg shadow-indigo-500/20">
            <BookOpen className="w-8 h-8 text-white" />
          </div>
          <div>
            <span className="text-xs font-bold tracking-widest text-indigo-400 uppercase">Training Module</span>
            <h1 className="text-2xl md:text-3xl font-black text-white mt-1">
              {getText(content.title)}
            </h1>
          </div>
        </div>

        {/* --- CONTINGUT DELS BLOCS --- */}
        <div className="p-6 md:p-8 space-y-8">
          {/* TypeScript ara sap que 'blocks' és un array de TheoryBlock */}
          {content.blocks?.map((block, idx) => {
            
            // CAS 1: TEXT
            if (block.type === 'text') {
              return (
                <p key={idx} className="text-slate-300 text-lg leading-relaxed">
                  {getText(block.content)}
                </p>
              );
            }

            // CAS 2: LLISTA
            if (block.type === 'list') {
              return (
                <ul key={idx} className="space-y-3 bg-slate-950/30 p-5 rounded-xl border border-slate-800">
                  {block.items.map((item, i) => (
                    <li key={i} className="flex gap-3 text-slate-300">
                      <span className="text-indigo-500 font-bold">•</span>
                      <span>{getText(item)}</span>
                    </li>
                  ))}
                </ul>
              );
            }

            // CAS 3: CODI
            if (block.type === 'code') {
              return (
                <div key={idx} className="relative group rounded-xl overflow-hidden border border-slate-700 bg-slate-950">
                  <div className="flex items-center justify-between px-4 py-2 bg-slate-900 border-b border-slate-800">
                    <span className="text-xs text-slate-500 font-mono flex items-center gap-2">
                      <Terminal className="w-3 h-3" />
                      {block.lang || 'text'}
                    </span>
                    <div className="flex gap-1.5">
                      <div className="w-2.5 h-2.5 rounded-full bg-red-500/20" />
                      <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/20" />
                      <div className="w-2.5 h-2.5 rounded-full bg-green-500/20" />
                    </div>
                  </div>
                  <pre className="p-4 overflow-x-auto text-sm font-mono leading-relaxed text-indigo-300">
                    <code>{block.value}</code>
                  </pre>
                </div>
              );
            }

            return null;
          })}
        </div>

        {/* --- FOOTER --- */}
        <div className="p-6 bg-slate-900/80 border-t border-slate-800 flex justify-end">
          <button
            onClick={() => onNext(true)}
            className="group relative inline-flex items-center justify-center gap-2 px-8 py-4 font-bold text-white transition-all duration-200 bg-indigo-600 rounded-xl hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-600 active:scale-95 shadow-lg shadow-indigo-600/30"
          >
            <span>Entesos, Continuar</span>
            <ChevronRight className="w-5 h-5 transition-transform group-hover:translate-x-1" />
          </button>
        </div>

      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/BossMarker.tsx ===================

// filepath: src/presentation/components/features/learning-path/BossMarker.tsx
'use client';

import { useTranslations } from 'next-intl';
import { Medal, Trophy, Crown, Rocket, LucideIcon, Sparkles, Check } from 'lucide-react';
import { clsx } from 'clsx';

const ICONS: Record<string, LucideIcon> = {
  medal: Medal,
  trophy: Trophy,
  crown: Crown,
  rocket: Rocket
};

const THEMES: Record<string, { bg: string, border: string, shadow: string, ring: string }> = {
  'bg-blue-500':   { bg: 'bg-blue-600',   border: 'border-blue-800',   shadow: 'shadow-blue-600/40',   ring: 'border-blue-400' },
  'bg-orange-500': { bg: 'bg-orange-500', border: 'border-orange-700', shadow: 'shadow-orange-500/40', ring: 'border-orange-300' },
  'bg-red-600':    { bg: 'bg-red-600',    border: 'border-red-800',    shadow: 'shadow-red-600/40',    ring: 'border-red-400' },
  'bg-purple-600': { bg: 'bg-purple-600', border: 'border-purple-800', shadow: 'shadow-purple-600/40', ring: 'border-purple-400' },
  'bg-yellow-500': { bg: 'bg-yellow-500', border: 'border-yellow-700', shadow: 'shadow-yellow-500/40', ring: 'border-yellow-200' },
};

// 🟢 TEMA "COMPLETED" (Verd Maragda estàndard)
const COMPLETED_THEME = {
  bg: 'bg-emerald-500',
  border: 'border-emerald-700',
  shadow: 'shadow-emerald-500/40',
  ring: 'border-emerald-300'
};

interface BossMarkerProps {
  titleKey?: string;
  iconName?: string;
  colorClass?: string;
  isLocked: boolean;
  isCompleted: boolean; // 👈 NOVA PROP
}

export function BossMarker({ titleKey, iconName, colorClass, isLocked, isCompleted }: BossMarkerProps) {
  const t = useTranslations();
  const IconComponent = (iconName && ICONS[iconName]) ? ICONS[iconName] : Trophy;
  
  // 1. SELECCIÓ DE TEMA:
  // Si està complet -> Verd. Si no -> Color del Boss.
  const baseTheme = THEMES[colorClass || 'bg-yellow-500'] || THEMES['bg-yellow-500'];
  const theme = isCompleted ? COMPLETED_THEME : baseTheme;

  return (
    <div className={clsx(
      "relative flex flex-col items-center justify-center w-36 h-36 transition-all duration-500",
      // Si està complet o actiu, escala normal/gran. Si està bloquejat, normal.
      !isLocked ? "scale-110" : "opacity-100"
    )}>

      {/* --- AURA EXTERNA (Només si Actiu o Complet) --- */}
      {!isLocked && (
        <>
          <div className={clsx(
             "absolute inset-0 rounded-full border-2 border-dashed opacity-50 animate-[spin_10s_linear_infinite]",
             theme.ring
          )} />
          
          <div className={clsx(
             "absolute inset-4 rounded-full blur-xl opacity-30 animate-pulse",
             theme.bg
          )} />
        </>
      )}

      {/* --- NUCLI CENTRAL --- */}
      <div className={clsx(
        "relative w-24 h-24 rounded-full flex items-center justify-center transition-all duration-300 z-10",
        "border-4 border-b-8",
        
        isLocked 
          ? "bg-slate-800 border-slate-950 text-slate-500" 
          : `${theme.bg} ${theme.border} text-white shadow-xl ${theme.shadow} animate-float`
      )}>
        
        {/* ICONA */}
        <div className="relative z-10">
           <IconComponent className={clsx(
             "transition-transform duration-300",
             isLocked 
               ? "w-10 h-10 opacity-50 grayscale"
               : "w-12 h-12 drop-shadow-md animate-bounce-sm"
           )} />
           
           {/* Checkmark de victòria si està complet */}
           {isCompleted && (
             <div className="absolute -bottom-2 -right-2 bg-white text-emerald-600 rounded-full p-1 shadow-sm border-2 border-emerald-100">
                <Check className="w-4 h-4 stroke-[4]" />
             </div>
           )}

           {/* Espurnes (Només si actiu/complet) */}
           {!isLocked && !isCompleted && (
             <Sparkles className="absolute -top-3 -right-3 w-5 h-5 text-white animate-pulse" />
           )}
        </div>

        {/* Gloss */}
        {!isLocked && (
           <div className="absolute inset-2 rounded-full bg-gradient-to-b from-white/20 to-transparent pointer-events-none" />
        )}
      </div>

      {/* --- ETIQUETA --- */}
      <div className={clsx(
        "absolute -bottom-6 px-4 py-1.5 rounded-full border shadow-md z-20 min-w-[130px] text-center transition-transform",
        isLocked 
          ? "bg-slate-900 border-slate-950 text-slate-500"
          : `${theme.bg} ${theme.border} border-b-4 -translate-y-1`
      )}>
        <span className={clsx(
          "text-[10px] font-black uppercase tracking-[0.2em] leading-none",
           isLocked ? "text-slate-500" : "text-white"
        )}>
          {titleKey ? t(titleKey) : 'BOSS'}
        </span>
      </div>

    </div>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/HorizontalPath.tsx ===================

// filepath: src/presentation/components/features/learning-path/HorizontalPath.tsx
'use client';

import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { LevelNode } from './LevelNode';
import { useRef, useEffect, useState, useCallback } from 'react';
import { clsx } from 'clsx';
import { ChevronLeft, ChevronRight } from 'lucide-react';

interface PathProps {
  levels: LevelNodeDTO[];
  slug: string;
}

export function HorizontalPath({ levels, slug }: PathProps) {
  const scrollRef = useRef<HTMLDivElement>(null);
  const animationRef = useRef<number | null>(null); // Referència per al bucle d'animació
  
  const [showLeft, setShowLeft] = useState(false);
  const [showRight, setShowRight] = useState(true);

  // Constants
  const SCROLL_SPEED = 12; // Píxels per frame (ajusta-ho si va molt ràpid o lent)
  const AMPLITUDE_Y = 60;
  const HORIZONTAL_GAP = 160;
  const INITIAL_X = 100;
  const totalWidth = (levels.length * HORIZONTAL_GAP) + 200;

  // --- LOGICA DE VISIBILITAT DELS BOTONS ---
  const handleScroll = useCallback(() => {
    if (scrollRef.current) {
      const { scrollLeft, scrollWidth, clientWidth } = scrollRef.current;
      setShowLeft(scrollLeft > 10);
      setShowRight(scrollLeft < scrollWidth - clientWidth - 1);
    }
  }, []);

  // --- LOGICA DE SCROLL CONTINU (HOLD TO SCROLL) ---
  
  const startScrolling = (direction: 'left' | 'right') => {
    // Si ja estem fent scroll, no fem res
    if (animationRef.current) return;

    const scrollLoop = () => {
      if (scrollRef.current) {
        const amount = direction === 'left' ? -SCROLL_SPEED : SCROLL_SPEED;
        scrollRef.current.scrollLeft += amount; // Modificació directa per màxima suavitat
        
        // Continuem el bucle
        animationRef.current = requestAnimationFrame(scrollLoop);
      }
    };

    // Iniciem el bucle
    scrollLoop();
  };

  const stopScrolling = () => {
    if (animationRef.current) {
      cancelAnimationFrame(animationRef.current);
      animationRef.current = null;
    }
  };

  // --- EFECTES ---
  useEffect(() => {
    const container = scrollRef.current;
    if (container) {
      const activeNode = container.querySelector('[data-active="true"]');
      if (activeNode) {
        activeNode.scrollIntoView({ behavior: 'auto', inline: 'center' });
      }
      container.addEventListener('scroll', handleScroll);
      handleScroll();
      return () => container.removeEventListener('scroll', handleScroll);
    }
  }, [levels, handleScroll]);

  // Classes comunes pel botó
  const buttonClass = "bg-slate-800 hover:bg-blue-600 text-white p-4 rounded-full shadow-2xl border-2 border-slate-600 hover:border-blue-400 backdrop-blur-md transition-all active:scale-95 pointer-events-auto flex items-center justify-center select-none";

  return (
    <div className="relative w-full h-[80vh] group">

      {/* --- BOTÓ ESQUERRA --- */}
      <div className={clsx(
        "absolute left-0 top-0 bottom-0 w-32 z-[9999] flex items-center justify-start pl-6 transition-opacity duration-300 pointer-events-none bg-linear-to-r from-slate-950 via-slate-950/80 to-transparent",
        showLeft ? "opacity-100" : "opacity-0"
      )}>
        <button 
          // Esdeveniments per a ratolí
          onMouseDown={() => startScrolling('left')}
          onMouseUp={stopScrolling}
          onMouseLeave={stopScrolling} // Important: si surt del botó, para
          // Esdeveniments per a tàctil (mòbil)
          onTouchStart={() => startScrolling('left')}
          onTouchEnd={stopScrolling}
          
          className={buttonClass}
          aria-label="Scroll Left"
        >
          <ChevronLeft className="w-8 h-8 stroke-[3]" />
        </button>
      </div>

      {/* --- BOTÓ DRETA --- */}
      <div className={clsx(
        "absolute right-0 top-0 bottom-0 w-32 z-[9999] flex items-center justify-end pr-6 transition-opacity duration-300 pointer-events-none bg-linear-to-l from-slate-950 via-slate-950/80 to-transparent",
        showRight ? "opacity-100" : "opacity-0"
      )}>
        <button 
          // Esdeveniments per a ratolí
          onMouseDown={() => startScrolling('right')}
          onMouseUp={stopScrolling}
          onMouseLeave={stopScrolling}
          // Esdeveniments per a tàctil
          onTouchStart={() => startScrolling('right')}
          onTouchEnd={stopScrolling}

          className={buttonClass}
          aria-label="Scroll Right"
        >
          <ChevronRight className="w-8 h-8 stroke-[3]" />
        </button>
      </div>

      {/* --- SCROLL AREA --- */}
      <div ref={scrollRef} className="w-full h-full overflow-x-auto overflow-y-hidden flex items-center [&::-webkit-scrollbar]:hidden [-ms-overflow-style:'none'] [scrollbar-width:'none']">
        <div className="relative h-full flex items-center" style={{ minWidth: `${totalWidth}px` }}>

          {/* SVG LINE (Amb el fix de .toFixed(2) inclòs) */}
          <svg className="absolute left-0 w-full h-full pointer-events-none opacity-20" style={{ zIndex: 0 }}>
            <path
              d={`M ${INITIAL_X} 50% ${levels.map((_, i) => {
                const yOffset = (Math.sin(i) * AMPLITUDE_Y).toFixed(2);
                return `L ${INITIAL_X + (i * HORIZONTAL_GAP)}px calc(50% + ${yOffset}px)`;
              }).join(' ')}`}
              fill="none" stroke="#64748b" strokeWidth="4" strokeDasharray="12,12" strokeLinecap="round" strokeLinejoin="round"
            />
          </svg>

          {/* NODES (Amb el fix de .toFixed(2) inclòs) */}
          {levels.map((level, index) => {
            const yOffset = (Math.sin(index) * AMPLITUDE_Y).toFixed(2);
            const leftPos = INITIAL_X + (index * HORIZONTAL_GAP);

            return (
              <div
                key={level.tier}
                data-active={level.isCurrentPosition}
                className={clsx(
                  "absolute transition-all duration-500",
                  level.isBoss ? "z-30" : "z-10"
                )}
                style={{
                  left: `${leftPos}px`,
                  top: `calc(50% + ${yOffset}px - 32px)`
                }}
              >
                <LevelNode {...level} slug={slug} index={index} />
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/LearningPathOrchestrator.tsx ===================

// filepath: src/presentation/components/features/learning-path/LearningPathOrchestrator.tsx
'use client';

import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { VerticalPath } from './VerticalPath';
import { HorizontalPath } from './HorizontalPath';

interface OrchestratorProps {
  levels: LevelNodeDTO[];
  slug: string;
}

export function LearningPathOrchestrator({ levels, slug }: OrchestratorProps) {
  return (
    <>
      {/* VERSIÓ MÒBIL: Visible fins a md, després s'amaga */}
      <div className="block md:hidden w-full pb-32">
        <VerticalPath levels={levels} slug={slug} />
      </div>

      {/* VERSIÓ ESCRIPTORI: Oculta fins a md, després es mostra */}
      <div className="hidden md:block w-full h-full min-h-[80vh]">
        <HorizontalPath levels={levels} slug={slug} />
      </div>
    </>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/LevelNode.tsx ===================

// filepath: src/presentation/components/features/learning-path/LevelNode.tsx
'use client';

import Link from 'next/link';
import {
  Check, Lock, Puzzle, Brain,
  ArrowDownUp, SquareTerminal, Wrench, BookOpen,
  Scale // He afegit Scale per al tipus BINARY_DECISION
} from 'lucide-react';
import { clsx } from 'clsx';
import { LevelStatus } from '@/application/dto/level-node.dto';
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';
import { BossMarker } from './BossMarker';

interface LevelNodeProps {
  tier: number;
  status: LevelStatus;
  slug: string;
  index: number;
  predominantType?: ChallengeType;
  isCurrentPosition?: boolean;
  isBoss?: boolean;
  bossTitleKey?: string;
  bossIconName?: string;
  bossColorClass?: string;
}

// 🛠️ FIX: Recuperem la lògica de selecció d'icona
function getGameIcon(type: string) {
  switch (type) {
    case 'THEORY': // 2. Nou tipus: TEORIA
      return <BookOpen className="w-8 h-8" />;
    case 'TERMINAL':
      return <SquareTerminal className="w-8 h-8" />;
    case 'CODE_FIX':
      return <Wrench className="w-8 h-8" />;
    case 'MATCHING':
      return <Puzzle className="w-8 h-8" />;
    case 'BINARY_DECISION':
      return <Scale className="w-8 h-8" />; // Icona de balança per decisions
    case 'LOGIC_ORDER': // Si tens aquest tipus en el futur
      return <ArrowDownUp className="w-8 h-8" />;
    case 'QUIZ':
    default:
      return <Brain className="w-8 h-8" />;
  }
}

export function LevelNode({
  tier, status, slug, predominantType = 'QUIZ', isCurrentPosition,
  isBoss, bossTitleKey, bossIconName, bossColorClass
}: LevelNodeProps) {

  const isLocked = status === 'LOCKED';
  const isCompleted = status === 'COMPLETED';
  // Si és un node de TEORIA, li donem un estil especial (Lila)
  const isTheory = predominantType === 'THEORY';
  // ============================================
  // 🏰 RENDERITZAT DE BOSS (Delegate Pattern)
  // ============================================
  if (isBoss) {
    const BossContent = (
      <div className="relative group flex flex-col items-center justify-center py-4 z-20">
        <BossMarker
          titleKey={bossTitleKey}
          iconName={bossIconName}
          colorClass={bossColorClass}
          isLocked={isLocked}
          isCompleted={isCompleted}
        />
      </div>
    );

    return isLocked ? (
      <div className="flex justify-center">{BossContent}</div>
    ) : (
      <div className="flex justify-center">
        <Link href={`/learn/${slug}/play?tier=${tier}`}>{BossContent}</Link>
      </div>
    );
  }

  // ============================================
  // 🟢 RENDERITZAT NORMAL
  // ============================================

  const baseStyles = "relative w-16 h-16 md:w-20 md:h-20 rounded-full flex flex-col items-center justify-center border-b-4 transition-all duration-300 z-10 active:border-b-0 active:translate-y-[4px]";

  const statusStyles = {
    LOCKED: "bg-slate-800 border-slate-950 text-slate-500 cursor-not-allowed",
    COMPLETED: "bg-emerald-500 border-emerald-700 text-white shadow-lg shadow-emerald-900/20",
    // 3. Si és TEORIA actiu, el fem Lila. Si és JOC actiu, Blau.
    ACTIVE: isTheory
      ? "bg-purple-600 border-purple-800 text-white shadow-[0_0_40px_rgba(147,51,234,0.4)] ring-4 ring-purple-500/20"
      : "bg-blue-600 border-blue-800 text-white shadow-[0_0_40px_rgba(37,99,235,0.4)] ring-4 ring-blue-500/20"
  };

  const NormalContent = (
    <div className="relative group">
      {/* Fletxa de START només si és la posició actual */}
      {isCurrentPosition && (
        <div className="absolute -top-14 left-1/2 -translate-x-1/2 flex flex-col items-center animate-bounce z-30 pointer-events-none">
          <div className="bg-white text-blue-600 px-3 py-1 rounded-lg font-bold text-[10px] shadow-xl mb-0.5 uppercase tracking-wider border-2 border-blue-100">START</div>
          <div className="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-8 border-t-white"></div>
        </div>
      )}

      <div className={clsx(baseStyles, statusStyles[status])}>
        <div className={clsx("transition-transform duration-300", status === 'ACTIVE' ? "scale-110" : "group-hover:scale-110", status === 'LOCKED' && "opacity-40 grayscale")}>
          {/* AQUÍ ÉS ON CRIDEM LA FUNCIÓ ARREGLADA */}
          {getGameIcon(predominantType)}
        </div>

        {/* Badges petits de estat */}
        {status === 'COMPLETED' && <div className="absolute -right-2 -top-2 bg-yellow-400 text-yellow-900 rounded-full p-1 border-4 border-slate-950 shadow-sm z-20"><Check className="w-3.5 h-3.5 stroke-3" /></div>}
        {status === 'LOCKED' && <div className="absolute -right-1 -bottom-1 bg-slate-700 text-slate-400 rounded-full p-1.5 border-4 border-slate-950 z-20"><Lock className="w-3 h-3" /></div>}
      </div>

      {/* Etiqueta de nivell */}
      <div className={clsx("absolute -bottom-8 left-1/2 -translate-x-1/2 px-2.5 py-0.5 rounded-full border text-[10px] font-bold whitespace-nowrap shadow-md", status === 'ACTIVE' ? "bg-blue-600 border-blue-400 text-white" : "bg-slate-900 border-slate-700 text-slate-400")}>
        LVL {tier}
      </div>
    </div>
  );

  return isLocked ? (
    <div className="flex justify-center py-4">{NormalContent}</div>
  ) : (
    <div className="flex justify-center py-4">
      <Link href={`/learn/${slug}/play?tier=${tier}`}>{NormalContent}</Link>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/VerticalPath.tsx ===================

// filepath: src/presentation/components/features/learning-path/VerticalPath.tsx
'use client';

import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { LevelNode } from './LevelNode';

import { clsx } from 'clsx';

interface PathProps {
  levels: LevelNodeDTO[];
  slug: string;
}

export function VerticalPath({ levels, slug }: PathProps) {
  const AMPLITUDE = 75; 
  const VERTICAL_GAP = 100; 
  const INITIAL_Y = 60;

  return (
      <div className="relative mt-8 w-full flex flex-col items-center pb-24">
         {/* SVG i Path logic (Igual) */}
         
         <div className="flex flex-col gap-0 w-full relative z-10 items-center">
             {levels.map((level, index) => {
                 const xOffset = Math.sin(index) * AMPLITUDE; 
                 // Més espai vertical si és Boss perquè el Marker ocupa espai
                 const isBossSpacing = level.isBoss ? 'py-8' : 'py-0'; 

                 return (
                    <div 
                      key={level.tier} 
                      className={clsx(
                        "absolute w-full flex justify-center transition-transform duration-500",
                        isBossSpacing
                      )}
                      style={{ 
                          top: `${index * VERTICAL_GAP + INITIAL_Y - 32}px`,
                          transform: `translateX(${xOffset}px)`
                      }}
                    >
                        <div className="relative">
                            
                      

                            <LevelNode {...level} slug={slug} index={index} />
                        </div>
                    </div>
                 );
             })}
         </div>

         <div style={{ height: `${levels.length * VERTICAL_GAP + 100}px` }} />
      </div>
  );
}

// =================== FILE: src/presentation/components/features/topics/TopicCard.tsx ===================

'use client';

import { useLocale } from 'next-intl';
import { Topic } from '@/core/entities/topic.entity';
import { getLocalizedText } from '@/core/utils/i18n-utils';
import * as Icons from 'lucide-react';
import { LucideIcon } from 'lucide-react'; // 👈 Importem el tipus

export function TopicCard({ topic }: { topic: Topic }) {
  const locale = useLocale();
  
  // ✅ FIX: Fem un cast segur a un Record<string, LucideIcon>
  // Això diu: "Tracta l'objecte Icons com un diccionari de icones"
  const iconList = Icons as unknown as Record<string, LucideIcon>;
  const IconComponent = iconList[topic.iconName] || Icons.Box;

  return (
    <div className={`p-6 rounded-xl border ${topic.isActive ? 'border-slate-200' : 'border-slate-800 opacity-50'}`}>
      <div className={`${topic.colorTheme} w-12 h-12 rounded-lg flex items-center justify-center mb-4`}>
        <IconComponent className="text-white w-6 h-6" />
      </div>
      
      <h3 className="text-lg font-bold text-slate-900 dark:text-white mb-2">
        {getLocalizedText(topic.title, locale)}
      </h3>

      <p className="text-sm text-slate-500">
        {getLocalizedText(topic.description, locale)}
      </p>
    </div>
  );
}

// =================== FILE: src/presentation/components/layout/DesktopNavbar.tsx ===================

// filepath: src/presentation/components/layout/DesktopNavbar.tsx
'use client';

// IMPORTACIONS ARQUITECTÒNIQUES: Usem el nostre wrapper, no el de Next directament
import { Link } from '@/navigation'; 
import { LanguageSwitcher } from '../ui/gamified/LanguagerSwitcher';
import { Button3D } from '../ui/gamified/Button3D';
import { LogOut, User } from 'lucide-react';
import { logoutAction } from '@/presentation/actions/auth/logout.actions';

interface DesktopNavbarProps {
  isLoggedIn: boolean;
}

export function DesktopNavbar({ isLoggedIn }: DesktopNavbarProps) {
  // No necessitem useLocale(), el Link ja sap on som.

  return (
    <header className="hidden md:flex w-full h-20 border-b-2 border-slate-800 bg-slate-900/80 backdrop-blur-md fixed top-0 z-50 px-8 items-center justify-between">
      {/* LOGO - Ruta neta '/' */}
      <Link href="/" className="text-2xl font-black tracking-tighter text-green-500 hover:scale-105 transition-transform">
        edu<span className="text-white">Tech</span>
      </Link>

      {/* ACCIONS DRETA */}
      <div className="flex items-center gap-4">
        <LanguageSwitcher />

        {isLoggedIn ? (
          <div className="flex gap-3">
             {/* Rutes netes sense ${locale} */}
             <Link href="/profile">
                <Button3D variant="outline" className="py-2 px-4 text-sm">
                   <User className="w-4 h-4" /> Perfil
                </Button3D>
             </Link>
             <div onClick={() => logoutAction()} className="cursor-pointer">
                <Button3D variant="danger" className="py-2 px-4 text-sm">
                   <LogOut className="w-4 h-4" />
                </Button3D>
             </div>
          </div>
        ) : (
          <div className="flex gap-3">
            <Link href="/login">
               <Button3D variant="outline" className="py-2 px-6 text-sm">
                 Entrar
               </Button3D>
            </Link>
            <Link href="/register">
               <Button3D variant="primary" className="py-2 px-6 text-sm">
                 Començar
               </Button3D>
            </Link>
          </div>
        )}
      </div>
    </header>
  );
}

// =================== FILE: src/presentation/components/layout/MobileBottomBar.tsx ===================

// filepath: src/presentation/components/layout/MobileBottomBar.tsx
'use client';

import { Link, usePathname } from '@/navigation';
import { Home, Zap, User, LogIn } from 'lucide-react';
import { clsx } from 'clsx';

interface MobileBottomBarProps {
  isLoggedIn: boolean;
}

export function MobileBottomBar({ isLoggedIn }: MobileBottomBarProps) {
  const pathname = usePathname();

  // 🛑 LOGICA D'ARQUITECTE: SI ESTEM JUGANT, NO MOSTREM LA BARRA
  // Això dóna tota la pantalla al joc (100dvh real)
  if (pathname.includes('/play') || pathname.includes('/arena')) {
    return null;
  }

  const navItems = [
    { label: 'Inici', href: '/', icon: Home },
    { label: 'Aprendre', href: '/learn', icon: Zap },
    { label: isLoggedIn ? 'Perfil' : 'Entrar', href: isLoggedIn ? '/profile' : '/login', icon: isLoggedIn ? User : LogIn }
  ];

  return (
    <div className="fixed bottom-0 left-0 w-full bg-slate-950/90 backdrop-blur-md border-t border-slate-800 px-6 py-3 md:hidden z-50 pb-safe">
      <div className="flex justify-between items-center max-w-sm mx-auto">
        {navItems.map((item) => {
          const isActive = pathname === item.href;
          const Icon = item.icon;
          
          return (
            <Link 
              key={item.href} 
              href={item.href}
              className={clsx(
                "flex flex-col items-center gap-1 transition-all active:scale-90",
                isActive ? "text-blue-400" : "text-slate-500 hover:text-slate-300"
              )}
            >
              <Icon className={clsx("w-6 h-6", isActive && "fill-current")} />
              <span className="text-[10px] font-bold tracking-wide uppercase">{item.label}</span>
            </Link>
          );
        })}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/ui/admin-pagination.tsx ===================

// filepath: src/presentation/components/ui/admin-pagination.tsx
'use client';

import { useRouter, useSearchParams } from 'next/navigation';

interface Props {
  currentPage: number;
  totalPages: number;
}

export function AdminPagination({ currentPage, totalPages }: Props) {
  const router = useRouter();
  const searchParams = useSearchParams();

  const changePage = (newPage: number) => {
    const params = new URLSearchParams(searchParams.toString());
    params.set('page', newPage.toString());
    router.push(`?${params.toString()}`);
  };

  if (totalPages <= 1) return null;

  return (
    <div className="flex items-center justify-between px-4 py-3 bg-white dark:bg-slate-900 border-t border-gray-200 dark:border-slate-800 sm:px-6 transition-colors rounded-b-xl">
      
      {/* MOBILE VIEW */}
      <div className="flex justify-between flex-1 sm:hidden gap-2">
        <button
          onClick={() => changePage(Math.max(1, currentPage - 1))}
          disabled={currentPage === 1}
          className="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded-md hover:bg-gray-50 dark:hover:bg-slate-700 disabled:opacity-50 transition-colors"
        >
          ← Ant.
        </button>
        <button
          onClick={() => changePage(Math.min(totalPages, currentPage + 1))}
          disabled={currentPage === totalPages}
          className="relative inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-700 rounded-md hover:bg-gray-50 dark:hover:bg-slate-700 disabled:opacity-50 transition-colors"
        >
          Seg. →
        </button>
      </div>

      {/* DESKTOP VIEW */}
      <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
        <div>
          <p className="text-sm text-gray-700 dark:text-gray-400">
            Mostrant pàgina <span className="font-medium text-gray-900 dark:text-white">{currentPage}</span> de <span className="font-medium text-gray-900 dark:text-white">{totalPages}</span>
          </p>
        </div>
        <div>
          <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
            <button
              onClick={() => changePage(currentPage - 1)}
              disabled={currentPage === 1}
              className="relative inline-flex items-center rounded-l-md px-3 py-2 text-gray-400 dark:text-gray-500 ring-1 ring-inset ring-gray-300 dark:ring-slate-700 hover:bg-gray-50 dark:hover:bg-slate-800 focus:z-20 focus:outline-offset-0 disabled:opacity-30 disabled:hover:bg-transparent transition-colors"
            >
              <span className="sr-only">Previous</span>
              <svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fillRule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clipRule="evenodd" />
              </svg>
            </button>
            
            {/* Indicador visual de pàgina (opcional, per donar context) */}
            <span className="relative inline-flex items-center px-4 py-2 text-sm font-semibold text-gray-900 dark:text-white ring-1 ring-inset ring-gray-300 dark:ring-slate-700 focus:outline-offset-0 bg-white dark:bg-slate-800">
              {currentPage}
            </span>

            <button
              onClick={() => changePage(currentPage + 1)}
              disabled={currentPage === totalPages}
              className="relative inline-flex items-center rounded-r-md px-3 py-2 text-gray-400 dark:text-gray-500 ring-1 ring-inset ring-gray-300 dark:ring-slate-700 hover:bg-gray-50 dark:hover:bg-slate-800 focus:z-20 focus:outline-offset-0 disabled:opacity-30 disabled:hover:bg-transparent transition-colors"
            >
              <span className="sr-only">Next</span>
              <svg className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fillRule="evenodd" d="M7.21 14.77a.75.75 0 01.02-1.06L11.168 10 7.23 6.29a.75.75 0 111.04-1.08l4.5 4.25a.75.75 0 010 1.08l-4.5 4.25a.75.75 0 01-1.06-.02z" clipRule="evenodd" />
              </svg>
            </button>
          </nav>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/ui/gamified/Button3D.tsx ===================

'use client';

import { ButtonHTMLAttributes, ReactNode } from 'react';
import { clsx } from 'clsx';
import { Loader2 } from 'lucide-react';

interface Button3DProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'success' | 'danger' | 'outline';
  isLoading?: boolean;
  children: ReactNode;
}

export function Button3D({ 
  children, 
  variant = 'primary', 
  isLoading, 
  className,
  disabled,
  ...props 
}: Button3DProps) {
  
  // Mapeig de variants a les nostres classes globals
  const variantClasses = {
    primary: 'btn-primary',
    success: 'btn-success',
    danger: 'btn-danger',
    outline: 'btn-outline',
  };

  return (
    <button
      disabled={disabled || isLoading}
      className={clsx(
        variantClasses[variant], // Aplica la classe base del globals.css
        "flex items-center justify-center gap-2", // Centrat extra
        (disabled || isLoading) && "opacity-70 cursor-not-allowed transform-none active:translate-y-0 active:border-b-4", // Estat desactivat
        className
      )}
      {...props}
    >
      {isLoading && <Loader2 className="w-5 h-5 animate-spin" />}
      {children}
    </button>
  );
}

// =================== FILE: src/presentation/components/ui/gamified/LanguagerSwitcher.tsx ===================

'use client';

import { useLocale } from 'next-intl';
import { usePathname, useRouter } from 'next/navigation';
import { Globe } from 'lucide-react';
import { useState } from 'react';
import { clsx } from 'clsx';

const languages = [
  { code: 'ca', label: 'Català', flag: '🐱' }, // Emoji provisional
  { code: 'en', label: 'English', flag: '🇬🇧' },
  { code: 'es', label: 'Español', flag: '🇪🇸' },
];

export function LanguageSwitcher() {
  const locale = useLocale();
  const pathname = usePathname();
  const router = useRouter();
  const [isOpen, setIsOpen] = useState(false);

  const changeLanguage = (newLocale: string) => {
    // Substituïm el locale actual pel nou a la URL
    // Ex: /ca/login -> /en/login
    const newPath = pathname.replace(`/${locale}`, `/${newLocale}`);
    router.push(newPath);
    setIsOpen(false);
  };

  return (
    <div className="relative">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-4 py-2 rounded-xl border-2 border-slate-700 bg-slate-800 hover:bg-slate-700 font-bold text-slate-400 transition-colors"
      >
        <Globe className="w-5 h-5" />
        <span className="uppercase">{locale}</span>
      </button>

      {/* Dropdown Gamificat */}
      {isOpen && (
        <div className="absolute top-14 right-0 bg-slate-800 border-2 border-slate-700 rounded-xl shadow-xl p-2 w-48 flex flex-col gap-2 z-50 animate-in fade-in zoom-in-95">
          {languages.map((lang) => (
            <button
              key={lang.code}
              onClick={() => changeLanguage(lang.code)}
              className={clsx(
                "flex items-center gap-3 p-3 rounded-lg font-bold transition-all border-b-4 active:border-b-0 active:translate-y-1",
                locale === lang.code 
                  ? "bg-blue-500/20 text-blue-400 border-blue-500/50" 
                  : "hover:bg-slate-700 text-slate-300 border-transparent hover:border-slate-600"
              )}
            >
              <span className="text-xl">{lang.flag}</span>
              {lang.label}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/presentation/context/GameSessionContext.tsx ===================

// filepath: src/presentation/context/GameSessionContext.tsx
'use client';

import { createContext, useContext } from 'react';

// Definim què és la informació de la sessió
interface GameSessionContextType {
  progress: number;
  currentIndex: number;
  totalChallenges: number;
  topicSlug: string;
}

const GameSessionContext = createContext<GameSessionContextType | null>(null);

export function useGameSessionContext() {
  const context = useContext(GameSessionContext);
  if (!context) {
    throw new Error('useGameSessionContext must be used within a GameSessionProvider');
  }
  return context;
}

export const GameSessionProvider = GameSessionContext.Provider;

// =================== FILE: src/presentation/hooks/game/useGameSession.ts ===================

// filepath: src/presentation/hooks/game/useGameSession.ts
import { useState, useEffect } from 'react';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { submitSessionAction } from '@/presentation/actions/gamification/submit-session.action';
import { SessionResultDTO } from '@/application/dto/session-result.dto';

type GameStatus = 'PLAYING' | 'SUBMITTING' | 'SUCCESS' | 'ERROR';

export function useGameSession(challenges: Challenge[]) {
  // Obtenim un ID únic per a la sessió actual (basat en el Topic)
  // Això evita que l'estat de "React" es barregi amb el de "SQL"
  const topicId = challenges[0]?.topicId || 'unknown_topic';
  const storageKey = `edutech_progress_${topicId}`;

  // 1. ESTAT INICIAL: Comencem a 0, però permetrem la "hidratació" posterior
  const [currentIndex, setCurrentIndex] = useState(0);
  const [status, setStatus] = useState<GameStatus>('PLAYING');
  const [result, setResult] = useState<SessionResultDTO | null>(null);
  const [error, setError] = useState<string | null>(null);
  const [isHydrated, setIsHydrated] = useState(false); // Per evitar salts visuals

  // 2. RECUPERACIÓ (Hydration): Quan el component es munta, mirem si hi ha progrés guardat
  useEffect(() => {
    const savedIndex = sessionStorage.getItem(storageKey);
    if (savedIndex) {
      const parsedIndex = parseInt(savedIndex, 10);
      // Validem que l'índex guardat tingui sentit (no sigui major que els reptes actuals)
      if (!isNaN(parsedIndex) && parsedIndex < challenges.length) {
        setCurrentIndex(parsedIndex);
      }
    }
    setIsHydrated(true);
  }, [storageKey, challenges.length]);

  // 3. PERSISTÈNCIA: Cada cop que canvia l'índex, el guardem
  useEffect(() => {
    if (isHydrated && status === 'PLAYING') {
      sessionStorage.setItem(storageKey, currentIndex.toString());
    }
  }, [currentIndex, storageKey, isHydrated, status]);

  const currentChallenge = challenges[currentIndex];
  const progress = challenges.length > 0 ? ((currentIndex) / challenges.length) * 100 : 0;

  const handleNext = () => {
    if (currentIndex < challenges.length - 1) {
      setCurrentIndex(prev => prev + 1);
    } else {
      setStatus('SUBMITTING');
    }
  };

  const handleRetry = () => {
    setError(null);
    setStatus('SUBMITTING');
  };

  // Logica de Submit (sense canvis grans, només neteja del storage)
  useEffect(() => {
    if (status === 'SUBMITTING') {
      let isMounted = true;

      const submit = async () => {
        try {
          const challengeIds = challenges.map(c => c.id);
          
          if (!topicId || topicId === 'unknown_topic') throw new Error("Topic ID not found");

          const response = await submitSessionAction(challengeIds, topicId);

          if (!isMounted) return;

          if (response.success) {
            setResult(response.data);
            setStatus('SUCCESS');
            // ✅ NETEJA: Si acabem amb èxit, esborrem el progrés guardat
            sessionStorage.removeItem(storageKey);
          } else {
            setError(response.error);
            setStatus('ERROR');
          }
        } catch (err) {
            if (isMounted) {
                console.error(err);
                setError('CONNECTION_ERROR'); 
                setStatus('ERROR');
            }
        }
      };

      submit();

      return () => { isMounted = false; };
    }
  }, [status, challenges, topicId, storageKey]);

  return {
    currentChallenge,
    currentIndex,
    totalChallenges: challenges.length,
    progress,
    status,
    result,
    error,
    handleNext,
    handleRetry,
    isHydrated // Opcional: per si vols mostrar un spinner mentre llegeix del disc
  };
}

// =================== FILE: src/presentation/utils/auth-guards.test.ts ===================

// filepath: src/presentation/utils/auth-guards.test.ts
import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { assertAdmin } from './auth-guards';
import { AuthenticationError, UnauthorizedError } from '@/core/errors/auth.error';

// Mocks
const mockGetUser = vi.fn();
vi.mock('@/infrastructure/utils/supabase/server', () => ({
  createClient: vi.fn(() => Promise.resolve({
    auth: {
      getUser: mockGetUser
    }
  }))
}));

describe('AuthGuards: assertAdmin', () => {
  const ORIGINAL_ENV = process.env;

  beforeEach(() => {
    vi.resetModules();
    process.env = { ...ORIGINAL_ENV, ADMIN_EMAILS: 'admin@test.com,boss@test.com' };
  });

  afterEach(() => {
    process.env = ORIGINAL_ENV;
  });

  it('hauria de llançar AuthenticationError si no hi ha usuari loguejat', async () => {
    // Arrange
    mockGetUser.mockResolvedValue({ data: { user: null }, error: null });

    // Act & Assert
    await expect(assertAdmin()).rejects.toThrow(AuthenticationError);
  });

  it('hauria de llançar UnauthorizedError si el mail no està a la llista', async () => {
    // Arrange
    mockGetUser.mockResolvedValue({ 
      data: { user: { email: 'hacker@bad.com' } }, 
      error: null 
    });

    // Act & Assert
    await expect(assertAdmin()).rejects.toThrow(UnauthorizedError);
  });

  it('hauria de retornar l usuari si és un admin vàlid', async () => {
    // Arrange
    const adminUser = { email: 'admin@test.com', id: '123' };
    mockGetUser.mockResolvedValue({ 
      data: { user: adminUser }, 
      error: null 
    });

    // Act
    const result = await assertAdmin();

    // Assert
    expect(result).toEqual(adminUser);
  });
});

// =================== FILE: src/presentation/utils/auth-guards.ts ===================

// filepath: src/presentation/utils/auth-guards.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { AuthenticationError, UnauthorizedError } from '@/core/errors/auth.error';

/**
 * Verifica si l'usuari actual té permisos d'administrador.
 * Utilitza les variables d'entorn per validar la llista d'emails permesos.
 * * @throws {AuthenticationError} Si no hi ha sessió activa.
 * @throws {UnauthorizedError} Si l'usuari no és admin.
 * @returns L'objecte usuari de Supabase si és vàlid.
 */
export async function assertAdmin() {
  const supabase = await createClient();
  
  const { data: { user }, error } = await supabase.auth.getUser();

  if (error || !user) {
    throw new AuthenticationError('Cal iniciar sessió per accedir a aquesta funció.');
  }

  const adminEmails = (process.env.ADMIN_EMAILS || '').split(',');
  const userEmail = user.email || '';
  
  if (!userEmail || !adminEmails.includes(userEmail)) {
    throw new UnauthorizedError(`L'usuari ${userEmail} no té permisos d'administrador.`);
  }

  return user;
}

// =================== FILE: src/presentation/utils/icon-mapper.tsx ===================

// filepath: src/presentation/utils/icon-mapper.tsx
import { 
  Code2, 
  Database, 
  Server, 
  Globe, 
  Cpu, 
  Terminal,
  ShieldCheck,
  Atom,
  Container,
  Layers,
  LucideIcon 
} from 'lucide-react';

// Mapa de claus (string BD) -> Components (Lucide)
const ICON_MAP: Record<string, LucideIcon> = {
  'code': Code2,
  'database': Database,
  'server': Server,
  'web': Globe,
  'algo': Cpu,
  'terminal': Terminal,
  
  // Nous temes
  'brand-react': Atom,
  'security': ShieldCheck,
  'docker': Container,
  'fullstack': Layers,
  
  // Fallback
  'default': Code2 
};

/**
 * Retorna directament el JSX de la icona.
 * Així al component només has de fer: {getTopicIcon(nom, classes)}
 */
export const getTopicIcon = (iconName: string, className?: string) => {
  const IconComponent = ICON_MAP[iconName] || ICON_MAP['default'];
  return <IconComponent className={className} />;
};

// =================== FILE: src/proxy.ts ===================

// filepath: src/proxy.ts
import { NextRequest, NextResponse } from 'next/server';
import createIntlMiddleware from 'next-intl/middleware';
import { routing } from './routing';
import { createMiddlewareClient } from '@/infrastructure/utils/supabase/middleware';

export default async function proxy(request: NextRequest) {
  // 1. Inicialitzem client de Supabase (Infraestructura)
  // Això gestiona automàticament el refresc de tokens
  const { supabase, response } = await createMiddlewareClient(request);

  // 2. SEGURETAT: Protecció de rutes Admin (/sys-ops)
  // Només comprovem usuari si realment cal, per rendiment
  if (request.nextUrl.pathname.includes('/sys-ops')) {
    const { data: { user } } = await supabase.auth.getUser();
    
    // Obtenim llista d'admins de les ENV
    const adminEmails = (process.env.ADMIN_EMAILS || '').split(',');
    
    // Validació
    if (!user || !user.email || !adminEmails.includes(user.email)) {
      // Redirigim a l'arrel si no és admin (Security by Obscurity)
      return NextResponse.redirect(new URL('/', request.url));
    }
  }

  // 3. i18n: Si passem la seguretat, deleguem a next-intl
  // IMPORTANT: next-intl necessita retornar la seva pròpia resposta
  const handleI18n = createIntlMiddleware(routing);
  const intlResponse = handleI18n(request);

  // 4. Fusionem les cookies de Supabase (sessió) amb la resposta de l'idioma
  // Si Supabase ha refrescat el token, hem de passar aquesta cookie a la resposta final
  const supabaseCookies = response.cookies.getAll();
  supabaseCookies.forEach(cookie => {
    intlResponse.cookies.set(cookie.name, cookie.value, cookie);
  });

  return intlResponse;
}

export const config = {
  matcher: ['/((?!api|_next|_vercel|.*\\..*).*)']
};

// =================== FILE: src/routing.ts ===================

// filepath: src/routing.ts
import { defineRouting } from 'next-intl/routing';

// NOVA IMPLEMENTACIÓ v4
export const routing = defineRouting({
  // Una llista de tots els locales suportats
  locales: ['ca', 'es', 'en'],
  
  // Si no es troba cap locale, es fa servir aquest
  defaultLocale: 'ca',

  // Opcional: Prefixar sempre el locale o no (as-needed és net per al default)
  localePrefix: 'always' 
});

// Exportem tipus per a usar-los al codi
export type Locale = (typeof routing.locales)[number];

// =================== FILE: src/test/setup.ts ===================

// filepath: src/test/setup.ts
import dotenv from 'dotenv';
import path from 'path';

// Carreguem explícitament el fitxer .env.test
dotenv.config({ path: path.resolve(process.cwd(), '.env.test') });

// Opcional: Si no troba el .env.test, prova amb .env.local per desenvolupament local
if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
    dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });
}

console.log('🧪 Test Environment Loaded. Supabase URL:', process.env.NEXT_PUBLIC_SUPABASE_URL ? '✅ Found' : '❌ Missing');

// =================== FILE: supabase/snippets/Untitled query 908.sql ===================

-- 1. TAULA TOPICS
CREATE TABLE IF NOT EXISTS public.topics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slug TEXT UNIQUE NOT NULL,
    name_key TEXT NOT NULL,
    icon_name TEXT NOT NULL,
    color_theme TEXT NOT NULL,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. TAULA CHALLENGES
CREATE TABLE IF NOT EXISTS public.challenges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    topic_id UUID REFERENCES public.topics(id) ON DELETE CASCADE,
    difficulty_tier INT DEFAULT 1,
    type TEXT NOT NULL,
    content JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. TAULA PROFILES (La crea Supabase Auth normalment, però la simulem per local)
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT,
    total_xp INT DEFAULT 0,
    level INT DEFAULT 1,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. TAULA USER_PROGRESS
CREATE TABLE IF NOT EXISTS public.user_progress (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    challenge_id UUID REFERENCES public.challenges(id) ON DELETE CASCADE,
    topic_id UUID REFERENCES public.topics(id),
    xp_earned INT DEFAULT 10,
    completed_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, challenge_id)
);

-- Activem RLS (Bones pràctiques, encara que el test usi Service Key)
ALTER TABLE public.topics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_progress ENABLE ROW LEVEL SECURITY;

-- Permisos bàsics de lectura pública
CREATE POLICY "Public topics" ON public.topics FOR SELECT USING (true);
CREATE POLICY "Public challenges" ON public.challenges FOR SELECT USING (true);

// =================== FILE: tsconfig.json ===================

{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
   "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}


// =================== FILE: vitest.config.ts ===================

// filepath: vitest.config.ts
import { defineConfig } from 'vitest/config';
import tsconfigPaths from 'vite-tsconfig-paths';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [
    tsconfigPaths(), // <--- AQUESTA és la clau màgica que soluciona el teu error
    react(),
  ],
  test: {
    environment: 'jsdom', // Necessari per testejar components de React més endavant
    globals: true,
    setupFiles: ['./src/test/setup.ts'],
    include: ['src/**/*.test.ts', 'src/**/*.test.tsx'],
  },
});