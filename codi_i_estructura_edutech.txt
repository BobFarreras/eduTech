ESTRUCTURA DEL PROJECTE (./src)

├── .env.local
├── .env.test
├── .git
│   ├── COMMITMESSAGE
│   ├── COMMIT_EDITMSG
│   ├── config
│   ├── description
│   ├── FETCH_HEAD
│   ├── fork-settings
│   ├── HEAD
│   ├── hooks
│   │   ├── applypatch-msg.sample
│   │   ├── commit-msg.sample
│   │   ├── fsmonitor-watchman.sample
│   │   ├── post-update.sample
│   │   ├── pre-applypatch.sample
│   │   ├── pre-commit.sample
│   │   ├── pre-merge-commit.sample
│   │   ├── pre-push.sample
│   │   ├── pre-rebase.sample
│   │   ├── pre-receive.sample
│   │   ├── prepare-commit-msg.sample
│   │   ├── push-to-checkout.sample
│   │   ├── sendemail-validate.sample
│   │   └── update.sample
│   ├── index
│   ├── info
│   │   └── exclude
│   ├── logs
│   │   ├── HEAD
│   │   └── refs
│   │       ├── heads
│   │       │   ├── develop
│   │       │   ├── feature
│   │       │   │   ├── disseny
│   │       │   │   ├── guia-landing-dashbaord-temas
│   │       │   │   └── intro
│   │       │   ├── main
│   │       │   └── release
│   │       └── remotes
│   │           └── origin
│   │               ├── develop
│   │               ├── feature
│   │               │   ├── disseny
│   │               │   ├── guia-landing-dashbaord-temas
│   │               │   └── intro
│   │               ├── HEAD
│   │               └── main
│   ├── objects
│   │   ├── 00
│   │   │   └── 4145cddf3f9db91b57b9cb596683c8eb420862
│   │   ├── 01
│   │   │   ├── 0eef23e3ed3e7876206ffad64bf4494c6ef227
│   │   │   └── 5d48bb6db79a89418e9f358fe66de69fd65d80
│   │   ├── 02
│   │   │   ├── 7b19c3168ca82e0a98846f809ef8081b8faf12
│   │   │   ├── d74d7a73523ae654ee7996075a9c19d3272621
│   │   │   └── d79e55310cd450d29bb498d87752859a8b9df0
│   │   ├── 04
│   │   │   ├── 0b8f194987501ed51710f784f9755cc5e7cb75
│   │   │   ├── 636a1498fd827392f5f0865a26ba2dabe92c2d
│   │   │   ├── b967fbfcdfb1eea0c0a650e157cb6a0bbf5eef
│   │   │   └── bba9ece5910fc4423e33dcc66c97304d30dfb8
│   │   ├── 05
│   │   │   ├── 6fb6fc9c03efba3460d94879c1706390cde238
│   │   │   ├── 70397c440de7a8f3235d04daff14aa20d375ef
│   │   │   ├── adaf33d6627beab311fb925cd7c5f7e1276f6e
│   │   │   └── e726d1b4201bc8c7716d2b058279676582e8c0
│   │   ├── 06
│   │   │   └── de34e06752cc4541ecf84592fdb51dbe5eb2cd
│   │   ├── 07
│   │   │   ├── b44284fc13dc40728613f85e40e6e77710f094
│   │   │   └── f479fe404dfe2d68e7173384701197c0b176a6
│   │   ├── 08
│   │   │   ├── 18b631e0b42052ced52fdff1485d28d61cc57c
│   │   │   ├── 4574ea613c0a038c8b873df74da6d8017f9781
│   │   │   ├── ccaed9a63a41f56e6093a60168c20d00361d5c
│   │   │   └── f86f50b63dfd3dbe7d9c6c2541c177f010ef88
│   │   ├── 0a
│   │   │   ├── b593262f0c4e6c7413096389842c7bd5cb2ddf
│   │   │   └── bccc9ba9da2cb89682c1e9300c9784dc9c6e8c
│   │   ├── 0b
│   │   │   ├── 13009f75033f238a46de000826d890d0479b16
│   │   │   └── d69f6e23d4ad3740241f397554e8bac8744487
│   │   ├── 0c
│   │   │   └── 1f99ab34c339c2ea2d1a435a356118b4ff274b
│   │   ├── 0d
│   │   │   ├── 61fc3145757dff109ec9f6e6881e8274b6fbcd
│   │   │   ├── b39bab6cdcaac3727db5c9917123f8b34797b9
│   │   │   └── ca57ff408f6ff3f3f9dd3e8438514a1d9175ad
│   │   ├── 0e
│   │   │   └── 4d12127f3e7b2e2d8f83ce171ab9b5a8472dc0
│   │   ├── 0f
│   │   │   └── 94900c5ede38da9333b59d70605cb22ac2c56b
│   │   ├── 10
│   │   │   ├── 574cf7398601760c6979b2d86e6ab3e6bae418
│   │   │   ├── 61a3ae36856f48e9098c4043ab0525f502a3b2
│   │   │   ├── 9299c2486a080e055f57352eddca7902041411
│   │   │   ├── b25b6ae1faa4aaad56c6671d0551f27d3a95ad
│   │   │   └── ce8354c2e9a574f67e7ced1f1236a5d83c5c00
│   │   ├── 11
│   │   │   ├── 1a4703e992d2e086f64b5b44e7699e1a66ee37
│   │   │   └── 3ff51874a0c194cabf16238facf1606639b430
│   │   ├── 13
│   │   │   ├── 37c09f5b5c6afbc222872e76b15f45ce8afde4
│   │   │   └── fd6ef1df7a3a04a7b9ac2109d583a577a01c41
│   │   ├── 14
│   │   │   ├── 0a2428b176921e71677d0ae9fe72c2471e62f0
│   │   │   ├── 239e33c642ebae81dfead9793f6d448c4c3d53
│   │   │   └── e6698b9cd6ef72606c4c8e46e26459b14c0c28
│   │   ├── 15
│   │   │   └── 8eedabf3ed298aa3f60d560cfee6a9f676b60c
│   │   ├── 16
│   │   │   ├── 0d71f1d1997fdcb81238ed50462a2a9585220f
│   │   │   ├── 1a5baa5cc7fa8cebd87f46159a43da7988b632
│   │   │   ├── c346783d7e4de061a989a4660454ec563981a8
│   │   │   ├── c8cd51d4ee5f89b5282289da25958bcd7aa87a
│   │   │   ├── fb5feeaaef791cdae952849d2745fefb17c61c
│   │   │   └── fe115375f775a90f6949733f3b23725f7b9ea3
│   │   ├── 17
│   │   │   ├── 2534024ac234a6148c27a743c13dec7391e16e
│   │   │   ├── 601a4ea100588cad36097e4b22f9eb72a7b1ea
│   │   │   ├── 975f58393f8de813a56bdd14fa617c738918b2
│   │   │   └── b05bf1e17c6d2338f255fdc91766a0d266a9d7
│   │   ├── 18
│   │   │   └── 5963839c4e68d3272c6a99638efae21fa7c372
│   │   ├── 19
│   │   │   ├── a064bcb06e714c0b9d82e9c88af2e379ffd506
│   │   │   ├── c3c9199df07fd38b5f14bb1a613ac88710994c
│   │   │   └── f1cd7c5a82bd4185760e4cb037bf65550ef2fb
│   │   ├── 1a
│   │   │   └── 3c93f2f4c694a3f10671740e274f56b85bd528
│   │   ├── 1b
│   │   │   ├── 155791014fdca5fc6f8afb7703330f74d8d155
│   │   │   ├── 38c4140d843dd5048c7fc01778190a278d5f4f
│   │   │   └── bdefa03f86d5362e42a17484cb981f35cf9657
│   │   ├── 1c
│   │   │   └── e2de9553d3e043e5f664ea0aaf3f03f28388aa
│   │   ├── 1d
│   │   │   ├── 06b087f2924c307c6bb65f7f1f50312aaacdc0
│   │   │   └── 0a646399d463b41f6fb0d7c4b61fc91a88fbb6
│   │   ├── 1e
│   │   │   └── 9299edcaaf0d95b04beba9a1fd734ad9efd61c
│   │   ├── 1f
│   │   │   ├── 1b0d2c58bca49764a3308a108951e0452c5638
│   │   │   ├── 3539f92e16c8e8cde5988867545957539361c8
│   │   │   └── 7d4da3487c41b868ffa71a1ffbbe9c2653ea2b
│   │   ├── 20
│   │   │   └── 04c8a4c68447324ad5c34657703fce95ffd976
│   │   ├── 21
│   │   │   ├── 15cf378d7577f78415d621838b573f98aaa2e8
│   │   │   ├── 197cb054499c1ed27d30ceda94fe55c6b98bb5
│   │   │   ├── 4acebfb2e59637b8974f757bd321cb72d1e7df
│   │   │   ├── db4ac5e7d725253baf1fc15431047772c6acca
│   │   │   ├── de2a25ecb0133617c8662b35c9665af8671e59
│   │   │   └── ead2c8bae08f5d4ca086cf368710e69c45327c
│   │   ├── 22
│   │   │   ├── 3a5c1d5702bf142f9bb8557b4bb0c831ffca78
│   │   │   ├── 4d0bf38eca17c182142d9a2de8b87a3de1fabd
│   │   │   ├── a1b5e85f87475df58de8540389891aae8038c7
│   │   │   └── c16c118afe1205caa5fc80806e2dc3596997f1
│   │   ├── 23
│   │   │   └── d1978e03013d339a619f03e4de7595bbdd4b41
│   │   ├── 24
│   │   │   ├── aff6fb486ebedb9637e2053d08186a5c9e61cc
│   │   │   └── ef84f46b9096d61c8da2fa14d388eaac2c7ca7
│   │   ├── 25
│   │   │   ├── 620be82adf68408563df8406776739ece50cba
│   │   │   ├── 85c78eed6c3f92a45db47a2d93d26de3b103d5
│   │   │   └── 9cb818bbe158d8652b209a09ba3793c7d85164
│   │   ├── 26
│   │   │   └── c1ad9bb3f31571028cc2e70efd84b4bc521f94
│   │   ├── 28
│   │   │   ├── 3755f6a4baa82f78345123acb23ceea1e38b8c
│   │   │   ├── d949ca0826d217ff324d737ff58ed654d667c9
│   │   │   └── df353e961d46630a57d7a8ea7b6a6f54f7bd88
│   │   ├── 29
│   │   │   ├── 5f8fdf14fcfe6cccaa832133037157521b1890
│   │   │   ├── b31ab112cf6500423b77898317dd139f59d5b3
│   │   │   ├── bf102ba89b603bf873441d557f7580fbd941a6
│   │   │   └── ed011bba0f49f19aa1b2f970c6849754cf69eb
│   │   ├── 2b
│   │   │   └── b180444840fd8115b4d7ad05ab2d3bb3e00410
│   │   ├── 2c
│   │   │   ├── 33dae76f776268f9eacf7f9bed0eb7afb79897
│   │   │   ├── 83f74a34a2404b39d41483302cd218e6e2b616
│   │   │   ├── a3e961a71678c49e89eb2bb8e1c17c4f367b6c
│   │   │   └── d7983b1c3542b0765ea7bc182d7b1b8d1a8f37
│   │   ├── 2d
│   │   │   ├── 72dafbb02d7daf4a151c7c14ee763b190fe60e
│   │   │   └── dee3360ca237036b8054556c22b6dc23deb12a
│   │   ├── 2e
│   │   │   ├── 6429aac6ef84dc65772c227d8c60696849400d
│   │   │   └── 7b63413ccb1ebe40ea1aaa9bc1013f9b708539
│   │   ├── 2f
│   │   │   └── 73963b3be265fcb46de5a7017ba78fe3f692e6
│   │   ├── 30
│   │   │   ├── 51705602d93af08603a350d45fa8b694f172cc
│   │   │   └── 64b81e80cf949ad98ace47b0bfdbe51815e34f
│   │   ├── 32
│   │   │   ├── 21f6486fbdce0f9df334b4ebdb1712378fdb2e
│   │   │   └── e55937e08a9e9c6b6668139b800cf00972598c
│   │   ├── 34
│   │   │   └── aaad1b55589ee16a460cf745f150e9e3c35238
│   │   ├── 35
│   │   │   ├── 00afdf9f09b933f0bc6954f576be9400fc45cb
│   │   │   └── 2de3757a0aed623e714d2a7ec71eb0c448611b
│   │   ├── 36
│   │   │   ├── f345740d5cfe4a662e5976e288e062251ef0cd
│   │   │   └── f825b06fb9856f2c19966c029ce49480ebfdf6
│   │   ├── 38
│   │   │   ├── 0b95186261f56228d4a2ea3f5b775db056ff5a
│   │   │   ├── 23a190c5162de1543bc055cab8d53d1b72598c
│   │   │   ├── a2213af2cab025173a2048df9c7892620aac04
│   │   │   └── de622fe5f0e9413ab31c470caad81e7d04d628
│   │   ├── 39
│   │   │   ├── 708f3768a2b40b86e797628b752f3542d31937
│   │   │   ├── a1c3512eb5abd37c557977793454be2fb41c1b
│   │   │   └── e5f580699f1001b08630a482be204adbc426c2
│   │   ├── 3a
│   │   │   ├── 13f90a773b0facb675bf5b1a8239c8f33d36f5
│   │   │   └── dffb2c75f2c2597bc747d64c55028929c1aec5
│   │   ├── 3b
│   │   │   └── c1f9cfb261928772ee7db9178d84fb1d6e9861
│   │   ├── 3c
│   │   │   └── 9f5a80fbeb07ba3bb268df78f05350c9efc6eb
│   │   ├── 3d
│   │   │   ├── a9b0adf0c8e4db443baab46b410d177435bdf9
│   │   │   └── d622fd0e7db324caed1164ed126363b5c25bad
│   │   ├── 3e
│   │   │   ├── b652e6cc3294e4256523cf995dd0863bf140d4
│   │   │   └── d78237e0d567e13e959b5627ae2190febb68d1
│   │   ├── 3f
│   │   │   ├── 0abce9320b2946a2a419106589095411878c18
│   │   │   ├── 3f1d8815f85f94d581d30a5368f92610823d7f
│   │   │   └── 795c4719a381185e1d5dde19cc57446a7b92cf
│   │   ├── 42
│   │   │   └── 2e226632f46ebf95f8156fdad2429e5c17369d
│   │   ├── 43
│   │   │   ├── 15996943841cc3786a79ea7e75da20c3b4c0f5
│   │   │   └── f752b362a7171fc3082ee213b39a89a77d233e
│   │   ├── 44
│   │   │   ├── 33a9e2dcf80b5d027852fec66aedc0a4081419
│   │   │   ├── d98862904591fdee0ba3849a7e5a18b015c9de
│   │   │   └── efeedd11a6f664930c8d3ad5ec6147429b0bd0
│   │   ├── 45
│   │   │   ├── 62a4446e0cfd91a48927f5993f33e4b5a91a2a
│   │   │   ├── 8a9f9510c2ba91675cff01bbd31a2540a075d0
│   │   │   └── bdc3e92234b3bec56cdbec2c22b3c2ebc553f7
│   │   ├── 47
│   │   │   ├── 0a9f15697716a9333c28aedaa9a27cbf0dd0f9
│   │   │   └── 5efcb7080478264baf7f470f7010561cc9b82f
│   │   ├── 48
│   │   │   └── 51e0ce64b2e9cc2a84534b3a5769121d0d61a2
│   │   ├── 49
│   │   │   ├── 99f57fcccca993a99a91590d3e67f574958691
│   │   │   └── fe033835b7a050b0b13908617f24f3e77ac50e
│   │   ├── 4a
│   │   │   └── 82067c6393bf10773e3f2bc5c01cb1f5d172a0
│   │   ├── 4b
│   │   │   └── 40cf3b66c4cd1859a7b09996e8f553ac9081b2
│   │   ├── 4c
│   │   │   ├── 274d9941dd1aa01b02d879024f35f8432eaceb
│   │   │   ├── 59dfb5d468d4900302b3c54d77f79f49cf2ae7
│   │   │   ├── 8169b5975cf154cc5108b4bdfc7f2bb4941783
│   │   │   └── e183a8041940a2e3af71282c402ab4946057af
│   │   ├── 4d
│   │   │   ├── 3e60c0ab8df919b259e85ef5dbfeca805f5024
│   │   │   ├── 72bcc0916491a2d79d8991576ef4cd047e5256
│   │   │   ├── 7f5f66f495830e43b101040ee4119ee778b13d
│   │   │   └── 8ac67ae9af5fac962ad54466be430d83722720
│   │   ├── 4e
│   │   │   ├── 1ca65f38f890868fc09edbb416fd56691c4a98
│   │   │   ├── 22e75671a3be243b539e48efe05d0cf186207a
│   │   │   ├── 8128c13ee1f30c70773245b478c73d97068834
│   │   │   └── d0c80be3ce06a7227dd64672065059ee82a46c
│   │   ├── 4f
│   │   │   └── e3df39c2b9cfc5412e3f44c96fc52b3a766662
│   │   ├── 50
│   │   │   ├── 1681935a10848a742f4734a29e1eb54c3741e0
│   │   │   ├── cc68a673e7a9d6f75e99661c48a425468aa481
│   │   │   └── f654f106d61febdd8e3f458595c3d906ad6ee8
│   │   ├── 51
│   │   │   ├── 131b825c832aa9eab3694152db63bf82f95cf9
│   │   │   ├── 4fa32bdfba678418e8257935069d9b99176e61
│   │   │   └── 74b28c565c285e3e312ec5178be64fbeca8398
│   │   ├── 52
│   │   │   └── 7b05f291fdd7cf1213ff5b485f837b62a7bed4
│   │   ├── 53
│   │   │   ├── 358a5c2b94e262aa6dc86e9fb0f72bea850184
│   │   │   └── bb8bade75b6c3696aeb1a1d3d6062ec22a0fe8
│   │   ├── 54
│   │   │   ├── 1fb8ff03f7a96c8aae773953290e5cb3efb8b4
│   │   │   ├── aa0b7fd7796f2fa4ed685a86c1d2646b9874c2
│   │   │   └── f703ad0731034831e268a2baf07dcb35630d6a
│   │   ├── 56
│   │   │   └── 7f17b0d7c7fb662c16d4357dd74830caf2dccb
│   │   ├── 57
│   │   │   └── ad22ccf8283e658b9faca9e1120b93c8527b28
│   │   ├── 58
│   │   │   └── bd66e222ef2690c5141a8d9bb965182ffd755b
│   │   ├── 59
│   │   │   └── 762441534360e2f0dacbde4373688c086dcef4
│   │   ├── 5a
│   │   │   ├── 1d75d065e5e15ebb4b715d89c33745b2b4fe7b
│   │   │   ├── ca76ef45874e010a847d03b9f53482c7d00bd1
│   │   │   └── fabbcc49de92848f355737f448a51be4b77c2c
│   │   ├── 5b
│   │   │   ├── 023437294451c67a894df4133787a3639775ba
│   │   │   ├── 41b477e2fee7389befd3a7ccaa065113cca188
│   │   │   └── b532756e4e8d66bcc7e3aff713e40f93643587
│   │   ├── 5c
│   │   │   └── be8363c0fa0773c1053d24163941d972091f5e
│   │   ├── 5d
│   │   │   ├── 4bf334306b76a2d560210c0ae495be7490dcf6
│   │   │   ├── edd03103f0b96f6fb1804b8fb6585759194c85
│   │   │   └── ee72c7a991a38e93be8f14616e15669cc7d2fb
│   │   ├── 5e
│   │   │   └── f6a520780202a1d6addd833d800ccb1ecac0bb
│   │   ├── 5f
│   │   │   └── 9338e1e57273fcc15065c07ba742e7d85cd21a
│   │   ├── 60
│   │   │   └── 3529b3ff040734310385de5d6e10a43f7825f2
│   │   ├── 61
│   │   │   ├── 925ebd9473a5264094d2abfdc540521a9cfdbc
│   │   │   ├── bd35d411b806c2baf9ae4bc74c9d65af087d99
│   │   │   ├── c3c08e5a28ac3b8c43b6f788b0a847a98f2f90
│   │   │   ├── e36849cf7cfa9f1f71b4a3964a4953e3e243d3
│   │   │   └── e581b98275acc8ea1eb4aed49d69f8aedca80d
│   │   ├── 62
│   │   │   ├── 3773613fec6ecc992854196197cc67b0aa0e6a
│   │   │   ├── b072941ec1d1a263e8236ece19c0449509b708
│   │   │   ├── c03e7f0e8507413c49d79bb24bf3c25aec797f
│   │   │   ├── c687561adcaf4f2f55638a5af80236bf5c70ae
│   │   │   └── fdd33153bb1bb0f61c7820738cb6fc485057c0
│   │   ├── 63
│   │   │   ├── 7468941006f41bbe515470e69b60ce2756b50c
│   │   │   └── 84949d797e98c8cd010d700ee4533a8b8de6d4
│   │   ├── 64
│   │   │   └── 6dd9c4a73fadd9e06b216d123b1576e6c9f0fb
│   │   ├── 65
│   │   │   ├── b67c55f602d788bbfdc8051307a2083f346e7b
│   │   │   └── b8bace8f5a2fa3364240b1a24f62b8ec3d04b4
│   │   ├── 67
│   │   │   ├── 6a638283b2a9f9de87a0738ffcdc10f4ba38a1
│   │   │   ├── 7b580ec7e529bf6126a1ab076169c18f2601d5
│   │   │   └── f2df0015a3ac5252d4b8eef4cb3eae8b2edd82
│   │   ├── 68
│   │   │   └── 314a9ada144cb2905e8b7ec5dd2470caa0aa80
│   │   ├── 69
│   │   │   ├── 3d40c739d65e11ab90857b9d08c01003dab9d1
│   │   │   ├── 6c7fac44397c7e0524411e1f6e3c84ede5031c
│   │   │   ├── 8d402e602c49dedaa37ec5fff294bc00322464
│   │   │   ├── bb98fd900582a80fd8f30f4f6c768ba90b05f8
│   │   │   └── f0089abf6d24bf28b39ff390b28fe53148062c
│   │   ├── 6a
│   │   │   ├── 1f6637d1801c39ffdb284f4e4bdb0fa18a3828
│   │   │   └── c5bdf674999accb0a886a0073a9e8d56c39c31
│   │   ├── 6b
│   │   │   └── b148f7ce15bba64bd95c1efe14e275448cc4b0
│   │   ├── 6c
│   │   │   ├── 1ac599d84befb016681da8aae64dc6b36cc434
│   │   │   ├── 6a18573bce17a8c8fd81f8a261224b019e6b53
│   │   │   ├── 8a26247536aacbd255fdeef489ef96f940242a
│   │   │   ├── c650b181b8802678414eb38578a5f6fcb378c0
│   │   │   └── cdd16acbe992989fd60f86fce7572fbc2b8457
│   │   ├── 6d
│   │   │   ├── 8528a8aaa9232337743c16c47a47a14a8b90f0
│   │   │   └── ec08c3288ebb44f1c973ae8378e747bcbd831d
│   │   ├── 6e
│   │   │   ├── 4da63431f1a44845fc662abe74abc93fb31833
│   │   │   ├── 4db68bf040562147487696f7682f0fcaaf38fc
│   │   │   └── 8b054637d6464bb59541bbfe5e96595b0ac9b0
│   │   ├── 6f
│   │   │   ├── 00e7c197c9cccef3f77871243e772cfc178073
│   │   │   ├── 2fc59dafa59fa1ac95d15036e63068dbcf50d1
│   │   │   ├── 9460110fa10f09b7384eeed6530244494cb59b
│   │   │   └── d38a0376292147428995a2261054daf6b542c4
│   │   ├── 70
│   │   │   ├── 1f624c6222b52b2ef34a10cca7d1d768ffe69b
│   │   │   ├── 53ebdab5909131d942fe35697a7748b6d6f37a
│   │   │   ├── 6e59b6b961a3a6fc0cf8f2ea1a1de27b995c07
│   │   │   ├── 84550fcb65e233aaa8d7f1e8079ee4d0f90899
│   │   │   └── e776f2ae54982fd8091152aa8d941a95cf5cec
│   │   ├── 71
│   │   │   ├── 08a7455ac3521cfb2dc6f65dcf1099e219c2da
│   │   │   ├── 8d6fea4835ec2d246af9800eddb7ffb276240c
│   │   │   ├── b887a4d3957ba19e64e3a904eb7de62b1379c4
│   │   │   └── dacfcb3c1f7b6e3f9a285dd40e21208577c221
│   │   ├── 72
│   │   │   └── 91eaf9c03a77276ff7c6bc0fa0fd76c41193fb
│   │   ├── 73
│   │   │   └── df25bfa4202bdd9e126c1125fc19e18af8e49d
│   │   ├── 75
│   │   │   └── 0fbf3bd2034fc0339e00137bd1aa625ecc2550
│   │   ├── 76
│   │   │   ├── 5afd7191f0a5a263c1406e41fea92d89b68744
│   │   │   └── e9cf9a49313c468c7a25c39c22eb17260059ed
│   │   ├── 77
│   │   │   ├── 053960334e2e34dc584dea8019925c3b4ccca9
│   │   │   ├── 1054c7fbfbca8eb1ab50dd1d32f8f9a758b987
│   │   │   └── 2ac07b104f8b34b3e8fe047ee3253e57cfa903
│   │   ├── 78
│   │   │   ├── 0a4a055c11fd0d6ef77951122c7fa2d1304872
│   │   │   ├── 5f9f0d3fe77f55743d1f4af9331bed0029e0aa
│   │   │   └── 899f1de8f8620147083721474ce663692aa14f
│   │   ├── 79
│   │   │   └── b95ec71a8e1a170c43ae3eac3c573136ec945b
│   │   ├── 7a
│   │   │   └── e253db098336a83a72060b75d07c52999fa2d8
│   │   ├── 7c
│   │   │   └── 14e3c0bfe4f746e54336e64c1e0268d840c5ef
│   │   ├── 7e
│   │   │   ├── 3a3344852b951510c7b37480df7a230ba7d3fc
│   │   │   ├── 4d45340d501eaaa7d4e6e12a4632ba8fe49500
│   │   │   └── 68610739e1fcda271958847deb1450707a0abb
│   │   ├── 7f
│   │   │   ├── 98de0603b7b70a66afb32a51e75ee64fcfb6e1
│   │   │   └── a60dcec011d7fe07df55a3460f54144693c715
│   │   ├── 80
│   │   │   ├── 307e031220d9287df6c8210b145f1bc11b3c82
│   │   │   └── d9a039a54ad64e04b96a461c973f3810c9468c
│   │   ├── 82
│   │   │   ├── 0c7bfa7f19058c55dc962f54619019f6076d14
│   │   │   └── e150d81b28a737f8f05ae89267770c60c7faaa
│   │   ├── 83
│   │   │   └── 0208aa3b69ea36173970f13b56128a201da103
│   │   ├── 84
│   │   │   ├── 25971febcb78d372c790dd79ae92bf1dd17114
│   │   │   └── da5efb62c34058c822cf55e84b2e2e37e512db
│   │   ├── 85
│   │   │   ├── 9f85ac590a98c1ca6f0141acd0d6fdcd1ce8c6
│   │   │   └── cec038c8fbb945227c181948dcc8c407fdb437
│   │   ├── 87
│   │   │   ├── 24663871e69a5ddb00260615e14f2c77718cc2
│   │   │   ├── 56ae3a9e606a10486409e1ba7ecfc940eed223
│   │   │   ├── 70f254e209aca2304a1e8436a2bb082ceddbec
│   │   │   ├── acc152028ea38ea04370e75e4eb9e81f9658c5
│   │   │   └── b57fa1adc8c0c32cb00fa3f558742b473a0b38
│   │   ├── 88
│   │   │   ├── 1598005177bd1618b3cbea6488a5ecfc6fb9c1
│   │   │   ├── 9f96713fc47f964a3b756114e07d25f6067865
│   │   │   └── d050b1908057b53d38b42702ebc659e3d7f696
│   │   ├── 89
│   │   │   └── 711140ffdc55edf3535e46d666652f94483b9e
│   │   ├── 8a
│   │   │   ├── 233efe36b8788b93fb30068ba821d7b25d795b
│   │   │   ├── 595ce74ddc509cf445afcfdf56a19e46b9adb8
│   │   │   └── f9b4522d82e78bf661ea7599048bc17050f91f
│   │   ├── 8b
│   │   │   └── fc383be5f240cac9abea0bbf38eacba5ea1ad4
│   │   ├── 8c
│   │   │   └── 68db77089294cb4f34409f8507dd639ce8aea9
│   │   ├── 8d
│   │   │   ├── 2cb87f170efaeeb9ded51c61eb8bb358fdef56
│   │   │   └── 5adede09c5f7b2a15a10e67a188afd31950770
│   │   ├── 8e
│   │   │   └── 37883471f58907aa611d62688bb8f9657d7834
│   │   ├── 8f
│   │   │   ├── 1525d8d8d2d073770f0c8af0445641a029dd87
│   │   │   ├── 5db4f5df8d2f78ad6ed6ee52f4631bb8d06e11
│   │   │   ├── 80aaaff97a1bfe6b4d753625085944568a1363
│   │   │   ├── 8735950a6c03bf3ecb571c49c9c4a14b400bf1
│   │   │   └── c1aa288c105c33a9e6a17f51614b2ae559d9c5
│   │   ├── 91
│   │   │   └── b46072ce462dabcaa7cc1c7b02793345470e14
│   │   ├── 92
│   │   │   ├── 0d1851956905c031a7b99124fc864a2e0f9eb9
│   │   │   ├── d6a32bc12ed111c856f56aa08f445fcb2770b2
│   │   │   └── dc0cf707480e9bf4517198db9b0cb3e8a9d2fa
│   │   ├── 94
│   │   │   └── 51a8f3e3588f383bb93711e0772a33bbfcccb0
│   │   ├── 95
│   │   │   ├── cebe3192365cf2e8e9f27a0bd19af452f16c16
│   │   │   └── fcdab10ee521da7fea7417812b63e2566635e7
│   │   ├── 96
│   │   │   └── c961613ff1605d56cea4a36cd54bfc32a22162
│   │   ├── 97
│   │   │   └── 3df98d62fa9c685a6fab5633ab794cee53ece8
│   │   ├── 99
│   │   │   ├── 2428cd58c0cf84de0b8c8e5157c7f7f5675924
│   │   │   ├── 9fa6c15c75cfaea7c509843fc7500a4d223056
│   │   │   └── e515b28b4036300b38267649774650be6fdca1
│   │   ├── 9a
│   │   │   ├── 5c043f3fc4c089818ef4fb3406c77724a6fad2
│   │   │   └── e2ad84233ef97092ffd3fd8e0d0905fecd93b9
│   │   ├── 9b
│   │   │   ├── 26ad3414c99b7a31852a97b3026fc90cbd3379
│   │   │   └── 317fff1b90f99f948bdeff9ac806c35b1b8957
│   │   ├── 9c
│   │   │   ├── 76c60214d033f75d9d9460463d9ccf67acf9fd
│   │   │   └── f1a7fc2f312b8eb5a48675ad21041de50fc5e4
│   │   ├── 9e
│   │   │   ├── 26dfeeb6e641a33dae4961196235bdb965b21b
│   │   │   └── 91b6a697269bae99bec2bcdd93b4b625a64564
│   │   ├── 9f
│   │   │   ├── 654ccf8d7b5b47bea4dab691093ace0ac2b097
│   │   │   └── ff0be18a7cc4adbec703370de0699e0e2b8035
│   │   ├── a0
│   │   │   ├── 22f5afabf0a1817b50cb3bdf214b2ec24450c6
│   │   │   ├── 59e66c323f9a0602ea58c2213e0e5c887c2d03
│   │   │   └── a2d622b94c09d9fdb24ee3c4a543568b4516d8
│   │   ├── a1
│   │   │   ├── c9b38cd3933c6f42e652b63149a5e71d17caa1
│   │   │   └── f1371cbd80f4b87c71a4c5a8d1ca3098d11369
│   │   ├── a2
│   │   │   ├── 6a0f6774d196847097b42a7b1fb209198b5311
│   │   │   └── dc41ecee5ec435200fe7cba2bde4107f823774
│   │   ├── a3
│   │   │   ├── 6a22742ce6d02c8c2a92a3c18bf17df346349a
│   │   │   ├── 9663e34765a9491e1fd2702bb07c60fd2a7cf3
│   │   │   └── f9e2d2704038a10b168b1d6be7e004ae6292d1
│   │   ├── a5
│   │   │   ├── 0c52fecede06e6be8828ac13c32a6cae53b9c3
│   │   │   └── 6967e5f6925a30da01bf8a2fd2b4d3c90212d5
│   │   ├── a6
│   │   │   ├── 14c93bc6f69d345145c3c542654967bc6a09fd
│   │   │   └── 94b225a1f288245f4d53944934154f68a09e78
│   │   ├── a7
│   │   │   ├── 12b20cabf3b8694ca0320fd2387f17e8a809f4
│   │   │   └── 2ee82fcb0b296466094dd3d499c6c544503427
│   │   ├── a8
│   │   │   ├── 57ac6488fb587d098e0c5427e26a5ed240920c
│   │   │   ├── bb40b77df91e4d94b01f27dcafd381d064a943
│   │   │   └── c364ef11cf6287217c3893da5a6bc74110285c
│   │   ├── aa
│   │   │   └── ad6f9e6e9b2262b043340091540f96d909e849
│   │   ├── ab
│   │   │   ├── 35ea493266e71887e89fc54670a8a20762b598
│   │   │   ├── 84d5367e4576533bcace775fc9808d35659b5c
│   │   │   └── c42a2a9598506c4618371a37086904c7e5d9ec
│   │   ├── ac
│   │   │   ├── 3010aaf318556fb8dad42c2c536c1aed11802b
│   │   │   ├── 54d8f9dd20d06aa3cb50cd88c9610fef438493
│   │   │   ├── 5f774584a459947eba4ae6924c3cbffe795f3e
│   │   │   ├── 7948fbd8711b8ced7c3393a2731347361c0792
│   │   │   └── eb6b40bd52da1885bb93ce0376e2e801503e66
│   │   ├── ae
│   │   │   ├── 4af8a2d462370662d40d21e41e06b38ad5ec6b
│   │   │   └── 8b81d707cc0fbd69fff5bd7a300418bfefb790
│   │   ├── af
│   │   │   └── 2f8d71ce3b3d348a9bfd091931f3ecd6c75485
│   │   ├── b0
│   │   │   ├── 43215504c26a302f47378a169a7fd92d071809
│   │   │   └── 9512775e5ac76b11bb1893fc5dfeb8f2b18fa2
│   │   ├── b1
│   │   │   └── 79c0414b448240bb6b7edae5b985c3492e6e3f
│   │   ├── b2
│   │   │   └── b2a44f6ebc70c450043c05a002e7a93ba5d651
│   │   ├── b3
│   │   │   ├── 0affec3cccf8d2d576b2dfdc4f887e00575468
│   │   │   ├── 5ffef1ae46f9e25de64e79e7f5313304f4084b
│   │   │   └── f6b7d796cc810c477568ce1c3fae6c1fcd6fab
│   │   ├── b4
│   │   │   ├── 0d63d590fc272bc2e06ff11dbfc28c9a4eb4be
│   │   │   └── 31b46901bb358d1cbc1ddfa38eabc5d0ef8e0a
│   │   ├── b5
│   │   │   ├── 9b99bbba5d6199cb5661df6c1a8a553223e601
│   │   │   ├── c00bffbb624b9f5075c4ec811a3460d07bffb9
│   │   │   └── d42f2d6153c5cfaf9c5d9f79a07e391092f5ee
│   │   ├── b6
│   │   │   ├── 807fa1e0255e7564262a1eed638f835461ce98
│   │   │   ├── a00f96a9ad86187797fb06e59097bc5db83bbd
│   │   │   ├── b792c5f81cca3d5930f481ad4739d247de0f0f
│   │   │   └── bcac4347fcd4179b38917e4777a25671492bc7
│   │   ├── b7
│   │   │   └── c6aa4345283710fd0d2057224d0228604e4dd5
│   │   ├── b8
│   │   │   ├── 27122a52b9685eb556f43eb18f3ec03d9364c2
│   │   │   ├── 29e25000fb383298f9ecf9410d67b64e8b39e9
│   │   │   ├── 3c1a95cf725f54b89989cec9aaa72b5b13e9dd
│   │   │   ├── 60f2f1e5e356e8161ca7b31d23664903d03286
│   │   │   ├── a62350bdd39491de7f91cb17feff0476aec4ba
│   │   │   └── aedb04de049fdf8c4b46cd4c86ad21364a3c2e
│   │   ├── b9
│   │   │   ├── 72a336ac76e2b7561ff089f66be319826cf0f0
│   │   │   └── f6644009fb6d28a499b3fbb7587b83fb01fe6d
│   │   ├── ba
│   │   │   └── 512d945cb5e8ae6480ac980182580583cb1471
│   │   ├── bc
│   │   │   ├── b5055dd14f94daf8b4d54426e2a7ac54d8da72
│   │   │   └── d20d50622030b045c6fafbc9d498f48274054c
│   │   ├── bd
│   │   │   ├── 8e3ee190e25153dcece1cb7f7d9250a3965cb6
│   │   │   └── bf82f943c1b3b7403724818b02a1e132de6729
│   │   ├── be
│   │   │   └── 7664c777d57a57b2a11a6f43b121ded4445a71
│   │   ├── bf
│   │   │   ├── 53897f8dcd7f853a219b86f78e2dc880a4c9e1
│   │   │   ├── 561a008ee7a1de93a7e72a96367d218acabf1e
│   │   │   └── 5856c9e06d448c1cbdcf6b336943ddda564377
│   │   ├── c0
│   │   │   └── 7cbd1d5e15e7cc2e5aac44ece89f32d8101b17
│   │   ├── c1
│   │   │   └── 3ac22293ba01c82e7ea1f82e67208658f85465
│   │   ├── c2
│   │   │   ├── a0f573b87d904a96bd74a7bb03b788f2a36e6e
│   │   │   ├── e366092f989f71220d905088de450abe73816b
│   │   │   └── e599d835e5cae1bd4032bdfad977a1e8b77680
│   │   ├── c3
│   │   │   ├── 1b53f14e7ea500b787f04883762514e7109d8c
│   │   │   ├── 2f10c10bbbb5c3a7341c115e0304e165ecbbb2
│   │   │   ├── 5142462549129aa7e715f7ea4159b7ffc0d965
│   │   │   ├── 7c083502e03911e3a804136bfa2dccf3299fb8
│   │   │   ├── 916e1cbd113afac45c720518158ff68cb64745
│   │   │   └── cf3dc879480568aa6b18f55556a7d648c37b56
│   │   ├── c4
│   │   │   ├── 3df598287bddf40922123f319fac304d4006b1
│   │   │   ├── a6967055c1467d80d966d289614b9c5c10f1bb
│   │   │   ├── afcda3cbf287268a5c2532ce4d6b0c141d9397
│   │   │   ├── b79bbc54166e31cde5b0ff7d8a6449ca02fe80
│   │   │   └── cebbb656595b7e2689d0fdb6205549cfda6e6a
│   │   ├── c6
│   │   │   └── 8f3cfcd0d32fb84c9815afb35398dc50a45942
│   │   ├── c7
│   │   │   └── 90ee2159fa8d433c9a9a359329db1830806da8
│   │   ├── c8
│   │   │   ├── 3b8bde585180c668610ffd24c36ad0333cc79a
│   │   │   ├── 8f389de09f418da376598c42e8788d4fb6d172
│   │   │   └── eebc3b3e73d0d9de9c5d1290cd57c79b8c05a9
│   │   ├── c9
│   │   │   ├── b24106a6b73bbc5af45f9c3077aae19d149df5
│   │   │   └── e8e66d9392e9814068859712cfa9d9be7dd441
│   │   ├── ca
│   │   │   └── b8578683fd664da09c17300198ef8c1acc71de
│   │   ├── cb
│   │   │   ├── 00b65b8267f131bba4574665e34e53e1d1641b
│   │   │   └── b2ccd2ac03c24767efbad394851c45db6ae934
│   │   ├── cc
│   │   │   ├── 046bfdb61be3306115a20bc91f9a126dc22392
│   │   │   ├── 3675a32b2e303558947771ba7bd8f989900d38
│   │   │   └── 501c035e59e25e1992562017720a7e5eddac40
│   │   ├── cd
│   │   │   └── 43a3dfb9c40dda769b684e3aa5efbc34c97ee4
│   │   ├── ce
│   │   │   ├── 40cfe2f868af6b31274c51c03d228f5fc35606
│   │   │   ├── 891dfa9c5e080ab2571fcf2c82243db37b7267
│   │   │   └── e0907b7e7cbc66a82b00933185a67456bd6115
│   │   ├── cf
│   │   │   ├── 3aeeb9e008f9c0ea619a013d173f397edf538c
│   │   │   └── b15609831558e3cf174cdff065fc3849a24a07
│   │   ├── d0
│   │   │   ├── 529914c4247adceb9e0efe33b2f5323f976d33
│   │   │   ├── 8f0a5bf288cdc9c72cf1718d2f8ad1cdf25a57
│   │   │   ├── 9b5314a8a2ff3af492fcc235f42016ff6035f6
│   │   │   ├── b375b17ef9cdc2a31b46c8c15ec36b209bbaca
│   │   │   └── e06523feda206f9001f46cc14970dfe7bb9bc4
│   │   ├── d1
│   │   │   └── 319a820cb2e7fb21fc60dbe2b11fa19318c528
│   │   ├── d2
│   │   │   ├── 24263a40a8ebac73dfd6b44c656a0652a8193f
│   │   │   └── 461b41a3257d540e8f2d9751ed664c49a1e8d5
│   │   ├── d3
│   │   │   ├── 04b956391e6ee8255017a2973146b6e0591202
│   │   │   ├── a17686c2628f5a1cf46fef95a48cd00fe3ed66
│   │   │   └── ebd0a85b17f04b3c14c81a78e31593cfb976e9
│   │   ├── d4
│   │   │   ├── 185a631d6561a74de83f1d6471482979747692
│   │   │   ├── 3225b3d1d62a7ec86b2175a73781d663618755
│   │   │   ├── c4af3805715167f660a7c11bac58825634b5b2
│   │   │   ├── ce8e56fbff630654a395d7b7983bcc963bfa8b
│   │   │   ├── eb1c32f75c809ad2c12d55950f4dd4869ae825
│   │   │   └── f23458bb690a2b0a9f1c261227d22be92b861e
│   │   ├── d5
│   │   │   ├── 0081b62e4fac9753ed2d4432631703cfc06b79
│   │   │   ├── 561f5939a6d0ba07e1d78d633e61d28c65f7ce
│   │   │   ├── 5d4b0d5083cd80f48b9b38b313fdf0b94f2346
│   │   │   └── 98fa265bbb10b06e9e85415a28e0281b920b0f
│   │   ├── d6
│   │   │   └── 0fe3c09cbb3feb73af75e2df667d5667ec7567
│   │   ├── d7
│   │   │   ├── 9c068facd518e3ded00ce0c1e80c30039ed5ad
│   │   │   └── a7e233674fa7a1d33557b1661158e1d2a64186
│   │   ├── d8
│   │   │   ├── 62d8f80dcf116c148f59aeeaad9e55236cd5be
│   │   │   ├── d0be3730dc9be49a0568b506a6064d64d3fa3a
│   │   │   └── f7ddc7a7cf8faa797a9f0fd2b1e56f43089dce
│   │   ├── d9
│   │   │   ├── 2a30768993ed5daa7dafdf93f91f9cb0f1c581
│   │   │   ├── 351f4e6fd1a0f974151fe3c4169d86909d688b
│   │   │   ├── b3230ecef05fafe0f2bf27672bd3d5625fc81d
│   │   │   ├── c9b360490816fba04aad77d674b8e5454c971b
│   │   │   └── eecedba03e8cfdc49c57c52ee2468eef4aeb40
│   │   ├── da
│   │   │   ├── 249d63ea71614a20a96e85d05fdb920b2b6d7a
│   │   │   ├── 94a6a6bd9a995b9e723b272b60b0adcd9ce200
│   │   │   └── a4df17a92bd55571038d8d49de2da1c7adda7b
│   │   ├── db
│   │   │   ├── 3db2b73a57f7561c20647da3b25d79fed950fb
│   │   │   └── 4f79d03b16a5c6f7345591f07e008f04102c50
│   │   ├── dc
│   │   │   ├── 1b0e86c2a5918154f7b1207ff2ec526b859984
│   │   │   └── 7b1ecf579e4f4951a169da64d4b65501c2ae9a
│   │   ├── dd
│   │   │   └── d9e02aa63213dcc33f23fb37be1a82ad59d08c
│   │   ├── de
│   │   │   └── f9f13c60a07a0fcd269f9cb13e199ec06f99b9
│   │   ├── df
│   │   │   └── 6c5ef7a8137627017248132e57f1bb1292bde1
│   │   ├── e1
│   │   │   └── 6879c95980e66fd50737d88f4fef4f3524e84b
│   │   ├── e2
│   │   │   └── 15bc4ccf138bbc38ad58ad57e92135484b3c0f
│   │   ├── e5
│   │   │   ├── 44750e7fa925893d524e318fc8aa0075f8fa9f
│   │   │   └── ed42749de21f0c22f9a7f0360671f5171e7c20
│   │   ├── e6
│   │   │   └── 4cf6e3cbd001069367388c82ae42c9d68a53d4
│   │   ├── e9
│   │   │   ├── 6c4a1785a0b6a994b620c9601c9b38add83e8e
│   │   │   ├── a5271000d47bb187484a599af3b48c74ba8140
│   │   │   ├── ab86a4326eeaa67251dda7a2593fa279a035df
│   │   │   └── ffa3083ad279ecf95fd8eae59cb253e9a539c4
│   │   ├── ec
│   │   │   └── 0ae4d77a8368ba13843aee8f1bf0f6725fe0f9
│   │   ├── ed
│   │   │   ├── 49d17583eda5134e2339bedfa7455ff01553d5
│   │   │   └── abd1131859b6172c3de33f678cd1b5ec64dbd0
│   │   ├── ef
│   │   │   ├── 0f27144d47fdc9e6736d8afd15e2bf4bda034c
│   │   │   ├── 14a463734886adbca33cd414c4ce169fb83fc1
│   │   │   └── a906a3c9129a272b7e6c1a7399caa8dbea2209
│   │   ├── f0
│   │   │   ├── 3ee597143c968d01da4a75d93e94224519d8d1
│   │   │   └── 6c16c4683b441de360ec26358120b5326fc66c
│   │   ├── f1
│   │   │   └── 35d299140954410f6f3f25c254d8bf4326deb0
│   │   ├── f2
│   │   │   └── a487b6bf0cec284f8cec392e661a2d4002b597
│   │   ├── f3
│   │   │   └── bf5269c6d4f70f9ab7df745643cb9ac63d48dd
│   │   ├── f4
│   │   │   ├── a16719c17bb88c98551770e84136d313c28f7e
│   │   │   ├── b82dd18861ecba6910474949825b9ff42b51ab
│   │   │   ├── df37bb5eb1fe7f7a215e10d2487f5637af2bb8
│   │   │   └── f09ba5e9061bbd9b5d05c9aed97d7bb09efc1c
│   │   ├── f6
│   │   │   └── 5934a5165a8c768442be1381847abdf22052fa
│   │   ├── f7
│   │   │   ├── c3b49366c844d323c49b9096dee100847bd2e2
│   │   │   └── fa87eb875260ed98651bc419c8139b5119e554
│   │   ├── f8
│   │   │   ├── 6636571f6946c495ba79193c455861637cd8df
│   │   │   ├── a22820db6e9db08bc546bb0e4726ccb754c527
│   │   │   ├── d53d0c7898a7d445c3218699c5d9237c710d7d
│   │   │   └── de00e530ec82458f0f64d340784c289d5f746f
│   │   ├── f9
│   │   │   ├── 54283ad2ea1e8a28d148155be2367063174334
│   │   │   └── 70366eb8ab2ea9a7c4657e1cecea24ee8d2c00
│   │   ├── fa
│   │   │   └── dd9c3b4c78a571ca1c5738c0b5c476fb642776
│   │   ├── fb
│   │   │   ├── 60711b4a84d47476343658d4b12de639fb9073
│   │   │   └── 7ab5fea133e3476f86e675686ac26648ec6409
│   │   ├── fc
│   │   │   ├── 3d2ee52244729eb953c442e06ff640ed405a65
│   │   │   ├── 5da66087e6ddd135559b563892998a6eba3512
│   │   │   ├── 8638fef2619867c737c07e55a3da7bd6e36aa0
│   │   │   ├── da7617f4555c1826cf6e0c3ac1607dd9d9f077
│   │   │   └── e81371e627d3ba1254b6e18a77d3850cfa94f7
│   │   ├── fd
│   │   │   └── cbd1aff894f31ebfe9e29331719b5ead3c60bd
│   │   ├── fe
│   │   │   └── c93eccc9bfd9142908bf93fdd0d729f7da0c61
│   │   ├── ff
│   │   │   ├── 13f68b886af1c25d8a6bc793cf7e8ef1ac1591
│   │   │   ├── 90bf7d4d9b7fd23ad571c79ae8711c4aec75a8
│   │   │   ├── b0ceb24de959555afe74dd0fb439f96a20868f
│   │   │   ├── c9ed7d54ed174ea20ef50f149f1b3487041e3b
│   │   │   └── efe900c5243fcf63eb76e2b84a5aa3990dbc06
│   │   ├── info
│   │   └── pack
│   ├── ORIG_HEAD
│   └── refs
│       ├── heads
│       │   ├── develop
│       │   ├── feature
│       │   │   ├── disseny
│       │   │   ├── guia-landing-dashbaord-temas
│       │   │   └── intro
│       │   ├── main
│       │   └── release
│       ├── remotes
│       │   └── origin
│       │       ├── develop
│       │       ├── feature
│       │       │   ├── disseny
│       │       │   ├── guia-landing-dashbaord-temas
│       │       │   └── intro
│       │       ├── HEAD
│       │       └── main
│       └── tags
├── .github
│   └── workflows
├── .gitignore
├── .vscode
│   └── settings.json
├── AGENTS.md
├── codi_i_estructura_edutech.txt
├── content
│   └── legal
├── docs
│   └── TECH_SPECS.md
├── eslint.config.mjs
├── esquema.sql
├── init-structure.js
├── merge.js
├── messages
│   ├── ca.ts
│   ├── en.ts
│   └── es.ts
├── next-env.d.ts
├── next.config.ts
├── package.json
├── pnpm-workspace.yaml
├── postcss.config.mjs
├── PRD.md
├── README.md
├── src
│   ├── app
│   │   ├── globals.css
│   │   ├── layout.tsx
│   │   └── [locale]
│   │       ├── (admin)
│   │       │   └── admin
│   │       │       ├── topics
│   │       │       └── users
│   │       ├── (auth)
│   │       │   ├── layout.tsx
│   │       │   ├── login
│   │       │   │   ├── LoginForm.tsx
│   │       │   │   └── page.tsx
│   │       │   └── register
│   │       │       ├── page.tsx
│   │       │       └── RegisterForm.tsx
│   │       ├── (dashboard)
│   │       │   └── dashboard
│   │       │       └── page.tsx
│   │       ├── (game)
│   │       │   ├── arena
│   │       │   └── learn
│   │       │       └── [slug]
│   │       │           ├── page.tsx
│   │       │           └── play
│   │       │               └── page.tsx
│   │       ├── api
│   │       │   └── webhooks
│   │       ├── layout.tsx
│   │       └── page.tsx
│   ├── application
│   │   ├── dto
│   │   │   ├── dashboard-topic.dto.ts
│   │   │   ├── level-node.dto.ts
│   │   │   └── session-result.dto.ts
│   │   ├── README.md
│   │   └── use-cases
│   │       ├── auth
│   │       │   ├── logout.use-case.test.ts
│   │       │   ├── logout.use-case.ts
│   │       │   └── README.md
│   │       ├── challenges
│   │       │   ├── get-next-challenge.use-case.test.ts
│   │       │   ├── get-next-challenge.use-case.ts
│   │       │   └── README.md
│   │       ├── dashboard
│   │       │   └── get-user-dashboard.use-case.ts
│   │       ├── gamification
│   │       │   ├── complete-session.use-case.test.ts
│   │       │   ├── complete-session.use-case.ts
│   │       │   └── README.md
│   │       └── topics
│   │           ├── get-active-topics.use-case.test.ts
│   │           ├── get-active-topics.use-case.ts
│   │           ├── get-topic-path.use-case.ts
│   │           └── README.md
│   ├── core
│   │   ├── entities
│   │   │   ├── challenges
│   │   │   │   ├── challenge.entitiy.test.ts
│   │   │   │   ├── challenge.entity.ts
│   │   │   │   ├── definitions
│   │   │   │   │   ├── code-fix.content.ts
│   │   │   │   │   ├── logic-order.content.ts
│   │   │   │   │   ├── matching.content.ts
│   │   │   │   │   ├── quiz.content.ts
│   │   │   │   │   ├── shared.ts
│   │   │   │   │   └── terminal.content.ts
│   │   │   │   └── index.ts
│   │   │   └── topic.entity.ts
│   │   ├── errors
│   │   │   ├── domain-error.ts
│   │   │   ├── topic.errors.ts
│   │   │   └── user-not-found.error.ts
│   │   ├── README.md
│   │   ├── repositories
│   │   │   ├── challenge.repository.ts
│   │   │   ├── topic.repository.ts
│   │   │   └── user.repository.ts
│   │   ├── services
│   │   │   ├── auth.service.ts
│   │   │   └── level-calculator.service.ts
│   │   └── types
│   ├── i18n.ts
│   ├── infrastructure
│   │   ├── adapters
│   │   ├── config
│   │   ├── database
│   │   ├── mappers
│   │   │   ├── challenge.mappers.ts
│   │   │   ├── mapper.utils.ts
│   │   │   ├── README.md
│   │   │   └── __tests__
│   │   │       └── TerminalMapper.test.ts
│   │   ├── repositories
│   │   │   └── supabase
│   │   │       ├── challenge.repository.test.ts
│   │   │       ├── challenge.repository.ts
│   │   │       ├── topic.repository.ts
│   │   │       └── user.repository.ts
│   │   ├── service
│   │   │   └── supabase-auth.service.ts
│   │   └── utils
│   │       └── supabase
│   │           └── server.ts
│   ├── navigation.ts
│   ├── presentation
│   │   ├── actions
│   │   │   ├── auth
│   │   │   │   ├── auth.action.ts
│   │   │   │   └── logout.actions.ts
│   │   │   ├── challenges
│   │   │   │   └── get-next-challenge.action.ts
│   │   │   ├── gamification
│   │   │   │   └── submit-session.action.ts
│   │   │   └── topics
│   │   │       └── get-topics.action.ts
│   │   ├── components
│   │   │   ├── admin
│   │   │   ├── auth
│   │   │   │   └── LogoutButton.tsx
│   │   │   ├── features
│   │   │   │   ├── auth
│   │   │   │   ├── dashboard
│   │   │   │   │   └── TopicCard.tsx
│   │   │   │   ├── game-engine
│   │   │   │   │   ├── ChallengeRenderer.tsx
│   │   │   │   │   ├── challenges
│   │   │   │   │   ├── code-fix
│   │   │   │   │   │   ├── CodeWindow.tsx
│   │   │   │   │   │   ├── HintPanel.tsx
│   │   │   │   │   │   └── SolutionDeck.tsx
│   │   │   │   │   ├── CodeFixView.tsx
│   │   │   │   │   ├── GameArena.tsx
│   │   │   │   │   ├── GameError.tsx
│   │   │   │   │   ├── GameResult.tsx
│   │   │   │   │   ├── layout
│   │   │   │   │   │   └── GameSessionLayout.tsx
│   │   │   │   │   ├── LogicOrderView.tsx
│   │   │   │   │   ├── MatchingView.tsx
│   │   │   │   │   ├── QuizView.tsx
│   │   │   │   │   ├── README.md
│   │   │   │   │   └── TerminalView.tsx
│   │   │   │   ├── leaderboard
│   │   │   │   ├── learning-path
│   │   │   │   │   ├── HorizontalPath.tsx
│   │   │   │   │   ├── LearningPathOrchestrator.tsx
│   │   │   │   │   ├── LevelNode.tsx
│   │   │   │   │   └── VerticalPath.tsx
│   │   │   │   └── topics
│   │   │   │       └── TopicCard.tsx
│   │   │   ├── feedback
│   │   │   ├── layout
│   │   │   │   ├── DesktopNavbar.tsx
│   │   │   │   └── MobileBottomBar.tsx
│   │   │   └── ui
│   │   │       └── gamified
│   │   │           ├── Button3D.tsx
│   │   │           └── LanguagerSwitcher.tsx
│   │   ├── hooks
│   │   │   └── game
│   │   │       └── useGameSession.ts
│   │   └── utils
│   │       └── icon-mapper.tsx
│   ├── proxy.ts
│   ├── routing.ts
│   └── test
│       └── setup.ts
├── supabase
│   ├── .branches
│   │   └── _current_branch
│   ├── .temp
│   │   ├── cli-latest
│   │   ├── gotrue-version
│   │   ├── pooler-url
│   │   ├── postgres-version
│   │   ├── project-ref
│   │   ├── rest-version
│   │   └── storage-version
│   └── snippets
│       └── Untitled query 908.sql
├── tests
│   └── e2e
├── tsconfig.json
└── vitest.config.ts


CONTINGUT DELS FITXERS


// =================== FILE: .vscode/settings.json ===================

{
  "files.associations": {
    "*.css": "tailwindcss"
  },
  "i18n-ally.localesPaths": [
    "messages"
],
  "i18n-ally.keystyle": "nested",
  "i18n-ally.sortKeys": true,
  "i18n-ally.namespace": true,
  "i18n-ally.pathMatcher": "{locale}.ts",
  "i18n-ally.enabledParsers": ["ts", "js", "json"]
}


// =================== FILE: esquema.sql ===================


\restrict 6WeJCegmyC9ovGQ0ZWqr7EFQeFuX8oQpalw1d43BfZHDoi2TYuKvftsnrXspddD


SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;


CREATE SCHEMA IF NOT EXISTS "public";


ALTER SCHEMA "public" OWNER TO "pg_database_owner";


COMMENT ON SCHEMA "public" IS 'standard public schema';



CREATE TYPE "public"."challenge_type" AS ENUM (
    'QUIZ',
    'CODE_FIX',
    'TERMINAL',
    'DRAG_DROP',
    'MATCHING',
    'LOGIC_ORDER'
);


ALTER TYPE "public"."challenge_type" OWNER TO "postgres";


CREATE OR REPLACE FUNCTION "public"."handle_new_user"() RETURNS "trigger"
    LANGUAGE "plpgsql" SECURITY DEFINER
    SET "search_path" TO 'public'
    AS $$
begin
  insert into public.profiles (id, username, total_xp, current_level)
  values (
    new.id, 
    coalesce(new.raw_user_meta_data->>'full_name', new.email), -- Agafem el nom o l'email
    0, -- XP Inicial
    1  -- Nivell Inicial
  );
  return new;
end;
$$;


ALTER FUNCTION "public"."handle_new_user"() OWNER TO "postgres";

SET default_tablespace = '';

SET default_table_access_method = "heap";


CREATE TABLE IF NOT EXISTS "public"."challenges" (
    "id" "uuid" DEFAULT "extensions"."uuid_generate_v4"() NOT NULL,
    "topic_id" "uuid" NOT NULL,
    "difficulty_tier" integer NOT NULL,
    "type" "public"."challenge_type" NOT NULL,
    "content" "jsonb" DEFAULT '{}'::"jsonb" NOT NULL,
    "created_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    CONSTRAINT "challenges_difficulty_tier_check" CHECK ((("difficulty_tier" >= 1) AND ("difficulty_tier" <= 10)))
);


ALTER TABLE "public"."challenges" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."profiles" (
    "id" "uuid" NOT NULL,
    "username" "text",
    "total_xp" integer DEFAULT 0 NOT NULL,
    "current_level" integer DEFAULT 1 NOT NULL,
    "streak_days" integer DEFAULT 0 NOT NULL,
    "updated_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "level" integer DEFAULT 1
);


ALTER TABLE "public"."profiles" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."topics" (
    "id" "uuid" DEFAULT "extensions"."uuid_generate_v4"() NOT NULL,
    "slug" "text" NOT NULL,
    "name_key" "text" NOT NULL,
    "icon_name" "text" NOT NULL,
    "color_theme" "text" NOT NULL,
    "parent_topic_id" "uuid",
    "is_active" boolean DEFAULT false,
    "created_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "updated_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL
);


ALTER TABLE "public"."topics" OWNER TO "postgres";


CREATE TABLE IF NOT EXISTS "public"."user_progress" (
    "id" "uuid" DEFAULT "extensions"."uuid_generate_v4"() NOT NULL,
    "user_id" "uuid" NOT NULL,
    "challenge_id" "uuid" NOT NULL,
    "topic_id" "uuid" NOT NULL,
    "completed_at" timestamp with time zone DEFAULT "timezone"('utc'::"text", "now"()) NOT NULL,
    "xp_earned" integer NOT NULL
);


ALTER TABLE "public"."user_progress" OWNER TO "postgres";


ALTER TABLE ONLY "public"."challenges"
    ADD CONSTRAINT "challenges_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."profiles"
    ADD CONSTRAINT "profiles_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."topics"
    ADD CONSTRAINT "topics_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."topics"
    ADD CONSTRAINT "topics_slug_key" UNIQUE ("slug");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_pkey" PRIMARY KEY ("id");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_user_id_challenge_id_key" UNIQUE ("user_id", "challenge_id");



CREATE INDEX "idx_challenges_content" ON "public"."challenges" USING "gin" ("content");



ALTER TABLE ONLY "public"."challenges"
    ADD CONSTRAINT "challenges_topic_id_fkey" FOREIGN KEY ("topic_id") REFERENCES "public"."topics"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."profiles"
    ADD CONSTRAINT "profiles_id_fkey" FOREIGN KEY ("id") REFERENCES "auth"."users"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."topics"
    ADD CONSTRAINT "topics_parent_topic_id_fkey" FOREIGN KEY ("parent_topic_id") REFERENCES "public"."topics"("id");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_challenge_id_fkey" FOREIGN KEY ("challenge_id") REFERENCES "public"."challenges"("id") ON DELETE CASCADE;



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_topic_id_fkey" FOREIGN KEY ("topic_id") REFERENCES "public"."topics"("id");



ALTER TABLE ONLY "public"."user_progress"
    ADD CONSTRAINT "user_progress_user_id_fkey" FOREIGN KEY ("user_id") REFERENCES "public"."profiles"("id") ON DELETE CASCADE;



CREATE POLICY "Challenges are viewable by everyone" ON "public"."challenges" FOR SELECT USING (true);



CREATE POLICY "Dev allow all profiles" ON "public"."profiles" USING (true);



CREATE POLICY "Dev allow all progress" ON "public"."user_progress" USING (true);



CREATE POLICY "Public topics are viewable by everyone" ON "public"."topics" FOR SELECT USING (("is_active" = true));



ALTER TABLE "public"."challenges" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."profiles" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."topics" ENABLE ROW LEVEL SECURITY;


ALTER TABLE "public"."user_progress" ENABLE ROW LEVEL SECURITY;


GRANT USAGE ON SCHEMA "public" TO "postgres";
GRANT USAGE ON SCHEMA "public" TO "anon";
GRANT USAGE ON SCHEMA "public" TO "authenticated";
GRANT USAGE ON SCHEMA "public" TO "service_role";



GRANT ALL ON FUNCTION "public"."handle_new_user"() TO "anon";
GRANT ALL ON FUNCTION "public"."handle_new_user"() TO "authenticated";
GRANT ALL ON FUNCTION "public"."handle_new_user"() TO "service_role";



GRANT ALL ON TABLE "public"."challenges" TO "anon";
GRANT ALL ON TABLE "public"."challenges" TO "authenticated";
GRANT ALL ON TABLE "public"."challenges" TO "service_role";



GRANT ALL ON TABLE "public"."profiles" TO "anon";
GRANT ALL ON TABLE "public"."profiles" TO "authenticated";
GRANT ALL ON TABLE "public"."profiles" TO "service_role";



GRANT ALL ON TABLE "public"."topics" TO "anon";
GRANT ALL ON TABLE "public"."topics" TO "authenticated";
GRANT ALL ON TABLE "public"."topics" TO "service_role";



GRANT ALL ON TABLE "public"."user_progress" TO "anon";
GRANT ALL ON TABLE "public"."user_progress" TO "authenticated";
GRANT ALL ON TABLE "public"."user_progress" TO "service_role";



ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "postgres";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "anon";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "authenticated";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON SEQUENCES TO "service_role";






ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "postgres";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "anon";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "authenticated";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON FUNCTIONS TO "service_role";






ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "postgres";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "anon";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "authenticated";
ALTER DEFAULT PRIVILEGES FOR ROLE "postgres" IN SCHEMA "public" GRANT ALL ON TABLES TO "service_role";






\unrestrict 6WeJCegmyC9ovGQ0ZWqr7EFQeFuX8oQpalw1d43BfZHDoi2TYuKvftsnrXspddD

RESET ALL;


// =================== FILE: init-structure.js ===================

import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

// En la sintaxi moderna (ESM), __dirname no existeix per defecte,
// així que el creem nosaltres manualment:
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// ==========================================
// DEFINICIÓ DE L'ARQUITECTURA (TECHMASTERY)
// ==========================================

const structure = [
  // --- ARREL I CONFIGURACIÓ ---
  '.github/workflows',
  '.vscode',
  'content/legal',
  'messages',
  'public/images/badges',
  'public/images/topics',
  'tests/e2e',

  // --- CAPA DE DOMINI (CORE) ---
  'src/core/entities',
  'src/core/repositories',
  'src/core/errors',
  'src/core/types',
  'src/core/services',

  // --- CAPA D'APLICACIÓ (USE CASES) ---
  'src/application/use-cases/auth',
  'src/application/use-cases/challenges',
  'src/application/use-cases/topics',
  'src/application/use-cases/gamification',
  'src/application/dto',

  // --- CAPA D'INFRAESTRUCTURA (ADAPTERS) ---
  'src/infrastructure/repositories/supabase',
  'src/infrastructure/adapters',
  'src/infrastructure/config',
  'src/infrastructure/database',

  // --- CAPA DE PRESENTACIÓ (UI & ACTIONS) ---
  'src/presentation/actions',
  'src/presentation/hooks',
  'src/presentation/utils',
  
  // Components UI
  'src/presentation/components/ui',
  'src/presentation/components/layout',
  'src/presentation/components/feedback',
  
  // Components de Features
  'src/presentation/components/features/auth',
  'src/presentation/components/features/topics',
  'src/presentation/components/features/leaderboard',
  'src/presentation/components/features/game-engine',
  'src/presentation/components/features/game-engine/challenges',
  
  // Components d'Administració
  'src/presentation/components/admin',

  // --- NEXT.JS APP ROUTER ---
  'src/app/[locale]/api/webhooks',
  'src/app/[locale]/(auth)',
  'src/app/[locale]/(dashboard)',
  'src/app/[locale]/(game)/learn',
  'src/app/[locale]/(game)/arena',
  'src/app/[locale]/(admin)/admin/topics',
  'src/app/[locale]/(admin)/admin/users',
];

const filesToCreate = [
  {
    path: 'messages/ca.json',
    content: `{
  "app": { "name": "TechMastery" },
  "game": { "start": "Comença", "check": "Comprovar" }
}`
  },
  {
    path: 'messages/en.json',
    content: `{
  "app": { "name": "TechMastery" },
  "game": { "start": "Start", "check": "Check" }
}`
  },
  {
    path: 'src/core/README.md',
    content: `# Core Layer (Domini)
Aquesta capa conté les regles de negoci pures del joc.
⚠️ NO importis res de React, Next.js o Supabase aquí.`
  },
  {
    path: 'src/application/README.md',
    content: `# Application Layer (Casos d'Ús)
Aquí resideix l'orquestració de l'aplicació.`
  },
  {
    path: 'src/presentation/components/features/game-engine/README.md',
    content: `# Game Engine Components
Components polimòrfics per a Quiz, Terminal, etc.`
  },
  {
    path: 'src/app/globals.css',
    content: `@tailwind base;\n@tailwind components;\n@tailwind utilities;`
  }
];

console.log('🚀 Iniciant creació d\'estructura Enterprise (ESM)...\n');

// 1. CREACIÓ DE CARPETES
structure.forEach(dir => {
  const fullPath = path.join(__dirname, dir);
  if (!fs.existsSync(fullPath)) {
    fs.mkdirSync(fullPath, { recursive: true });
    console.log(`✅ Carpeta creada: ${dir}`);
  }
});

// 2. CREACIÓ D'ARXIUS BASE
filesToCreate.forEach(file => {
  const fullPath = path.join(__dirname, file.path);
  if (!fs.existsSync(fullPath)) {
    const dirName = path.dirname(fullPath);
    if (!fs.existsSync(dirName)) {
      fs.mkdirSync(dirName, { recursive: true });
    }
    fs.writeFileSync(fullPath, file.content);
    console.log(`📄 Fitxer creat: ${file.path}`);
  }
});

console.log('\n🎉 ESTRUCTURA COMPLETADA!');

// =================== FILE: merge.js ===================

import { readdirSync, statSync, readFileSync, writeFileSync } from "fs";
import { join, extname } from "path";

// --- Configuració ---
const rootFolder = "./";
const outputFile = "codi_i_estructura_edutech.txt";
const extensionsToInclude = [".ts", ".tsx", ".js", ".jsx", ".css", ".json", ".sql"];

const ignoreList = [
  "public",
  "node_modules",
  ".next",
  "dist",
  "build",
  ".DS_Store",
  "package-lock.json",
  "pnpm-lock.yaml",
];

let treeOutput = `ESTRUCTURA DEL PROJECTE (./src)\n\n`;
let contentOutput = "\n\nCONTINGUT DELS FITXERS\n";

function processDirectory(dir, prefix = "") {
  // Llegim i filtrem els arxius i carpetes del directori actual
  const items = readdirSync(dir).filter(item => !ignoreList.includes(item));

  items.forEach((item, index) => {
    const fullPath = join(dir, item);
    const stat = statSync(fullPath);
    const isLast = index === items.length - 1;

    // Afegim la línia corresponent a l'arbre de directoris
    treeOutput += `${prefix}${isLast ? "└── " : "├── "}${item}\n`;

    if (stat.isDirectory()) {
      // Si és un directori, fem la crida recursiva amb el nou prefix
      const newPrefix = prefix + (isLast ? "    " : "│   ");
      processDirectory(fullPath, newPrefix);
    } else if (extensionsToInclude.includes(extname(item))) {
      // Si és un fitxer vàlid, llegim el seu contingut
      const normalizedPath = fullPath.replace(/\\/g, "/");
      contentOutput += `\n\n// =================== FILE: ${normalizedPath} ===================\n\n`;
      contentOutput += readFileSync(fullPath, "utf8");
    }
  });
}

try {
  console.log("🌳 Generant l'arbre de directoris i llegint fitxers...");
  processDirectory(rootFolder);

  // Unim l'arbre i el contingut en un sol fitxer
  const finalOutput = treeOutput + contentOutput;

  writeFileSync(outputFile, finalOutput);
  console.log(`✅ Fitxer creat amb èxit: ${outputFile}`);
} catch (error) {
  console.error("❌ Hi ha hagut un error en crear el fitxer:", error);
}

// =================== FILE: messages/ca.ts ===================

// filepath: messages/ca.ts
export default {
  app: {
    name: "TechMastery"
  },
  game: {
    start: "Comença",
    check: "Comprovar",
    next: "Següent",
    finish: "Acabar",
    loading: "Carregant...",
    arena: {
      loading: "Guardant el teu progrés...",
      progress: "Progrés",
      construction: "En construcció...",
      skip: "Saltar",
      unauthorized_title: "Inicia sessió",
      unauthorized_desc: "Necessites un compte per guardar el teu progrés i pujar de nivell.",
      error_title: "Ups! Alguna cosa ha fallat",
      login_btn: "Entrar",
      retry_btn: "Reintentar",
      lesson_complete: "Lliçó Completada!",
      xp_earned: "XP Guanyada",
      dashboard_btn: "Tornar al Dashboard",
      level_up: "NIVELL SUPERAT!",
      continue_btn: "Continuar",
      quit: "Sortir"
    },
    modes: {
      logic_order: {
        label: "Ordre Lògic",
        your_answer: "La teva resposta",
        placeholder: "Arrossega els elements aquí",
        empty_options: "Tot col·locat ✨",
        drag_hint: "Clica o arrossega"
      },
      terminal: {
        label: "Terminal",
        prompt_user: "usuari",
        placeholder: "Escriu la comanda...",
        session_closed: "--- Sessió finalitzada ---"
      }
    },
    actions: {
      check: "Comprovar",
      verify: "Verificar",
      continue: "Continuar",
      reset: "Reiniciar",
      retry: "Tornar a provar"
    },
    feedback: {
      correct: "Correcte!",
      incorrect: "Incorrecte",
      solution: "Solució",
      hint: "Pista"
    },
    level_node: {
      level: "NIVELL",
      locked: "Bloquejat",
      completed: "Completat"
    }

  },
  // AFEGEIX AIXÒ:
  dashboard: {
    welcome_title: "Hola de nou",
    subtitle: "Quina tecnologia vols dominar avui?",
    availableTopics: "Temes Disponibles"
  },
  topic: {
    react: { title: "Fonaments de React" },
    typescript: { title: "TypeScript Pro" },
    supabase: { title: "Supabase i SQL" },
    legacy: { title: "PHP Legacy" },
    security: { title: "Seguretat OWASP" },
    docker_basics: { title: "Contenidors Docker" }
  },

  // --- NOVA SECCIÓ AUTH ---
  auth: {
    login: {
      title: "Benvingut a eduTech 🚀",
      subtitle: "Inicia sessió per continuar aprenent.",
      submit_button: "Entrar",
      forgot_password: "Has oblidat la contrasenya?",
      no_account: "Encara no tens compte?",
      register_link: "Crea un compte gratuït"
    },
    register: {
      title: "Uneix-te a eduTech",
      subtitle: "Comença a aprendre avui mateix.",
      submit_button: "Crear Compte",
      have_account: "Ja tens compte?",
      login_link: "Inicia sessió"
    },
    fields: {
      email: "Correu electrònic",
      email_placeholder: "usuari@exemple.com",
      password: "Contrasenya",
      password_placeholder: "••••••••"
    },
    errors: {
      generic: "Hi ha hagut un error inesperat.",
      invalid_credentials: "El correu o la contrasenya són incorrectes.",
      user_already_exists: "Aquest correu ja està registrat.",
      weak_password: "La contrasenya ha de tenir mínim 6 caràcters."
    },
    success: {
      check_email: "Compte creat! Revisa el teu correu."
    },
    logout: "Tancar Sessió"
  },
  landing: {
    badge: "Aprèn programació jugant",
    title_prefix: "Converteix-te en",
    title_highlight: "Senior Developer",
    description: "Domina React, Docker i Ciberseguretat amb reptes interactius. Sense vídeos avorrits. Només pràctica real.",
    cta_primary: "COMENÇAR GRATIS",
    cta_secondary: "SABER-NE MÉS",
    login_button: "ENTRAR"
  }
} as const;

// =================== FILE: messages/en.ts ===================

// filepath: messages/en.ts
export default {
  app: {
    name: "TechMastery"
  },
  game: {
    start: "Start",
    check: "Check",
    next: "Next",
    finish: "Finish",
    loading: "Loading...",
    arena: {
      loading: "Saving your progress...",
      progress: "Progress",
      construction: "Under construction...",
      skip: "Skip",
      unauthorized_title: "Log in",
      unauthorized_desc: "You need an account to save your progress and level up.",
      error_title: "Oops! Something went wrong",
      login_btn: "Log in",
      retry_btn: "Retry",
      lesson_complete: "Lesson Completed!",
      xp_earned: "XP Earned",
      dashboard_btn: "Back to Dashboard",
      level_up: "LEVEL UP!",
      continue_btn: "Continue",
      quit: "Quit"
    },
    modes: {
      logic_order: {
        label: "Logical Order",
        your_answer: "Your answer",
        placeholder: "Drag items here",
        empty_options: "All set ✨",
        drag_hint: "Click or drag"
      },
      terminal: {
        label: "Terminal",
        prompt_user: "user",
        placeholder: "Type the command...",
        session_closed: "--- Session ended ---"
      }
    },
    actions: {
      check: "Check",
      verify: "Verify",
      continue: "Continue",
      reset: "Reset",
      retry: "Try again"
    },
    feedback: {
      correct: "Correct!",
      incorrect: "Incorrect",
      solution: "Solution",
      hint: "Hint"
    },
    level_node: {
      level: "LEVEL",
      locked: "Locked",
      completed: "Completed"
    }
  },

  dashboard: {
    welcome_title: "Welcome back",
    subtitle: "What technology do you want to master today?",
    availableTopics: "Available Topics"
  },
  topic: {
    react: { title: "React Basics" },
    typescript: { title: "TypeScript Pro" },
    supabase: { title: "Supabase & SQL" },
    legacy: { title: "Legacy PHP" }, // Encara que estigui desactivat
    security: { title: "OWASP Top 10" }, // Exemple extra
    docker_basics: { title: "Docker Containers" }
  },
  auth: {
    login: {
      title: "Welcome to eduTech 🚀",
      subtitle: "Login to continue learning.",
      submit_button: "Login",
      forgot_password: "Forgot password?",
      no_account: "Don't have an account?",
      register_link: "Create free account"
    },
    register: {
      title: "Join eduTech",
      subtitle: "Start learning today.",
      submit_button: "Create Account",
      have_account: "Already have an account?",
      login_link: "Login"
    },
    fields: {
      email: "Email",
      email_placeholder: "user@example.com",
      password: "Password",
      password_placeholder: "••••••••"
    },
    errors: {
      generic: "An unexpected error occurred.",
      invalid_credentials: "Invalid email or password.",
      user_already_exists: "Email already registered.",
      weak_password: "Password must be at least 6 characters."
    },
    success: {
      check_email: "Account created! Check your email."
    },
    logout: "Logout"
  },
  landing: {
    badge: "Learn coding by playing",
    title_prefix: "Become a",
    title_highlight: "Senior Developer",
    description: "Master React, Docker, and Cybersecurity with interactive challenges. No boring videos. Just real practice.",
    cta_primary: "START FOR FREE",
    cta_secondary: "LEARN MORE",
    login_button: "LOGIN"
  }
} as const;

// =================== FILE: messages/es.ts ===================

// filepath: messages/es.ts
export default {
  app: {
    name: "TechMastery"
  },
  game: {
    start: "Comenzar",
    check: "Comprobar",
    next: "Siguiente",
    finish: "Finalizar",
    loading: "Cargando...",
    arena: {
      loading: "Guardando tu progreso...",
      progress: "Progreso",
      construction: "En construcción...",
      skip: "Saltar",
      unauthorized_title: "Inicia sesión",
      unauthorized_desc: "Necesitas una cuenta para guardar tu progreso y subir de nivel.",
      error_title: "¡Ups! Algo ha fallado",
      login_btn: "Entrar",
      retry_btn: "Reintentar",
      lesson_complete: "¡Lección completada!",
      xp_earned: "XP ganada",
      dashboard_btn: "Volver al Dashboard",
      level_up: "¡NIVEL SUPERADO!",
      continue_btn: "Continuar",
      quit: "Salir"
    },
    modes: {
      logic_order: {
        label: "Orden lógico",
        your_answer: "Tu respuesta",
        placeholder: "Arrastra los elementos aquí",
        empty_options: "Todo colocado ✨",
        drag_hint: "Haz clic o arrastra"
      },
      terminal: {
        label: "Terminal",
        prompt_user: "usuario",
        placeholder: "Escribe el comando...",
        session_closed: "--- Sesión finalizada ---"
      }
    },
    actions: {
      check: "Comprobar",
      verify: "Verificar",
      continue: "Continuar",
      reset: "Reiniciar",
      retry: "Volver a intentar"
    },
    feedback: {
      correct: "¡Correcto!",
      incorrect: "Incorrecto",
      solution: "Solución",
      hint: "Pista"
    },
    level_node: {
      level: "NIVEL",
      locked: "Bloqueado",
      completed: "Completado"
    }
  },

  dashboard: {
    welcome_title: "Hola de nuevo",
    subtitle: "¿Qué tecnología quieres dominar hoy?",
    availableTopics: "Temas Disponibles"
  },
  topic: {
    react: { title: "Fundamentos de React" },
    typescript: { title: "TypeScript Pro" },
    supabase: { title: "Supabase y SQL" },
    legacy: { title: "PHP Legacy" },
    security: { title: "Seguridad OWASP" },
    docker_basics: { title: "Contenedores Docker" }
  },
  auth: {
    login: {
      title: "Bienvenido a eduTech 🚀",
      subtitle: "Inicia sesión para seguir aprendiendo.",
      submit_button: "Iniciar sesión",
      forgot_password: "¿Olvidaste tu contraseña?",
      no_account: "¿No tienes una cuenta?",
      register_link: "Crear cuenta gratis"
    },
    register: {
      title: "Únete a eduTech",
      subtitle: "Empieza a aprender hoy.",
      submit_button: "Crear cuenta",
      have_account: "¿Ya tienes una cuenta?",
      login_link: "Iniciar sesión"
    },
    fields: {
      email: "Correo electrónico",
      email_placeholder: "usuario@ejemplo.com",
      password: "Contraseña",
      password_placeholder: "••••••••"
    },
    errors: {
      generic: "Ocurrió un error inesperado.",
      invalid_credentials: "Correo electrónico o contraseña incorrectos.",
      user_already_exists: "El correo electrónico ya está registrado.",
      weak_password: "La contraseña debe tener al menos 6 caracteres."
    },
    success: {
      check_email: "¡Cuenta creada! Revisa tu correo electrónico."
    },
    logout: "Cerrar sesión"
  },
  landing: {
    badge: "Aprende programación jugando",
    title_prefix: "Conviértete en",
    title_highlight: "Senior Developer",
    description: "Domina React, Docker y Ciberseguridad con retos interactivos. Sin vídeos aburridos. Solo práctica real.",
    cta_primary: "EMPEZAR GRATIS",
    cta_secondary: "SABER MÁS",
    login_button: "ENTRAR"
  }
} as const;


// =================== FILE: next-env.d.ts ===================

/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.


// =================== FILE: next.config.ts ===================

import createNextIntlPlugin from 'next-intl/plugin';

const withNextIntl = createNextIntlPlugin('./src/i18n.ts'); // Apunta al fitxer que crearem ara

/** @type {import('next').NextConfig} */
const nextConfig = {};

export default withNextIntl(nextConfig);

// =================== FILE: package.json ===================

{
  "name": "edu-tech",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "test": "vitest",
    "test:watch": "vitest --watch",
    "test:ci": "vitest run"
  },
  "dependencies": {
    "@supabase/ssr": "^0.8.0",
    "@supabase/supabase-js": "^2.90.1",
    "clsx": "^2.1.1",
    "framer-motion": "^12.24.11",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "next-intl": "^4.7.0",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "tailwind-merge": "^3.4.0",
    "zod": "^4.3.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@testing-library/dom": "^10.4.1",
    "@testing-library/react": "^16.3.1",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "@vitejs/plugin-react": "^5.1.2",
    "dotenv": "^17.2.3",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "jsdom": "^27.4.0",
    "tailwindcss": "^4",
    "tailwindcss-animate": "^1.0.7",
    "typescript": "^5",
    "vite-tsconfig-paths": "^6.0.3",
    "vitest": "^4.0.16"
  }
}

// =================== FILE: src/app/globals.css ===================

/* filepath: src/app/globals.css */
@import "tailwindcss";
@plugin "tailwindcss-animate";

@theme {
  --font-sans: var(--font-nunito), ui-sans-serif, system-ui;

  /* Colors Brand */
  --color-brand-primary: #3B82F6;
  --color-brand-primaryDark: #1D4ED8;
  --color-brand-success: #58CC02;
  --color-brand-successDark: #46A302;
  --color-brand-danger: #FF4B4B;
  --color-brand-dangerDark: #D62F2F;
  --color-brand-warning: #FFC800;
  --color-brand-warningDark: #D9AA00;
  --color-brand-surface: #1E293B;
  --color-brand-surfaceDark: #0F172A;

  --animate-bounce-sm: bounce-sm 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  @keyframes bounce-sm {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(0.95); }
  }
}

@layer components {
  /* TRUC: En lloc de fer @apply btn-game a tot arreu, 
     apliquem els estils base a TOTS els botons de cop.
  */
  .btn-game, 
  .btn-primary, 
  .btn-success, 
  .btn-danger, 
  .btn-outline {
    @apply relative w-full py-4 px-6 rounded-2xl font-black text-lg uppercase tracking-wider transition-all active:translate-y-1 active:border-b-0 cursor-pointer flex items-center justify-center gap-2;
  }

  /* Ara només definim els colors específics per cada variant */
  .btn-primary {
    @apply bg-brand-primary text-white border-b-4 border-brand-primaryDark hover:bg-blue-400;
  }
  
  .btn-success {
    @apply bg-brand-success text-white border-b-4 border-brand-successDark hover:bg-green-400;
  }

  .btn-danger {
    @apply bg-brand-danger text-white border-b-4 border-brand-dangerDark hover:bg-red-400;
  }

  .btn-outline {
    @apply bg-slate-800 text-slate-300 border-2 border-b-4 border-slate-700 hover:bg-slate-700;
  }

  /* Inputs */
  .input-game {
    @apply w-full p-4 bg-slate-800 border-2 border-slate-700 rounded-xl text-white font-bold placeholder-slate-500 focus:outline-none focus:border-brand-primary focus:bg-slate-900 transition-all;
  }
}

// =================== FILE: src/app/layout.tsx ===================

// filepath: src/app/layout.tsx
import { ReactNode } from 'react';

// Aquest layout és necessari per Next.js però no ha de fer RES visualment
// perquè tota la teva app viu dins de /[locale]/
export default function RootLayout({ children }: { children: ReactNode }) {
  return children;
}

// =================== FILE: src/app/[locale]/(auth)/layout.tsx ===================

// filepath: src/app/[locale]/(auth)/layout.tsx
import { ReactNode } from 'react';

export default function AuthLayout({ children }: { children: ReactNode }) {
  return (
    <div className="min-h-screen w-full flex items-center justify-center bg-slate-950 relative overflow-hidden">
      {/* Fons decoratiu (Opcional: efecte grid o gradient) */}
      <div className="absolute inset-0 bg-[linear-gradient(to_right,#4f4f4f2e_1px,transparent_1px),linear-gradient(to_bottom,#4f4f4f2e_1px,transparent_1px)] bg-[size:14px_24px] [mask-image:radial-gradient(ellipse_60%_50%_at_50%_0%,#000_70%,transparent_100%)]" />
      
      {/* Contingut centrat (Login/Register) */}
      <div className="relative z-10 w-full max-w-md p-4">
        {children}
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/login/LoginForm.tsx ===================

// filepath: src/app/[locale]/(auth)/login/LoginForm.tsx
'use client';

import { useActionState } from 'react';
import { authAction } from '@/presentation/actions/auth/auth.action';
import { Loader2, LogIn } from 'lucide-react';
import { useTranslations } from 'next-intl';

// 1. IMPORTACIÓ CORRECTA (Arquitectura Centralitzada)
import { Link } from '@/navigation'; 

export function LoginForm() {
  const t = useTranslations('auth');
  
  // 2. HEM ELIMINAT 'const locale = useLocale();' -> Ja no cal!

  const [state, action, isPending] = useActionState(authAction, {});

  return (
    <form action={action} className="flex flex-col gap-4">
      <input type="hidden" name="intent" value="login" />

      {/* EMAIL */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.email')}
        </label>
        <input 
          name="email" 
          type="email" 
          required 
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.email_placeholder')}
        />
      </div>
      
      {/* PASSWORD */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.password')}
        </label>
        <div className="text-right mb-1">
            {/* TODO: Crear ruta real /forgot-password */}
            <Link href="/forgot-password" className="text-xs text-blue-400 hover:underline">
              {t('login.forgot_password')}
            </Link>
        </div>
        <input 
          name="password" 
          type="password" 
          required 
          minLength={6}
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.password_placeholder')}
        />
      </div>

      {/* ERRORS */}
      {state?.errorKey && (
        <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm flex items-center gap-2">
          ⚠️ <span>{t(state.errorKey)}</span>
        </div>
      )}

      {/* BOTÓ */}
      <button 
        type="submit" 
        disabled={isPending}
        className="w-full py-3 mt-2 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold rounded-lg transition-all flex justify-center items-center shadow-lg shadow-blue-900/20"
      >
        {isPending ? <Loader2 className="animate-spin w-5 h-5" /> : (
            <span className="flex items-center gap-2">
                {t('login.submit_button')} <LogIn className="w-4 h-4" />
            </span>
        )}
      </button>

      {/* FOOTER LINK - MOLT MÉS NET */}
      <div className="text-center mt-6 text-sm text-slate-500">
        {t('login.no_account')}{' '}
        <Link 
          href="/register" 
          className="text-blue-400 hover:text-blue-300 font-medium hover:underline transition-colors"
        >
          {t('login.register_link')}
        </Link>
      </div>
    </form>
  );
}

// =================== FILE: src/app/[locale]/(auth)/login/page.tsx ===================

// filepath: src/app/[locale]/(auth)/login/page.tsx
import { LoginForm } from './LoginForm';
import { getTranslations } from 'next-intl/server'; // <--- Import de servidor

interface Props {
  params: Promise<{ locale: string }>;
}

export default async function LoginPage({ params }: Props) {
  // 1. Esperem els paràmetres (Next.js 15 requires await)
  const { locale } = await params;
  
  // 2. Carreguem les traduccions al servidor
  const t = await getTranslations({ locale, namespace: 'auth.login' });

  return (
    <div className="bg-slate-900 border border-slate-800 rounded-xl p-8 shadow-2xl backdrop-blur-sm w-full">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-white mb-2">{t('title')}</h1>
        <p className="text-slate-400">{t('subtitle')}</p>
      </div>

      <LoginForm />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/register/page.tsx ===================

// filepath: src/app/[locale]/(auth)/register/page.tsx
import { RegisterForm } from './RegisterForm';
import { getTranslations } from 'next-intl/server';

interface Props {
  params: Promise<{ locale: string }>;
}

export default async function RegisterPage({ params }: Props) {
  const { locale } = await params;
  
  // namespace 'auth.register' coincideix amb el teu fitxer .ts
  const t = await getTranslations({ locale, namespace: 'auth.register' });

  return (
    <div className="bg-slate-900 border border-slate-800 rounded-xl p-8 shadow-2xl backdrop-blur-sm w-full">
      <div className="text-center mb-8">
        <h1 className="text-3xl font-bold text-white mb-2">{t('title')}</h1>
        <p className="text-slate-400">{t('subtitle')}</p>
      </div>
      <RegisterForm />
    </div>
  );
}

// =================== FILE: src/app/[locale]/(auth)/register/RegisterForm.tsx ===================

// filepath: src/app/[locale]/(auth)/register/RegisterForm.tsx
'use client';

import { useActionState } from 'react';
import { authAction } from '@/presentation/actions/auth/auth.action';
import { Loader2 } from 'lucide-react';
import { useTranslations } from 'next-intl';

// 1. IMPORTACIÓ CORRECTA
import { Link } from '@/navigation';

export function RegisterForm() {
  const t = useTranslations('auth');
  // 2. HEM ELIMINAT 'const locale = useLocale();'

  const [state, action, isPending] = useActionState(authAction, {});

  return (
    <form action={action} className="flex flex-col gap-4">
      <input type="hidden" name="intent" value="signup" />

      {/* EMAIL */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.email')}
        </label>
        <input 
          name="email" 
          type="email" 
          required 
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.email_placeholder')} 
        />
      </div>

      {/* PASSWORD */}
      <div>
        <label className="block text-sm font-medium text-slate-400 mb-1">
          {t('fields.password')}
        </label>
        <input 
          name="password" 
          type="password" 
          required 
          minLength={6} 
          className="w-full p-3 bg-slate-950 border border-slate-800 rounded-lg text-white focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20 transition-all"
          placeholder={t('fields.password_placeholder')} 
        />
      </div>

      {/* MISSATGES */}
      {state?.errorKey && (
        <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-lg text-red-400 text-sm">
          ⚠️ {t(state.errorKey)}
        </div>
      )}
      {state?.messageKey && (
        <div className="p-3 bg-green-500/10 border border-green-500/20 rounded-lg text-green-400 text-sm">
          ✅ {t(state.messageKey)}
        </div>
      )}

      {/* BOTÓ */}
      <button 
        disabled={isPending} 
        className="w-full py-3 bg-blue-600 hover:bg-blue-500 disabled:opacity-50 text-white font-bold rounded-lg transition-all flex justify-center items-center shadow-lg"
      >
        {isPending ? <Loader2 className="animate-spin" /> : t('register.submit_button')}
      </button>

      {/* FOOTER - SENSE LOCALE MANUAL */}
      <div className="text-center mt-4 text-sm text-slate-500">
        {t('register.have_account')}{' '}
        <Link 
          href="/login" 
          className="text-blue-400 hover:underline"
        >
          {t('register.login_link')}
        </Link>
      </div>
    </form>
  );
}

// =================== FILE: src/app/[locale]/(dashboard)/dashboard/page.tsx ===================

// filepath: src/app/[locale]/(dashboard)/dashboard/page.tsx
import { createClient } from '@/infrastructure/utils/supabase/server';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { GetUserDashboardUseCase } from '@/application/use-cases/dashboard/get-user-dashboard.use-case';
import { TopicCard } from '@/presentation/components/features/dashboard/TopicCard';
import { getTranslations } from 'next-intl/server'; // <--- Import
import { redirect } from 'next/navigation';

interface DashboardPageProps {
    params: Promise<{ locale: string }>;
}

export default async function DashboardPage({ params }: DashboardPageProps) {
  const { locale } = await params;
  
  // 1. CARREGAR TOTES LES TRADUCCIONS (sense namespace específic)
  // Així podem fer t('dashboard.welcome_title') i també t('topic.react.title')
  const t = await getTranslations(); 
  
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    redirect('/login');
  }

  const topicRepo = new SupabaseTopicRepository();
  const useCase = new GetUserDashboardUseCase(topicRepo);
  const topics = await useCase.execute(user.id, locale, supabase);

  return (
    <div className="min-h-screen bg-slate-950 p-6 md:p-12">
      <div className="max-w-6xl mx-auto mb-10">
        <h1 className="text-3xl md:text-4xl font-black text-white mb-2 tracking-tight">
           {t('dashboard.welcome_title')}, <span className="text-blue-500">{user.email?.split('@')[0]}</span>! 👋
        </h1>
        <p className="text-slate-400 text-lg">
           {t('dashboard.subtitle')}
        </p>
      </div>

      <div className="max-w-6xl mx-auto grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
         {topics.map((topic) => (
             <TopicCard 
                key={topic.id} 
                topic={topic} 
                // AQUÍ FEM LA TRADUCCIÓ DINÀMICA
                // Si la clau (topic.nameKey) no existeix, next-intl retornarà la clau com a fallback
                translatedTitle={t(topic.nameKey)} 
             />
         ))}
      </div>

      {topics.length === 0 && (
          <div className="text-center py-20">
             <p className="text-slate-500">No s'han trobat temes actius.</p>
          </div>
      )}
    </div>
  );
}

// =================== FILE: src/app/[locale]/(game)/learn/[slug]/page.tsx ===================

// filepath: src/app/[locale]/(game)/learn/[slug]/page.tsx
import { createClient } from '@/infrastructure/utils/supabase/server';
import { GetTopicPathUseCase } from '@/application/use-cases/topics/get-topic-path.use-case';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { ArrowLeft } from 'lucide-react';
import { redirect } from 'next/navigation';
import { getTranslations } from 'next-intl/server';
import { Link } from '@/navigation'; 
import { LearningPathOrchestrator } from '@/presentation/components/features/learning-path/LearningPathOrchestrator';

interface TopicPageProps {
  params: Promise<{ slug: string; locale: string }>;
}

export default async function TopicMapPage({ params }: TopicPageProps) {
  const { slug } = await params;
  const t = await getTranslations(); 
  const supabase = await createClient();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) redirect('/login');

  const topicRepo = new SupabaseTopicRepository();
  const topic = await topicRepo.findBySlug(slug);
  
  if (!topic) return <div className="text-white text-center pt-20">Tema no trobat (404)</div>;

  const pathUseCase = new GetTopicPathUseCase(topicRepo);
  const { levels, totalXp } = await pathUseCase.execute(user.id, topic.id);

  return (
    <div className="min-h-screen bg-slate-950 flex flex-col items-center relative overflow-hidden">
      
      {/* HEADER FIX (Comú per a totes les vistes) */}
      <header className="sticky top-0 w-full bg-slate-900/90 backdrop-blur-md border-b border-slate-800 p-3 md:p-4 flex items-center justify-between z-50 shadow-2xl">
         <Link href="/dashboard" className="text-slate-400 hover:text-white transition-colors">
            <ArrowLeft className="w-6 h-6" />
         </Link>
         <h1 className="font-bold text-white text-base md:text-xl tracking-tight">{t(topic.nameKey)}</h1>
         <div className="text-xs md:text-sm font-bold text-yellow-500 bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20 shadow-[0_0_15px_rgba(234,179,8,0.2)]">
            {totalXp} XP
         </div>
      </header>

      {/* COMPONENT INTEL·LIGENT DE RUTA */}
      <div className="w-full flex-1 relative">
         <LearningPathOrchestrator levels={levels} slug={slug} />
      </div>
    </div>
  );
}

// =================== FILE: src/app/[locale]/(game)/learn/[slug]/play/page.tsx ===================

// filepath: src/app/[locale]/(game)/learn/[slug]/play/page.tsx
import { getNextChallengeAction } from '@/presentation/actions/challenges/get-next-challenge.action';
import { GameArena } from '@/presentation/components/features/game-engine/GameArena';
// 1. IMPORT CORRECTE PER A i18n
import { Link } from '@/navigation';
import { ArrowLeft } from 'lucide-react';

interface PlayPageProps {
  params: Promise<{ slug: string; locale: string }>;
  searchParams: Promise<{ tier?: string }>;
}

export default async function PlayPage({ params, searchParams }: PlayPageProps) {
  const { slug } = await params;
  const { tier } = await searchParams;

  // 2. Determinar Dificultat (Tier)
  const difficulty = tier ? parseInt(tier, 10) : 1;

  // 3. Cridar l'Acció passant el NIVELL
  // (Nota: Ara haurem d'actualitzar l'acció per acceptar aquest paràmetre)
  const response = await getNextChallengeAction(slug, difficulty);

  return (
    <main className="min-h-screen bg-slate-950 flex flex-col">
      {/* HEADER DE JOC */}
      <header className="border-b border-slate-800 bg-slate-900/80 backdrop-blur-md p-4 sticky top-0 z-20">
        <div className="max-w-5xl mx-auto flex items-center justify-between">

          {/* 4. UX MILLORADA: Tornar al MAPA, no a l'inici */}
          <Link
            href={`/learn/${slug}`}
            className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors group"
          >
            <div className="p-1.5 rounded-full bg-slate-800 group-hover:bg-slate-700 transition-colors">
              <ArrowLeft className="w-4 h-4" />
            </div>
            <span className="font-medium text-sm">Sortir del nivell</span>
          </Link>

          {/* Badge de Nivell */}
          <div className="px-3 py-1 bg-blue-500/10 border border-blue-500/20 text-blue-400 text-xs font-bold rounded-full uppercase tracking-wider">
            Tier {difficulty}
          </div>
        </div>
      </header>

      {/* ZONA DE JOC */}
      <div className="flex-1 flex flex-col items-center justify-center p-4 md:p-6 w-full max-w-5xl mx-auto">
        {!response.success ? (
          <div className="text-center max-w-md p-8 bg-slate-900 border border-red-900/50 rounded-2xl">
            <h1 className="text-xl font-bold text-red-400 mb-2">Error de càrrega</h1>
            <p className="text-slate-400 mb-6">{response.error}</p>
            <Link href={`/learn/${slug}`} className="px-6 py-2 bg-slate-800 rounded-lg hover:bg-slate-700 transition-colors">
              Tornar al Mapa
            </Link>
          </div>
        ) : !response.data || response.data.length === 0 ? (
          <div className="text-center py-10 animate-in fade-in zoom-in duration-500">
            <div className="text-6xl mb-4">🎉</div>
            <h1 className="text-3xl font-black text-transparent bg-clip-text bg-linear-to-r from-yellow-400 to-orange-500 mb-4">
              Nivell Completat!
            </h1>
            <p className="text-xl text-slate-400 max-w-lg mx-auto mb-8">
              Ja has superat tots els reptes d'aquest nivell de dificultat.
            </p>
            <Link
              href={`/learn/${slug}`}
              className="inline-flex items-center px-8 py-4 bg-blue-600 rounded-xl font-bold text-white hover:bg-blue-500 hover:scale-105 transition-all shadow-lg shadow-blue-600/20"
            >
              Tornar al Mapa
            </Link>
          </div>
        ) : (
          // ✅ AQUÍ ESTÀ EL CANVI: PASSEM EL SLUG
          <GameArena
            challenges={response.data}
            topicSlug={slug} // <--- CONNEXIÓ FINAL
          />
        )}
      </div>
    </main>
  );
}

// =================== FILE: src/app/[locale]/layout.tsx ===================

// filepath: src/app/[locale]/layout.tsx
import type { Metadata } from "next";
import { Nunito } from "next/font/google";
import { NextIntlClientProvider } from 'next-intl';
import { getMessages } from 'next-intl/server';
import { createClient } from '@/infrastructure/utils/supabase/server'; // Importem el client
import "../globals.css";

// Components de Navegació
import { MobileBottomBar } from "@/presentation/components/layout/MobileBottomBar";
import { DesktopNavbar } from "@/presentation/components/layout/DesktopNavbar";

const nunito = Nunito({ 
  subsets: ["latin"],
  weight: ["400", "700", "800", "900"],
  variable: "--font-nunito",
});

export const metadata: Metadata = {
  title: "EduTech",
  description: "Aprèn tecnologia jugant",
};

export default async function LocaleLayout({
  children,
  params
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;
  const messages = await getMessages();

  // 1. COMPROVACIÓ DE SESSIÓ AL SERVIDOR
  const supabase = await createClient();
  const { data: { user } } = await supabase.auth.getUser();
  const isLoggedIn = !!user; // true si hi ha usuari, false si no

  return (
    <html lang={locale}>
      <body className={`${nunito.variable} font-sans bg-slate-950 text-white antialiased pb-24 md:pb-0 md:pt-20`}>
        {/* pb-24: Padding inferior al mòbil perquè la barra no tapi contingut.
            md:pt-20: Padding superior a l'escriptori perquè la navbar no tapi contingut.
        */}

        <NextIntlClientProvider messages={messages}>
          
          {/* BARRA SUPERIOR (ESCRIPTORI) */}
          <DesktopNavbar isLoggedIn={isLoggedIn} />

          {/* CONTINGUT PRINCIPAL */}
          <main className="min-h-screen relative">
             {children}
          </main>

          {/* BARRA INFERIOR (MÒBIL) */}
          <MobileBottomBar isLoggedIn={isLoggedIn} />

        </NextIntlClientProvider>
      </body>
    </html>
  );
}

// =================== FILE: src/app/[locale]/page.tsx ===================

// ✅ ARA (CORRECTE - Apuntant al teu fitxer v4):
import { Link } from '@/navigation';   // <-- AQUEST ÉS EL CANVI CLAU
import { redirect } from 'next/navigation'; // El redirect aquí pot ser el natiu pq ja tenim el locale als params

import { createClient } from '@/infrastructure/utils/supabase/server';
import { ArrowRight, Code2, Terminal } from 'lucide-react';
import { getTranslations } from 'next-intl/server';

interface LandingPageProps {
  params: Promise<{ locale: string }>;
}

export default async function LandingPage({ params }: LandingPageProps) {
  // 1. OBTENIR LOCALE I TRADUCCIONS
  const { locale } = await params;
  const t = await getTranslations('landing');
  const supabase = await createClient();

  // 2. SI JA TÉ SESSIÓ -> CAP AL DASHBOARD (AMB LOCALE CORRECTE!)
  const { data: { user } } = await supabase.auth.getUser();
  
  if (user) {
    redirect(`/${locale}/dashboard`);
  }

  return (
    <main className="flex min-h-screen flex-col bg-slate-950 text-white overflow-hidden relative">
      


      {/* Fons Decoratiu */}
      <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0 pointer-events-none">
          <div className="absolute top-[-10%] left-[-10%] w-[500px] h-125 bg-blue-600/20 rounded-full blur-[100px]" />
          <div className="absolute bottom-[-10%] right-[-10%] w-[500px] h-[500px] bg-emerald-500/10 rounded-full blur-[100px]" />
      </div>

      {/* Contingut */}
      <div className="z-10 flex flex-col items-center justify-center min-h-screen px-4 text-center max-w-4xl mx-auto pt-20">
        
        {/* Badge */}
        <div className="mb-8 px-4 py-1.5 rounded-full border border-slate-700 bg-slate-900/50 backdrop-blur-sm text-sm text-slate-300 font-medium inline-flex items-center gap-2 animate-in fade-in slide-in-from-bottom-4 duration-700">
           <span className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
           {t('badge')}
        </div>

        {/* Títol Hero */}
        <h1 className="text-5xl md:text-7xl font-black mb-6 leading-tight tracking-tight animate-in fade-in slide-in-from-bottom-8 duration-700">
           {t('title_prefix')} <br/>
           <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-emerald-400">
             {t('title_highlight')}
           </span>
        </h1>

        <p className="text-lg md:text-xl text-slate-400 mb-10 max-w-2xl leading-relaxed animate-in fade-in slide-in-from-bottom-12 duration-700">
           {t('description')}
        </p>

        {/* Botons */}
        <div className="flex flex-col sm:flex-row gap-4 w-full sm:w-auto animate-in fade-in slide-in-from-bottom-16 duration-700">
           <Link 
             href="/login" 
             className="px-8 py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl transition-all hover:scale-105 active:scale-95 shadow-lg shadow-blue-500/25 flex items-center justify-center gap-2"
           >
             {t('cta_primary')} <ArrowRight className="w-5 h-5" />
           </Link>
           <Link 
             href="/about" 
             className="px-8 py-4 bg-slate-800 hover:bg-slate-700 text-white font-bold rounded-xl transition-all border border-slate-700"
           >
             {t('cta_secondary')}
           </Link>
        </div>

        {/* Icones Flotants (Decoració) */}
        <div className="absolute top-1/4 left-10 md:left-20 opacity-20 rotate-[-12deg] animate-pulse pointer-events-none">
            <Code2 className="w-24 h-24" />
        </div>
        <div className="absolute bottom-1/4 right-10 md:right-20 opacity-20 rotate-[12deg] animate-pulse pointer-events-none">
            <Terminal className="w-24 h-24" />
        </div>
      </div>
    </main>
  );
}

// =================== FILE: src/application/dto/dashboard-topic.dto.ts ===================

// filepath: src/application/dto/dashboard-topic.dto.ts
import { Topic } from "@/core/entities/topic.entity";

export interface DashboardTopicDTO extends Topic {
  progressPercentage: number; // 0 a 100
  totalXpEarned: number;
  currentLevel: number;
  isLocked: boolean; // Per si volem bloquejar temes avançats
}

// =================== FILE: src/application/dto/level-node.dto.ts ===================

// filepath: src/application/dto/level-node.dto.ts

import { ChallengeType } from '@/core/entities/challenges/challenge.entity';
export type LevelStatus = 'LOCKED' | 'ACTIVE' | 'COMPLETED';
export interface LevelNodeDTO {
  tier: number;
  status: LevelStatus;
  totalXp: number;
  label: string;
  // Nous camps visuals
  isCurrentPosition: boolean;
  predominantType: ChallengeType; 
}

// =================== FILE: src/application/dto/session-result.dto.ts ===================

// filepath: src/application/dto/session-result.dto.ts
export interface SessionResultDTO {
  xpEarned: number;
  newTotalXp: number;
  newLevel: number;
  leveledUp: boolean;
}

// =================== FILE: src/application/use-cases/auth/logout.use-case.test.ts ===================

// filepath: src/application/use-cases/auth/logout.use-case.test.ts
import { describe, it, expect, vi } from 'vitest';
import { LogoutUseCase } from './logout.use-case';
import { IAuthService } from '@/core/services/auth.service';

const mockAuthService = {
  login: vi.fn(),
  register: vi.fn(),
  logout: vi.fn(), // <--- Això és el que provarem
  getUser: vi.fn(),
} as unknown as IAuthService;

describe('LogoutUseCase', () => {
  it('should call auth service to sign out', async () => {
    // ARRANGE
    const useCase = new LogoutUseCase(mockAuthService);

    // ACT
    await useCase.execute();

    // ASSERT
    expect(mockAuthService.logout).toHaveBeenCalled();
  });
});

// =================== FILE: src/application/use-cases/auth/logout.use-case.ts ===================

// filepath: src/application/use-cases/auth/logout.use-case.ts
import { IAuthService } from '@/core/services/auth.service';

export class LogoutUseCase {
  constructor(private readonly authService: IAuthService) {}

  async execute(): Promise<void> {
    await this.authService.logout();
  }
}

// =================== FILE: src/application/use-cases/challenges/get-next-challenge.use-case.test.ts ===================

// filepath: src/application/use-cases/challenges/get-next-challenge.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { GetNextChallengeUseCase } from './get-next-challenge.use-case';
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { Challenge, ChallengeType, QuizContent } from '@/core/entities/challenges/challenge.entity';
import { Topic } from '@/core/entities/topic.entity';

// Mocks
const mockTopicRepo = {
  findBySlug: vi.fn(),
} as unknown as ITopicRepository;

const mockChallengeRepo = {
  findNextForUser: vi.fn(),
} as unknown as IChallengeRepository;

describe('GetNextChallengeUseCase', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should return challenges translated to the requested locale', async () => {
    // ARRANGE
    const locale = 'en';
    const topicSlug = 'react-basics';
    const userId = 'user-123';
    const topicId = 'topic-abc';
    const difficulty = 1;

    // 1. Simulem que trobem el tema
    const mockTopic: Topic = {
      id: topicId,
      slug: topicSlug,
      nameKey: 'topic.react.title',
      description: 'Test Description', // 👈 AFEGIT (soluciona l'error TS)
      iconName: 'brand-react',     
      colorTheme: 'bg-blue-500',
      isActive: true,              
      createdAt: new Date(),
      updatedAt: new Date()
    };

    vi.mocked(mockTopicRepo.findBySlug).mockResolvedValue(mockTopic);

    // 2. Simulem que el repositori retorna reptes
    const mockChallenges: Challenge[] = [
      {
        id: 'c1',
        topicId: topicId,
        difficultyTier: difficulty,
        type: 'QUIZ' as ChallengeType,
        content: {
          question: 'Question in English',
          explanation: 'Explanation',
          correctOptionIndex: 0,
          options: [{ id: 'o1', text: 'Option 1' }]
        },
        createdAt: new Date()
      }
    ];

    vi.mocked(mockChallengeRepo.findNextForUser).mockResolvedValue(mockChallenges);

    const useCase = new GetNextChallengeUseCase(mockTopicRepo, mockChallengeRepo);

    // ACT
    const result = await useCase.execute(topicSlug, userId, locale, difficulty);

    // ASSERT
    expect(mockTopicRepo.findBySlug).toHaveBeenCalledWith(topicSlug);
    expect(mockChallengeRepo.findNextForUser).toHaveBeenCalledWith(topicId, userId, locale, difficulty);
    
    expect(result).toHaveLength(1);
    
    const content = result[0].content as QuizContent;
    expect(content.question).toBe('Question in English');
  });
});

// =================== FILE: src/application/use-cases/challenges/get-next-challenge.use-case.ts ===================

// filepath: src/application/use-cases/challenges/get-next-challenge.use-case.ts
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { TopicNotFoundError } from '@/core/errors/topic.errors';

export class GetNextChallengeUseCase {
  constructor(
    private readonly topicRepository: ITopicRepository,
    private readonly challengeRepository: IChallengeRepository
  ) {}

  // 1. AFEGIM 'difficulty' A LA SIGNATURA
  async execute(topicSlug: string, userId: string, locale: string, difficulty: number): Promise<Challenge[]> {
    const topic = await this.topicRepository.findBySlug(topicSlug);

    if (!topic) {
      throw new TopicNotFoundError(topicSlug);
    }

    // 2. PASSEM 'difficulty' AL REPOSITORI
    return this.challengeRepository.findNextForUser(topic.id, userId, locale, difficulty);
  }
}

// =================== FILE: src/application/use-cases/dashboard/get-user-dashboard.use-case.ts ===================

// filepath: src/application/use-cases/dashboard/get-user-dashboard.use-case.ts
import { ITopicRepository } from "@/core/repositories/topic.repository";
import { DashboardTopicDTO } from "@/application/dto/dashboard-topic.dto";
import { SupabaseClient } from "@supabase/supabase-js"; 

// Nota: Normalment injectariem un IUserProgressRepository, 
// però per agilitzar la demo farem la consulta de progrés aquí o passarem el client.
// Per Clean Arch estricta, hauries de crear IUserProgressRepository.

export class GetUserDashboardUseCase {
  constructor(private topicRepository: ITopicRepository) {}

  async execute(userId: string, locale: string, supabaseClient: SupabaseClient): Promise<DashboardTopicDTO[]> {
    // 1. Obtenir tots els temes actius (traduïts)
    // Assumim que el teu repo ja suporta locale, si no, usa el que tinguis
    const topics = await this.topicRepository.findAllActive(); 

    // 2. Obtenir el progrés de l'usuari (Raw query a Supabase per velocitat)
    const { data: progressData } = await supabaseClient
        .from('user_progress')
        .select('topic_id, xp_earned')
        .eq('user_id', userId);

    // 3. Fusionar dades (Mapping)
    return topics.map(topic => {
        // Calculem XP total per aquest tema
        const topicProgress = progressData?.filter(p => p.topic_id === topic.id) || [];
        const totalXp = topicProgress.reduce((sum, p) => sum + (p.xp_earned || 0), 0);
        
        // Càlcul simplificat de percentatge (Ex: 1000 XP = 100%)
        // Més endavant ho farem comptant reptes totals vs reptes fets
        const percentage = Math.min(100, (totalXp / 500) * 100); 

        return {
            ...topic,
            progressPercentage: Math.round(percentage),
            totalXpEarned: totalXp,
            currentLevel: Math.floor(totalXp / 100) + 1,
            isLocked: false // Lògica futura de bloqueig
        };
    });
  }
}

// =================== FILE: src/application/use-cases/gamification/complete-session.use-case.test.ts ===================

// filepath: src/application/use-cases/gamification/complete-session.use-case.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { CompleteSessionUseCase } from './complete-session.use-case';
import { IUserRepository, UserProfile } from '@/core/repositories/user.repository';

// Mock del Repositori
const mockUserRepo = {
  findById: vi.fn(),
  saveProgress: vi.fn(),
  updateXp: vi.fn(),
} as unknown as IUserRepository;

describe('CompleteSessionUseCase', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('should calculate XP, save progress and level up user', async () => {
    // ARRANGE (Preparem l'escenari)
    const userId = 'user-123';
    const challengeIds = ['c1', 'c2', 'c3']; // 3 reptes fets
    const topicId = 'topic-react';
    
    // Simulem un usuari que té 90 XP (i pujarà de nivell aviat)
    const mockUser: UserProfile = { 
      id: userId, 
      totalXp: 90, 
      level: 1 
    };

    vi.mocked(mockUserRepo.findById).mockResolvedValue(mockUser);

    const useCase = new CompleteSessionUseCase(mockUserRepo);

    // ACT (Executem)
    const result = await useCase.execute(userId, challengeIds, topicId);

    // ASSERT (Verifiquem)
    
    // 1. Ha de guanyar 30 XP (3 reptes * 10 XP)
    expect(result.xpEarned).toBe(30);
    
    // 2. XP Total: 90 + 30 = 120
    expect(result.newTotalXp).toBe(120);
    
    // 3. Com que supera els 100 XP, ha de ser Nivell 2
    expect(result.newLevel).toBe(2); 
    expect(result.leveledUp).toBe(true);

    // 4. Verifiquem que s'ha cridat al repositori per guardar
    expect(mockUserRepo.saveProgress).toHaveBeenCalledWith(userId, challengeIds, topicId, 10);
    expect(mockUserRepo.updateXp).toHaveBeenCalledWith(userId, 120, 2);
  });
});

// =================== FILE: src/application/use-cases/gamification/complete-session.use-case.ts ===================

// filepath: src/application/use-cases/gamification/complete-session.use-case.ts
import { IUserRepository } from '@/core/repositories/user.repository';
import { LevelCalculatorService } from '@/core/services/level-calculator.service';

export interface SessionResult {
  xpEarned: number;
  newTotalXp: number;
  newLevel: number;
  leveledUp: boolean;
}

export class CompleteSessionUseCase {
  private levelService = new LevelCalculatorService();

  constructor(private readonly userRepository: IUserRepository) {}

  async execute(userId: string, challengeIds: string[], topicId: string): Promise<SessionResult> {
    const XP_PER_CHALLENGE = 10;
    const totalXpEarned = challengeIds.length * XP_PER_CHALLENGE;

    // 1. Obtenim estat actual
    const userProfile = await this.userRepository.findById(userId);
    
    if (!userProfile) {
      throw new Error(`User ${userId} not found`);
    }

    // 2. Guardem el progrés detallat
    await this.userRepository.saveProgress(userId, challengeIds, topicId, XP_PER_CHALLENGE);

    // 3. Calculem nous valors
    const oldLevel = userProfile.level;
    const newTotalXp = userProfile.totalXp + totalXpEarned;
    const newLevel = this.levelService.calculateLevel(newTotalXp);

    // 4. Actualitzem el perfil si ha canviat alguna cosa
    if (newTotalXp !== userProfile.totalXp) {
        await this.userRepository.updateXp(userId, newTotalXp, newLevel);
    }

    return {
      xpEarned: totalXpEarned,
      newTotalXp,
      newLevel,
      leveledUp: newLevel > oldLevel
    };
  }
}

// =================== FILE: src/application/use-cases/topics/get-active-topics.use-case.test.ts ===================

// filepath: src/application/use-cases/topics/get-active-topics.use-case.test.ts
import { describe, it, expect, vi } from 'vitest';
import { GetActiveTopicsUseCase } from './get-active-topics.use-case';
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { Topic } from '@/core/entities/topic.entity';

// 1. Creem un Mock del Repositori
const mockTopicRepo = {
  findAllActive: vi.fn(),
  findAll: vi.fn(),
  findById: vi.fn(),
  findBySlug: vi.fn(),
  create: vi.fn(),
  update: vi.fn(),
} as unknown as ITopicRepository;

describe('GetActiveTopicsUseCase', () => {
  it('should return a list of active topics', async () => {
    // ARRANGE (Preparar)
    const mockTopics: Topic[] = [
      { 
        id: '123', 
        slug: 'react', 
        nameKey: 'topic.react', 
        iconName: 'react', 
        colorTheme: 'blue', 
        isActive: true, 
        createdAt: new Date(), 
        updatedAt: new Date() 
      }
    ];
    
    // Configurem el mock per retornar les dades falses
    vi.mocked(mockTopicRepo.findAllActive).mockResolvedValue(mockTopics);

    const useCase = new GetActiveTopicsUseCase(mockTopicRepo);

    // ACT (Executar)
    const result = await useCase.execute();

    // ASSERT (Verificar)
    expect(result).toHaveLength(1);
    expect(result[0].slug).toBe('react');
    expect(mockTopicRepo.findAllActive).toHaveBeenCalledTimes(1);
  });

  it('should return empty list if no topics found', async () => {
    vi.mocked(mockTopicRepo.findAllActive).mockResolvedValue([]);
    const useCase = new GetActiveTopicsUseCase(mockTopicRepo);
    
    const result = await useCase.execute();
    
    expect(result).toEqual([]);
  });
});

// =================== FILE: src/application/use-cases/topics/get-active-topics.use-case.ts ===================

// filepath: src/application/use-cases/topics/get-active-topics.use-case.ts
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { Topic } from '@/core/entities/topic.entity';

/**
 * Cas d'Ús: Obtenir el llistat de temes disponibles per als usuaris.
 * Només retorna els que tenen isActive: true.
 */
export class GetActiveTopicsUseCase {
  // Injectem la interfície, no la implementació de Supabase!
  constructor(private readonly topicRepository: ITopicRepository) {}

  async execute(): Promise<Topic[]> {
    return this.topicRepository.findAllActive();
  }
}

// =================== FILE: src/application/use-cases/topics/get-topic-path.use-case.ts ===================

// filepath: src/application/use-cases/topics/get-topic-path.use-case.ts
import { ITopicRepository } from '@/core/repositories/topic.repository';
import { LevelNodeDTO, LevelStatus } from '@/application/dto/level-node.dto';
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';

export class GetTopicPathUseCase {

  constructor(private topicRepo: ITopicRepository) { }

  async execute(userId: string, topicId: string) {
    const stats = await this.topicRepo.getTopicProgressSummary(topicId, userId);
    const levels: LevelNodeDTO[] = [];

    // CAS 1: L'usuari mai ha tocat aquest tema (Array buit)
    // Retornem el nivell 1 desbloquejat per defecte.
    if (stats.length === 0) {
      return {
        levels: [{
          tier: 1,
          status: 'ACTIVE' as LevelStatus,
          label: 'Inici',
          totalXp: 0,
          isCurrentPosition: true,
          predominantType: 'QUIZ' as ChallengeType, // ✅ Forcem el tipus aquí també
        }],
        totalXp: 0
      };
    }

    let isPreviousLevelCompleted = true;

    // CAS 2: Iterem sobre l'històric real
    for (let i = 0; i < stats.length; i++) {
      const stat = stats[i];
      let status: LevelStatus = 'LOCKED';

      const isCompleted = stat.completedChallenges >= stat.totalChallenges && stat.totalChallenges > 0;

      if (isCompleted) {
        status = 'COMPLETED';
      } else if (isPreviousLevelCompleted) {
        status = 'ACTIVE';
        isPreviousLevelCompleted = false; // Ja tenim un actiu, el següent serà locked
      } else {
        status = 'LOCKED';
      }

      // Lògica per saber on posar el ninotet "You are here"
      const isCurrentPosition = status === 'ACTIVE' || (status === 'COMPLETED' && !stats[i + 1]);

      levels.push({
        tier: stat.tier,
        status,
        label: this.getLevelLabel(stat.tier),
        totalXp: stat.completedChallenges,
        isCurrentPosition: isCurrentPosition, 
        
        // ✅ CORRECCIÓ CLAU:
        // 1. Fem 'as ChallengeType' per calmar TypeScript.
        // 2. Afegim '|| 'QUIZ'' per seguretat si la BD retorna null.
        predominantType: (stat.mostCommonType as ChallengeType) || 'QUIZ'
      });

      if (status === 'COMPLETED') {
        isPreviousLevelCompleted = true;
      }
    }

    // CAS 3: Nivell Següent (Future Level)
    // Si l'últim nivell conegut està completat, n'obrim un de nou buit.
    const lastLevel = levels[levels.length - 1];
    if (lastLevel && lastLevel.status === 'COMPLETED') {
      levels.push({
        tier: lastLevel.tier + 1,
        status: 'ACTIVE' as LevelStatus,
        label: '???',
        totalXp: 0,
        isCurrentPosition: true,
        predominantType: 'QUIZ' as ChallengeType // Per defecte el futur és QUIZ fins que es descobreix
      });
    }

    const totalXp = levels.reduce((acc, curr) => acc + curr.totalXp, 0);
    return { levels, totalXp };
  }

  private getLevelLabel(tier: number): string {
    const labels = ["Fonaments", "Conceptes Clau", "Pràctica", "Avançat", "Expert", "Mestre", "Llegenda"];
    return labels[tier - 1] || `Nivell ${tier}`;
  }
}

// =================== FILE: src/core/entities/challenges/challenge.entitiy.test.ts ===================

// filepath: src/core/entities/challenges/challenge.entity.test.ts
import { describe, it, expect } from 'vitest';

// ✅ CORRECCIÓ 1: Importem des del './index' (Barrel File)
// Aquest fitxer agrupa totes les exportacions de la carpeta 'challenges'
import { Challenge, CodeFixContent } from './index'; 

describe('Challenge Entity Polymorphism', () => {
  
  it('should correctly type a CODE_FIX challenge', () => {
    // Arrange
    const codeChallenge: Challenge = {
      id: '1',
      topicId: 'react',
      difficultyTier: 1,
      type: 'CODE_FIX',
      createdAt: new Date(),
      content: {
        description: 'Completa el hook',
        initialCode: 'const [val, setVal] = ___(0);',
        solution: 'useState',
        tests: [],
        // ✅ CORRECCIÓ 2: Afegim camps obligatoris definits a la interfície
        hint: 'Pensa en el hook d\'estat',
        options: [] 
      } as CodeFixContent
    };

    // Act & Assert
    if (codeChallenge.type === 'CODE_FIX') {
        // TypeScript ara sap segur que és CodeFixContent gràcies a l'import correcte
        const content = codeChallenge.content as CodeFixContent;
        
        expect(content.initialCode).toContain('___');
        expect(content.solution).toBe('useState');
    } else {
        throw new Error('Type guard failed');
    }
  });
});

// =================== FILE: src/core/entities/challenges/challenge.entity.ts ===================

// filepath: src/core/entities/challenges/challenge.entity.ts
import { QuizContent } from './definitions/quiz.content';
import { CodeFixContent } from './definitions/code-fix.content';
import { MatchingContent } from './definitions/matching.content';
import { TerminalContent } from './definitions/terminal.content';
import { LogicOrderContent } from './definitions/logic-order.content';

// 1. Tipus de Repte (Enum strings)
export type ChallengeType = 
  | 'QUIZ' 
  | 'CODE_FIX' 
  | 'MATCHING' 
  | 'TERMINAL' 
  | 'LOGIC_ORDER';

// 2. Unió Discriminada (Polimorfisme)
export type ChallengeContent = 
  | QuizContent 
  | CodeFixContent 
  | MatchingContent
  | TerminalContent 
  | LogicOrderContent;

// 3. Entitat de Domini
export interface Challenge {
  id: string;
  topicId: string;
  difficultyTier: number;
  type: ChallengeType;
  content: ChallengeContent;
  createdAt: Date;
}

// =================== FILE: src/core/entities/challenges/definitions/code-fix.content.ts ===================

// filepath: src/core/entities/challenges/definitions/code-fix.content.ts
export interface CodeFixOption {
  id: string;
  code: string;
  isCorrect: boolean;
}

export interface CodeFixContent {
  description: string;
  initialCode: string;
  solution: string;
  hint: string;
  tests: { input: string; output: string }[];
  options: CodeFixOption[];
}

// =================== FILE: src/core/entities/challenges/definitions/logic-order.content.ts ===================

// filepath: src/core/entities/challenges/definitions/logic-order.content.ts
import { ChallengeOption } from './shared';

export interface LogicOrderContent {
  description: string;    
  items: ChallengeOption[]; // Els items que arribaran DESORDENATS al client
}

// =================== FILE: src/core/entities/challenges/definitions/matching.content.ts ===================

// filepath: src/core/entities/challenges/definitions/matching.content.ts
import { ChallengeOption } from './shared';

export interface MatchingContent {
  instruction: string;
  pairs: { 
    left: ChallengeOption; 
    right: ChallengeOption 
  }[];
}

// =================== FILE: src/core/entities/challenges/definitions/quiz.content.ts ===================

// filepath: src/core/entities/challenges/definitions/quiz.content.ts
import { ChallengeOption } from './shared';

export interface QuizContent {
  question: string;
  explanation: string;
  options: ChallengeOption[]; 
  correctOptionIndex: number;
}

// =================== FILE: src/core/entities/challenges/definitions/shared.ts ===================

// filepath: src/core/entities/challenges/definitions/shared.ts
export interface ChallengeOption {
  id: string;
  text: string;
}

// =================== FILE: src/core/entities/challenges/definitions/terminal.content.ts ===================

// filepath: src/core/entities/challenges/definitions/terminal.content.ts
export interface TerminalContent {
  instruction: string;      
  initialCommand?: string;  
  validCommands: string[];  
  hint: string;             
  explanation: string;      
  outputParams: {
    success: string;        
    error: string;          
  };
}

// =================== FILE: src/core/entities/challenges/index.ts ===================

// filepath: src/core/entities/challenges/index.ts
export * from './definitions/shared';
export * from './definitions/quiz.content';
export * from './definitions/code-fix.content';
export * from './definitions/matching.content';
export * from './definitions/terminal.content';
export * from './definitions/logic-order.content';

export * from './challenge.entity';

// =================== FILE: src/core/entities/topic.entity.ts ===================

// filepath: src/core/entities/topic.entity.ts

/**
 * Representa una categoria o àrea d'aprenentatge dins del sistema.
 * Aquesta entitat és agnòstica a la base de dades.
 */
export interface Topic {
  id: string;              // UUID
  slug: string;            // URL friendly ID (ex: 'react-basics')
  nameKey: string;         // Clau de traducció i18n (ex: 'topic.react.title')
  iconName: string;        // Identificador de la icona (ex: 'brand-react')
  colorTheme: string;      // Classe CSS o Hex (ex: 'bg-blue-500')
  parentTopicId?: string;  // Opcional: Per a jerarquies
  isActive: boolean;       // Per a soft-deletes i control de visibilitat
  description: string,
  // Metadades d'auditoria (opcionals al domini pur, però útils)
  createdAt: Date;
  updatedAt: Date;
}

/**
 * Tipus per a la creació d'un nou tema (sense ID ni dates)
 */
export type CreateTopicInput = Omit<Topic, 'id' | 'createdAt' | 'updatedAt'>;

// =================== FILE: src/core/errors/domain-error.ts ===================

// filepath: src/core/errors/domain-error.ts
export abstract class DomainError extends Error {
  constructor(message: string) {
    super(message);
    this.name = this.constructor.name;
    Object.setPrototypeOf(this, new.target.prototype);
  }
}

// =================== FILE: src/core/errors/topic.errors.ts ===================

// filepath: src/core/errors/topic.errors.ts
import { DomainError } from './domain-error';

export class TopicNotFoundError extends DomainError {
  constructor(identifier: string) {
    super(`El tema amb identificador '${identifier}' no s'ha trobat.`);
  }
}

export class TopicAlreadyExistsError extends DomainError {
  constructor(slug: string) {
    super(`Ja existeix un tema amb l'slug '${slug}'.`);
  }
}

// =================== FILE: src/core/errors/user-not-found.error.ts ===================

// filepath: src/core/errors/user-not-found.error.ts
export class UserNotFoundError extends Error {
  constructor(userId: string) {
    super(`User with ID ${userId} could not be found.`);
    this.name = 'UserNotFoundError';
  }
}

// =================== FILE: src/core/repositories/challenge.repository.ts ===================

// filepath: src/core/repositories/challenge.repository.ts
import { Challenge } from '../entities/challenges/challenge.entity';

export interface IChallengeRepository {
  /**
   * Obté el següent repte per a un usuari en un tema,
   * traduït a l'idioma especificat.
   */
  findNextForUser(topicId: string, userId: string, locale: string, difficulty: number): Promise<Challenge[]>;

  // (Opcional) Si necessites aquests altres mètodes, també han de rebre locale
  findByTopicId(topicId: string, locale: string): Promise<Challenge[]>;
  findById(id: string, locale: string): Promise<Challenge | null>;
}

// =================== FILE: src/core/repositories/topic.repository.ts ===================

// filepath: src/core/repositories/topic.repository.ts
import { Topic, CreateTopicInput } from '../entities/topic.entity';
import { ChallengeType } from '../entities/challenges/challenge.entity'; // Importa el tipus
export interface TierProgressStats {
  tier: number;
  totalChallenges: number;
  completedChallenges: number;
  mostCommonType: ChallengeType; // <--- NOU CAMP
}
/**
 * Contracte que qualsevol adaptador de persistència (Infrastructure) ha de complir.
 * Retorna Promises perquè l'I/O és asíncron, però retorna entitats de Domini.
 */
export interface ITopicRepository {
  /**
   * Obté tots els temes actius.
   */
  findAllActive(): Promise<Topic[]>;

  /**
   * Obté tots els temes (inclosos els inactius) - Útil per a Admin.
   */
  findAll(): Promise<Topic[]>;

  /**
   * Cerca un tema pel seu ID.
   * @returns El tema o null si no existeix.
   */
  findById(id: string): Promise<Topic | null>;

  /**
   * Cerca un tema pel seu slug (per a rutes públiques).
   * @returns El tema o null si no existeix.
   */
  findBySlug(slug: string): Promise<Topic | null>;

  /**
   * Crea un nou tema.
   */
  create(topic: CreateTopicInput): Promise<Topic>;
  
  /**
   * Actualitza un tema existent.
   */
  update(id: string, topic: Partial<CreateTopicInput>): Promise<Topic>;

  getTopicProgressSummary(topicId: string, userId: string): Promise<TierProgressStats[]>;
}

// =================== FILE: src/core/repositories/user.repository.ts ===================

// filepath: src/core/repositories/user.repository.ts
export interface UserProfile {
  id: string;
  totalXp: number;
  level: number;
}

export interface IUserRepository {
  findById(userId: string): Promise<UserProfile | null>;
  saveProgress(userId: string, challengeIds: string[], topicId: string, xpPerChallenge: number): Promise<void>;
  updateXp(userId: string, newXp: number, newLevel: number): Promise<void>;
}

// =================== FILE: src/core/services/auth.service.ts ===================

// filepath: src/core/services/auth.service.ts
export interface UserIdentity {
  id: string;
  email: string;
}

export interface IAuthService {
  logout(): Promise<void>;
  getUser(): Promise<UserIdentity | null>;
  // Login i Register els gestiona Supabase directament via Actions, 
  // però el Logout és millor passar-lo per aquí per neteja.
}

// =================== FILE: src/core/services/level-calculator.service.ts ===================

// filepath: src/core/services/level-calculator.service.ts
export class LevelCalculatorService {
  /**
   * Fórmula simple: Nivell = (TotalXP / 100) + 1
   * 0-99 XP -> Nivell 1
   * 100-199 XP -> Nivell 2
   */
  calculateLevel(totalXp: number): number {
    if (totalXp < 0) return 1;
    return Math.floor(totalXp / 100) + 1;
  }

  /**
   * Calcula el % de progrés cap al següent nivell.
   */
  calculateProgressToNextLevel(totalXp: number): number {
    const currentLevel = this.calculateLevel(totalXp);
    const xpForCurrentLevel = (currentLevel - 1) * 100;
    const xpInCurrentLevel = totalXp - xpForCurrentLevel;
    
    return Math.min(100, Math.max(0, xpInCurrentLevel));
  }
}

// =================== FILE: src/i18n.ts ===================

// filepath: src/i18n.ts
import { notFound } from 'next/navigation';
import { getRequestConfig } from 'next-intl/server';
import { routing, type Locale } from './routing';

export default getRequestConfig(async ({ requestLocale }) => {
  const locale = await requestLocale;

  // Validació sense 'any':
  // Convertim routing.locales a llista d'strings genèrics per comprovar
  if (!locale || !(routing.locales as readonly string[]).includes(locale)) {
    notFound(); // Ara sí que l'executem si la validació falla
  }

  return {
    // Aquí ja estem segurs que 'locale' és vàlid, podem fer el cast segur a Locale
    locale: locale as Locale,
    messages: (await import(`../messages/${locale}.ts`)).default
  };
});

// =================== FILE: src/infrastructure/mappers/challenge.mappers.ts ===================

// filepath: src/infrastructure/mappers/challenge.mappers.ts
import { ChallengeContent } from '@/core/entities/challenges/challenge.entity';
import { translate, LocalizedString } from './mapper.utils';

// --- DEFINICIONS DE DADES "RAW" (Així és com ve el JSON de BD) ---

interface RawOption {
  id: string;
  text: LocalizedString;
}

interface RawQuizContent {
  question: LocalizedString;
  explanation: LocalizedString;
  options: RawOption[];
  correctOptionIndex: number;
}
// 1. DEFINICIÓ RAW (Com ve de la BD)
interface RawLogicOrderContent {
  description: LocalizedString;
  items: Array<{ id: string; text: LocalizedString }>;
}
// Suport per a dades antigues (Legacy)
interface LegacyRawQuizContent {
  question?: string;
  explanation?: string;
  options?: string[];
  correctOptionIndex?: number;
}

interface RawMatchingContent {
  instruction: LocalizedString;
  pairs: Array<{
    left: { id: string; text: LocalizedString };
    right: { id: string; text: LocalizedString };
  }>;
}

interface RawCodeFixContent {
  description: LocalizedString;
  initialCode: string;
  solution: string;
  hint: LocalizedString;
  tests?: Array<{ input: string; output: string }>;
  options: Array<{
    id: string;
    code: string;
    isCorrect: boolean;
  }>;
}

interface RawTerminalContent {
  instruction: LocalizedString;
  initialCommand?: string;
  validCommands: string[];
  hint: LocalizedString;
  explanation: LocalizedString;
  outputParams: {
    success: string;
    error: string;
  };
}

// --- INTERFÍCIE D'ESTRATÈGIA ---
interface ContentMapperStrategy {
  // L'entrada és 'unknown' perquè ve de la BD/JSON. No assumim res fins a validar.
  map(rawData: unknown, locale: string): ChallengeContent;
}

// --- 1. QUIZ MAPPER ---
class QuizMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    // 1. Intentem tractar-lo com a format nou
    const content = rawData as Partial<RawQuizContent>;
    const legacyContent = rawData as Partial<LegacyRawQuizContent>;

    // Type Guard simple: Si té 'options' i és un array d'objectes -> Format Nou
    const isNewFormat = 
      content.options && 
      Array.isArray(content.options) && 
      content.options.length > 0 &&
      typeof content.options[0] === 'object';

    if (isNewFormat) {
      // Ara TypeScript sap que 'content' és compatible amb RawQuizContent en aquest bloc
      const validContent = content as RawQuizContent;
      
      return {
        question: translate(validContent.question, locale),
        explanation: translate(validContent.explanation, locale),
        correctOptionIndex: validContent.correctOptionIndex,
        options: validContent.options.map((opt) => ({
          id: opt.id,
          text: translate(opt.text, locale)
        }))
      };
    } else {
      // Legacy handling
      const opts = legacyContent.options || [];
      return {
        question: String(legacyContent.question || ''),
        explanation: String(legacyContent.explanation || ''),
        correctOptionIndex: legacyContent.correctOptionIndex || 0,
        options: Array.isArray(opts) ? opts.map((txt, idx) => ({
          id: `opt-${idx}`,
          text: String(txt)
        })) : []
      }; // No cal cast a 'any', ja retorna ChallengeContent (QuizContent)
    }
  }
}

// --- 2. MATCHING MAPPER ---
class MatchingMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawMatchingContent;

    return {
      instruction: translate(content.instruction, locale),
      pairs: Array.isArray(content.pairs)
        ? content.pairs.map((p) => ({
            left: { id: p.left.id, text: translate(p.left.text, locale) },
            right: { id: p.right.id, text: translate(p.right.text, locale) }
          }))
        : []
    };
  }
}

// --- 3. CODE FIX MAPPER ---
class CodeFixMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawCodeFixContent;

    return {
      description: translate(content.description, locale),
      initialCode: content.initialCode || '',
      solution: content.solution || '',
      hint: translate(content.hint, locale),
      tests: content.tests || [],
      options: Array.isArray(content.options) ? content.options.map((opt) => ({
        id: opt.id,
        code: opt.code,
        isCorrect: opt.isCorrect
      })) : []
    };
  }
}

// --- 4. TERMINAL MAPPER ---
class TerminalMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawTerminalContent;

    return {
      instruction: translate(content.instruction, locale),
      initialCommand: content.initialCommand || '',
      validCommands: Array.isArray(content.validCommands) ? content.validCommands : [],
      hint: translate(content.hint, locale),
      explanation: translate(content.explanation, locale),
      outputParams: {
        success: content.outputParams?.success || 'OK',
        error: content.outputParams?.error || 'Error'
      }
    };
  }
}


// 2. LOGIC ORDER MAPPER (NOU)
class LogicOrderMapper implements ContentMapperStrategy {
  map(rawData: unknown, locale: string): ChallengeContent {
    const content = rawData as RawLogicOrderContent;

    return {
      description: translate(content.description, locale),
      items: Array.isArray(content.items)
        ? content.items.map(item => ({
            id: item.id,
            text: translate(item.text, locale)
          }))
        : []
    };
  }
}

// --- FACTORY ---
export const ChallengeMapperFactory = {
  getMapper(type: string): ContentMapperStrategy {
    switch (type) {
      case 'QUIZ': return new QuizMapper();
      case 'MATCHING': return new MatchingMapper();
      case 'CODE_FIX': return new CodeFixMapper();
      case 'TERMINAL': return new TerminalMapper();
      case 'LOGIC_ORDER': return new LogicOrderMapper();
      default:
        console.warn(`Unknown challenge type: ${type}. Fallback to Quiz.`);
        return new QuizMapper();
    }
  }
};

// =================== FILE: src/infrastructure/mappers/mapper.utils.ts ===================

// filepath: src/infrastructure/mappers/mapper.utils.ts

export type LocalizedString = Record<string, string>;

/**
 * Tradueix un camp que pot ser string, objecte localitzat o null/unknown.
 */
export function translate(field: unknown, locale: string): string {
  if (typeof field === 'string') return field;
  
  if (!field || typeof field !== 'object') return '';

  // Fem un cast segur perquè sabem que és un objecte, 
  // però accedim amb comprovació de claus
  const localized = field as Record<string, unknown>;
  
  const val = localized[locale] || localized['ca'] || localized['en'] || Object.values(localized)[0];
  
  return typeof val === 'string' ? val : '';
}

/**
 * Parsea el JSON de forma segura retornant 'unknown' en lloc de 'any'.
 * Això obliga a qui ho usi a definir el tipus esperat.
 */
export function parseJsonContent(content: unknown): unknown {
  if (typeof content === 'string') {
    try {
      return JSON.parse(content);
    } catch (e) {
      console.error('Error parsing JSON content', e);
      return {};
    }
  }
  return content || {};
}

// =================== FILE: src/infrastructure/mappers/__tests__/TerminalMapper.test.ts ===================

// filepath: src/infrastructure/mappers/__tests__/TerminalMapper.test.ts
import { describe, it, expect } from 'vitest';
import { ChallengeMapperFactory } from '../challenge.mappers';
import { TerminalContent } from '@/core/entities/challenges/challenge.entity';

describe('TerminalMapper', () => {
    const mapper = ChallengeMapperFactory.getMapper('TERMINAL');

    it('hauria de mapejar un JSON complet correctament al català', () => {
        const rawData = {
            instruction: { ca: 'Fes això', en: 'Do this' },
            initialCommand: 'docker',
            validCommands: ['docker ps', 'docker ls'],
            hint: { ca: 'Pista', en: 'Hint' },
            explanation: { ca: 'Explicació', en: 'Expl' },
            outputParams: { success: 'Ok', error: 'Fail' }
        };

        const result = mapper.map(rawData, 'ca') as TerminalContent;

        expect(result).toEqual({
            instruction: 'Fes això',
            initialCommand: 'docker',
            validCommands: ['docker ps', 'docker ls'],
            hint: 'Pista',
            explanation: 'Explicació',
            outputParams: { success: 'Ok', error: 'Fail' }
        });
    });

    it('hauria de fer fallback a langlès o valors per defecte si falta traducció', () => {
        const rawData = {
            instruction: { en: 'Do this' }, // No hi ha 'ca'
            
            // CORRECCIÓ: Posem comandes reals. Si posem null, el mapper retornarà [], no 2.
            // Volem provar que SI hi ha comandes, es mantenen encara que falti la traducció.
            validCommands: ['ls -la', 'ls -l -a'], 
            
            outputParams: {}
        };

        const result = mapper.map(rawData, 'ca') as TerminalContent;

        // Ara sí que té sentit esperar 2 comandes
        expect(result.validCommands).toHaveLength(2); 
        expect(result.instruction).toBe('Do this'); // Fallback a anglès
        expect(result.validCommands[0]).toBe('ls -la');
    });

    it('hauria de gestionar inputs corruptes sense llançar excepció', () => {
        const rawCorrupt = "Això no és un objecte";
        const result = mapper.map(rawCorrupt, 'ca');
        expect(result).toBeDefined();
        expect(result).toHaveProperty('instruction');
    });
});

// =================== FILE: src/infrastructure/repositories/supabase/challenge.repository.test.ts ===================

// filepath: src/infrastructure/repositories/supabase/challenge.repository.test.ts
import { describe, it, expect, vi } from 'vitest';
import { SupabaseChallengeRepository } from './challenge.repository';
import { QuizContent } from '@/core/entities/challenges/challenge.entity';
// Importem el client "RAW" de l'SDK oficial, no el nostre wrapper de Next.js
import { createClient as createRawSupabaseClient } from '@supabase/supabase-js';

// --- 1. CONFIGURACIÓ DE L'ENTORN DE TEST ---

// Necessitem l'URL i la Key. En test, solem usar la SERVICE_ROLE_KEY per saltar-nos les RLS i poder crear/esborrar dades lliurement.
// Si no tens SERVICE_ROLE_KEY al .env.test, usa l'ANON_KEY, però assegura't que les RLS permeten escriptura.
const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL || '';
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || '';

if (!SUPABASE_URL || !SUPABASE_KEY) {
  throw new Error('Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY in .env.test');
}

// Creem un client real que funciona en Node (sense cookies)
const testClient = createRawSupabaseClient(SUPABASE_URL, SUPABASE_KEY, {
  auth: {
    persistSession: false, // No volem guardar sessió en disc durant els tests
  }
});

// --- 2. MOCK MÀGIC (DEPENDENCY INJECTION) ---
// Aquí diem: "Quan algú importi '@/infrastructure/utils/supabase/server',
// NO executis el codi real (que peta per les cookies).
// Retorna aquest objecte en el seu lloc."
vi.mock('@/infrastructure/utils/supabase/server', () => ({
  createClient: async () => testClient
}));

// --- 3. EL TEST ---

describe('SupabaseChallengeRepository (REAL DB INTEGRATION)', () => {
  // El repositori farà servir internament el nostre 'testClient' gràcies al mock
  const repository = new SupabaseChallengeRepository();

  it('should store and retrieve a localized JSONB challenge correctly', async () => {
    // A. SETUP: Creem les dades usant el client de test directament
    const topicId = '11111111-1111-4111-8111-111111111111';
    const challengeId = '22222222-2222-4222-8222-222222222222';
    const testSlug = 'integration-test-topic'; // Constant per evitar typos
    const userId = 'user-test-123';

    // 🔥 NETEJA AGRESSIVA (Idempotència)
    // Esborrem primer pel conflicte únic (slug) i després per ID.
    // Això garanteix que la taula està neta abans de començar, passi el que passi.
    await testClient.from('challenges').delete().eq('id', challengeId);
    await testClient.from('topics').delete().eq('slug', testSlug);
    await testClient.from('topics').delete().eq('id', topicId);

    // Crear Tema
    const { error: topicError } = await testClient.from('topics').insert({
      id: topicId,
      slug: 'integration-test-topic',
      name_key: 'test',
      icon_name: 'test',
      color_theme: 'red',
      is_active: true
    });
    if (topicError) throw new Error(`Error creating topic: ${topicError.message}`);

    // Crear Repte
    const { error: challengeError } = await testClient.from('challenges').insert({
      id: challengeId,
      topic_id: topicId,
      difficulty_tier: 1,
      type: 'QUIZ',
      content: {
        question: { en: 'Hello?', ca: 'Hola?' },
        explanation: { en: 'Yes', ca: 'Si' },
        options: [{ id: '1', text: { en: 'A', ca: 'A' } }],
        correctOptionIndex: 0
      },
      created_at: new Date().toISOString()
    });
    if (challengeError) throw new Error(`Error creating challenge: ${challengeError.message}`);

    // B. ACT: Provem el Repositori
    // Aquesta crida internament farà `await createClient()` que retornarà el nostre `testClient`
    const result = await repository.findNextForUser(topicId, userId, 'en', 1);

    // C. ASSERT
    expect(result).toHaveLength(1);
    const challenge = result[0];
    const content = challenge.content as QuizContent;

    expect(challenge.id).toBe(challengeId);
    expect(content.question).toBe('Hello?');

    // D. CLEANUP
    await testClient.from('challenges').delete().eq('id', challengeId);
    await testClient.from('topics').delete().eq('id', topicId);
  });
});

// =================== FILE: src/infrastructure/repositories/supabase/challenge.repository.ts ===================

// filepath: src/infrastructure/repositories/supabase/challenge.repository.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { IChallengeRepository } from '@/core/repositories/challenge.repository';
import { Challenge, ChallengeType } from '@/core/entities/challenges/challenge.entity';
import { parseJsonContent } from '@/infrastructure/mappers/mapper.utils';
import { ChallengeMapperFactory } from '@/infrastructure/mappers/challenge.mappers';

type ChallengeRow = {
  id: string;
  topic_id: string;
  difficulty_tier: number;
  type: string;
  content: unknown;
  created_at: string;
};

export class SupabaseChallengeRepository implements IChallengeRepository {

  // Aquesta funció ara és super neta gràcies al patró Strategy
  private mapToEntity(row: ChallengeRow, locale: string): Challenge {
    const rawData = parseJsonContent(row.content);
    const mapper = ChallengeMapperFactory.getMapper(row.type);
    
    // Deleguem la complexitat al mapper específic
    const localizedContent = mapper.map(rawData, locale);

    return {
      id: row.id,
      topicId: row.topic_id,
      difficultyTier: row.difficulty_tier,
      type: row.type as ChallengeType,
      content: localizedContent,
      createdAt: new Date(row.created_at),
    };
  }

  // --- PUBLIC METHODS (Iguals que abans, però més nets) ---

  async findNextForUser(topicId: string, userId: string, locale: string, difficulty: number): Promise<Challenge[]> {
    const supabase = await createClient();

    // 1. Obtenir IDs completats
    const { data: completed } = await supabase
      .from('user_progress')
      .select('challenge_id')
      .eq('user_id', userId)
      .eq('topic_id', topicId);

    const completedIds = completed?.map(c => c.challenge_id) || [];

    // 2. Buscar reptes no completats
    let query = supabase
      .from('challenges')
      .select('*')
      .eq('topic_id', topicId)
      .eq('difficulty_tier', difficulty);

    if (completedIds.length > 0) {
      query = query.filter('id', 'not.in', `(${completedIds.join(',')})`);
    }

    const { data: newChallenges } = await query.limit(10);

    if (newChallenges && newChallenges.length > 0) {
      return newChallenges.map(row => this.mapToEntity(row as ChallengeRow, locale));
    }

    // 3. Fallback: Mode Repàs
    const { data: reviewChallenges } = await supabase
      .from('challenges')
      .select('*')
      .eq('topic_id', topicId)
      .eq('difficulty_tier', difficulty)
      .limit(10);

    return (reviewChallenges || []).map(row => this.mapToEntity(row as ChallengeRow, locale));
  }

  async findByTopicId(topicId: string, locale: string = 'ca'): Promise<Challenge[]> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('challenges')
      .select('*')
      .eq('topic_id', topicId);

    if (error) throw new Error(error.message);
    return data.map((row) => this.mapToEntity(row as ChallengeRow, locale));
  }

  async findById(id: string, locale: string = 'ca'): Promise<Challenge | null> {
    const supabase = await createClient();
    const { data, error } = await supabase
      .from('challenges')
      .select('*')
      .eq('id', id)
      .single();

    if (error) {
      if (error.code === 'PGRST116') return null;
      throw new Error(error.message);
    }
    return this.mapToEntity(data as ChallengeRow, locale);
  }
}

// =================== FILE: src/infrastructure/repositories/supabase/topic.repository.ts ===================

// filepath: src/infrastructure/repositories/supabase/topic.repository.ts

import { ITopicRepository, TierProgressStats } from '@/core/repositories/topic.repository';
import { Topic, CreateTopicInput } from '@/core/entities/topic.entity';
import { TopicNotFoundError } from '@/core/errors/topic.errors';
import { createClient } from '@/infrastructure/utils/supabase/server'; // El teu helper
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';
// 1. Definim el tipus exacte de la fila a la BD (Lectura)
type TopicRow = {
  id: string;
  slug: string;
  name_key: string;
  icon_name: string;
  color_theme: string;
  parent_topic_id: string | null;
  is_active: boolean;
  created_at: string;
  updated_at: string;
  description?: string;
};

// 2. Definim el tipus per a Escriptura (Insert/Update)
type TopicPersistencePayload = {
  slug?: string;
  name_key?: string;
  icon_name?: string;
  color_theme?: string;
  parent_topic_id?: string | null;
  is_active?: boolean;
};

export class SupabaseTopicRepository implements ITopicRepository {

  // ❌ ESBORRAT: No podem tenir una propietat 'supabase' aquí perquè el client és async.
  // private supabase = ...

  private mapToEntity(row: TopicRow): Topic {
    return {
      id: row.id,
      slug: row.slug,
      nameKey: row.name_key,
      iconName: row.icon_name,
      colorTheme: row.color_theme,
      parentTopicId: row.parent_topic_id || undefined,
      isActive: row.is_active,
      createdAt: new Date(row.created_at),
      updatedAt: new Date(row.updated_at),
      description: row.description || ''
    };
  }

  async findAllActive(): Promise<Topic[]> {
    // ✅ CORRECCIÓ: Instanciem el client DINS del mètode
    const supabase = await createClient();

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .eq('is_active', true)
      .returns<TopicRow[]>();

    if (error) throw new Error(`Supabase Error: ${error.message}`);

    return data.map((row) => this.mapToEntity(row));
  }

  async findAll(): Promise<Topic[]> {
    const supabase = await createClient(); // ✅ Instancia local

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .returns<TopicRow[]>();

    if (error) throw new Error(error.message);
    return data.map((row) => this.mapToEntity(row));
  }

  async findById(id: string): Promise<Topic | null> {
    const supabase = await createClient(); // ✅ Instancia local

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .eq('id', id)
      .single<TopicRow>();

    if (error) {
      if (error.code === 'PGRST116') return null;
      throw new Error(error.message);
    }

    return this.mapToEntity(data);
  }

  async findBySlug(slug: string): Promise<Topic | null> {
    const supabase = await createClient(); // ✅ Instancia local

    const { data, error } = await supabase
      .from('topics')
      .select('*')
      .eq('slug', slug)
      .single<TopicRow>();

    if (error) {
      if (error.code === 'PGRST116') return null;
      throw new Error(error.message);
    }

    return this.mapToEntity(data);
  }

  async create(input: CreateTopicInput): Promise<Topic> {
    const supabase = await createClient(); // ✅ Instancia local

    const dbPayload: TopicPersistencePayload = {
      slug: input.slug,
      name_key: input.nameKey,
      icon_name: input.iconName,
      color_theme: input.colorTheme,
      parent_topic_id: input.parentTopicId || null,
      is_active: input.isActive
    };

    const { data, error } = await supabase
      .from('topics')
      .insert(dbPayload)
      .select()
      .single<TopicRow>();

    if (error) throw new Error(error.message);
    return this.mapToEntity(data);
  }

  async update(id: string, input: Partial<CreateTopicInput>): Promise<Topic> {
    const supabase = await createClient(); // ✅ Instancia local

    const dbPayload: TopicPersistencePayload = {};

    if (input.slug !== undefined) dbPayload.slug = input.slug;
    if (input.nameKey !== undefined) dbPayload.name_key = input.nameKey;
    if (input.iconName !== undefined) dbPayload.icon_name = input.iconName;
    if (input.colorTheme !== undefined) dbPayload.color_theme = input.colorTheme;
    if (input.isActive !== undefined) dbPayload.is_active = input.isActive;
    if (input.parentTopicId !== undefined) dbPayload.parent_topic_id = input.parentTopicId;

    const { data, error } = await supabase
      .from('topics')
      .update(dbPayload)
      .eq('id', id)
      .select()
      .single<TopicRow>();

    if (error) {
      if (error.code === 'PGRST116') {
        throw new TopicNotFoundError(id);
      }
      throw new Error(error.message);
    }

    return this.mapToEntity(data);
  }

  async getTopicProgressSummary(topicId: string, userId: string): Promise<TierProgressStats[]> {
    const supabase = await createClient();

    // 1. Obtenir reptes amb el seu TIPUS
    const { data: challenges, error: chalError } = await supabase
      .from('challenges')
      .select('id, difficulty_tier, type') // <--- AFEGIM 'type'
      .eq('topic_id', topicId);

    if (chalError) throw new Error(chalError.message);
    if (!challenges) return [];

    // 2. Obtenir el progrés de l'usuari en aquest tema
    const { data: progress, error: progError } = await supabase
      .from('user_progress')
      .select('challenge_id')
      .eq('user_id', userId)
      .eq('topic_id', topicId);

    if (progError) throw new Error(progError.message);

    // 3. Càlculs (Igual que abans)
    const completedSet = new Set(progress?.map(p => p.challenge_id));
   const statsMap = new Map<number, TierProgressStats>();

    challenges.forEach(c => {
      const tier = c.difficulty_tier;
      
      // ✅ CORRECCIÓ 3: Cast segur al nostre tipus (ChallengeType) en lloc de 'any'
      // Supabase retorna string, nosaltres li diem a TS que confiem que és un dels nostres tipus.
      const type = c.type as ChallengeType; 

      if (!statsMap.has(tier)) {
        statsMap.set(tier, {
          tier,
          totalChallenges: 0,
          completedChallenges: 0,
          mostCommonType: type // Usem la variable tipada
        });
      }
      const stat = statsMap.get(tier)!;
      stat.totalChallenges++;
      if (completedSet.has(c.id)) {
        stat.completedChallenges++;
      }
    });

    return Array.from(statsMap.values()).sort((a, b) => a.tier - b.tier);
  }

  
}

// =================== FILE: src/infrastructure/repositories/supabase/user.repository.ts ===================

// filepath: src/infrastructure/repositories/supabase/user.repository.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { IUserRepository, UserProfile } from '@/core/repositories/user.repository'; // Assegura't que aquesta interfície existeix al Core

export class SupabaseUserRepository implements IUserRepository {
  
  async findById(userId: string): Promise<UserProfile | null> {
    const supabase = await createClient();
    
    // Obtenim el perfil de la taula 'profiles'
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (error) {
      console.error('Error fetching user profile:', error);
      return null;
    }

    return {
      id: data.id,
      totalXp: data.total_xp || 0,
      level: data.level || 1,
      // Mapem altres camps si cal
    };
  }

  async saveProgress(userId: string, challengeIds: string[], topicId: string, xpPerChallenge: number): Promise<void> {
    const supabase = await createClient();

    // Guardem cada repte completat a 'user_progress'
    // Usem upsert per evitar errors si ja existeix
    const progressInserts = challengeIds.map(challengeId => ({
      user_id: userId,
      challenge_id: challengeId,
      topic_id: topicId,
      completed_at: new Date().toISOString(),
      xp_earned: xpPerChallenge
    }));

    const { error } = await supabase
      .from('user_progress') // Assegura't que aquesta taula existeix
      .upsert(progressInserts, { onConflict: 'user_id, challenge_id' });

    if (error) {
      console.error('Error saving progress:', error);
      throw new Error('Database error saving progress');
    }
  }

  async updateXp(userId: string, newTotalXp: number, newLevel: number): Promise<void> {
    const supabase = await createClient();

    const { error } = await supabase
      .from('profiles')
      .update({ 
        total_xp: newTotalXp,
        level: newLevel,
        updated_at: new Date().toISOString()
      })
      .eq('id', userId);

    if (error) {
      console.error('Error updating XP:', error);
      throw new Error('Database error updating XP');
    }
  }
}

// =================== FILE: src/infrastructure/service/supabase-auth.service.ts ===================

// filepath: src/infrastructure/services/supabase-auth.service.ts
import { createClient } from '@/infrastructure/utils/supabase/server';
import { IAuthService, UserIdentity } from '@/core/services/auth.service';

export class SupabaseAuthService implements IAuthService {
  
  async logout(): Promise<void> {
    const supabase = await createClient();
    await supabase.auth.signOut();
  }

  async getUser(): Promise<UserIdentity | null> {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    
    if (!user || !user.email) return null;
    
    return {
      id: user.id,
      email: user.email
    };
  }
}

// =================== FILE: src/infrastructure/utils/supabase/server.ts ===================

// filepath: src/infrastructure/utils/supabase/server.ts
import { createServerClient } from '@supabase/ssr';
import { cookies } from 'next/headers';

export async function createClient() {
  const cookieStore = await cookies();

  return createServerClient(
    process.env.NEXT_PUBLIC_SUPABASE_URL!,
    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,
    {
      cookies: {
        getAll() {
          return cookieStore.getAll();
        },
        setAll(cookiesToSet) {
          try {
            cookiesToSet.forEach(({ name, value, options }) =>
              cookieStore.set(name, value, options)
            );
          } catch {
            // The `setAll` method was called from a Server Component.
            // This can be ignored if you have middleware refreshing
            // user sessions.
          }
        },
      },
    }
  );
}

// =================== FILE: src/navigation.ts ===================

// filepath: src/navigation.ts
import { createNavigation } from 'next-intl/navigation';
import { routing } from './routing';

// Creem wrappers amb tipatge segur per al routing definit
export const { Link, redirect, usePathname, useRouter, getPathname } =
  createNavigation(routing);

// =================== FILE: src/presentation/actions/auth/auth.action.ts ===================

// filepath: src/presentation/actions/auth/auth.action.ts
'use server';

import { createClient } from '@/infrastructure/utils/supabase/server';
import { redirect } from 'next/navigation';

export type AuthState = {
  errorKey?: string; // <--- Canviem 'error' (text) per 'errorKey' (clau i18n)
  messageKey?: string;
};

export async function authAction(prevState: AuthState, formData: FormData): Promise<AuthState> {
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;
  const intent = formData.get('intent') as string;
  
  const supabase = await createClient();

  if (intent === 'signup') {
    const { error } = await supabase.auth.signUp({
      email,
      password,
      options: { data: { full_name: email.split('@')[0] } }
    });

    if (error) {
      // Mapeig d'errors bàsic
      if (error.message.includes('already registered')) return { errorKey: 'auth.errors.user_already_exists' };
      if (error.message.includes('Password')) return { errorKey: 'auth.errors.weak_password' };
      return { errorKey: 'auth.errors.generic' };
    }

    return { messageKey: 'auth.success.check_email' };
  } 
  
  else {
    const { error } = await supabase.auth.signInWithPassword({ email, password });

    if (error) {
      // Supabase sol retornar "Invalid login credentials" per seguretat
      return { errorKey: 'auth.errors.invalid_credentials' };
    }

    redirect('/');
  }
}

// =================== FILE: src/presentation/actions/auth/logout.actions.ts ===================

// filepath: src/presentation/actions/auth/logout.action.ts
'use server';

import { LogoutUseCase } from '@/application/use-cases/auth/logout.use-case';
import { SupabaseAuthService } from '@/infrastructure/service/supabase-auth.service';
import { redirect } from 'next/navigation'; // Aquí SÍ usem el natiu

export async function logoutAction() {
  const authService = new SupabaseAuthService();
  const useCase = new LogoutUseCase(authService);
  
  await useCase.execute();
  
  // Truc d'Arquitecte: Redirigim a l'arrel "/"
  // El Middleware detectarà "/" -> Detectarà l'idioma del navegador -> Redirigirà a "/ca/login"
  redirect('/login'); 
}

// =================== FILE: src/presentation/actions/challenges/get-next-challenge.action.ts ===================

// filepath: src/presentation/actions/challenges/get-next-challenge.action.ts
'use server';

import { GetNextChallengeUseCase } from '@/application/use-cases/challenges/get-next-challenge.use-case';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { SupabaseChallengeRepository } from '@/infrastructure/repositories/supabase/challenge.repository';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { getLocale } from 'next-intl/server';
import { createClient } from '@/infrastructure/utils/supabase/server'; // <--- Necessari per user real

type ActionResponse = 
  | { success: true; data: Challenge[] } 
  | { success: false; error: string };

// 1. AFEGIM EL PARÀMETRE difficulty AMB VALOR PER DEFECTE
export async function getNextChallengeAction(topicSlug: string, difficulty: number = 1): Promise<ActionResponse> {
  console.log(`🚀 [ACTION] Rebuda petició: Slug="${topicSlug}", Tier=${difficulty}`);
  
  try {
    const locale = await getLocale();
    const supabase = await createClient(); 

    const { data: { user } } = await supabase.auth.getUser();
    if (!user) {
        console.warn('⛔ [ACTION] Usuari no autenticat');
        return { success: false, error: 'Has d\'iniciar sessió per jugar.' };
    }

    const topicRepo = new SupabaseTopicRepository();
    // Afegim log per veure si troba el tema
    const topic = await topicRepo.findBySlug(topicSlug);
    if (!topic) {
        console.error(`❌ [ACTION] Tema no trobat pel slug: ${topicSlug}`);
        return { success: false, error: 'Tema no trobat' };
    }
    console.log(`✅ [ACTION] Tema trobat: ID=${topic.id}`);

    const challengeRepo = new SupabaseChallengeRepository();
    
    // NOTA: Ara cridem directament al repo aquí per saltar-nos el UseCase en el debug, 
    // o bé deixem el UseCase però sabent que el log està dins del repo.
    // Mantenim l'estructura neta cridant al UseCase:
    
    const useCase = new GetNextChallengeUseCase(topicRepo, challengeRepo);
    const challenges = await useCase.execute(topicSlug, user.id, locale, difficulty); 

    console.log(`🏁 [ACTION] Retornant ${challenges.length} reptes al client.`);
    return { success: true, data: challenges };

  } catch (error) {
    console.error('❌ [ACTION] Exception:', error);
    return { 
      success: false, 
      error: 'No s\'ha pogut carregar el repte.' 
    };
  }
}

// =================== FILE: src/presentation/actions/gamification/submit-session.action.ts ===================

// filepath: src/presentation/actions/gamification/submit-session.action.ts
'use server';

import { CompleteSessionUseCase, SessionResult } from '@/application/use-cases/gamification/complete-session.use-case';
import { SupabaseUserRepository } from '@/infrastructure/repositories/supabase/user.repository';
import { createClient } from '@/infrastructure/utils/supabase/server'; // <--- Nou import

type ActionResponse = 
  | { success: true; data: SessionResult }
  | { success: false; error: string };

export async function submitSessionAction(challengeIds: string[], topicId: string): Promise<ActionResponse> {
  try {
    // 1. Obtenim l'usuari real de la sessió
    const supabase = await createClient();
    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      return { success: false, error: 'Unauthorized: Please login first' };
    }

    // 2. Ja tenim l'ID real!
    const userId = user.id;

    // 3. Executem el cas d'ús
    const userRepo = new SupabaseUserRepository();
    const useCase = new CompleteSessionUseCase(userRepo);

    const result = await useCase.execute(userId, challengeIds, topicId);

    return { success: true, data: result };
  } catch (error) {
    console.error('Error submitting session:', error);
    return { success: false, error: 'Failed to save progress' };
  }
}

// =================== FILE: src/presentation/actions/topics/get-topics.action.ts ===================

// filepath: src/presentation/actions/topics/get-topics.action.ts
'use server';

import { GetActiveTopicsUseCase } from '@/application/use-cases/topics/get-active-topics.use-case';
import { SupabaseTopicRepository } from '@/infrastructure/repositories/supabase/topic.repository';
import { Topic } from '@/core/entities/topic.entity';

// Definim un tipus de retorn estàndard per a les accions
type ActionResponse<T> = 
  | { success: true; data: T }
  | { success: false; error: string };

export async function getTopicsAction(): Promise<ActionResponse<Topic[]>> {
  try {
    // 1. Instanciem les dependències (Composition Root per request)
    // Nota: Més endavant injectarem el client de Supabase amb cookies aquí.
    const repository = new SupabaseTopicRepository();
    const useCase = new GetActiveTopicsUseCase(repository);

    // 2. Executem el cas d'ús
    const topics = await useCase.execute();

    // 3. Retornem l'èxit
    // Next.js serialitzarà això automàticament
    return { success: true, data: topics };
  } catch (error) {
    console.error('Error fetching topics:', error);
    // 4. Gestió d'errors segura (no enviem stack trace al client)
    return { 
      success: false, 
      error: 'No s\'han pogut carregar els temes. Torna-ho a provar més tard.' 
    };
  }
}

// =================== FILE: src/presentation/components/auth/LogoutButton.tsx ===================

// filepath: src/presentation/components/auth/LogoutButton.tsx
'use client';

import { LogOut } from 'lucide-react';
import { logoutAction } from '@/presentation/actions/auth/logout.actions';

export function LogoutButton() {
  return (
    <button 
      onClick={() => logoutAction()}
      className="flex items-center gap-2 text-slate-400 hover:text-red-400 transition-colors text-sm font-medium p-2 rounded-lg hover:bg-red-500/10 w-full"
    >
      <LogOut className="w-4 h-4" />
      <span>Tancar Sessió</span>
    </button>
  );
}

// =================== FILE: src/presentation/components/features/dashboard/TopicCard.tsx ===================

// filepath: src/presentation/components/features/dashboard/TopicCard.tsx
import Link from 'next/link';
import { DashboardTopicDTO } from '@/application/dto/dashboard-topic.dto';
import { getTopicIcon } from '@/presentation/utils/icon-mapper';
import { clsx } from 'clsx';
import { ArrowRight, Lock } from 'lucide-react';

interface TopicCardProps {
  topic: DashboardTopicDTO;
  translatedTitle: string; // <--- NOU CAMP
}

export function TopicCard({ topic, translatedTitle }: TopicCardProps) {
  const themeColor = topic.colorTheme || 'bg-slate-700';

  return (
    <Link 
      href={topic.isLocked ? '#' : `/learn/${topic.slug}`}
      className={clsx(
        "group relative flex flex-col bg-slate-900 border-2 border-slate-800 rounded-2xl overflow-hidden transition-all duration-200",
        !topic.isLocked && "hover:-translate-y-1 hover:border-blue-500/50 hover:shadow-[0_8px_0_0_#1e293b] active:translate-y-0 active:shadow-none",
        topic.isLocked && "opacity-60 cursor-not-allowed grayscale"
      )}
    >
      {/* HEADER DE COLOR */}
      <div className={clsx("h-24 flex items-center justify-center relative overflow-hidden", themeColor)}>
         <div className="absolute inset-0 bg-black/10" /> {/* Overlay subtil */}
         <div className="text-white drop-shadow-md transform group-hover:scale-110 transition-transform duration-300">
            {getTopicIcon(topic.iconName, "w-12 h-12")}
         </div>
      </div>

      {/* BODY */}
      <div className="p-5 flex-1 flex flex-col">
       <h3 className="text-lg font-bold text-white mb-1">{translatedTitle}</h3>
        <p className="text-slate-400 text-xs mb-4 line-clamp-2">{topic.description}</p>

        {/* BARRA DE PROGRÉS */}
        <div className="mt-auto">
           <div className="flex justify-between text-xs font-bold mb-1.5 uppercase tracking-wider">
              <span className={topic.isLocked ? "text-slate-600" : "text-blue-400"}>
                 {topic.isLocked ? "Bloquejat" : `Nivell ${topic.currentLevel}`}
              </span>
              <span className="text-slate-500">{topic.progressPercentage}%</span>
           </div>
           
           <div className="h-3 w-full bg-slate-800 rounded-full overflow-hidden border border-slate-700/50">
              <div 
                className={clsx("h-full rounded-full transition-all duration-1000", 
                    topic.isLocked ? "bg-slate-600" : "bg-blue-500"
                )}
                style={{ width: `${topic.progressPercentage}%` }}
              />
           </div>
        </div>
      </div>

      {/* BOTÓ D'ACCIÓ (Només visible en hover o mòbil) */}
      {!topic.isLocked && (
          <div className="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
             <div className="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                <ArrowRight className="w-4 h-4 text-white" />
             </div>
          </div>
      )}
      
      {topic.isLocked && (
         <div className="absolute top-3 right-3">
             <Lock className="w-5 h-5 text-white/50" />
         </div>
      )}
    </Link>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/ChallengeRenderer.tsx ===================

// filepath: src/presentation/components/features/game-engine/ChallengeRenderer.tsx
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { QuizView } from './QuizView';
import { MatchingView } from './MatchingView';
import { CodeFixView } from './CodeFixView';
import { TerminalView } from './TerminalView';
import { LogicOrderView } from './LogicOrderView';

// Definició de les dades de sessió (Tipatge estricte)
export interface SessionData {
  progress: number;
  currentIndex: number;
  totalChallenges: number;
  topicSlug: string;
}

interface ChallengeRendererProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
  sessionData: SessionData; // 👈 Aquesta prop és OBLIGATÒRIA
}

export function ChallengeRenderer({ challenge, onNext, sessionData }: ChallengeRendererProps) {

  switch (challenge.type) {
    // ----------------------------------------------------------------------
    // ⚠️ NOTES D'ARQUITECTURA:
    // Els jocs QUIZ, MATCHING i CODE_FIX encara no usen el nou 'GameSessionLayout'.
    // Per això no els passem 'sessionData'.
    // Si en el futur els actualitzes al nou disseny, hauràs d'afegir la prop aquí.
    // ----------------------------------------------------------------------

    case 'QUIZ':
      return <QuizView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'MATCHING':
      return <MatchingView key={challenge.id} challenge={challenge} onNext={onNext} />;

    case 'CODE_FIX':
      return <CodeFixView key={challenge.id} challenge={challenge} onNext={onNext} />;

    // ----------------------------------------------------------------------
    // ✅ JOCS ACTUALITZATS AL NOU LAYOUT RESPONSIVE (AMB HEADER/FOOTER)
    // ----------------------------------------------------------------------

    case 'TERMINAL':
      return (
        <TerminalView 
          key={challenge.id} 
          challenge={challenge} 
          onNext={onNext} 
          sessionData={sessionData} // 👈 AFEGIT: Soluciona l'error TS2741
        />
      );

    case 'LOGIC_ORDER':
      return (
        <LogicOrderView 
          key={challenge.id} 
          challenge={challenge} 
          onNext={onNext} 
          sessionData={sessionData} 
        />
      );

    default:
      return <div className="text-red-500 p-4">Tipus no suportat: {challenge.type}</div>;
  }
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/CodeWindow.tsx ===================

import { clsx } from 'clsx';

// Motor de sintaxi optimitzat
const SyntaxHighlighter = ({ code }: { code: string }) => {
  const parts = code.split(/(\s+|[(){}[\]<>=;])/g);
  return (
    <span className="font-mono text-sm md:text-base leading-relaxed">
      {parts.map((part, i) => {
        if (['function', 'const', 'let', 'var', 'return', 'if', 'else', 'export', 'default'].includes(part)) 
          return <span key={i} className="text-pink-500">{part}</span>;
        if (['useState', 'useEffect', 'useContext', 'useMemo'].includes(part)) 
          return <span key={i} className="text-yellow-300 font-medium">{part}</span>;
        if (part.startsWith('<') || part.startsWith('</') || part.endsWith('>')) 
          return <span key={i} className="text-blue-400">{part}</span>;
        if (part.match(/^[A-Z]/) && !['A', 'B', 'C'].includes(part)) 
          return <span key={i} className="text-yellow-400">{part}</span>;
        if (['=', '=>', '==='].includes(part)) 
          return <span key={i} className="text-blue-300">{part}</span>;
        return <span key={i} className="text-blue-100/90">{part}</span>;
      })}
    </span>
  );
};

interface CodeWindowProps {
  initialCode: string;
  selectedCode?: string | null;
  isError?: boolean;
  isSuccess?: boolean;
}

export function CodeWindow({ initialCode, selectedCode, isError, isSuccess }: CodeWindowProps) {
  // Calculem les línies totals per als números de línia
  const lines = initialCode.split('\n');
  
  // Dividim el codi pel marcador per saber en quina línia cau el "forat"
  const parts = initialCode.split('???');
  const preCode = parts[0];
  const postCode = parts[1] || '';

  return (
    <div className="bg-[#1e1e1e] rounded-xl overflow-hidden shadow-2xl border border-slate-700 ring-4 ring-black/20 mt-4">
      
      {/* 1. BARRA DE TÍTOL (VSCODE STYLE) */}
      <div className="bg-[#252526] px-4 py-2 flex items-center gap-2 border-b border-[#333]">
        <div className="flex gap-1.5 mr-4">
          <div className="w-3 h-3 rounded-full bg-[#ff5f56]"></div>
          <div className="w-3 h-3 rounded-full bg-[#ffbd2e]"></div>
          <div className="w-3 h-3 rounded-full bg-[#27c93f]"></div>
        </div>
        
        {/* Pestanya activa */}
        <div className="flex items-center gap-2 px-3 py-1.5 bg-[#1e1e1e] rounded-t-md text-[11px] text-blue-300 font-mono border-t border-x border-[#333] -mb-[9px] z-10">
          <span className="text-yellow-500 text-[10px] font-bold">JS</span> 
          Solution.jsx
        </div>
      </div>

      {/* 2. AREA DE CODI AMB NÚMEROS DE LÍNIA */}
      <div className="flex relative min-h-[160px]">
        
        {/* Columna de números */}
        <div className="bg-[#1e1e1e] w-12 py-6 flex flex-col items-end pr-4 text-slate-600 font-mono text-xs select-none border-r border-[#333]">
          {lines.map((_, i) => (
            <div key={i} className="leading-relaxed h-[1.5rem]">{i + 1}</div>
          ))}
        </div>

        {/* Editor de codi */}
        <div className="flex-1 p-6 py-6 font-mono overflow-x-auto bg-[#1e1e1e]/50">
          <div className="whitespace-pre">
            <SyntaxHighlighter code={preCode} />
            
            {/* EL "FORAT" INTERACTIU */}
            <span className={clsx(
              "px-3 py-1 rounded-md mx-1 font-bold transition-all duration-300 inline-block min-w-20 text-center",
              "border-b-2 shadow-inner",
              !selectedCode ? "bg-slate-800 text-slate-500 border-slate-600 animate-pulse italic text-sm" :
              isSuccess ? "bg-green-500/20 text-green-400 border-green-500 scale-110 shadow-[0_0_15px_rgba(34,197,94,0.2)]" :
              isError ? "bg-red-500/20 text-red-400 border-red-500 shake-animation" :
              "bg-blue-500/20 text-blue-300 border-blue-500"
            )}>
              {selectedCode || "???"}
            </span>

            <SyntaxHighlighter code={postCode} />
          </div>
        </div>
      </div>

      {/* 3. FOOTER DE L'EDITOR */}
      <div className="bg-[#252526] px-4 py-1 border-t border-[#333] flex justify-between items-center text-[10px] font-mono text-slate-500 uppercase tracking-widest">
        <div className="flex gap-4">
          <span>Ln {lines.length}, Col 1</span>
          <span>Spaces: 2</span>
        </div>
        <div className="flex gap-2 items-center">
          <div className="w-2 h-2 rounded-full bg-blue-500"></div>
          <span>JavaScript JSX</span>
        </div>
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/HintPanel.tsx ===================

// filepath: src/presentation/components/features/game-engine/code-fix/HintPanel.tsx
import { useState } from 'react';
import { Lightbulb, X } from 'lucide-react';


interface HintPanelProps {
  hintText: string;
}

export function HintPanel({ hintText }: HintPanelProps) {
  const [isOpen, setIsOpen] = useState(false);

  if (!isOpen) {
    return (
      <button 
        onClick={() => setIsOpen(true)}
        className="flex items-center gap-2 text-xs text-yellow-500/80 hover:text-yellow-400 transition-colors mt-2 ml-auto"
      >
        <Lightbulb className="w-4 h-4" /> Necessito una pista
      </button>
    );
  }

  return (
    <div className="mt-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3 flex items-start gap-3 animate-in fade-in slide-in-from-top-1">
       <Lightbulb className="w-4 h-4 text-yellow-500 shrink-0 mt-0.5" />
       <p className="text-yellow-200/90 text-sm flex-1">{hintText}</p>
       <button onClick={() => setIsOpen(false)} className="text-yellow-500/50 hover:text-yellow-500">
         <X className="w-4 h-4" />
       </button>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/code-fix/SolutionDeck.tsx ===================

// filepath: src/presentation/components/features/game/code-fix/SolutionDeck.tsx
'use client';

import { CodeFixOption } from '@/core/entities/challenges';
import { clsx } from 'clsx';
import { CheckCircle2, Circle } from 'lucide-react';

interface SolutionDeckProps {
  options: CodeFixOption[];
  selectedId: string | null;
  onSelect: (id: string) => void;
  isSubmitted: boolean;
}

export function SolutionDeck({ options, selectedId, onSelect, isSubmitted }: SolutionDeckProps) {
  return (
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 my-6">
      {options.map((option) => {
        const isSelected = selectedId === option.id;

        return (
          <button
            key={option.id}
            onClick={() => !isSubmitted && onSelect(option.id)}
            disabled={isSubmitted}
            className={clsx(
              "relative group text-left p-4 rounded-xl border-2 transition-all duration-300 w-full",
              // Estats de color
              isSelected
                ? "border-blue-500 bg-blue-500/10 shadow-[0_0_20px_rgba(59,130,246,0.3)]"
                : "border-slate-800 bg-slate-900/50 hover:border-slate-600 hover:bg-slate-800",
              
              isSubmitted && isSelected && "border-green-500 bg-green-500/10"
            )}
          >
            {/* Checkbox Icon UI */}
            <div className={clsx(
                "absolute top-4 right-4 transition-colors",
                isSelected ? "text-blue-400" : "text-slate-600 group-hover:text-slate-400"
            )}>
                {isSelected ? <CheckCircle2 className="w-5 h-5" /> : <Circle className="w-5 h-5" />}
            </div>

            {/* Codi Polimòrfic (Responsive) */}
            <div className="pr-8"> {/* Padding right per no trepitjar la icona */}
                <code className={clsx(
                    "block font-mono text-xs md:text-sm leading-relaxed",
                    "text-slate-300",
                    // ✨ MÀGIA DISNEY PER EVITAR DESBORDAMENT ✨
                    "break-all whitespace-pre-wrap word-break-break-word"
                )}>
                    {option.code}
                </code>
            </div>
          </button>
        );
      })}
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/CodeFixView.tsx ===================

// filepath: src/presentation/components/features/game/code-fix/CodeFixView.tsx
'use client';

import { useState } from 'react';
// ✅ FIX: Importem des del 'index' de la carpeta (Barrel File), no del fitxer intern
import { Challenge, CodeFixContent } from '@/core/entities/challenges'; 
import { Terminal, Play, ArrowRight } from 'lucide-react';
import { CodeWindow } from './code-fix/CodeWindow';
import { SolutionDeck } from './code-fix/SolutionDeck';
import { HintPanel } from './code-fix/HintPanel';
import { clsx } from 'clsx';

interface CodeFixViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function CodeFixView({ challenge, onNext }: CodeFixViewProps) {
  // Ara TypeScript sap perfectament què és CodeFixContent
  const content = challenge.content as CodeFixContent;
  
  const [selectedId, setSelectedId] = useState<string | null>(null);
  const [status, setStatus] = useState<'IDLE' | 'SUCCESS' | 'ERROR'>('IDLE');

  const handleCheck = () => {
    if (!selectedId) return;

    // ✅ FIX: Ara 'opt' ja no és 'any', TS sap que és un 'CodeFixOption'
    const selectedOption = content.options.find(opt => opt.id === selectedId);
    
    if (selectedOption?.isCorrect) {
       setStatus('SUCCESS');
       setTimeout(() => onNext(true), 1500); 
    } else {
       setStatus('ERROR');
       setTimeout(() => setStatus('IDLE'), 1000);
    }
  };

  const currentCode = selectedId 
    ? content.options.find(o => o.id === selectedId)?.code 
    : null;

  return (
    <div className="w-full max-w-3xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
      
      {/* HEADER */}
      <div className="flex items-center gap-3 mb-2 text-slate-300">
         <div className="p-2 bg-blue-500/10 rounded-lg">
            <Terminal className="w-5 h-5 text-blue-400" />
         </div>
         <h2 className="font-mono font-bold text-lg text-white tracking-wider">DEBUG_MODE</h2>
      </div>
      
      <p className="text-slate-400 text-sm mb-6 pl-12 border-l-2 border-slate-800">
         {content.description}
      </p>

      {/* EDITOR */}
      <CodeWindow 
         initialCode={content.initialCode} 
         selectedCode={currentCode}
         isError={status === 'ERROR'}
         isSuccess={status === 'SUCCESS'}
      />

      {/* TARGETES D'OPCIONS (Aquí és on aplicarem el disseny Disney) */}
      <SolutionDeck 
         options={content.options} 
         selectedId={selectedId} 
         onSelect={(id) => {
             setSelectedId(id);
             setStatus('IDLE');
         }}
         isSubmitted={status === 'SUCCESS'}
      />

      {/* PISTA */}
      <HintPanel hintText={content.hint} />

      {/* BOTÓ D'ACCIÓ */}
      <div className="mt-8 flex justify-end border-t border-slate-800 pt-6">
         <button
            onClick={handleCheck}
            disabled={!selectedId || status === 'SUCCESS'}
            className={clsx(
               "px-8 py-3 rounded-xl font-bold flex items-center gap-2 transition-all shadow-lg transform active:scale-95",
               !selectedId ? "bg-slate-800 text-slate-500 cursor-not-allowed" :
               status === 'SUCCESS' ? "bg-green-600 text-white hover:bg-green-500" :
               "bg-blue-600 hover:bg-blue-500 text-white hover:scale-105 shadow-blue-900/20"
            )}
         >
            {status === 'SUCCESS' ? 'SISTEMA RESTAURAT' : 'EXECUTAR PATCH'} 
            {status === 'SUCCESS' ? <ArrowRight className="w-5 h-5" /> : <Play className="w-4 h-4 fill-current" />}
         </button>
      </div>

    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/GameArena.tsx ===================

// filepath: src/presentation/components/features/game-engine/GameArena.tsx
'use client';

import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { useGameSession } from '@/presentation/hooks/game/useGameSession';
import { ChallengeRenderer } from './ChallengeRenderer';
import { GameResult } from './GameResult';
import { GameError } from './GameError';
import { Loader2} from 'lucide-react';


// NO importis el layout aquí directament si vols que cada joc tingui el seu footer propi.
// Però per mantenir consistència, podem passar el footer des del ChallengeRenderer.
// REVISIÓ: El GameArena només proveeix el context. El layout el controlarà el fill.

// MIRA BÉ EL CANVI D'ESTRATÈGIA: 
// Passem el control del layout al component específic (LogicOrderView) 
// perquè ell sap quin botó necessita (Verificar, Continuar...).
// GameArena només retorna el contingut pur.

interface GameArenaProps {
  challenges: Challenge[];
  topicSlug: string;
}

export function GameArena({ challenges, topicSlug }: GameArenaProps) {
  const {
    currentChallenge, currentIndex, totalChallenges, progress,
    status, result, error, handleNext, handleRetry
  } = useGameSession(challenges);

  // Estats globals (Càrrega/Error) - Ocupen tota la pantalla
  if (status === 'SUBMITTING') return <FullScreenMsg><Loader2 className="w-12 h-12 animate-spin text-blue-500" /></FullScreenMsg>;
  if (status === 'SUCCESS' && result) return <GameResult xpEarned={result.xpEarned} newLevel={result.newLevel} leveledUp={result.leveledUp} topicSlug={topicSlug} />;
  if (status === 'ERROR' && error) return <GameError message={error} onRetry={handleRetry} />;

  // Renderitzem el joc actual.
  // Passem les dades de sessió (progress, etc.) com a props al Renderer 
  // perquè el component final (LogicOrderView) pugui muntar el GameSessionLayout complet.
  return (
    <ChallengeRenderer
      challenge={currentChallenge}
      onNext={handleNext}
      // 👇 Aquest objecte ha de coincidir amb la interfície SessionData
      sessionData={{
        progress,
        currentIndex,
        totalChallenges,
        topicSlug
      }}
    />
  );
}

function FullScreenMsg({ children }: { children: React.ReactNode }) {
  return <div className="fixed inset-0 flex items-center justify-center bg-slate-950 z-50">{children}</div>;
}

// =================== FILE: src/presentation/components/features/game-engine/GameError.tsx ===================

// filepath: src/presentation/components/features/game-engine/GameError.tsx
import { AlertTriangle, RotateCcw, LogIn } from 'lucide-react';
import { Link } from '@/navigation';
import { useTranslations } from 'next-intl';

interface GameErrorProps {
  message: string;
  onRetry: () => void;
}

export function GameError({ message, onRetry }: GameErrorProps) {
  const t = useTranslations('game.arena');
  const isAuthError = message.includes('Unauthorized');

  return (
    <div className="text-center max-w-sm bg-slate-800 p-8 rounded-2xl border border-red-500/20 mx-auto">
      <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
         {isAuthError ? <LogIn className="w-8 h-8 text-blue-400" /> : <AlertTriangle className="w-8 h-8 text-red-400" />}
      </div>
      
      <h3 className="text-xl font-bold text-white mb-2">
        {isAuthError ? t('unauthorized_title') : t('error_title')}
      </h3>
      
      {/* Si l'error és tècnic, el mostrem tal qual o un genèric si prefereixes */}
      <p className="text-slate-400 mb-6 text-sm">
        {isAuthError ? t('unauthorized_desc') : message}
      </p>

      <div className="flex gap-3 justify-center">
        {isAuthError ? (
           <Link href="/login">
             <button className="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-lg">
                {t('login_btn')}
             </button>
           </Link>
        ) : (
           <button onClick={onRetry} className="px-6 py-2 bg-red-600 hover:bg-red-500 text-white font-bold rounded-lg flex items-center gap-2">
             <RotateCcw className="w-4 h-4" /> {t('retry_btn')}
           </button>
        )}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/GameResult.tsx ===================

// filepath: src/presentation/components/features/game-engine/GameResult.tsx
import { Trophy, Star, ArrowRight } from 'lucide-react';
import { Link } from '@/navigation'; // ✅ Import correcte
import { useTranslations } from 'next-intl';

interface GameResultProps {
  xpEarned: number;
  newLevel: number;
  leveledUp: boolean;
  topicSlug: string; // <--- NOVA PROP NECESSÀRIA
}

export function GameResult({ xpEarned, newLevel, leveledUp, topicSlug }: GameResultProps) {
  const t = useTranslations('game.arena');

  return (
    <div className="flex flex-col items-center animate-in zoom-in-50">
      <div className="w-32 h-32 bg-yellow-500/10 rounded-full flex items-center justify-center mb-6 relative">
        <Trophy className="w-16 h-16 text-yellow-400" />
        {leveledUp && (
          <div className="absolute -top-2 -right-2 bg-purple-600 text-white text-xs font-bold px-3 py-1 rounded-full animate-bounce">
            {t('level_up')}
          </div>
        )}
      </div>
      
      <h2 className="text-3xl font-bold text-white mb-6">{t('lesson_complete')}</h2>
      
      <div className="bg-slate-800 p-6 rounded-xl w-full max-w-sm mb-6 space-y-4">
         <div className="flex justify-between items-center text-slate-300">
            <span>{t('xp_earned')}</span>
            <span className="text-green-400 font-bold flex gap-1 items-center">
                +{xpEarned} <Star className="w-4 h-4 fill-green-400" />
            </span>
         </div>
         <div className="flex justify-between items-center text-slate-300 pt-4 border-t border-slate-700">
            <span>Nivell Actual</span>
            <span className="text-white font-bold text-xl">{newLevel}</span>
         </div>
      </div>

      {/* ARA TORNA AL MAPA DEL TEMA */}
      <Link href={`/learn/${topicSlug}`}>
        <button className="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-500 transition-all flex items-center gap-2">
            {t('continue_btn') || "Continuar"} <ArrowRight className="w-5 h-5" />
        </button>
      </Link>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/layout/GameSessionLayout.tsx ===================

// filepath: src/presentation/components/features/game-engine/layout/GameSessionLayout.tsx
'use client';

import { ReactNode } from 'react';
import { clsx } from 'clsx';

interface GameSessionLayoutProps {
  header: ReactNode;
  children: ReactNode; // La zona de joc
  footer: ReactNode;   // El botó de verificar
  className?: string;
}

export function GameSessionLayout({ header, children, footer, className }: GameSessionLayoutProps) {
  return (
    // CONTENIDOR MESTRE: Fixat a la pantalla, sense scroll global.
    // 'fixed inset-0' garanteix que ocupa tota la pantalla i tapa la UI de sota.
    <div className="fixed inset-0 z-50 flex flex-col bg-slate-950 h-dvh w-screen overflow-hidden">
      
      {/* 1. HEADER (Fix) */}
      <header className="shrink-0 px-4 py-3 bg-slate-950/95 backdrop-blur z-20 border-b border-white/5">
        {header}
      </header>

      {/* 2. ZONA DE JOC (Flexible) */}
      {/* 'flex-1' l'obliga a ocupar tot l'espai disponible.
          'min-h-0' és vital per permetre scroll intern en fills flex.
          'relative' crea un context per a posicionaments absoluts interns. */}
      <main className={clsx("flex-1 min-h-0 relative w-full max-w-3xl mx-auto", className)}>
        {/* Wrapper intern per centrar i donar padding sense trencar el scroll */}
        <div className="h-full w-full flex flex-col px-4 py-2 overflow-hidden">
           {children}
        </div>
      </main>

      {/* 3. FOOTER (Fix i Segur) */}
      {/* 'pb-safe' (si tens la utilitat de Tailwind configurada) o un padding generós */}
      <footer className="shrink-0 px-4 pt-3 pb-6 bg-slate-950/95 backdrop-blur z-20 border-t border-white/5 w-full max-w-3xl mx-auto">
        {footer}
      </footer>

    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/LogicOrderView.tsx ===================

// filepath: src/presentation/components/features/game-engine/LogicOrderView.tsx
'use client';

import { useState } from 'react';
import { Challenge, LogicOrderContent, ChallengeOption } from '@/core/entities/challenges/challenge.entity';
import { RotateCcw, GripVertical, X } from 'lucide-react';
import { clsx } from 'clsx';
import { Reorder, AnimatePresence, motion, LayoutGroup } from 'framer-motion';
import { GameSessionLayout } from './layout/GameSessionLayout';
import { Link } from '@/navigation';
import { X as CloseIcon } from 'lucide-react';
// 1. IMPORTAR HOOK DE TRADUCCIÓ
import { useTranslations } from 'next-intl';

interface LogicOrderViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
  sessionData: { progress: number; currentIndex: number; totalChallenges: number; topicSlug: string };
}

export function LogicOrderView({ challenge, onNext, sessionData }: LogicOrderViewProps) {
  // 2. INICIALITZAR HOOK
  const t = useTranslations('game');
  
  const content = challenge.content as LogicOrderContent;
  const [available, setAvailable] = useState<ChallengeOption[]>(content.items);
  const [selected, setSelected] = useState<ChallengeOption[]>([]);
  const [hasSubmitted, setHasSubmitted] = useState(false);
  const [isCorrect, setIsCorrect] = useState<boolean | null>(null);

  const handleSelect = (item: ChallengeOption) => {
    if (hasSubmitted) return;
    setAvailable(prev => prev.filter(i => i.id !== item.id));
    setSelected(prev => [...prev, item]);
  };
  const handleDeselect = (item: ChallengeOption) => {
    if (hasSubmitted) return;
    setSelected(prev => prev.filter(i => i.id !== item.id));
    setAvailable(prev => [...prev, item]); 
  };
  const handleReset = () => {
    setAvailable(content.items); setSelected([]); setHasSubmitted(false); setIsCorrect(null);
  };
  const handleSubmit = () => {
    if (hasSubmitted) return;
    const currentOrder = selected.map(s => s.id);
    const correctOrder = [...content.items].map(i => i.id).sort(); 
    const correct = JSON.stringify(currentOrder) === JSON.stringify(correctOrder);
    setIsCorrect(correct); setHasSubmitted(true);
    if (correct) setTimeout(() => onNext(true), 1500);
  };

  const Header = (
    <div className="flex items-center gap-4 w-full">
        <Link href={`/learn/${sessionData.topicSlug}`} className="text-slate-400 hover:text-white p-1">
           <CloseIcon className="w-6 h-6" />
        </Link>
        <div className="flex-1 h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
            <div 
              className="bg-blue-500 h-full transition-all duration-500 ease-out"
              style={{ width: `${sessionData.progress}%` }} 
            />
        </div>
    </div>
  );

  const Footer = (
    <div className="flex gap-3 w-full">
       <button 
          onClick={handleReset}
          className="p-4 rounded-xl bg-slate-800 text-slate-400 hover:bg-slate-700 transition-colors border border-slate-700"
          title={t('actions.reset')} // Accessibilitat
       >
          <RotateCcw className="w-6 h-6" />
       </button>
       <button
          onClick={handleSubmit}
          disabled={selected.length === 0 || hasSubmitted}
          className={clsx(
             "flex-1 p-4 rounded-xl font-black text-lg uppercase tracking-wider transition-all shadow-lg active:scale-95 flex items-center justify-center gap-2",
             hasSubmitted 
                ? (isCorrect ? "bg-green-500 text-white" : "bg-red-500 text-white")
                : selected.length === 0 
                    ? "bg-slate-800 text-slate-600 border-slate-700 cursor-not-allowed"
                    : "bg-blue-600 text-white border-b-4 border-blue-800 shadow-blue-500/20"
          )}
       >
          {/* 3. ÚS DE CLAUS DE TRADUCCIÓ */}
          {hasSubmitted ? (
             isCorrect ? t('feedback.correct') : t('feedback.incorrect')
          ) : t('actions.check')}
       </button>
    </div>
  );

  return (
    <GameSessionLayout header={Header} footer={Footer}>
      <LayoutGroup>
        <div className="flex flex-col h-full gap-2">
          
          <div className="shrink-0 text-center pb-2">
             <h2 className="text-lg font-bold text-white leading-tight">{content.description}</h2>
             {/* Subtítol opcional amb el nom del mode */}
             <div className="text-[10px] uppercase tracking-widest text-slate-500 font-bold mt-1">
                {t('modes.logic_order.label')}
             </div>
          </div>

          <div className="flex-1 min-h-0 flex flex-col gap-2">
             
             <div className="flex-1 bg-slate-900/50 rounded-xl border-2 border-dashed border-slate-700 p-2 overflow-y-auto relative min-h-25">
                <span className="absolute top-2 right-2 text-[9px] text-slate-500 uppercase font-bold tracking-widest pointer-events-none">
                    {t('modes.logic_order.your_answer')}
                </span>
                
                {selected.length === 0 && (
                   <div className="absolute inset-0 flex flex-col items-center justify-center text-slate-600 pointer-events-none">
                      <GripVertical className="w-6 h-6 mb-1 opacity-50" />
                      <span className="text-xs">{t('modes.logic_order.placeholder')}</span>
                   </div>
                )}

                <Reorder.Group axis="y" values={selected} onReorder={setSelected} className="flex flex-col gap-2 w-full pb-8">
                   <AnimatePresence mode='popLayout'>
                     {selected.map((item, index) => (
                       <Reorder.Item key={item.id} value={item} dragListener={!hasSubmitted} layoutId={item.id}
                         className="relative p-3 rounded-lg border bg-slate-800 border-slate-600 flex items-center gap-3 select-none touch-none"
                       >
                          <span className="w-5 h-5 rounded-full bg-slate-700 flex items-center justify-center text-[10px] font-bold">{index + 1}</span>
                          <span className="flex-1 text-sm font-medium">{item.text}</span>
                          {!hasSubmitted && <button onClick={() => handleDeselect(item)}><X className="w-4 h-4 text-slate-500" /></button>}
                       </Reorder.Item>
                     ))}
                   </AnimatePresence>
                </Reorder.Group>
             </div>

             <div className="shrink-0 h-auto max-h-[40%] overflow-y-auto bg-slate-950/30 rounded-xl border border-slate-800 p-2">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2">
                   <AnimatePresence mode='popLayout'>
                      {available.map((item) => (
                         <motion.button
                            layoutId={item.id} key={item.id} onClick={() => handleSelect(item)} disabled={hasSubmitted}
                            className="p-3 rounded-lg bg-slate-800 border-b-2 border-slate-900 text-slate-300 text-xs font-medium text-left flex justify-between items-center group"
                         >
                            <span className="line-clamp-2">{item.text}</span>
                            <span className="text-blue-500 font-bold">+</span>
                         </motion.button>
                      ))}
                   </AnimatePresence>
                   {available.length === 0 && (
                       <div className="text-center text-xs text-slate-600 py-2">
                           {t('modes.logic_order.empty_options')}
                       </div>
                   )}
                </div>
             </div>

          </div>
        </div>
      </LayoutGroup>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/MatchingView.tsx ===================

'use client';

import { useState, useMemo } from 'react';
import { Challenge, MatchingContent } from '@/core/entities/challenges/challenge.entity';
import { Check, ArrowRight, Puzzle } from 'lucide-react';
import { clsx } from 'clsx';

// --- UTILS ---

function pseudoRandom(seed: number) {
  let t = seed += 0x6D2B79F5;
  t = Math.imul(t ^ t >>> 15, t | 1);
  t ^= t + Math.imul(t ^ t >>> 7, t | 61);
  return ((t ^ t >>> 14) >>> 0) / 4294967296;
}

function cyrb53(str: string, seed = 0) {
  let h1 = 0xdeadbeef ^ seed, h2 = 0x41c6ce57 ^ seed;
  for (let i = 0, ch; i < str.length; i++) {
    ch = str.charCodeAt(i);
    h1 = Math.imul(h1 ^ ch, 2654435761);
    h2 = Math.imul(h2 ^ ch, 1597334677);
  }
  h1 = Math.imul(h1 ^ (h1 >>> 16), 2246822507) ^ Math.imul(h2 ^ (h2 >>> 13), 3266489909);
  h2 = Math.imul(h2 ^ (h2 >>> 16), 2246822507) ^ Math.imul(h1 ^ (h1 >>> 13), 3266489909);
  return 4294967296 * (2097151 & h2) + (h1 >>> 0);
}

// ✅ CORRECCIÓ 1: Protecció contra arrays nuls o indefinits
function seededShuffle<T>(array: T[] | undefined | null, seedString: string): T[] {
  if (!array || !Array.isArray(array)) {
      console.warn("seededShuffle rebut un array invàlid:", array);
      return []; 
  }
  const copy = [...array];
  let seed = cyrb53(seedString);

  for (let i = copy.length - 1; i > 0; i--) {
    const randomFloat = pseudoRandom(seed++);
    const j = Math.floor(randomFloat * (i + 1));
    [copy[i], copy[j]] = [copy[j], copy[i]];
  }
  return copy;
}

// --- COMPONENT ---

interface MatchingViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
}

export function MatchingView({ challenge, onNext }: MatchingViewProps) {
  const content = challenge.content as MatchingContent;
  
  // ESTAT UI
  const [selectedLeft, setSelectedLeft] = useState<string | null>(null);
  const [matchedPairs, setMatchedPairs] = useState<Set<string>>(new Set());
  const [errorPair, setErrorPair] = useState<{left: string, right: string} | null>(null);
  const [isCompleted, setIsCompleted] = useState(false);

  // ✅ CORRECCIÓ 2: Protecció dins del useMemo
  const rightOptions = useMemo(() => {
    // Si no hi ha contingut o no hi ha pairs, retornem buit per evitar l'error
    if (!content || !content.pairs) return [];
    
    return seededShuffle(content.pairs, challenge.id);
  }, [content, challenge.id]);

  // Si no hi ha parelles carregades, mostrem un error o loader en lloc de petar
  if (!content?.pairs || content.pairs.length === 0) {
      return <div className="text-center p-10 text-red-400">Error: No s'han trobat parelles per relacionar.</div>;
  }

  const handleLeftClick = (id: string) => {
    if (matchedPairs.has(id)) return; 
    setSelectedLeft(id);
    setErrorPair(null);
  };

  const handleRightClick = (rightId: string) => {
    if (!selectedLeft) return; 

    const pair = content.pairs.find(p => p.left.id === selectedLeft);

    if (pair && pair.right.id === rightId) {
      const newMatches = new Set(matchedPairs);
      newMatches.add(selectedLeft);
      setMatchedPairs(newMatches);
      setSelectedLeft(null);

      if (newMatches.size === content.pairs.length) {
        setIsCompleted(true);
      }
    } else {
      setErrorPair({ left: selectedLeft, right: rightId });
      setTimeout(() => {
        setErrorPair(null);
        setSelectedLeft(null);
      }, 800);
    }
  };

  return (
    <div className="w-full max-w-4xl mx-auto animate-in fade-in slide-in-from-bottom-4 duration-500">
      
      <div className="text-center mb-8">
         <div className="inline-flex items-center justify-center p-3 bg-purple-500/10 rounded-full mb-4">
            <Puzzle className="w-8 h-8 text-purple-400" />
         </div>
         <h2 className="text-xl md:text-2xl font-bold text-white">
            {content.instruction}
         </h2>
         <p className="text-slate-400 mt-2 text-sm">Selecciona un element de cada columna per relacionar-los.</p>
      </div>

      <div className="grid grid-cols-2 gap-8 md:gap-12 relative">
         
         {/* COLUMNA ESQUERRA */}
         <div className="flex flex-col gap-4">
            {content.pairs.map((pair) => {
               const isMatched = matchedPairs.has(pair.left.id);
               const isSelected = selectedLeft === pair.left.id;
               const isError = errorPair?.left === pair.left.id;

               return (
                  <button
                    key={pair.left.id}
                    onClick={() => handleLeftClick(pair.left.id)}
                    disabled={isMatched}
                    className={clsx(
                       "p-4 rounded-xl border-2 text-left transition-all duration-300 relative select-none",
                       isMatched ? "bg-green-500/10 border-green-500 text-green-400 opacity-50" :
                       isError ? "bg-red-500/10 border-red-500 text-red-400 shake-animation" :
                       isSelected ? "bg-blue-600/20 border-blue-500 text-blue-200 scale-105 shadow-lg shadow-blue-500/20" :
                       "bg-slate-800 border-slate-700 text-slate-300 hover:border-slate-500 hover:bg-slate-700"
                    )}
                  >
                     {pair.left.text}
                     {isMatched && <Check className="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5" />}
                  </button>
               );
            })}
         </div>

         {/* COLUMNA DRETA */}
         <div className="flex flex-col gap-4">
            {rightOptions.map((pair) => {
               const originalPair = content.pairs.find(p => p.right.id === pair.right.id);
               // Safe navigation operator ?. per evitar crash si originalPair no es troba
               const isMatched = originalPair && matchedPairs.has(originalPair.left.id);
               const isError = errorPair?.right === pair.right.id;

               return (
                  <button
                    key={pair.right.id}
                    onClick={() => handleRightClick(pair.right.id)}
                    disabled={isMatched || !selectedLeft}
                    className={clsx(
                       "p-4 rounded-xl border-2 text-left transition-all duration-300 relative select-none",
                       isMatched ? "bg-green-500/10 border-green-500 text-green-400 opacity-50" :
                       isError ? "bg-red-500/10 border-red-500 text-red-400 shake-animation" :
                       selectedLeft && !isMatched ? "bg-slate-800 border-slate-600 cursor-pointer hover:border-purple-400 hover:bg-slate-700" :
                       "bg-slate-800 border-slate-800 text-slate-500 cursor-not-allowed opacity-60"
                    )}
                  >
                     {pair.right.text}
                  </button>
               );
            })}
         </div>
      </div>

      {isCompleted && (
         <div className="mt-8 flex justify-center animate-in zoom-in duration-300">
            <button
               onClick={() => onNext(true)}
               className="px-8 py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl flex items-center gap-2 shadow-lg hover:scale-105 transition-all"
            >
               NIVELL SUPERAT <ArrowRight className="w-5 h-5" />
            </button>
         </div>
      )}

    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/QuizView.tsx ===================

// filepath: src/presentation/components/features/game-engine/QuizView.tsx
'use client';

import { useState } from 'react';
import { Challenge, QuizContent } from '@/core/entities/challenges/challenge.entity';
import { CheckCircle2, XCircle, ArrowRight } from 'lucide-react';
import { clsx } from 'clsx';


interface QuizViewProps {
  challenge: Challenge;
  // ✅ CORRECCIÓ 1: La signatura ha de coincidir amb el que envia el pare
  onNext: (isCorrect: boolean) => void;
}

export function QuizView({ challenge, onNext }: QuizViewProps) {
  // const t = useTranslations('game.quiz'); 
  
  const [selectedOptionId, setSelectedOptionId] = useState<string | null>(null);
  const [isSubmitted, setIsSubmitted] = useState(false);

  const content = challenge.content as QuizContent;

  const handleOptionClick = (optionId: string) => {
    if (isSubmitted) return; 
    setSelectedOptionId(optionId);
    setIsSubmitted(true);
  };

  // ✅ CORRECCIÓ 2: Funció per gestionar el click a "Continuar"
  const handleContinue = () => {
    // Calculem si és correcte buscant l'índex de l'ID seleccionat
    const selectedIndex = content.options.findIndex(o => o.id === selectedOptionId);
    const isCorrect = selectedIndex === content.correctOptionIndex;
    
    // Avisem al pare amb el resultat
    onNext(isCorrect);
  };

  const getOptionStyles = (optionId: string, index: number) => {
    if (!isSubmitted) {
      return "border-slate-700 bg-slate-800/50 hover:bg-slate-700 hover:border-blue-500/50 text-slate-300 cursor-pointer active:scale-[0.98]";
    }

    const isCorrect = index === content.correctOptionIndex;
    const isSelected = optionId === selectedOptionId;

    if (isCorrect) {
      return "border-green-500 bg-green-500/20 text-green-400 shadow-[0_0_15px_rgba(34,197,94,0.3)] font-bold";
    }

    if (isSelected && !isCorrect) {
      return "border-red-500 bg-red-500/10 text-red-400 opacity-90 shake-animation"; 
    }

    return "border-slate-800 bg-slate-900/50 text-slate-600 opacity-40 grayscale";
  };

  // Helpers per determinar l'estat actual visualment
  const selectedIndex = content.options.findIndex(o => o.id === selectedOptionId);
  const isCorrectAnswer = selectedIndex === content.correctOptionIndex;

  return (
    <div className="w-full max-w-2xl mx-auto flex flex-col gap-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
      
      {/* PREGUNTA */}
      <div className="bg-slate-900/80 p-6 rounded-2xl border border-slate-800 shadow-xl backdrop-blur-sm relative overflow-hidden">
        <div className="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2" />
        <h2 className="text-xl md:text-2xl font-bold text-white leading-relaxed relative z-10">
          {content.question}
        </h2>
      </div>

      {/* OPCIONS */}
      <div className="grid gap-3">
        {content.options.map((option, index) => {
            const isOptCorrect = index === content.correctOptionIndex;
            const isOptSelected = option.id === selectedOptionId;

            return (
              <button
                key={option.id}
                onClick={() => handleOptionClick(option.id)}
                disabled={isSubmitted}
                className={clsx(
                  "w-full text-left p-4 rounded-xl border-2 transition-all duration-300 flex items-center justify-between group relative overflow-hidden",
                  getOptionStyles(option.id, index)
                )}
              >
                <div className="flex items-center gap-4 z-10 w-full">
                    {/* Badge A, B, C... */}
                    <div className={clsx(
                        "w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold border transition-colors",
                        isSubmitted && isOptCorrect ? "bg-green-500 border-green-500 text-slate-900" :
                        isSubmitted && isOptSelected ? "bg-red-500 border-red-500 text-white" :
                        "bg-slate-800 border-slate-600 text-slate-400 group-hover:border-blue-500 group-hover:text-blue-400"
                    )}>
                        {String.fromCharCode(65 + index)}
                    </div>
                    
                    <span className="font-medium text-lg flex-1">{option.text}</span>

                    {isSubmitted && isOptCorrect && (
                        <CheckCircle2 className="w-6 h-6 text-green-400 animate-in zoom-in spin-in-90 duration-300" />
                    )}
                    {isSubmitted && isOptSelected && !isOptCorrect && (
                        <XCircle className="w-6 h-6 text-red-400 animate-in zoom-in duration-300" />
                    )}
                </div>
              </button>
            );
        })}
      </div>

      {/* FEEDBACK & NEXT BUTTON */}
      {isSubmitted && (
        <div className={clsx(
            "rounded-2xl p-1 animate-in slide-in-from-bottom-2 duration-300 overflow-hidden shadow-2xl",
             isCorrectAnswer 
                ? "bg-linear-to-r from-green-500 to-emerald-600" 
                : "bg-linear-to-r from-red-500 to-rose-600"
        )}>
           <div className="bg-slate-950 rounded-xl p-5">
               <div className="flex items-start gap-4 mb-4">
                  <div className={clsx("p-3 rounded-full shrink-0", 
                      isCorrectAnswer ? "bg-green-500/20 text-green-400" : "bg-red-500/20 text-red-400"
                  )}>
                      {isCorrectAnswer ? <CheckCircle2 className="w-6 h-6" /> : <XCircle className="w-6 h-6" />}
                  </div>
                  <div>
                      <h3 className={clsx("font-bold text-lg mb-1", isCorrectAnswer ? "text-green-400" : "text-red-400")}>
                          {isCorrectAnswer ? "Correcte!" : "Incorrecte"}
                      </h3>
                      <p className="text-slate-300 text-sm leading-relaxed">
                          {content.explanation}
                      </p>
                  </div>
               </div>

               <button 
                 // ✅ CORRECCIÓ 3: Cridem al handler que passa el boolean, no directament onNext
                 onClick={handleContinue}
                 className={clsx(
                    "w-full py-3.5 font-bold rounded-lg transition-transform active:scale-[0.98] flex items-center justify-center gap-2 shadow-lg",
                    isCorrectAnswer 
                    ? "bg-green-600 hover:bg-green-500 text-white"
                    : "bg-red-600 hover:bg-red-500 text-white"
                 )}
               >
                 CONTINUAR <ArrowRight className="w-5 h-5" />
               </button>
           </div>
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/presentation/components/features/game-engine/TerminalView.tsx ===================

// filepath: src/presentation/components/features/game-engine/TerminalView.tsx
'use client';

import { useState, useRef, useEffect } from 'react';
import { Challenge, TerminalContent } from '@/core/entities/challenges/challenge.entity';
import { Terminal as TerminalIcon, ArrowRight, CheckCircle2, Command, X as CloseIcon } from 'lucide-react';
import { HintPanel } from './code-fix/HintPanel';
import { GameSessionLayout } from './layout/GameSessionLayout';
import { Link } from '@/navigation';
import { SessionData } from './ChallengeRenderer';
// 1. IMPORTEM EL HOOK DE TRADUCCIÓ
import { useTranslations } from 'next-intl';

interface TerminalViewProps {
  challenge: Challenge;
  onNext: (isCorrect: boolean) => void;
  sessionData: SessionData;
}

type LogLine = {
  type: 'command' | 'output-success' | 'output-error';
  text: string;
};

export function TerminalView({ challenge, onNext, sessionData }: TerminalViewProps) {
  // 2. INICIALITZEM EL HOOK (Namespace 'game')
  const t = useTranslations('game');
  
  const content = challenge.content as TerminalContent;
  
  const [input, setInput] = useState(content.initialCommand || '');
  const [history, setHistory] = useState<LogLine[]>([]);
  const [isCompleted, setIsCompleted] = useState(false);
  
  const inputRef = useRef<HTMLInputElement>(null);
  const scrollRef = useRef<HTMLDivElement>(null);

  // Auto-scroll
  useEffect(() => {
    if (scrollRef.current) {
      scrollRef.current.scrollTop = scrollRef.current.scrollHeight;
    }
  }, [history]);

  // Focus
  useEffect(() => {
    if (!isCompleted) {
        setTimeout(() => inputRef.current?.focus(), 100);
    }
  }, [history, isCompleted]);

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter' && !isCompleted && input.trim()) {
      executeCommand();
    }
  };

  const executeCommand = () => {
    const cmd = input.trim();
    const newHistory: LogLine[] = [...history, { type: 'command', text: cmd }];

    const normalizedInput = cmd.replace(/\s+/g, ' ').trim();
    const isValid = content.validCommands.some(vc => vc.replace(/\s+/g, ' ').trim() === normalizedInput);

    if (isValid) {
      newHistory.push({ type: 'output-success', text: content.outputParams.success });
      setHistory(newHistory);
      setIsCompleted(true);
      setInput('');
    } else {
      newHistory.push({ type: 'output-error', text: `${cmd}: ${content.outputParams.error}` });
      setHistory(newHistory);
      setInput('');
    }
  };

  // --- HEADER ---
  const Header = (
    <div className="flex items-center gap-4 w-full">
        <Link href={`/learn/${sessionData.topicSlug}`} className="text-slate-400 hover:text-white p-1">
           <CloseIcon className="w-6 h-6" />
        </Link>
        <div className="flex-1 h-3 bg-slate-800 rounded-full overflow-hidden border border-slate-700">
            <div 
              className="bg-blue-500 h-full transition-all duration-500 ease-out"
              style={{ width: `${sessionData.progress}%` }} 
            />
        </div>
    </div>
  );

  // --- FOOTER ---
  const Footer = isCompleted ? (
    <div className="animate-in slide-in-from-bottom-4 duration-500 w-full">
        <div className="bg-green-900/20 border border-green-500/30 rounded-xl p-4 flex flex-col gap-3 backdrop-blur-md">
            <div className="flex items-start gap-3">
                <CheckCircle2 className="w-5 h-5 text-green-400 shrink-0 mt-0.5" />
                <div>
                    {/* Traducció: "Correcte!" */}
                    <h3 className="text-green-400 font-bold text-sm">{t('feedback.correct')}</h3>
                    <p className="text-slate-300 text-xs leading-relaxed line-clamp-3">
                        {content.explanation}
                    </p>
                </div>
            </div>
            <button 
                onClick={() => onNext(true)}
                className="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg active:scale-95"
            >
                {/* Traducció: "CONTINUAR" */}
                {t('actions.continue')} <ArrowRight className="w-5 h-5" />
            </button>
        </div>
    </div>
  ) : (
    content.hint ? <div className="w-full"><HintPanel hintText={content.hint} /></div> : <div className="h-4" />
  );

  return (
    <GameSessionLayout header={Header} footer={Footer}>
      <div className="flex flex-col h-full gap-2">
        
        {/* TITOL (Fixe) */}
        <div className="shrink-0 flex items-start gap-3 px-1 pb-2">
           <div className="p-2 bg-slate-800 rounded-lg shrink-0 border border-slate-700 shadow-sm">
              <TerminalIcon className="w-5 h-5 text-green-400" />
           </div>
           <div className="min-w-0">
              {/* Traducció: "Terminal" */}
              <h2 className="font-bold text-white text-base leading-tight truncate">{t('modes.terminal.label')}</h2>
              <p className="text-slate-400 text-xs leading-snug mt-0.5 line-clamp-2">{content.instruction}</p>
           </div>
        </div>

        {/* TERMINAL */}
        <div 
          className="flex-1 min-h-0 bg-[#0c0c0c] rounded-xl overflow-hidden border border-slate-700 shadow-2xl font-mono text-sm relative flex flex-col"
          onClick={() => !isCompleted && inputRef.current?.focus()}
        >
          {/* Top Bar */}
          <div className="bg-[#1f1f1f] px-3 py-1.5 flex items-center gap-2 border-b border-[#333] shrink-0">
            <div className="flex gap-1.5">
               <div className="w-2.5 h-2.5 rounded-full bg-red-500/80"></div>
               <div className="w-2.5 h-2.5 rounded-full bg-yellow-500/80"></div>
               <div className="w-2.5 h-2.5 rounded-full bg-green-500/80"></div>
            </div>
            <div className="text-slate-500 text-[10px] ml-2 flex items-center gap-1 opacity-60">
               {/* Traducció: "usuari@edutech:~" */}
               <Command className="w-3 h-3" /> {t('modes.terminal.prompt_user')}@edutech:~
            </div>
          </div>

          {/* Logs Area */}
          <div 
            ref={scrollRef}
            className="flex-1 overflow-y-auto p-3 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-transparent space-y-1"
          >
            {history.map((line, i) => (
              <div key={i} className="wrap-break-word leading-relaxed text-xs md:text-sm">
                {line.type === 'command' && (
                  <div className="text-white mt-2">
                    <span className="text-green-500 mr-2 font-bold">➜</span>
                    <span className="text-blue-400 mr-2 font-bold">~</span>
                    {line.text}
                  </div>
                )}
                {line.type === 'output-success' && (
                  <div className="text-emerald-400/90 whitespace-pre-wrap pl-4 border-l-2 border-emerald-500/30 ml-1 mt-1 font-medium pb-2">
                    {line.text}
                  </div>
                )}
                {line.type === 'output-error' && (
                  <div className="text-red-400 pl-4 mt-1 bg-red-500/5 p-1 rounded-sm inline-block">
                    {line.text}
                  </div>
                )}
              </div>
            ))}

            {/* Input Actiu */}
            {!isCompleted && (
              <div className="flex items-center text-white animate-in fade-in pt-1 pb-10">
                <span className="text-green-500 mr-2 shrink-0 font-bold">➜</span>
                <span className="text-blue-400 mr-2 shrink-0 font-bold">~</span>
                <input
                  ref={inputRef}
                  type="text"
                  value={input}
                  onChange={(e) => setInput(e.target.value)}
                  onKeyDown={handleKeyDown}
                  // Afegim placeholder traduït
                  placeholder={t('modes.terminal.placeholder')}
                  className="bg-transparent border-none outline-none flex-1 text-white placeholder-slate-700 font-mono caret-green-500 p-0 m-0"
                  autoComplete="off"
                  spellCheck="false"
                  autoFocus
                />
              </div>
            )}
            
            {/* Missatge Final */}
            {isCompleted && (
               <div className="mt-4 text-slate-500 italic text-xs border-t border-slate-800 pt-2">
                  {/* Traducció: "--- Sessió finalitzada ---" */}
                  {t('modes.terminal.session_closed')}
               </div>
            )}
          </div>
        </div>

      </div>
    </GameSessionLayout>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/HorizontalPath.tsx ===================

// filepath: src/presentation/components/features/learning-path/HorizontalPath.tsx
'use client';

import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { LevelNode } from './LevelNode';
import { useRef, useEffect } from 'react';

interface PathProps {
  levels: LevelNodeDTO[];
  slug: string;
}

export function HorizontalPath({ levels, slug }: PathProps) {
  const containerRef = useRef<HTMLDivElement>(null);

  // Auto-scroll fins al nivell actual quan carregui la pàgina
  useEffect(() => {
    if (containerRef.current) {
        const activeNode = containerRef.current.querySelector('[data-active="true"]');
        if (activeNode) {
            activeNode.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'center' });
        }
    }
  }, []);

  // CONFIGURACIÓ ESCRIPTORI
  const AMPLITUDE_Y = 60; // Quant puja i baixa la corba
  const HORIZONTAL_GAP = 160; // Espai entre nodes
  const INITIAL_X = 100;

  // Amplada total necessària per al SVG
  const totalWidth = (levels.length * HORIZONTAL_GAP) + 300;

  return (
    <div 
        ref={containerRef}
        className="w-full h-[80vh] overflow-x-auto overflow-y-hidden relative custom-scrollbar flex items-center"
        style={{ scrollBehavior: 'smooth' }}
    >
        <div className="relative h-full flex items-center" style={{ minWidth: `${totalWidth}px` }}>
            
            {/* SVG HORITZONTAL (Ona sinusoïdal lateral) */}
            <svg className="absolute left-0 w-full h-full pointer-events-none opacity-20" style={{ zIndex: 0 }}>
                <path 
                d={`M ${INITIAL_X} 50% ${levels.map((_, i) => {
                    const yOffset = Math.sin(i) * AMPLITUDE_Y; 
                    // Aquí la lògica és inversa: Avancem en X, oscil·lem en Y
                    return `L ${INITIAL_X + (i * HORIZONTAL_GAP)}px calc(50% + ${yOffset}px)`;
                }).join(' ')}`}
                fill="none" 
                stroke="#64748b" 
                strokeWidth="4" 
                strokeDasharray="12,12"
                strokeLinecap="round"
                strokeLinejoin="round"
                />
            </svg>

            {/* NODES HORITZONTALS */}
            {levels.map((level, index) => {
                const yOffset = Math.sin(index) * AMPLITUDE_Y;
                const leftPos = INITIAL_X + (index * HORIZONTAL_GAP);

                return (
                    <div 
                        key={level.tier}
                        data-active={level.isCurrentPosition}
                        className="absolute transition-all duration-500 hover:z-50"
                        style={{ 
                            left: `${leftPos}px`,
                            // Centrem verticalment (50%) i apliquem l'oscil·lació
                            top: `calc(50% + ${yOffset}px - 48px)` // -48px és la meitat de l'alçada del node (96px/2) per centrar-lo
                        }}
                    >
                        <LevelNode 
                            {...level}
                            slug={slug}
                            index={index}
                        />
                    </div>
                );
            })}

            {/* BOSS FINAL */}
             <div 
                className="absolute opacity-40"
                style={{ 
                    left: `${INITIAL_X + (levels.length * HORIZONTAL_GAP)}px`,
                    top: `calc(50% - 64px)` 
                }}
             >
                 <div className="w-32 h-32 border-4 border-dashed border-slate-700 rounded-full flex items-center justify-center text-slate-500 font-black text-xl bg-slate-900/50">
                    BOSS
                 </div>
             </div>

        </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/LearningPathOrchestrator.tsx ===================

// filepath: src/presentation/components/features/learning-path/LearningPathOrchestrator.tsx
'use client';

import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { VerticalPath } from './VerticalPath';
import { HorizontalPath } from './HorizontalPath';

interface OrchestratorProps {
  levels: LevelNodeDTO[];
  slug: string;
}

export function LearningPathOrchestrator({ levels, slug }: OrchestratorProps) {
  return (
    <>
      {/* VERSIÓ MÒBIL: Visible fins a md, després s'amaga */}
      <div className="block md:hidden w-full pb-32">
        <VerticalPath levels={levels} slug={slug} />
      </div>

      {/* VERSIÓ ESCRIPTORI: Oculta fins a md, després es mostra */}
      <div className="hidden md:block w-full h-full min-h-[80vh]">
        <HorizontalPath levels={levels} slug={slug} />
      </div>
    </>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/LevelNode.tsx ===================

// filepath: src/presentation/components/features/learning-path/LevelNode.tsx
'use client';

import Link from 'next/link';
import {
  Check, Lock, Puzzle, Brain,
  ArrowDownUp, SquareTerminal, Wrench
} from 'lucide-react';
import { clsx } from 'clsx';
import { LevelStatus } from '@/application/dto/level-node.dto';
import { ChallengeType } from '@/core/entities/challenges/challenge.entity';


interface LevelNodeProps {
  tier: number;
  status: LevelStatus;
  slug: string;
  index: number;
  predominantType?: ChallengeType;
  isCurrentPosition?: boolean;
}

// ✅ HELPER EXTERN NETEJAR
// Ara aquesta funció NOMÉS retorna el tipus de joc. No es preocupa de l'estat.
function getGameIcon(type: string) {
  switch (type) {
    case 'TERMINAL':
      return <SquareTerminal className="w-8 h-8" />;
    case 'LOGIC_ORDER':
      return <ArrowDownUp className="w-8 h-8" />;
    case 'CODE_FIX':
      return <Wrench className="w-8 h-8" />;
    case 'MATCHING':
      return <Puzzle className="w-8 h-8" />;
    case 'QUIZ':
    default:
      return <Brain className="w-8 h-8" />;
  }
}

export function LevelNode({ tier, status, slug, index, predominantType = 'QUIZ', isCurrentPosition }: LevelNodeProps) {
  // const t = useTranslations('game.level_node');


  // 🎨 CANVIS DE DISSENY:
  // 1. w-16 h-16 (64px) per mòbil -> w-24 h-24 (96px) per escriptori
  // 2. border-b-4 (més subtil en mòbil)
  const baseStyles = "relative w-16 h-16 md:w-24 md:h-24 rounded-full flex flex-col items-center justify-center border-b-4 md:border-b-[6px] transition-all duration-300 z-10 active:border-b-0 active:translate-y-[4px]";
  const statusStyles = {
    // LOCKED: Gris fosc, icona apagada
    LOCKED: "bg-slate-800 border-slate-950 text-slate-500 cursor-not-allowed",
    // COMPLETED: Verd maragda
    COMPLETED: "bg-emerald-500 border-emerald-700 text-white shadow-lg shadow-emerald-900/20",
    // ACTIVE: Blau elèctric
    ACTIVE: "bg-blue-600 border-blue-800 text-white shadow-[0_0_40px_rgba(37,99,235,0.4)] ring-4 ring-blue-500/20"
  };

  const content = (
    <div className="relative group">

      {/* INDICADOR "START" (Només si és la posició actual) */}
      {isCurrentPosition && (
        <div className="absolute -top-16 left-1/2 -translate-x-1/2 flex flex-col items-center animate-bounce z-30 pointer-events-none">
          <div className="bg-white text-blue-600 px-3 py-1 rounded-lg font-bold text-xs shadow-xl mb-1 uppercase tracking-wider border-2 border-blue-100">
            START
          </div>
          <div className="w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-8 border-t-white"></div>
        </div>
      )}

      {/* CERCLE PRINCIPAL */}
      <div className={clsx(baseStyles, statusStyles[status])}>

        {/* ICONA CENTRAL */}
        <div className={clsx(
          "transition-transform duration-300",
          status === 'ACTIVE' ? "scale-110" : "group-hover:scale-110",
          // Si està bloquejat, fem la icona una mica més transparent/grisa
          status === 'LOCKED' && "opacity-40 grayscale"
        )}>
          {/* 🟢 ARA SEMPRE MOSTREM LA ICONA DEL JOC, FINS I TOT BLOQUEJAT */}
          {getGameIcon(predominantType)}
        </div>

        {/* BADGE: COMPLETAT (Check) */}
        {status === 'COMPLETED' && (
          <div className="absolute -right-2 -top-2 bg-yellow-400 text-yellow-900 rounded-full p-1.5 border-4 border-slate-950 shadow-sm z-20 animate-in zoom-in">
            <Check className="w-4 h-4 stroke-4" />
          </div>
        )}

        {/* BADGE: BLOQUEJAT (Cadenat petit) */}
        {status === 'LOCKED' && (
          <div className="absolute -right-1 -bottom-1 bg-slate-700 text-slate-400 rounded-full p-1.5 border-4 border-slate-950 z-20">
            <Lock className="w-3 h-3" />
          </div>
        )}
      </div>

      {/* TEXT NIVELL (A sota) */}
      <div className={clsx(
        "absolute -bottom-10 left-1/2 -translate-x-1/2 px-3 py-1 rounded-full border text-[10px] font-bold whitespace-nowrap shadow-md transition-colors",
        status === 'ACTIVE' ? "bg-blue-600 border-blue-400 text-white" : "bg-slate-900 border-slate-700 text-slate-400"
      )}>
        NIVELL {tier}
      </div>
    </div>
  );

  // Si està bloquejat, no posem Link
  if (status === 'LOCKED') {
    return <div className="flex justify-center py-4">{content}</div>;
  }

  // Si està actiu o completat, és clicable
  return (
    <div className="flex justify-center py-4">
      <Link href={`/learn/${slug}/play?tier=${tier}`} aria-label={`Nivell ${tier}`}>
        {content}
      </Link>
    </div>
  );
}

// =================== FILE: src/presentation/components/features/learning-path/VerticalPath.tsx ===================

// filepath: src/presentation/components/features/learning-path/VerticalPath.tsx
'use client';

import { LevelNodeDTO } from '@/application/dto/level-node.dto';
import { LevelNode } from './LevelNode';

interface PathProps {
  levels: LevelNodeDTO[];
  slug: string;
}

export function VerticalPath({ levels, slug }: PathProps) {
  // CONFIGURACIÓ MÒBIL
  const AMPLITUDE = 75; 
  const VERTICAL_GAP = 88; 
  const INITIAL_Y = 40;

  return (
      <div className="relative mt-8 w-full flex flex-col items-center">
         
         {/* SVG MÒBIL */}
         <svg className="absolute top-0 w-full h-full pointer-events-none opacity-30" style={{ zIndex: 0 }}>
            <path 
              d={`M 50% ${INITIAL_Y} ${levels.map((_, i) => {
                 const xOffset = Math.sin(i) * AMPLITUDE; 
                 return `L calc(50% + ${xOffset}px) ${i * VERTICAL_GAP + INITIAL_Y}`;
              }).join(' ')}`}
              fill="none" 
              stroke="#475569" 
              strokeWidth="6" 
              strokeDasharray="8,8"
              strokeLinecap="round"
              strokeLinejoin="round"
            />
         </svg>

         {/* NODES MÒBIL */}
         <div className="flex flex-col gap-6 w-full relative z-10 items-center">
             {levels.map((level, index) => {
                 const xOffset = Math.sin(index) * AMPLITUDE; 
                 return (
                    <div 
                      key={level.tier} 
                      style={{ transform: `translateX(${xOffset}px)` }}
                      className="transition-transform duration-500"
                    >
                       <LevelNode 
                          {...level}
                          slug={slug}
                          index={index}
                       />
                    </div>
                 );
             })}
             
             <div className="flex justify-center mt-8 opacity-40">
                 <div className="w-24 h-24 border-4 border-dashed border-slate-700 rounded-full flex items-center justify-center text-slate-600 font-black text-sm bg-slate-900/50">
                    BOSS
                 </div>
             </div>
         </div>
      </div>
  );
}

// =================== FILE: src/presentation/components/features/topics/TopicCard.tsx ===================

// filepath: src/presentation/components/features/topics/TopicCard.tsx
import { createElement } from 'react';
import { Topic } from '@/core/entities/topic.entity';
import { getTopicIcon } from '@/presentation/utils/icon-mapper';
import { useTranslations, useLocale } from 'next-intl'; // <--- Importem useLocale
import Link from 'next/link';

interface TopicCardProps {
  topic: Topic;
}

export function TopicCard({ topic }: TopicCardProps) {
  const t = useTranslations(); 
  const locale = useLocale(); // <--- Obtenim l'idioma actual ('ca', 'en', etc.)
  
  const IconComponent = getTopicIcon(topic.iconName);

  return (
    <Link 
      // CORRECCIÓ: Afegim el locale a la ruta
      href={`/${locale}/learn/${topic.slug}`} 
      className="group relative block overflow-hidden rounded-xl bg-slate-800 border border-slate-700 hover:border-blue-500 transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/20"
    >
      <div className={`absolute inset-0 opacity-0 group-hover:opacity-10 transition-opacity ${topic.colorTheme}`} />
      
      <div className="p-6">
        <div className={`w-12 h-12 rounded-lg flex items-center justify-center mb-4 ${topic.colorTheme} bg-opacity-20 text-white`}>
          {createElement(IconComponent, { className: "w-6 h-6" })}
        </div>

        <h3 className="text-xl font-bold text-white mb-2">
          
          {t(topic.nameKey)} 
        </h3>
        
        <div className="flex items-center text-sm text-slate-400 group-hover:text-blue-400 transition-colors">
          <span>{t('dashboard.startTopic')}</span>
          <svg className="w-4 h-4 ml-2 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
          </svg>
        </div>
      </div>
    </Link>
  );
}

// =================== FILE: src/presentation/components/layout/DesktopNavbar.tsx ===================

// filepath: src/presentation/components/layout/DesktopNavbar.tsx
'use client';

// IMPORTACIONS ARQUITECTÒNIQUES: Usem el nostre wrapper, no el de Next directament
import { Link } from '@/navigation'; 
import { LanguageSwitcher } from '../ui/gamified/LanguagerSwitcher';
import { Button3D } from '../ui/gamified/Button3D';
import { LogOut, User } from 'lucide-react';
import { logoutAction } from '@/presentation/actions/auth/logout.actions';

interface DesktopNavbarProps {
  isLoggedIn: boolean;
}

export function DesktopNavbar({ isLoggedIn }: DesktopNavbarProps) {
  // No necessitem useLocale(), el Link ja sap on som.

  return (
    <header className="hidden md:flex w-full h-20 border-b-2 border-slate-800 bg-slate-900/80 backdrop-blur-md fixed top-0 z-50 px-8 items-center justify-between">
      {/* LOGO - Ruta neta '/' */}
      <Link href="/" className="text-2xl font-black tracking-tighter text-green-500 hover:scale-105 transition-transform">
        edu<span className="text-white">Tech</span>
      </Link>

      {/* ACCIONS DRETA */}
      <div className="flex items-center gap-4">
        <LanguageSwitcher />

        {isLoggedIn ? (
          <div className="flex gap-3">
             {/* Rutes netes sense ${locale} */}
             <Link href="/profile">
                <Button3D variant="outline" className="py-2 px-4 text-sm">
                   <User className="w-4 h-4" /> Perfil
                </Button3D>
             </Link>
             <div onClick={() => logoutAction()} className="cursor-pointer">
                <Button3D variant="danger" className="py-2 px-4 text-sm">
                   <LogOut className="w-4 h-4" />
                </Button3D>
             </div>
          </div>
        ) : (
          <div className="flex gap-3">
            <Link href="/login">
               <Button3D variant="outline" className="py-2 px-6 text-sm">
                 Entrar
               </Button3D>
            </Link>
            <Link href="/register">
               <Button3D variant="primary" className="py-2 px-6 text-sm">
                 Començar
               </Button3D>
            </Link>
          </div>
        )}
      </div>
    </header>
  );
}

// =================== FILE: src/presentation/components/layout/MobileBottomBar.tsx ===================

// filepath: src/presentation/components/layout/MobileBottomBar.tsx
'use client';

import { Link, usePathname } from '@/navigation';
import { Home, Zap, User, LogIn } from 'lucide-react';
import { clsx } from 'clsx';

interface MobileBottomBarProps {
  isLoggedIn: boolean;
}

export function MobileBottomBar({ isLoggedIn }: MobileBottomBarProps) {
  const pathname = usePathname();

  // 🛑 LOGICA D'ARQUITECTE: SI ESTEM JUGANT, NO MOSTREM LA BARRA
  // Això dóna tota la pantalla al joc (100dvh real)
  if (pathname.includes('/play') || pathname.includes('/arena')) {
    return null;
  }

  const navItems = [
    { label: 'Inici', href: '/', icon: Home },
    { label: 'Aprendre', href: '/learn', icon: Zap },
    { label: isLoggedIn ? 'Perfil' : 'Entrar', href: isLoggedIn ? '/profile' : '/login', icon: isLoggedIn ? User : LogIn }
  ];

  return (
    <div className="fixed bottom-0 left-0 w-full bg-slate-950/90 backdrop-blur-md border-t border-slate-800 px-6 py-3 md:hidden z-50 pb-safe">
      <div className="flex justify-between items-center max-w-sm mx-auto">
        {navItems.map((item) => {
          const isActive = pathname === item.href;
          const Icon = item.icon;
          
          return (
            <Link 
              key={item.href} 
              href={item.href}
              className={clsx(
                "flex flex-col items-center gap-1 transition-all active:scale-90",
                isActive ? "text-blue-400" : "text-slate-500 hover:text-slate-300"
              )}
            >
              <Icon className={clsx("w-6 h-6", isActive && "fill-current")} />
              <span className="text-[10px] font-bold tracking-wide uppercase">{item.label}</span>
            </Link>
          );
        })}
      </div>
    </div>
  );
}

// =================== FILE: src/presentation/components/ui/gamified/Button3D.tsx ===================

'use client';

import { ButtonHTMLAttributes, ReactNode } from 'react';
import { clsx } from 'clsx';
import { Loader2 } from 'lucide-react';

interface Button3DProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'success' | 'danger' | 'outline';
  isLoading?: boolean;
  children: ReactNode;
}

export function Button3D({ 
  children, 
  variant = 'primary', 
  isLoading, 
  className,
  disabled,
  ...props 
}: Button3DProps) {
  
  // Mapeig de variants a les nostres classes globals
  const variantClasses = {
    primary: 'btn-primary',
    success: 'btn-success',
    danger: 'btn-danger',
    outline: 'btn-outline',
  };

  return (
    <button
      disabled={disabled || isLoading}
      className={clsx(
        variantClasses[variant], // Aplica la classe base del globals.css
        "flex items-center justify-center gap-2", // Centrat extra
        (disabled || isLoading) && "opacity-70 cursor-not-allowed transform-none active:translate-y-0 active:border-b-4", // Estat desactivat
        className
      )}
      {...props}
    >
      {isLoading && <Loader2 className="w-5 h-5 animate-spin" />}
      {children}
    </button>
  );
}

// =================== FILE: src/presentation/components/ui/gamified/LanguagerSwitcher.tsx ===================

'use client';

import { useLocale } from 'next-intl';
import { usePathname, useRouter } from 'next/navigation';
import { Globe } from 'lucide-react';
import { useState } from 'react';
import { clsx } from 'clsx';

const languages = [
  { code: 'ca', label: 'Català', flag: '🐱' }, // Emoji provisional
  { code: 'en', label: 'English', flag: '🇬🇧' },
  { code: 'es', label: 'Español', flag: '🇪🇸' },
];

export function LanguageSwitcher() {
  const locale = useLocale();
  const pathname = usePathname();
  const router = useRouter();
  const [isOpen, setIsOpen] = useState(false);

  const changeLanguage = (newLocale: string) => {
    // Substituïm el locale actual pel nou a la URL
    // Ex: /ca/login -> /en/login
    const newPath = pathname.replace(`/${locale}`, `/${newLocale}`);
    router.push(newPath);
    setIsOpen(false);
  };

  return (
    <div className="relative">
      <button 
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-2 px-4 py-2 rounded-xl border-2 border-slate-700 bg-slate-800 hover:bg-slate-700 font-bold text-slate-400 transition-colors"
      >
        <Globe className="w-5 h-5" />
        <span className="uppercase">{locale}</span>
      </button>

      {/* Dropdown Gamificat */}
      {isOpen && (
        <div className="absolute top-14 right-0 bg-slate-800 border-2 border-slate-700 rounded-xl shadow-xl p-2 w-48 flex flex-col gap-2 z-50 animate-in fade-in zoom-in-95">
          {languages.map((lang) => (
            <button
              key={lang.code}
              onClick={() => changeLanguage(lang.code)}
              className={clsx(
                "flex items-center gap-3 p-3 rounded-lg font-bold transition-all border-b-4 active:border-b-0 active:translate-y-1",
                locale === lang.code 
                  ? "bg-blue-500/20 text-blue-400 border-blue-500/50" 
                  : "hover:bg-slate-700 text-slate-300 border-transparent hover:border-slate-600"
              )}
            >
              <span className="text-xl">{lang.flag}</span>
              {lang.label}
            </button>
          ))}
        </div>
      )}
    </div>
  );
}

// =================== FILE: src/presentation/hooks/game/useGameSession.ts ===================

// filepath: src/presentation/hooks/game/useGameSession.ts
import { useState, useEffect } from 'react';
import { Challenge } from '@/core/entities/challenges/challenge.entity';
import { submitSessionAction } from '@/presentation/actions/gamification/submit-session.action';
import { SessionResultDTO } from '@/application/dto/session-result.dto';

type GameStatus = 'PLAYING' | 'SUBMITTING' | 'SUCCESS' | 'ERROR';

export function useGameSession(challenges: Challenge[]) {
  const [currentIndex, setCurrentIndex] = useState(0);
  const [status, setStatus] = useState<GameStatus>('PLAYING');
  
  // CORRECCIÓ: Usem el tipus estricte en lloc de 'any'
  const [result, setResult] = useState<SessionResultDTO | null>(null);
  const [error, setError] = useState<string | null>(null);

  const currentChallenge = challenges[currentIndex];
  // Validació per evitar NaN si l'array és buit
  const progress = challenges.length > 0 ? ((currentIndex) / challenges.length) * 100 : 0;

  const handleNext = () => {
    if (currentIndex < challenges.length - 1) {
      setCurrentIndex(prev => prev + 1);
    } else {
      setStatus('SUBMITTING');
    }
  };

  const handleRetry = () => {
    setError(null);
    setStatus('SUBMITTING');
  };

  useEffect(() => {
    if (status === 'SUBMITTING') {
      let isMounted = true; // Evitem actualitzacions si el component es desmunta

      const submit = async () => {
        try {
          const challengeIds = challenges.map(c => c.id);
          const topicId = challenges[0]?.topicId;

          if (!topicId) throw new Error("Topic ID not found");

          const response = await submitSessionAction(challengeIds, topicId);

          if (!isMounted) return;

          if (response.success) {
            setResult(response.data); // Ara TypeScript sap que això és SessionResultDTO
            setStatus('SUCCESS');
          } else {
            setError(response.error);
            setStatus('ERROR');
          }
        } catch (err) {
            if (isMounted) {
                console.error(err);
                setError('CONNECTION_ERROR'); // Usem una clau per traduir després
                setStatus('ERROR');
            }
        }
      };

      submit();

      return () => { isMounted = false; };
    }
  }, [status, challenges]);

  return {
    currentChallenge,
    currentIndex,
    totalChallenges: challenges.length,
    progress,
    status,
    result,
    error,
    handleNext,
    handleRetry
  };
}

// =================== FILE: src/presentation/utils/icon-mapper.tsx ===================

// filepath: src/presentation/utils/icon-mapper.tsx
import { 
  Code2, 
  Database, 
  Server, 
  Globe, 
  Cpu, 
  Terminal,
  ShieldCheck,
  Atom,
  Container,
  Layers,
  LucideIcon 
} from 'lucide-react';

// Mapa de claus (string BD) -> Components (Lucide)
const ICON_MAP: Record<string, LucideIcon> = {
  'code': Code2,
  'database': Database,
  'server': Server,
  'web': Globe,
  'algo': Cpu,
  'terminal': Terminal,
  
  // Nous temes
  'brand-react': Atom,
  'security': ShieldCheck,
  'docker': Container,
  'fullstack': Layers,
  
  // Fallback
  'default': Code2 
};

/**
 * Retorna directament el JSX de la icona.
 * Així al component només has de fer: {getTopicIcon(nom, classes)}
 */
export const getTopicIcon = (iconName: string, className?: string) => {
  const IconComponent = ICON_MAP[iconName] || ICON_MAP['default'];
  return <IconComponent className={className} />;
};

// =================== FILE: src/proxy.ts ===================

// filepath: src/proxy.ts
import createMiddleware from 'next-intl/middleware';
import { routing } from './routing';
 
export default createMiddleware(routing);

export const config = {
  // MATCHER CORRECTE (REGEX):
  // Atrapa totes les peticions EXCEPTE:
  // - api (rutes d'API)
  // - _next/static (fitxers estàtics de Next)
  // - _vercel (interns de Vercel)
  // - fitxers amb extensió (imatges .png, .jpg, favicon.ico, etc.)
  matcher: ['/((?!api|_next|_vercel|.*\\..*).*)']
};

// =================== FILE: src/routing.ts ===================

// filepath: src/routing.ts
import { defineRouting } from 'next-intl/routing';

// NOVA IMPLEMENTACIÓ v4
export const routing = defineRouting({
  // Una llista de tots els locales suportats
  locales: ['ca', 'es', 'en'],
  
  // Si no es troba cap locale, es fa servir aquest
  defaultLocale: 'ca',

  // Opcional: Prefixar sempre el locale o no (as-needed és net per al default)
  localePrefix: 'always' 
});

// Exportem tipus per a usar-los al codi
export type Locale = (typeof routing.locales)[number];

// =================== FILE: src/test/setup.ts ===================

// filepath: src/test/setup.ts
import dotenv from 'dotenv';
import path from 'path';

// Carreguem explícitament el fitxer .env.test
dotenv.config({ path: path.resolve(process.cwd(), '.env.test') });

// Opcional: Si no troba el .env.test, prova amb .env.local per desenvolupament local
if (!process.env.SUPABASE_SERVICE_ROLE_KEY) {
    dotenv.config({ path: path.resolve(process.cwd(), '.env.local') });
}

console.log('🧪 Test Environment Loaded. Supabase URL:', process.env.NEXT_PUBLIC_SUPABASE_URL ? '✅ Found' : '❌ Missing');

// =================== FILE: supabase/snippets/Untitled query 908.sql ===================

-- 1. TAULA TOPICS
CREATE TABLE IF NOT EXISTS public.topics (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    slug TEXT UNIQUE NOT NULL,
    name_key TEXT NOT NULL,
    icon_name TEXT NOT NULL,
    color_theme TEXT NOT NULL,
    active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. TAULA CHALLENGES
CREATE TABLE IF NOT EXISTS public.challenges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    topic_id UUID REFERENCES public.topics(id) ON DELETE CASCADE,
    difficulty_tier INT DEFAULT 1,
    type TEXT NOT NULL,
    content JSONB NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. TAULA PROFILES (La crea Supabase Auth normalment, però la simulem per local)
CREATE TABLE IF NOT EXISTS public.profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT,
    total_xp INT DEFAULT 0,
    level INT DEFAULT 1,
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. TAULA USER_PROGRESS
CREATE TABLE IF NOT EXISTS public.user_progress (
    user_id UUID REFERENCES public.profiles(id) ON DELETE CASCADE,
    challenge_id UUID REFERENCES public.challenges(id) ON DELETE CASCADE,
    topic_id UUID REFERENCES public.topics(id),
    xp_earned INT DEFAULT 10,
    completed_at TIMESTAMPTZ DEFAULT NOW(),
    PRIMARY KEY (user_id, challenge_id)
);

-- Activem RLS (Bones pràctiques, encara que el test usi Service Key)
ALTER TABLE public.topics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.challenges ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_progress ENABLE ROW LEVEL SECURITY;

-- Permisos bàsics de lectura pública
CREATE POLICY "Public topics" ON public.topics FOR SELECT USING (true);
CREATE POLICY "Public challenges" ON public.challenges FOR SELECT USING (true);

// =================== FILE: tsconfig.json ===================

{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
   "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}


// =================== FILE: vitest.config.ts ===================

// filepath: vitest.config.ts
import { defineConfig } from 'vitest/config';
import tsconfigPaths from 'vite-tsconfig-paths';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [
    tsconfigPaths(), // <--- AQUESTA és la clau màgica que soluciona el teu error
    react(),
  ],
  test: {
    environment: 'jsdom', // Necessari per testejar components de React més endavant
    globals: true,
    setupFiles: ['./src/test/setup.ts'],
    include: ['src/**/*.test.ts', 'src/**/*.test.tsx'],
  },
});